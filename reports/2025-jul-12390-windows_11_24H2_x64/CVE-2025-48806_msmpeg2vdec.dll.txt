{'date': 1752036862.3634894, 'patch_store_uid': 'beb8cab8-c498-45e4-a8ed-1dc1a4facc87', 'file': 'msmpeg2vdec.dll', 'change_count': 32, 'cve': 'CVE-2025-48806', 'kb': 'KB5062553', 'confidence': 0.26}
--------------------------------------------------------------------
CVE-2025-48806 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft MPEG-2 Video Extension (msmpeg2vdec.dll) – specifically the
sample management code that maintains an internal singly-linked list at
decoder-context offset 0x2020 (8224).

Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use After Free (double insertion of a list element leaves a
stale pointer that is later dereferenced).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Function  sub_1800D3630  (renamed  sub_1800D5428 after the patch) is
invoked whenever a decoded sample (pointer a2) is queued on the
"ready" list that hangs off context->+0x2020.  Each sample embeds a
next-pointer at +0x160 (352) and a reference counter at +0x150 (336).

PRE-PATCH behaviour:
 1. Caller passes context (a1) and sample (a2).
 2. The critical section at context+0x2038 (8232) is entered.
 3. The code blindly appends a2 to the tail of the list without first
    checking whether the sample is already linked.
 4. Because the reference count is incremented every time the routine
    is called, the same object can be inserted multiple times,
    producing identical list nodes that share the same memory.

REMOVAL path (not shown in the diff) only unlinks *one* occurrence and
releases one reference.  The second list entry continues to hold the
now-dangling pointer.  Subsequent list walks eventually reach this
pointer and dispatch a virtual method situated 48 bytes into the freed
object (see the original sub_180191FA0), leading to a call through a
freed vtable.  An attacker who controls heap layout can replace the
freed block, pivoting execution to attacker-controlled data.

The helper  sub_180191FA0 (now moved to sub_180192A80) shows exactly
that dereference pattern: it reads context+0x520 (1312) and calls
(*(void **)vtable+0x30)(obj).  If obj has already been freed, code
execution follows attacker data.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// PRE-PATCH: sub_1800D3630 (extract)
EnterCriticalSection(cs);
_InterlockedIncrement(a2 + 336);
*(DWORD *)(a2 + 40) = 0;
*(QWORD *)(a2 + 352) = 0;          // reset next
if (ctx->Head)                     // no duplicate check
{
    node = ctx->Head;
    while (node->Next)             // walk to tail
        node = node->Next;
    node->Next = a2;               // append sample
}
else
{
    ctx->Head = a2;                // first element
}
LeaveCriticalSection(cs);
```

```c
// POST-PATCH: duplicate suppression
if (sub_1800D6960(g_Config))       // returns 1 when protection is on
{
    for (node = ctx->Head; node; node = node->Next)
        if (node == a2)            // already in list -> abort
        {
            status = -1;
            goto exit;
        }
}
```
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
Malicious MPEG-2 bitstream -> Media Foundation pipeline ->
CDecoder::QueueSample() -> sub_1800D5428 (AddToReadyList) – sample is
inserted twice – later CDecoder::ProcessSamples() walks the list and
calls sub_180192A80 on the stale node, executing freed memory.

Attack Vector
--------------------------------------------------------------------
A crafted MPEG-2 video file or stream rendered by any application that
loads the Microsoft MPEG-2 Video Extension (e.g., Movies & TV, Edge,
Media Foundation-based players).  No special privileges are required;
code runs in the context of the invoking process.

Patch Description
--------------------------------------------------------------------
1. Added helper sub_1800D6960 that retrieves a configuration flag and
   returns its LSB.
2. In sub_1800D5428 the flag gates a pre-insertion search that scans
   the ready-list for the incoming sample pointer.  If found, the
   function aborts and returns -1, preventing a double insertion.
3. Legacy clean-up code (previously in sub_180191FA0) was moved to
   sub_180192A80; functionality unchanged.

Security Impact
--------------------------------------------------------------------
Without the patch an attacker can gain arbitrary code execution inside
any process that decodes MPEG-2 content.  Successful exploitation may
lead to full user-level compromise, sandbox escape, or elevation via a
privileged media service, depending on the host application.

Fix Effectiveness
--------------------------------------------------------------------
The duplicate-insertion check removes the immediate UAF condition and
is executed under the same critical section, so no race window
remains.  Protection, however, depends on the runtime flag parsed by
sub_1800D6960; if the flag is disabled (unknown default), the list
remains unaudited.  No further issues were visible in the supplied
patch, but additional auditing and fuzzing of list operations is
recommended.
