{'kb': 'KB5062553', 'date': 1752037028.8793902, 'change_count': 2, 'patch_store_uid': '140b6365-8efd-482c-91c1-75c13615cfcb', 'confidence': 0.16, 'file': 'vertdll.dll', 'cve': 'CVE-2025-47159'}
--------------------------------------------------------------------
CVE-2025-47159 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
vertdll.dll   (user-mode runtime that services code executing inside a
Windows Virtualization-Based Security enclave).  Affected routine is
RtlpEnterCriticalSectionContended, which acquires an RTL_CRITICAL_
SECTION when initial spinning has already failed.

Vulnerability Class
--------------------------------------------------------------------
Protection mechanism failure / use of untrusted shared memory
(CWE-693).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The routine decides whether to apply the dynamic spin-count algorithm
only when the system contains more than one logical processor.  That
decision is made by reading a 16-bit field that normally resides in
KUSER_SHARED_DATA:

    WORD  *(0x7FFE0000 + 0x036A)   ; NumberOfProcessors

Inside a VBS enclave the standard KUSER_SHARED_DATA page is *not* auto
mapped.  The hard-coded address 0x7FFE036A therefore resolves to an
ordinary, unprotected enclave page.  A less-privileged user who
creates or loads an enclave can deliberately commit pages at that
address and fill them with arbitrary data before the trusted vertdll
code runs.  When RtlpEnterCriticalSectionContended later executes it
reads the attacker-controlled word and treats the value as the actual
processor count.

If the forged value is greater than one the function executes the
multi-processor path:

  v3 = CS->Flags & 0x00FFFFFF   ; current spin count (24 bits)
  v4 = (CS->Flags & 0x2000000)  ; RTL_CRITICAL_SECTION_FLAG_DYN_SPIN

Various arithmetic operations then adjust v3 and may set/clear the high
flag bits (0xFF000000) in CS->Flags.  These high bits encode internal
protection options such as NO_DEBUG_INFO and DYNAMIC_SPIN.  Because the
branch is taken on untrusted data, a malicious enclave can cause vertdll
to clear or set those protection bits on *any* critical section it
enters, bypassing intended synchronization and debugging controls and
ultimately gaining higher privileges inside VTL1.

The flaw therefore crosses the VTL0 -> VTL1 trust boundary: attacker
(VTL0) supplies data that the trusted enclave (VTL1) uses in a security
decision.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable read
if ( MEMORY[0x7FFE036A] > 1u ) {          // <-- attacker controlled
    v3 = *(a1 + 32) & 0xFFFFFF;
    v4 = (*(a1 + 32) & 0x2000000) != 0;
}

// patched read
if ( *(_WORD *)(RtlEnclaveUntrustedSharedUserData + 874) > 1u ) {
    /* same body */
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User (VTL0) enclave loader:
1. Allocates and commits a data page at 0x7FFE0000, sets word 0x036A to
   an attacker-chosen value (e.g., 0xFFFF).
2. Starts enclave; vertdll gets mapped and RtlpEnterCriticalSection­
   Contended is executed (e.g., during loader-lock acquisition).
3. Function reads attacker value, misclassifies system topology, and
   alters CS->Flags bits under attacker influence.
4. Modified flags disable/alter critical safeguards, enabling privilege
   escalation inside VBS.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker who can create or load a VBS enclave.
No administrator rights are required; only the ability to commit pages
inside the enclave address space before vertdll starts running.

Patch Description
--------------------------------------------------------------------
Replaces the absolute reference to 0x7FFE036A with an indirect access
through RtlEnclaveUntrustedSharedUserData + 874.  The pointer is
provisioned by the kernel when the enclave is initialized and maps to a
read-only copy of KUSER_SHARED_DATA that the attacker cannot modify.
Thus the processor-count check now consumes trusted data.

Security Impact
--------------------------------------------------------------------
Before the patch a less-privileged enclave could subvert vertdll’s
internal synchronization logic and clear critical protection bits in
RTL_CRITICAL_SECTION structures, achieving elevation of privilege in
VTL1.  After the patch, the decision path is based on trusted read-only
state, closing the privilege-escalation avenue.

Fix Effectiveness
--------------------------------------------------------------------
The only untrusted dereference in the routine has been replaced.  No
other references to 0x7FFE0000 remain in this function, and
RtlEnclaveUntrustedSharedUserData is read-only inside the enclave.
Therefore the patch fully addresses the identified vulnerability.
