{'kb': 'KB5062553', 'date': 1752037795.819313, 'patch_store_uid': '8aafed3b-809e-47fe-b58d-87ad406ad8af', 'change_count': 4, 'file': 'vmwp.exe', 'confidence': 0.26, 'cve': 'CVE-2025-48002'}
--------------------------------------------------------------------
CVE-2025-48002 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Hyper-V user-mode worker process (vmwp.exe).  The affected
routines belong to the WIL feature-gating helper templates generated
inside vmwp.exe:
  * Feature_TestConfNum::GetCurrentFeatureEnabledState
  * Feature_ImplVal::GetCurrentFeatureEnabledState
  * Feature_TestValidate::ReportUsage

Vulnerability Class
--------------------------------------------------------------------
CWE-190: Integer overflow / wraparound leading to CWE-125: out-of-bounds
read (information disclosure).

Detailed Root Cause Analysis
--------------------------------------------------------------------
On x64 Windows the first four integer/pointer parameters are passed in
registers RCX, RDX, R8, R9.  Prior to the fix the template instance
wil::details::FeatureImpl<...>::ReportUsage was emitted with the
following prototype:
    ReportUsage(unsigned int *impl, unsigned __int8 reportingKind)

However *every* call-site supplied only the first argument, because the
intended design is that the helper figures out the reporting kind by
itself.  When the callee executed it still tried to consume the second
parameter, blindly interpreting whatever happened to be in the DL
register (high byte of RCX or residual stack data) as an 8-bit
reporting kind.

That byte is subsequently propagated to
wil::details::ReportUsageToService, which copies the value into a
telemetry / diagnostic buffer that is returned to the guest or to an
adjacent management component.  Consequently arbitrary stack or register
bytes from the Hyper-V worker process leak outside the VM boundary.

In addition, the helper stored the 32-bit feature mask in 8-bit
variables (char v9 / v11).  Any value >=0x100 silently wrapped, masking
upper bits (CWE-190).  The wrapped value is later used in bit tests and
conditionals that gate whether 0x400 (FEATURE_PRIVACY_GUARDED) is
cleared.  By forcing the overflow an attacker can bypass that guard and
make ReportUsage expose data that should have been suppressed.

The combined effects give the guest (or another adjacent tenant able to
influence feature activation) a reliable primitive to disclose vmwp.exe
stack memory.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable prototype (before)
__int64 __fastcall ReportUsage(unsigned int *impl,
                               unsigned __int8 reportingKind);

// fixed prototype (after)
__int64 __fastcall ReportUsage(unsigned int *impl);
```
```c
// truncated flag handling (before)
char v9; // CL  -> receives 32-bit OR result, wraps at 0xFF
...
if (v11 && !v9)
    *a2 &= ~0x400u;        // guard can be skipped
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
Guest / management input that toggles a feature flag
 --> vmwp!GetCurrentFeatureEnabledState
     (builds the 32-bit mask)
 --> if mask meets (0xC00==0xC00 || mask&0x40) path
     vmwp!Feature_TestValidate::ReportUsage  [bad call]
     |__ consumes stray DL byte (integer wrap)
     |__ wil::ReportUsageToService serialises data
 --> Data copied back to guest / network => leak

Attack Vector
--------------------------------------------------------------------
An authenticated attacker running in an adjacent guest or management
context issues configuration changes or hypercalls that cause the host
worker process to evaluate the affected feature flags.  The malformed
call to ReportUsage then exfiltrates host stack bytes via the normal
usage-report path.

Patch Description
--------------------------------------------------------------------
1. ReportUsage signature reduced to a single parameter; all call-sites
   updated accordingly.
2. GetCurrentFeatureEnabledState paths switched from __private_IsEnabled
   to the corrected ReportUsage helper, and the compound condition was
   simplified ("||" instead of separate branches).
3. Boolean work variables upgraded from char to int, eliminating 8-bit
   truncation.
4. Wrong trait id passed to GetCachedFeatureEnabledState replaced with
   the correct one.

Security Impact
--------------------------------------------------------------------
Before the fix an attacker could read up to one byte of uninitialised
vmwp.exe stack per invocation of ReportUsage.  Repeated calls allow the
collection of larger amounts of memory, potentially including host
ASLR/CFG material, guest secrets from neighbouring VMs, or Hyper-V
internal pointers.  The vulnerability does not grant write
capabilities, but the disclosed information is sufficient for
subsequent exploitation stages.

Fix Effectiveness
--------------------------------------------------------------------
The parameter-count mismatch is removed and no residual paths call the
old two-parameter stub; integer truncation has been eliminated.
Therefore the identified disclosure primitive is fully neutralised.
No alternative path performing the same out-of-bounds read was
observed in the patched binary, so the fix is considered effective.
