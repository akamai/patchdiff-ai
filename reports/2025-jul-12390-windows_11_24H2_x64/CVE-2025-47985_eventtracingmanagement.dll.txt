{'confidence': 0.25, 'file': 'eventtracingmanagement.dll', 'kb': 'KB5062553', 'date': 1752037475.682243, 'cve': 'CVE-2025-47985', 'change_count': 2, 'patch_store_uid': '804dd8b4-5422-406c-8d96-73156c78ca46'}
--------------------------------------------------------------------
CVE-2025-47985 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Event Tracing Management library (eventtracingmanagement.dll).
The affected routines live in the WIL feature-management helper
templates:
  • wil::details::FeatureImpl<__WilFeatureTraits_Feature_TestValidate>
  • wil::details::FeatureImpl<__WilFeatureTraits_Feature_TestConfNum>

Vulnerability Class
--------------------------------------------------------------------
CWE-822: Untrusted Pointer Dereference (local Elevation of Privilege).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Prior to the patch the helper
FeatureImpl<...>::__private_IsEnabled() accepted an *arbitrary* pointer
parameter (named a1, type unsigned int*).  The routine:
  1. Called GetCachedFeatureEnabledState(a1,&statePtr).
  2. Immediately treated the *return value* of that helper as a second
     pointer and performed:
        v7 = *(_QWORD *)return_value;   // double-deref, unguarded
  3. It also directly read the caller-supplied a1 contents
        v2 = *a1;
     without validating address, alignment or access rights.

Because the function executes in the Event Tracing service context
( SYSTEM integrity) any lower-privileged process that can reach
__private_IsEnabled() with a crafted pointer can force the service to
read or write arbitrary kernel / service address space.  The read value
(v2 / v7) later influences flags passed to
ReportUsageToService(), enabling controlled corruption of internal
ETW bookkeeping and ultimately privilege escalation.

The companion routine GetCurrentFeatureEnabledState() relied on
__private_IsEnabled().  Its decision logic used the returned boolean to
adjust a feature-state bitfield stored at *a2, so the untrusted pointer
dereference propagated directly into a shared state structure.

Parameters / structures involved
  • a1 – caller-supplied pointer to a 32-bit feature-state cache word.
  • GetCachedFeatureEnabledState() – returns another pointer that was
    blindly dereferenced.
  • a2 – pointer to caller-visible result structure subsequently
    modified with attacker-controlled bits.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
v2 = *a1;                             // 1st unguarded deref
v7 = *(_QWORD *)wil::details::FeatureImpl<...>::GetCachedFeatureEnabledState(
        a1, &v8);                     // double deref of untrusted value
...
wil::details::ReportUsageToService(a1 + 2, 50565209i64,
        (v2 >> 10) & 1, (v2 >> 11) & 1, &v5, v3, 0);
```
```c
// after
wil::details::FeatureImpl<...>::ReportUsage(
        (wil::details *)a1, …)       // new helper
// no second-level dereference; updates done through
// InterlockedCompareExchange on validated internal cache
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User-mode ETW consumer
    -> Feature APIs (wil::Feature<>::IsEnabled/ReportUsage)
        -> GetCurrentFeatureEnabledState()
            -> __private_IsEnabled(a1)   [vulnerable]
                -> untrusted pointer dereference
                -> corrupted flags
            <- back-propagation into *a2 structure
        -> ETW service logic executes with modified state

Attack Vector
--------------------------------------------------------------------
A local, authenticated attacker supplies a crafted pointer value when
invoking a WIL feature helper reachable from Event Tracing APIs.  When
the service dereferences that pointer, the attacker obtains arbitrary
read/write primitives inside the privileged Event Tracing process,
allowing elevation to SYSTEM.

Patch Description
--------------------------------------------------------------------
1. __private_IsEnabled() was removed; callers were updated to use a new
   ReportUsage() helper that:
   • Accepts a *wil::details* object rather than a raw uint32*.
   • Performs atomic CompareExchange loops that keep all accesses inside
     the process-owned cache object.
   • Never dereferences the result of GetCachedFeatureEnabledState(); it
     only uses the value returned in an out-parameter.
2. GetCurrentFeatureEnabledState() was rewritten to call the new
   ReportUsage() helper and the unsafe logic block was deleted.

Security Impact
--------------------------------------------------------------------
Before the fix, a local attacker could coerce the Event Tracing service
into following a user-controlled pointer, enabling arbitrary memory
access and resulting in a full LOCAL SYSTEM privilege escalation.

Fix Effectiveness
--------------------------------------------------------------------
The patch removes the untrusted second-level dereference entirely and
confines all memory operations to the internally allocated feature
cache, guarded by Interlocked* primitives.  No external pointers are
followed, eliminating the CWE-822 condition.  No residual dereference
paths comparable to the removed code are visible, so the fix appears
complete and effective.
