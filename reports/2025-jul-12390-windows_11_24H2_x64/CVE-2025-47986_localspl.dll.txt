{'confidence': 0.12, 'file': 'localspl.dll', 'patch_store_uid': '9319e798-57ab-4eac-b772-de3df940dd67', 'date': 1752037661.1168745, 'cve': 'CVE-2025-47986', 'change_count': 9, 'kb': 'KB5062553'}
--------------------------------------------------------------------
CVE-2025-47986 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Universal Print / Local Print Spooler – localspl.dll
Function: AssignFreeJobToFreePort()
Build: prior to June-2025 security update (10.0.1904x / 10.0.2539x)

Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use-After-Free (memory-safety, elevation of privilege)

Detailed Root Cause Analysis
--------------------------------------------------------------------
AssignFreeJobToFreePort() walks the linked list of INIPORT and
INIJOB objects trying to find a printable job ( pointer j ).  The loop
runs while the spooler lock is only partially held; another thread can
free the INIJOB structure at any time (e.g. when a user cancels the
job).

Prior to the patch the routine performed an additional data-type check
without first confirming that the object was still valid:

    v23 = *(const wchar_t **)(j + 120);   // read pDatatype
    _wcsicmp(L"XPS_PASS", v23);

If the job had just been deleted, *j now points to freed heap memory
(look-aside list).  Reading offset +120 therefore results in a use of
freed memory.  By creating and cancelling jobs while heap-spraying,
a local attacker can place controlled data in the freed block and make
the spooler interpret it as a wide-string pointer.  Subsequent string
comparison touches the attacker-controlled address space which lies in
a predictable, writable region.  Typical exploitation redirects the
flow to attacker-supplied shellcode under the SYSTEM account (the
spooler runs as LocalSystem), providing local privilege escalation.

The problem is purely temporal: AssignFreeJobToFreePort() caches the
INIJOB pointer ( j ) outside the critical section and later dereferences
it without re-validation.

Structures / offsets (64-bit):
  INIJOB +0x00  FLINK/BLINK
  INIJOB +0x20  status flags
  INIJOB +0x78  pDatatype (wide string pointer)   <-- offset 0x78 = 120

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
if (j) {
    if (dwFastPrintSlowDownThreshold > *(j+0xA8) &&
        (!*(DWORD*)(v11+0x228) ||
           (v23 = *(WCHAR**)(j+0x78)) == NULL ||
           _wcsicmp(L"XPS_PASS", v23))) {
        j = 0;                 // pointer used after it may be freed
    }
}

// after
if (j && dwFastPrintSlowDownThreshold > *(j+0xA8) &&
        !*(DWORD*)(v11+0x228)) {
    j = 0;                     // dangerous deref removed
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User submits many print jobs, then quickly cancels them.
2. Spooler thread 1 frees INIJOB record during cancellation.
3. Thread 2 concurrently enters AssignFreeJobToFreePort(), caches ‘j’
   pointer, releases list-lock and later executes extra datatype check.
4. j->pDatatype is read after free – attacker-controlled heap memory.
5. Crafted memory causes controlled crash or code execution inside
   spoolsv.exe.

Attack Vector
--------------------------------------------------------------------
Local authenticated user (or sandbox escape) who can create / cancel
print jobs interacts with the print spooler IPC (OpenPrinter /
StartDoc / SetJob).  No administrator rights are required.

Patch Description
--------------------------------------------------------------------
Microsoft removed the unsafe dereference entirely:
  • The datatype comparison (_wcsicmp) and the load of *(j+120) were
    deleted.
  • The pruning logic now only relies on job age threshold and a flag
    held in the parent INIPORT ( *(v11+552) ).
  • Several variables were renamed; control-flow labels were adjusted
    but no new functionality was added.

No memory layout changes – fix is purely defensive.

Security Impact
--------------------------------------------------------------------
Before the update an attacker could elevate privileges from any local
account to SYSTEM by executing code in the context of the spooler
service (Universal Print Management Service).  The spooler is enabled
by default on client and server SKUs, making the issue widely
reachable.

Fix Effectiveness
--------------------------------------------------------------------
The updated logic completely removes the out-of-lifetime access path,
thereby eliminating the UAF.  No residual pointer dereferences of the
freed INIJOB structure remain in this code path.  The fix is adequate
as long as no other code dereferences ‘j’ after the lock is released.
