{'patch_store_uid': '140b6365-8efd-482c-91c1-75c13615cfcb', 'change_count': 2, 'date': 1752036207.3480744, 'confidence': 0.16, 'kb': 'KB5062553', 'cve': 'CVE-2025-48803', 'file': 'vertdll.dll'}
--------------------------------------------------------------------
CVE-2025-48803 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
vertdll.dll (user-mode runtime loaded into Windows VBS enclaves).
Affected routine: RtlpEnterCriticalSectionContended (offset
0x180009FF0).

Vulnerability Class
--------------------------------------------------------------------
CWE-353: Missing support for integrity check / use of untrusted shared
state inside an enclave.

Detailed Root Cause Analysis
--------------------------------------------------------------------
Inside VBS user-mode enclaves the trusted system supplies a read-only
alias called RtlEnclaveUntrustedSharedUserData that mirrors selected
fields from KUSER_SHARED_DATA while preventing the enclave from
accessing attacker-controlled pages.  Prior to the patch the critical
section helper RtlpEnterCriticalSectionContended read the value at the
absolute virtual address 0x7FFE036A:

    if (MEMORY[0x7FFE036A] > 1u) { ... }

Because the enclave address space is fully controlled by the untrusted
host process, the host can map writable memory at 0x7FFE0000 inside the
enclave.  Consequently the test operates on attacker-supplied data with
no integrity guarantee.  The 16-bit field governs two internal
variables:

    v3 – spin-count history (low 24 bits of CSR->Flags)
    v4 – "adaptive spin" flag (bit 0x2000000 of CSR->Flags)

When the field is forced to a value <=1 the optimisation path is
skipped; when forced >1 it is taken.  By flipping the bit at run time an
attacker can:

1. Force excessive or negative spin counts (v3 becomes 0 or a large
   attacker-chosen number).
2. Drive the state machine in RtlpSpinForCriticalSection and subsequent
   atomic sequences into unexpected transitions.
3. Leave the CRITICAL_SECTION structure in an inconsistent state
   (Owner/LockCount mismatches) that is later processed by kernel
   callbacks (NtAlertThreadByThreadId, NtContinue, etc.).

Because enclave code runs at process integrity but manages objects that
are subsequently unmarshalled by the kernel on exit, corruption of the
structure results in an Elevation of Privilege from the enclave to the
hosting process context.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
if (MEMORY[0x7FFE036A] > 1u)                 // untrusted alias
{
    v3 = *(QWORD *)(a1 + 32) & 0xFFFFFF;
    v4 = (*(QWORD *)(a1 + 32) & 0x2000000) != 0;
}

// after
if (*(WORD *)(RtlEnclaveUntrustedSharedUserData + 874) > 1u) // trusted
{
    v3 = *(QWORD *)(a1 + 32) & 0xFFFFFF;
    v4 = (*(QWORD *)(a1 + 32) & 0x2000000) != 0;
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Enclave or host code calls EnterCriticalSection on a contended lock.
2. RtlpEnterCriticalSectionContended executes inside the enclave.
3. Routine reads WORD at 0x7FFE036A taken from enclave-mapped memory.
4. Host furnishes crafted value (>1) via a writable page mapping.
5. v3/v4 are set to attacker-chosen state; spin loop and atomic
   adjustments proceed with inconsistent counters.
6. Lock state becomes corrupted; subsequent leave/unwind paths execute
   incorrect atomic updates, mis-adjusting LockCount and recursion
   depth.
7. On enclave exit, corrupted CRITICAL_SECTION surfaces in kernel APC
   delivery, enabling arbitrary code execution in the host process.

Attack Vector
--------------------------------------------------------------------
Local attacker that can load or interact with a VBS enclave maps a
writable page at VA 0x7FFE0000 inside the enclave before the vulnerable
routine executes, then writes a value >1 at offset 0x36A.  No elevated
privilege is required to perform the mapping.

Patch Description
--------------------------------------------------------------------
The patch replaces the hard-coded absolute address with a reference to
RtlEnclaveUntrustedSharedUserData, the officially supported alias that
is mapped read-only inside the enclave and whose contents are populated
and integrity-checked by the kernel.  This removes attacker control of
the field.

Security Impact
--------------------------------------------------------------------
Prior to the patch an attacker in the same user session could escape the
VBS enclave boundary and execute arbitrary code in the host process
context (Elevation of Privilege).  Exploitation does not require admin
rights and affects any system using VBS enclaves.

Fix Effectiveness
--------------------------------------------------------------------
By redirecting the read to a kernel-managed, read-only alias the patch
eliminates the untrusted data source and closes the attack surface.  No
further logic changes were necessary.  Residual risk is low, though a
full audit should confirm that no other enclave routines still read
0x7FFEXXXX directly.
