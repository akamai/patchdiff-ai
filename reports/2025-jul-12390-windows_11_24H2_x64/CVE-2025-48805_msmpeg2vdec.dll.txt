{'kb': 'KB5062553', 'patch_store_uid': 'beb8cab8-c498-45e4-a8ed-1dc1a4facc87', 'file': 'msmpeg2vdec.dll', 'change_count': 32, 'confidence': 0.27, 'cve': 'CVE-2025-48805', 'date': 1752037727.5283873}
--------------------------------------------------------------------
CVE-2025-48805 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft MPEG-2 Video Extension (msmpeg2vdec.dll) – internal work
queue management routines

Vulnerability Class
--------------------------------------------------------------------
Heap-based Buffer Overflow (CWE-122)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The decoder maintains a singly-linked list that queues per-picture
work items.  Each list element is an allocator–backed structure whose
link field is located at offset +0x160 (decimal 352) and a reference
counter at +0x150 (decimal 336).

The enqueue helper originally implemented as sub_1800D3630()

    • acquired the object’s critical section (a1+0x2038)
    • blindly appended the node (a2) to the tail of the list whose head
      resides at a1+0x2020
    • released the lock and returned 0

No verification was performed to guarantee that the same node was not
already present in the list.  If higher-level decoding logic called
this helper twice with the same a2 pointer (a legitimate scenario when
error-handling or re-entrancy occurs) the following corruption
resulted:

    – On the second call *(a2+352) is reset to NULL while another list
      entry still references a2, breaking the forward chain.
    – Subsequent traversals operate on freed or out-of-range memory,
      allowing arbitrary pointer reads/writes.
    – Because list elements are heap-allocated MPEG-2 picture
      structures, an out-of-bounds write occurs inside the process
      heap, leading to controllable memory corruption and ultimately
      code execution in the calling context (typically the media
      player sandbox or the hosting browser tab).

This fault is completely inside the Microsoft-supplied extension – no
kernel interaction is involved – but it is triggered by data that an
attacker supplies in a crafted MPEG-2 bit-stream.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
/* before – sub_1800D3630 (excerpt) */
_InterlockedIncrement((volatile LONG *)(a2 + 336));
*(DWORD *)(a2 + 40) = 0;
*(QWORD *)(a2 + 352) = 0;          // zero link field
// blindly append
for ( i = *(QWORD *)(head + 352); i; i = *(QWORD *)(i + 352) )
    tail = i;
*(QWORD *)(tail + 352) = a2;       // duplicate insertion possible
```
```c
/* after – sub_1800D5428 (excerpt) */
if ((BYTE)sub_1800D6960(flag)) {
    for (i = *head; i; i = *(QWORD *)(i + 352)) {
        if (i == a2) {              // already in list ?
            v2 = -1;                // signal error
            goto leave;
        }
    }
}
// append only when unique
``` 

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. MPEG-2 parser processes crafted picture headers.
2. Decoder worker allocates a picture struct P and queues it via
   sub_1800D3630().
3. Malformed stream triggers an error path that re-queues the same P
   without having been dequeued first.
4. Duplicate insertion corrupts the forward list.
5. A later dequeue or flush walks the chain, overruns heap memory and
   transfers control to attacker-supplied data.

Attack Vector
--------------------------------------------------------------------
A malicious MPEG-2 video file or streaming content played through any
Windows component that leverages msmpeg2vdec.dll.  No user
interaction beyond opening/previewing the media is required.  The
attack works in the default configuration and in the browser preview
handler.

Patch Description
--------------------------------------------------------------------
The update replaces sub_1800D3630 with sub_1800D5428 which:

  • Enumerates the current queue while the critical section is held.
  • If the candidate node is already present, aborts and returns –1.
  • Otherwise continues with the original append logic.
  • Propagates the error status to callers by changing the return type
    (unsigned int instead of constant 0).

Ancillary changes in sub_1800E4060() and sub_1800D8030() only rename
globals and tighten feature-flag gating; they do not affect the fix.

Security Impact
--------------------------------------------------------------------
Prior to the patch an attacker could achieve heap corruption that
reliably leads to remote code execution in the context of the calling
process.  Successful exploitation bypasses CFG/DEP because the attacker
controls both the overwritten forward pointer and subsequent data
written by the list walker.

Fix Effectiveness
--------------------------------------------------------------------
The duplicate-node detection fully prevents the corrupted list state
that caused the overflow.  Because the verification is performed while
the critical section is held, race-conditions are excluded.  Returning
an explicit error allows higher-level code to recover gracefully.
No further exploitation path was identified after the fix.
