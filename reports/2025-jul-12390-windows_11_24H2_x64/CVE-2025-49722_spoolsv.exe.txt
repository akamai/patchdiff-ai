{'confidence': 0.26, 'kb': 'KB5062553', 'file': 'spoolsv.exe', 'cve': 'CVE-2025-49722', 'date': 1752036569.4893663, 'change_count': 41, 'patch_store_uid': 'b78f26b8-8fd5-4b88-9d92-123234523668'}
--------------------------------------------------------------------
CVE-2025-49722 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Print Spooler service (spoolsv.exe) – RPC asynchronous
worker-thread interface for printer / port / driver management.

Vulnerability Class
--------------------------------------------------------------------
CWE-400: Uncontrolled Resource Consumption (DoS) caused by missing
input validation on user-supplied Unicode strings passed through numerous
RPC async entry points.

Detailed Root Cause Analysis
--------------------------------------------------------------------
Spooler exposes a rich RPC interface.  For performance the majority of
operations are executed asynchronously: the RPC stub marshals
parameters, allocates a NThreadingLibrary::TWorkItem, copies user data
into that object and queues it to a global work-crew.

Prior to the patch none of these stubs verified the length of the
incoming wide-string parameters (printer name, driver name, port name,
form name, registry key, etc.).  The code path is identical in each
stub:
  1. operator new(sizeof(WorkItem)) allocates a fixed structure.
  2. Raw user pointer (USHORT *) is copied into the work-item without
     bounds checking.
  3. The work-item is added to g_pWorkCrew or immediately executed when
     the direct-call quota (<200) is not exceeded.

Because the worker thread later treats the string as a NUL-terminated
UNICODE_STRING, an attacker can:
  • Supply an extremely long string (many MB).
  • Force the spooler to repeatedly traverse it with wcslen/wcscpy when
    the item is processed, consuming CPU cycles.
  • Cause large heap allocations in downstream helpers that duplicate
    or canonicalise the string (e.g. NCoreLibrary::TString, NT registry
    helpers), rapidly exhausting memory and starving other requests.

All affected entry points (
RpcAsyncEnumPrinters, EnumPorts, EnumMonitors, EnumPrinterDrivers,
EnumPrintProcessors, EnumPrintProcessorDatatypes, AddPort, SetPort,
AddPrintProcessor, Delete* family, Get/Set printer data, forms,
GetPrinterDriverDirectory, GetPrintProcessorDirectory, etc.) shared the
same flaw.

The issue is reachable remotely (RPC over SMB/Spooler named pipe) by any
authenticated user in the adjacent network, matching Microsoft’s attack
vector description.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
Instance = TFunction8<...>::CreateInstance(
            (unsigned int)&YEnumPrintProcessors,
            (_DWORD)a3,      // unchecked USHORT * pName
            (_DWORD)a4, ...);
```
```c
// after
if (a3 && wcsnlen(a3, 0x104) >= 0x104 ||
    a4 && wcsnlen(a4, 0x104) >= 0x104) {
    LOWORD(a4) = ERROR_INVALID_PARAMETER;  // 87
    goto fail;
}
Instance = TFunction8<...>::CreateInstance(...);
```
Similar guards (length 0x104, 0x207, 0x400, etc.) were added to every
stub that accepts strings.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker opens \PIPE\spoolss and issues an RPC call, e.g.
   RpcAsyncEnumPrinters(level, VERY_LONG_STRING).
2. spoolsv!RpcAsyncEnumPrinters allocates work-item and copies pointer.
3. Work-item later calls wcslen/registry APIs; each traversal is O(N).
4. Repeated calls or very large N starve worker threads and exhaust
   paged heap – service becomes unresponsive or crashes, denying print
   functionality to the system.

Attack Vector
--------------------------------------------------------------------
Authenticated user on the same network submits crafted RPC requests to
the Print Spooler pipe (usually via SMB or local LPC).  No elevated
privilege is required beyond normal printer use rights.

Patch Description
--------------------------------------------------------------------
Microsoft introduced centralised parameter validation guarded by the
feature flag __WilFeatureTraits_Feature_2578215227.
For every asynchronous RPC stub that accepted user strings the patch
adds:
  • wcsnlen(…, MAX) length checks (max values: 0x104, 0x207, 0x400).
  • Early return through RpcAsyncCompleteCall with Win32 error 87
    (ERROR_INVALID_PARAMETER) when the limit is exceeded.
  • No work-item is allocated/queued, so no excessive resource
    consumption occurs.

Security Impact
--------------------------------------------------------------------
Prior to the fix, a low-privilege user could continuously send over-sized
strings, driving CPU utilisation and heap growth in spoolsv.exe,
causing print operations to fail for all users (service crash or
hang).  No code execution is indicated, but reliable Denial of Service
is achievable.

Fix Effectiveness
--------------------------------------------------------------------
Length validation is now present in every previously vulnerable stub and
occurs before any allocation.  Error path returns immediately, preventing
work-item creation and thus eliminating the resource amplification.
Provided the controlling WIL feature flag is enabled by default on
supported builds, the patch fully mitigates the vulnerability.

