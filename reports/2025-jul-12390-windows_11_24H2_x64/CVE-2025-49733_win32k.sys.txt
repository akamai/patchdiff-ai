{'patch_store_uid': '7dc41a8e-277a-408b-8bf9-c201766239d3', 'confidence': 0.11, 'kb': 'KB5062553', 'date': 1752037540.9352565, 'cve': 'CVE-2025-49733', 'change_count': 3, 'file': 'win32k.sys'}
--------------------------------------------------------------------
CVE-2025-49733 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
win32k.sys  (API-set contract resolution logic) – functions
ApiSetResolveToHost_V7, ApiSetpGetSearchKeyInfo_V7 and
ApiSetpSearchForSectionIndex_V7.

Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use-After-Free / general kernel memory corruption.

Detailed Root Cause Analysis
--------------------------------------------------------------------
The resolution path that translates an API-set contract name to the
real host module is:

  ApiSetResolveToHost_V7      (public entry)
      -> ApiSetpGetSearchKeyInfo_V7     (parse caller string)
      -> ApiSetpSearchForSectionIndex_V7 (locate mapping entry)

1.  Parsing routine (ApiSetpGetSearchKeyInfo_V7)
    ------------------------------------------------
    • Accepts a UNICODE_STRING buffer (a1) and length (a2).
    • Walks the buffer **backwards two bytes at a time** but treats it
      as a stream of single-byte characters (char *), so it only looks
      at the low-order byte of every UTF-16 code unit.
    • Performs no upfront sanity checks: any length >=2 is accepted,
      the mandatory "API-" / "EXT-" prefix is not verified and the
      trailer after the dash is allowed to contain non-numeric
      characters.
    • Two OUT parameters are returned:
          a4 – supposed start index of the section name
          a5 – boolean telling the caller whether the string describes
               a host or a contract.
      Because the parser never validates the prefix/trailer, attacker
      controlled inputs can force *a5 to **1** (host path) while
      *a4 still contains an arbitrary value.

2.  Lookup routine (ApiSetpSearchForSectionIndex_V7)
    -----------------------------------------------
    • Receives the string pointer, attacker-controlled length (*a4)
      and a section-table header (a2) that lives inside a shared
      ApiSet mapping in win32k.sys memory.
    • A case-folding polynomial hash is computed from the caller
      buffer; afterwards a binary search walks the section table:
          v24 = Base + Index * EntrySize - MappingBias
    • The code trusts the values coming from the parser – if the
      supplied length mismatches the real entry length a partial hash
      collision will cause the binary search to stop **inside the
      table bounds but on the wrong element**.
    • Subsequent dereferences (v27, v29) access memory that is only
      valid when the index is correct.  If the mapping entry is out of
      range or has been unmapped for another session, win32k touches
      freed memory, creating a use-after-free window that is exploitable
      for privilege escalation.

3.  ApiSetResolveToHost_V7 finally copies data from the (possibly
    stale) entry into a caller-supplied output buffer (*a5) – turning
    the UAF read into a potential write-what-where if the stale entry
    has been recycled.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// pre-patch: ApiSetpGetSearchKeyInfo_V7 (excerpt)
if ( *v9 == 46 ) {
    if ( v7 ) { *a4 = v8; goto LABEL_12; }
    v8 = v10; v7 = 1; }
...
*a4 = a2;         // length left unverified
*a5 = 1;          // caller will treat as host
```

```c
// post-patch: ApiSetpGetContractKeyInfo (excerpt)
if ( a2 < 5u || (unsigned)(2*a2) < 8 ) return 0;  // length checks
v5 = *a1 & 0xFFFFFFDFFFDFFFDFui64;
if ( v5 != 0x2D004900500041i64 && v5 != 0x2D005400580045i64 )
    return 0;                                      // prefix check
...
*(_DWORD *)(a4+12) = 1; // or 2 / 3 – explicit type field
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Local attacker passes a crafted Unicode string (eg. through
   NtOpenFile/NtLoadDriver path that resolves DLLs).
2. win32k.sys -> ApiSetResolveToHost_V7.
3. Malformed string parsed by ApiSetpGetSearchKeyInfo_V7; *a5 is set
   to HOST, *a4 left attacker-controlled.
4. ApiSetResolveToHost_V7 forwards those values to
   ApiSetpSearchForSectionIndex_V7.
5. Incorrect index used; function walks freed or out-of-range memory
   inside the ApiSet mapping (UAF).
6. Resolver writes data from that stale entry into caller buffer
   leading to kernel memory corruption and privilege escalation.

Attack Vector
--------------------------------------------------------------------
Any local process that can trigger loading or resolution of an
API-set name (for instance by using LoadLibrary with a crafted
"ext-ms-*.dll" path) can supply the malformed contract string and
take advantage of the kernel-mode UAF.  No special privileges are
required.

Patch Description
--------------------------------------------------------------------
• Replaced ApiSetpGetSearchKeyInfo_V7 with
  ApiSetpGetContractKeyInfo – a complete rewrite that
  – validates minimum length (>=5 UTF-16 characters / >=8 bytes).
  – enforces canonical prefixes ("API-" / "EXT-").
  – fully parses numeric version fields; rejects mixed or duplicate
    separators.
  – returns a 32-byte structured descriptor including an explicit
    Type field (1=contract,2=host,3=versioned).
• ApiSetResolveToHost_V7 updated to consume the new structure and to
  select the proper section table based on the validated Type.
• ApiSetpSearchForSectionIndex_V7 simplified – receives the new
  descriptor, computes the hash using correct stride size and returns
  the index **only** when both hash and string length match.
• Numerous magic values previously calculated on the fly are now read
  from fixed fields, reducing the chance of arithmetic overflow.

Security Impact
--------------------------------------------------------------------
The flaw allowed an attacker in user mode to obtain an arbitrary
kernel-mode read/write primitive by redirecting win32k to freed mapping
entries.  Successful exploitation yields local elevation-of-privilege
with SYSTEM rights.

Fix Effectiveness
--------------------------------------------------------------------
The new parser rejects all malformed prefixes, enforces numeric
trailers and fills a fixed descriptor that drives later look-ups.
Because the lookup routine now relies on the validated descriptor
rather than untrusted caller length, the erroneous index cannot be
forged and stale mapping entries are no longer reachable.  No obvious
bypass is visible in the patched code.

