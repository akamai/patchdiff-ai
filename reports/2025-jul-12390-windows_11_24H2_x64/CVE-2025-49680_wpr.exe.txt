{'change_count': 7, 'file': 'wpr.exe', 'confidence': 0.26, 'date': 1752036571.9332528, 'cve': 'CVE-2025-49680', 'patch_store_uid': '14681285-2fe8-4e0a-a455-9aaa16e1a2fa', 'kb': 'KB5062553'}
--------------------------------------------------------------------
CVE-2025-49680 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Performance Recorder (wpr.exe) – user-mode command line tool
shipped with Windows for collecting performance traces.

Vulnerability Class
--------------------------------------------------------------------
CWE-59: Improper Link Resolution Before File Access ("link following")

Detailed Root Cause Analysis
--------------------------------------------------------------------
Only the modified functions are visible, no file-handling code is
included in the diff.  What we do see is that several C++ allocator
specialisations (for SubConstraintInfo, JITDispatcherConnection*,
DxilResourceDesc, etc.) as well as the program entry point (wmain)
were updated.

1.  In each *allocator::deallocate* implementation the error path that
    raises a CRT invalid-parameter failure was previously declared as

        _o__invalid_parameter_noinfo_noreturn(arg1, arg2);

    The patched version now calls

        _o__invalid_parameter_noinfo_noreturn(arg1, arg2, arg3);

    where *arg3* is the calculated allocation size (bytes+39).  The
    third argument is expected by the CRT helper and is used when the
    process terminates via fast-fail.  Omitting it left an undefined
    value in the R8 register; if that value was later dereferenced by
    the CRT the process could AV immediately, producing an
    out-of-band termination that looks like a DoS.

2.  The entry routine *wmain* adds an early call to

        SetProcessMitigationPolicy(ProcessMitigationPolicy 16, …)

    when the *Feature_2578215227* feature flag is on.  Policy 16
    corresponds to *PROCESS_SHADOW_STACK_POLICY*.  This does not fix
    the logic bug above but hardens the process against certain
    exploit primitives.

Because the allocator bug is only reached when an allocation larger
than page size is freed and the hidden header pointer does not match
the user pointer, an attacker that can control either the allocation
size or corrupt the header can deterministically crash wpr.exe,
meeting the documented "Denial of Service" impact.  Whether or not
this involves symlink handling cannot be verified from the supplied
code – no path-handling routines are present – therefore that aspect
remains **unknown** from the evidence given.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
if ((uint64)(32*a3) >= 0x1000) {
    v4 = *((uint64*)a2 - 1);
    if ((uint64)a2 - v4 - 8 > 0x1F) {
        _o__invalid_parameter_noinfo_noreturn(v4, a2);
        __debugbreak();
    }
}

// after
if (bytes >= 0x1000) {
    hdr = *((uint64*)a2 - 1);
    sizeArg = bytes + 39;
    if ((uint64)a2 - hdr - 8 > 0x1F) {
        _o__invalid_parameter_noinfo_noreturn(hdr, a2, sizeArg);
        __debugbreak();
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker manipulates wpr.exe so that a container holds >0x1000
   bytes of data and its internal header pointer becomes inconsistent.
2. Container destructor calls the corresponding
   *std::allocator<…>::deallocate*.
3. The validation branch is taken; wrong argument list is sent to the
   CRT helper.
4. CRT dereferences the third argument (garbage), raising an
   access-violation and terminating the process.

Attack Vector
--------------------------------------------------------------------
Exact method is **unknown**; requires the ability to make wpr.exe
allocate and then free a large block whose hidden header gets
corrupted or mismatched.

Patch Description
--------------------------------------------------------------------
• Each *deallocate* specialisation now computes the exact byte size of
  the allocation and passes it as a third argument to
  _o__invalid_parameter_noinfo_noreturn, aligning with the CRT
  prototype.
• The jump-over addresses were updated to point at the new epilogues.
• wmain introduces an optional Shadow-Stack process mitigation to make
  exploitation harder, gated behind a feature flag.

Security Impact
--------------------------------------------------------------------
Prior to the fix an authorised local user could trigger an unhandled
access violation in wpr.exe, reliably crashing the tool and causing a
local Denial of Service.  No privilege escalation or information leak
is evident from the diff.

Fix Effectiveness
--------------------------------------------------------------------
The CRT helper is now invoked with the correct argument count and
semantics, eliminating the undefined behaviour that previously led to
an AV.  In the absence of further issues in caller-supplied values the
patch fully addresses the crash vector shown.
