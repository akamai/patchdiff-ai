{'kb': 'KB5062553', 'change_count': 1, 'confidence': 0.14, 'patch_store_uid': '823407ea-2473-4a3c-b08f-d5037b8633a1', 'file': 'vbsapi.dll', 'cve': 'CVE-2025-48803', 'date': 1752036218.5698247}
--------------------------------------------------------------------
Unknown-CVE Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
vbsapi.dll – routine SdbpGetVelocityState (exported by the
Virtualisation-Based Security run-time)

Vulnerability Class
--------------------------------------------------------------------
CWE-353  – Missing Support for Integrity Check (logic / access–control
error)

Detailed Root Cause Analysis
--------------------------------------------------------------------
SdbpGetVelocityState is an enclave-exposed helper that tells the caller
(1) whether the supplied *feature family* (a3 – L"Velocity" or
L"KIR") is supported, and (2) whether the requested *feature Id* (a4)
is currently enabled.  The caller passes two write-back pointers:
    int   *FeatureKnown (a1)
    BOOL  *FeatureEnabled (a2)

Before the patch the routine trusted the (family,Id) tuple blindly –
there is no cryptographic authentication, white-list validation, or
range checking apart from a hard-coded if/else list.  Any Id that falls
outside those literal compares slips through the bottom of the tree
and the function still returns success (v10==1) while leaving
*FeatureKnown set to 0.  Call-sites interpret that combination as
"known family, disabled feature" and silently switch the mitigation
off.  Because the enclave boundary gives the caller (already executing
with user privileges in VTL1) the ability to invoke this routine, a
local attacker can supply a deliberately crafted, unauthenticated Id to
disable KIR / Velocity mitigations and elevate privileges inside the
secure world.

The logic hole is purely a consequence of missing integrity support;
there is no signature, hash, or HMAC that protects the input.  The
patch adds the previously omitted Id 0x036E9876 (57579638,
DoYouCopyFix) and tightens boundary conditions (>0x3554D8F became
>0x3554D90).  As a side effect, the second out-parameter was promoted
from BOOL * to _DWORD * to make the 32-bit width explicit, but no other
behaviour changes.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// pre-patch excerpts (de-compiled)
if (wcsicmp_0(a3,L"Velocity")) {
    v10 = wcsicmp_0(a3,L"KIR") == 0;
    goto LABEL_65;                  // <- returns success even when Id
}
...
if (v16 != 1) {
LABEL_65:
    v9 = 0;                         // FeatureKnown = 0
    goto LABEL_66;                  // but v10 (function result) == 1
}
```
The function returns TRUE (success) although the supplied Id was never
validated.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User-mode (inside a VBS enclave) -> SdbRetrieveAppCompatInfo ->
SdbpGetVelocityState
  Pass arbitrary L"Velocity"/L"KIR" and rogue Id (a4)
  Routine falls through the compare list -> LABEL_65
  Returns success, *FeatureKnown = 0, *FeatureEnabled = 0
  Caller disables the corresponding mitigation, gaining elevated
  capabilities inside the enclave.

Attack Vector
--------------------------------------------------------------------
Local, post-compromise.  Code already running inside a Virtualisation
Based Security enclave calls the exported API with a forged feature Id
that is outside the hard-coded list.

Patch Description
--------------------------------------------------------------------
1. Added explicit handling for Id 0x036E9876 (57579638,
   Feature_DoYouCopyFix__private_IsEnabledDeviceUsageNoInline).
2. Changed upper-bound compare from 0x3554D8F to 0x3554D90, closing the
   gap that previously let 0x3554D90 fall into the wrong branch.
3. Adjusted follow-on deltas and label numbers; removed dead
   subtraction chain for 55922064.
4. Clarified width of the second out parameter by changing the type
   from BOOL * to _DWORD *.
No additional functional changes were introduced.

Security Impact
--------------------------------------------------------------------
Before the fix an unprivileged enclave caller could forge an unchecked
feature Id, forcing the kernel to believe that a security mitigation
was disabled.  This let the attacker undermine VBS isolation and gain
privileges within the trusted execution environment, which can be
leveraged for a full local elevation of privilege.

Fix Effectiveness
--------------------------------------------------------------------
The added compare closes the open range and the new constant covers the
previous hole, eliminating the unauthenticated paths.  As the call now
fails for any non-white-listed Id, the integrity of the Velocity / KIR
state is preserved and the elevation vector is removed.  No residual
bypass is observable in the patched logic.
