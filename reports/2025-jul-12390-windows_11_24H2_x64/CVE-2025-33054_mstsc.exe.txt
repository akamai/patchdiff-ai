{'change_count': 6, 'date': 1752035872.035787, 'confidence': 0.23, 'cve': 'CVE-2025-33054', 'file': 'mstsc.exe', 'kb': 'KB5062553', 'patch_store_uid': '2e76f7af-bb01-45e3-b010-90c78cd5de45'}
--------------------------------------------------------------------
CVE-2025-33054 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Remote Desktop Connection client (mstsc.exe) – WIL feature-gating and
usage-reporting helpers (FeatureImpl::<X>::GetCurrentFeatureEnabledState
and FeatureImpl::<X>::ReportUsage)

Vulnerability Class
--------------------------------------------------------------------
Logical/UI spoofing flaw – CWE-357: Insufficient UI warning of dangerous
operations

Detailed Root Cause Analysis
--------------------------------------------------------------------
The Remote Desktop client uses Windows-in-code (WIL) “feature gates” to
query whether a security-sensitive feature is active and whether its
result should suppress or surface UI prompts.  Each gate call returns a
32-bit flag block in *a2 :
  bit 0x040  – FEATURE_STATE_KNOWN
  bit 0x400  – FEATURE_VALIDATED / safe-path selected
  bit 0x800  – FEATURE_BLOCKED  (force prompt)

Prior to the patch the helper that fills this block contained three
independent bugs:
1.  Swapped bit mapping (0x40 vs 0x80) for the raw enablement flags in
    FeatureImpl<Standalone_25_06_NonSec>::GetCurrentFeatureEnabledState.
    The client therefore believed the feature was *validated* when in
    fact it was simply *enabled*, suppressing the warning banner.
2.  Uninitialised/incorrectly re-used boolean variables (v9/v10 and
    v12) in several GetCurrentFeatureEnabledState variants.  Because the
    variable value was later ANDed with bit 0x400, stale stack data
    could make the code clear that bit even when no validation had been
    performed.
3.  The ReportUsage helpers accepted a caller-supplied ReportingKind
    byte (a2).  That value was propagated directly to
    ReportUsageToService and also influenced the UI flag stored in
    v10/v11.  Attackers able to influence the call-stack could force the
    client to believe validation happened in a benign context
    (ReportingKind==0) and again suppress the prompt.

Combined, these bugs allowed the output flag block to advertise
"validated & safe" while the feature was merely enabled and unverified.
When mstsc evaluated the flags it skipped the normal certificate / name
/ redirection warning, enabling a spoofing scenario for a malicious
server.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before – swapped flag mapping and uses uninit v9/v10
v7 = ((FeatureEnabledState & 3) << 7) |
     ((FeatureEnabledState & 0x40) ? 0x800 : 0) |
     ((FeatureEnabledState & 0x80) ? 0x400 : 0);
 ...
if ( (v7 & 0xC00) == 0xC00 || (v7 & 0x40) )
{
    wil::Feature_TestValidate::__private_IsEnabled(...);
    v9 = 1;                 // may be uninitialised on other paths
}

// after – corrected mapping and boolean initialisation
v7 = ((FeatureEnabledState & 3) << 7) |
     ((FeatureEnabledState & 0x80) ? 0x400 : 0) |
     ((FeatureEnabledState & 0x40) ? 0x800 : 0);
*(_DWORD*)a2 = v7;
...
v10 = 0;   // explicit init
v11 = 1;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
mstsc.exe starts → FeatureImpl::<X>::GetCurrentFeatureEnabledState
populates flag block → UI logic decides whether to show security banner
→ because of wrong/cleared 0x400 bit banner is skipped → user is
presented with spoofed session believing it is safe.

Attack Vector
--------------------------------------------------------------------
A network attacker who can stand up or relay an RDP server persuades a
victim to connect.  The attacker relies on the incorrect feature state
flags to suppress mstsc’s usual “identity / redirection” warning, thus
spoofing a trusted session.

Patch Description
--------------------------------------------------------------------
• Corrects 0x40/0x80 mapping when translating FEATURE_ENABLED_STATE to
  internal flags.
• Forces default 0x40 (known) bit when FeatureEnabledState==0.
• Removes stale variable v12 and guarantees boolean variables are
  initialised before use.
• Eliminates branch that conditionally cleared 0x400 based on unverified
  validation.
• Reworks ReportUsage prototype:  takes fixed ReportingKind==1,
  hard-codes v9=3, preventing caller manipulation.
• Adds explicit ReportUsage(...) calls so validation now always happens
  before 0x400 is trusted.

Security Impact
--------------------------------------------------------------------
Before the fix, an attacker could cause mstsc to believe a dangerous
operation (connecting to an untrusted or spoofed server) was already
validated.  The UI banner meant to warn the user was therefore omitted,
leading to CVE-2025-33054 Remote Desktop spoofing.

Fix Effectiveness
--------------------------------------------------------------------
The corrected bit mapping, explicit variable initialisation, and locked
ReportingKind path remove all observed ways to fabricate the 0x400
validated bit.  UI warnings again appear whenever validation did not
occur, fully mitigating the spoofing vector described.
