{'change_count': 57, 'cve': 'CVE-2025-49723', 'patch_store_uid': 'b5c2a519-79b6-46c4-8b4b-d060a1082e3b', 'confidence': 0.26, 'date': 1752037043.7456, 'file': 'windows.staterepository.dll', 'kb': 'KB5062553'}
--------------------------------------------------------------------
CVE-2025-49723 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
windows.staterepository.dll – StateRepository::Security::AccessControl,
functions  CheckUserIsCallerOrAdministratorPrivilege( … , IUser *) and
CheckUserIsCallerOrAdministratorPrivilege( … , PSID )

Vulnerability Class
--------------------------------------------------------------------
Missing Authorization / Authentication Bypass (CWE-862)

Detailed Root Cause Analysis
--------------------------------------------------------------------
Two overloads are used by the StateRepository service to decide whether
a caller (identified by an IUser object or a raw SID) is the same user
as the current thread or is a built-in administrator.  In the original
implementation both functions returned S_OK when the supplied identity
parameter was NULL:

  • IUser* a3 == nullptr  ->  return 0 (S_OK)
  • PSID  Sid1 == NULL    ->  return 0 (S_OK)

Because the success code is propagated to higher-level helpers, every
subsequent privileged operation is executed under the assumption that
the check succeeded.  No call to StateRepository::Security::AccessControl
::Check() was made, and no SID comparison or ACL evaluation occurred.

Therefore any local caller able to invoke the StateRepository WinRT/COM
APIs could simply pass a null IUser/SID pointer and be treated as either
(1) the caller itself or (2) an administrator, completely bypassing the
intended security gate.  This is a textbook missing-authorization flaw.

Affected parameters / structures
  • IUser interface vtable slot 11 (index 88h) returning caller SID
  • PSID Sid1 parameter
  • administratorPrivilegeSecurityDescriptor constant
  • Returned HRESULT – 0 used to indicate success without verification

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE (IUser* overload)
if (!a3)
    return 0;               // <-- bypass

// BEFORE (PSID overload)
if (!Sid1)
    return 0;               // <-- bypass
```
```c
// AFTER (IUser* overload)
if (!a3)
{
    v9 = StateRepository::Security::AccessControl::Check(
             a1, a2, 0,
             administratorPrivilegeSecurityDescriptor, 1);
    if (v9 >= 0) return 0;
    Return_Hr(...);
}
```
```c
// AFTER (PSID overload)
if (!Sid1)
{
    v7 = StateRepository::Security::AccessControl::Check(
             a1, a2, 0,
             administratorPrivilegeSecurityDescriptor, 1);
    ...
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker obtains a client handle to the StateRepository WinRT API.
2. Calls any API path that eventually invokes
   CheckUserIsCallerOrAdministratorPrivilege(..., NULL).
3. Function immediately returns S_OK.
4. Privileged operation proceeds as if the caller were authorised.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker running arbitrary user-mode code can call
the public StateRepository interfaces and pass NULL for the identity
parameter, gaining write access to repository files/settings that are
supposed to be restricted to administrators.

Patch Description
--------------------------------------------------------------------
The patch removes the unconditional success return.  When the identity
parameter is NULL the code now:
  • Calls StateRepository::Security::AccessControl::Check() with the
    administratorPrivilegeSecurityDescriptor to explicitly verify the
    caller’s token.
  • Logs detailed error codes with unique site IDs (0x89, 0xA8, etc.).
  • Adds guarded execution through a Feature flag, allowing staged roll
    out but defaulting to the safe path when enabled.
  • Adds extra error-path handling and frees allocations reliably.

Security Impact
--------------------------------------------------------------------
Before the fix any standard user could bypass privilege checks and
perform arbitrary modifications (tampering) to StateRepository data that
should be accessible only to administrators.  This results in elevation
of privilege and integrity level violation.

Fix Effectiveness
--------------------------------------------------------------------
The new logic performs an actual ACL check for the administrator SID
whenever the caller does not present an explicit identity, eliminating
the NULL-pointer bypass.  No remaining direct path returning success
without a Check() call was observed in the patched diff.  Risk remains
only if the controlling Feature flag could be disabled, but under normal
configurations the fix is effective.
