{'file': 'appxdeploymentserver.dll', 'kb': 'KB5062553', 'date': 1752037978.6297145, 'patch_store_uid': '45eb45d0-52c3-48ef-9a6b-9f1dbc26b83f', 'confidence': 0.9, 'change_count': 163, 'cve': 'CVE-2025-48820'}
--------------------------------------------------------------------
CVE-2025-48820 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows AppX Deployment Service (AppXSVC) – one-time cleanup and on-
demand register handlers located in appxdeploymentserver.dll. Affected
helper previously named sub_1802A1CFC (RemoveDirectoryTreeSafely), and
its callers sub_18029FB14 / sub_18029CDF4.

Vulnerability Class
--------------------------------------------------------------------
Improper link resolution before file access (CWE-59) a.k.a. “link
following” that results in privileged directory / file deletion and
local elevation of privilege.

Detailed Root Cause Analysis
--------------------------------------------------------------------
The unpatched routine sub_1802A1CFC recursively deletes a directory
structure supplied by higher-level cleanup code.

1. It enumerates entries with FindFirst/FindNextFileW.
2. For every child item it directly calls CreateFileW with
   DELETE | FILE_FLAG_BACKUP_SEMANTICS | FILE_FLAG_OPEN_REPARSE_POINT.
3. The obtained handle is immediately passed to
   SetFileInformationByHandle( … , FileDispositionInfo ) to mark the
   object for deletion; if the item is itself a directory the function
   recurses without extra checks.
4. Crucially, the function never verifies that the opened handle still
   resolves inside the original root directory.  A malicious user can
   therefore create a directory junction or symlink inside the tree
   that points to any protected location.  When AppXSVC (running as
   SYSTEM) processes the tree it follows the attacker-controlled link
   and deletes arbitrary files or directories outside the intended
   scope.
5. The same helper is invoked by the On-Demand Register handler
   (sub_18029FB14) and by the broader registration flow
   (sub_18029CDF4), amplifying impact to several service actions.

Data structures / parameters involved
   •  v25 / v38 – wide-string buffers holding the full file names.
   •  FileW      – HANDLE opened with DELETE rights.
   •  v32        – attributes from GetFileInformationByHandle().
   •  FileInformation = 1 – buffer passed to
      SetFileInformationByHandle for FileDispositionInfoEx.
   •  rootPath (v9) – the current directory being processed.

Because no post-open validation is performed, a TOCTOU window exists
between directory enumeration and object deletion, enabling link
following attacks.

Vulnerability Code Snippets
--------------------------------------------------------------------
Before (simplified):
```c
FileW = CreateFileW(fullName, DELETE, FILE_SHARE_READ, NULL,
                    OPEN_EXISTING, 0x2200000, NULL);
if (FileW != INVALID_HANDLE_VALUE)
{
    // NO validation of final path
    SetFileInformationByHandle(FileW,
        FileRenameInfoEx|FileDispositionInfo,
        &FileInformation, sizeof(FileInformation));
}
```
After:
```c
FileW = CreateFileW(fullName, DELETE, FILE_SHARE_READ, NULL,
                    OPEN_EXISTING, 0x2200000, NULL);
if (FileW != INVALID_HANDLE_VALUE)
{
    lpString1 = GetFinalPathNameByHandleW(FileW, …);
    // Verify object is still under original root directory
    if (CompareStringOrdinal(lpString1, -1, rootPath, -1, TRUE)==CSTR_EQUAL)
    {
        SetFileInformationByHandle(FileW,
            FileRenameInfoEx|FileDispositionInfo,
            &FileInformation, sizeof(FileInformation));
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User operation leaves stale package data under a writable directory
   processed by AppXSVC.
2. Service calls sub_1802A25C4  ➜  sub_1802A5060  ➜  vulnerable
   sub_1802A1CFC.
3. Attacker pre-plants a junction   victimDir\evilLink  →  \Windows\
   System32.
4. Old code opens the link and marks the System32 object for deletion
   as SYSTEM, achieving EoP.
5. Patched code resolves the final path, sees it does not begin with
   victimDir, logs an error, and skips the entry.

Attack Vector
--------------------------------------------------------------------
Any local user who can create or modify contents within a directory
that AppXSVC later cleans (e.g., %ProgramData%\Microsoft\Windows\
AppRepository\Temp or per-package StateRootFolder) can introduce a
reparse point that redirects deletion outside the allowed tree,
leading to privileged file or directory deletion and elevation of
privilege.

Patch Description
--------------------------------------------------------------------
• Introduces new helper sub_18038CD98 that
  – Retrieves file attributes through handle (sub_18038CC44).
  – Obtains the canonical path of the opened object with
    sub_18038CCC0 (GetFinalPathNameByHandleW wrapper).
  – Uses CompareStringOrdinal to ensure the canonical path starts with
    the stored root directory path; deletion proceeds only on match.
• Adds extensive logging and WIL feature-flag checks.
• Replaces older APIs with safety-prefixed versions
  (sub_1802A22F0, sub_1802A5060, etc.) in all callers.

Security Impact
--------------------------------------------------------------------
Prior to the patch, an attacker-controlled junction or symlink allowed
arbitrary file/folder deletion under SYSTEM privileges, which can be
leveraged to replace or write protected files and attain local
privilege escalation (CVE-2025-48820).  The affected code runs in the
AppX Deployment Service context and is automatically triggered during
package install, uninstall or cleanup operations.

Fix Effectiveness
--------------------------------------------------------------------
By validating the canonical path obtained *after* the handle is opened
(and with FILE_FLAG_OPEN_REPARSE_POINT), the patch eliminates the link
following primitive.  The handle cannot later be redirected, closing
TOCTOU.  No residual path traversal or reparse-point bypass is evident
in the new logic, making the fix effective against the reported
vector.
