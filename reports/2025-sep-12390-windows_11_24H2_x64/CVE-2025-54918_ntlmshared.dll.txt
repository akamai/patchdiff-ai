{'kb': 'KB5065426', 'cve': 'CVE-2025-54918', 'change_count': 3, 'confidence': 0.29, 'patch_store_uid': 'a1c68f1b-3751-404d-bcd9-96badc64ba43', 'date': 1757853816.848807, 'file': 'ntlmshared.dll'}
--------------------------------------------------------------------
CVE-2025-54918 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows NTLM authentication logic inside ntlmshared.dll
(MsvpLm20GetNtlm3ChallengeResponse, MsvpAvlGet and related helpers).

Vulnerability Class
--------------------------------------------------------------------
Improper Authentication – CWE-287

Detailed Root Cause Analysis
--------------------------------------------------------------------
NTLMv2 messages carry a variable-length Target-Info list consisting of
‘AV pairs’.  Each pair begins with a 16-bit AV-ID, followed by a length
field and the value bytes.  Callers search this list with the helper
MsvpAvlGet( AvList , AvId , Size ).

Before the patch MsvpAvlGet completely ignored the requested AvId
(parameter a2).  The routine was hard-coded to succeed only when the
current pair’s ID equalled constant 7:
    if ( (_WORD)i == 7 ) return v3;
As a consequence every caller that looked for a *different* AV-ID
always failed.  In particular
MsvpLm20GetNtlm3ChallengeResponse() tries to fetch the AV_PAIR_TIMESTAMP
(ID 7) *or* other IDs (e.g. Channel-Bindings) depending on the call
site.  When the wanted ID was not 7 the lookup returned NULL, the code
assumed “timestamp not present” and simply replaced it with the local
system time by calling NtQuerySystemTime().

Because the server timestamp is part of the NTLMv2 response hash,
feeding the client’s current time instead of the received time removes
the freshness guarantee.  An attacker able to capture a legitimate
NTLMv2 response can replay it at any later moment (within the NTLM 7-
day window) and be authenticated, effectively bypassing anti-replay
logic and elevating privilege across the network.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// ntlmshared.dll – before patch
int *__fastcall MsvpAvlGet(int *a1, __int64 a2, unsigned int a3)
{
    ...
    for ( i = *a1; (int)a3 > 0 && a3 >= HIWORD(i)+4; i = *v3 )
    {
        if ( (_WORD)i == 7 )        // <- hard-coded AV-ID
            return v3;
        if ( !(_WORD)i )            // end of list
            return 0;
        a3 += -4 - HIWORD(i);
        ...
    }
}
```
```c
// after patch
if ( (unsigned __int16)i == a2 )     // compare with requested AvId
    return v3;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Server receives NTLM_AUTHENTICATE message.
2. LSA calls MsvpPasswordValidate -> MsvpLm20GetNtlm3ChallengeResponse.
3. Routine calls MsvpAvlGet to extract AV_PAIR_TIMESTAMP.
4. Hard-coded lookup fails → timestamp deemed missing.
5. NtQuerySystemTime() fills a fresh value; NTLMv2 hash is recomputed
   with attacker-controlled data.
6. Server accepts replayed / forged NTLMv2 response → privilege
   escalation.

Attack Vector
--------------------------------------------------------------------
A network attacker who can capture a valid NTLMv2 AUTHENTICATE message
(e.g. via MITM, SMB relay, or capture on another connection) resends
that message to a target service.  Because the timestamp is ignored and
re-generated locally, the server accepts the stale response and grants
the attacker the captured user’s privileges.

Patch Description
--------------------------------------------------------------------
1. MsvpAvlGet now compares the current pair’s AV-ID with the *caller
   supplied* AvId parameter instead of the fixed constant 7.
2. The function signature is updated (a2 changed to int), and callers
   are adapted.
3. Additional refactoring/feature-flag code (
   MsvpNtlm3*ResponseNew, ValidateResponseNew, etc.) is unrelated to the
   core fix.

Security Impact
--------------------------------------------------------------------
Prior to the fix any NTLMv2 session could be replayed within the 7-day
window, allowing an authenticated but unprivileged attacker to reuse
captured credentials and authenticate as the victim to arbitrary
services.  This results in an Elevation of Privilege across the
network.

Fix Effectiveness
--------------------------------------------------------------------
The comparison is now parameterised; the faulty constant is removed.
All call sites pass the correct AV-ID, so timestamps and other
important AV pairs are now reliably located and verified.  No new
memory or logic issues are visible in the patch, so the mitigation is
considered effective.
