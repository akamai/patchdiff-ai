{'confidence': 0.34, 'change_count': 30, 'file': 'urlmon.dll', 'kb': 'KB5065426', 'patch_store_uid': '3f6a756a-e722-40c3-8cca-f409af73c699', 'cve': 'CVE-2025-54917', 'date': 1757843528.3363457}
--------------------------------------------------------------------
CVE-2025-54917 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
urlmon.dll – URL-to-Zone resolution and special-directory mapping
(CMapPathToSpecialDirHelper, CSecurityManager::MapUrlToZonePrivate,
GetZoneFromFilePath, ExtractZoneFromFile, etc.)

Vulnerability Class
--------------------------------------------------------------------
Security-feature bypass / protection-mechanism failure
(CWE-693)

Detailed Root Cause Analysis
--------------------------------------------------------------------
Before the patch the routine
CMapPathToSpecialDirHelper::GetLocalDirType() copied the supplied
path (parameter a2) into the caller-provided buffer pszPath with a
home-grown loop:
  – The caller passed the maximum length in *a6 (often 260).
  – The loop blindly wrote two bytes at a time until it either reached
    the original *a6 counter or hit a NUL terminator.
  – If the incoming name was longer than the buffer, the loop truncated
    the string and then forced a NUL.  The function did **not** return
    an error unless the counter reached zero exactly, so silent
    truncation was treated as success.

The truncated string was subsequently used to
  1. remove the file part (PathRemoveFileSpecW),
  2. compare the directory against the helper’s cache, and
  3. decide which special directory type (Local, Profile, None) the
     path belongs to.
Because the comparison was carried out on the truncated value, an
attacker could craft a long path whose prefix matched a trusted local
folder once it had been cut off.  MapUrlToZonePrivate and
GetZoneFromFilePath therefore assigned Local Machine/Intranet zone to
content that originated from an untrusted location.

Additional weak points fixed by the patch reinforced the bypass:
 • PathPrefixMatchesWithSpecialDir() used the same unsafe copy logic.
 • MapUrlToZonePrivate accepted device paths ("\\.\" / "\\;" ) and
   incorrectly normalised them, again allowing remote resources to be
   treated as local.
 • ExtractZoneFromFile relied on an out-of-range index when the ADS
   (Zone.Identifier) lookup failed, defaulting to Zone 1.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
v11 = *a6;
... do {
    v15 = *(_WORD *)&v13[v14];
    if(!v15) break;
    *(_WORD*)v13 = v15;      // unchecked copy
    v13 += 2; --v11;
} while (v11);
*(_WORD*)v16 = 0;            // forced NUL, no error returned
```

```c
// after
v10 = StringCchCopyW(pszPath, *a6, a2);
if (FAILED(v10)) goto error; // copy is now bounded & error-checked
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker supplies a crafted file:/// or UNC path to IE / WebBrowser
   host.
2. CSecurityManager::MapUrlToZonePrivate →
   CMapPathToSpecialDirHelper::PathPrefixMatchesWithSpecialDir →
   GetLocalDirType.
3. GetLocalDirType truncates the long path, mis-classifies it as a
   trusted directory and returns DirectoryType = Local.
4. MapUrlToZonePrivate therefore returns URLZONE_LOCAL_MACHINE (or
   INTRANET).
5. The caller grants elevated privileges to the untrusted content.

Attack Vector
--------------------------------------------------------------------
Any network attacker able to entice a victim to open a specially
crafted long path/URL (for example from a remote share or malicious
website) can cause urlmon to map the resource to the Local or Intranet
zone, bypassing the intended zone-based security restrictions.

Patch Description
--------------------------------------------------------------------
• Replaced all manual copy loops with StringCchCopyW (bounded copy that
  propagates failure).
• Introduced FindCacheEntry() helper and centralised cache lookup.
• Added PathIsPrefixWrapperW and IsDriveAndNotIPv6 to normalise and
  validate paths, and gated legacy behaviour behind feature flags.
• MapUrlToZonePrivate now rejects device paths unless explicitly
  allowed and uses new wrappers when converting FILE:// URLs.
• ExtractZoneFromFile was rewritten to use GetZoneFromAlternateData
  Stream, validated array indexes, and removed silent fall-backs.
• Numerous feature-flag checks were tightened; default is now “fail
  closed”.

Security Impact
--------------------------------------------------------------------
Prior to the fix an attacker could get remote content executed in a
more privileged security zone, defeating zone-isolation, mark-of-the-
web and ActiveX download restrictions.  This enables further attacks
such as running ActiveX controls without prompt or relaxing cross-zone
navigation rules.

Fix Effectiveness
--------------------------------------------------------------------
The patched code eliminates silent truncation, enforces buffer limits
and adds explicit error handling.  Directory comparisons are now
performed on the full, validated path, and device / reparse-point
paths are normalised or rejected.  These changes close the discovered
bypass path and materially harden zone mapping; no residual unsafe
copies were observed in the modified routines.
