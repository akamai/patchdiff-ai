{'change_count': 45, 'date': 1757854249.0422025, 'cve': 'CVE-2025-53810', 'kb': 'KB5065426', 'file': 'mpssvc.dll', 'patch_store_uid': '55be8ad8-5a68-4e61-9274-e927d121c45f', 'confidence': 0.16}
--------------------------------------------------------------------
CVE-2025-53810 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Defender Firewall Service (mpssvc.dll) – blob/rule management
routines (FwIncrmAddBlob, FwLoadBlobsRepos, FwIncrmSetRule, Hyper-V
Mgr helpers) and wil feature-state helpers.

Vulnerability Class
--------------------------------------------------------------------
Type confusion / access of resource using incompatible type (CWE-843).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Several helper routines manipulate lists of _tag_FW_BLOB_RULE_CONTAINER
objects that are threaded through a doubly-linked list whose forward
and backward links are stored at offsets 0 and +8 of a list head
structure.

Before the fix the list head that is handed over to the loaders was
wrongly typed as a generic _QWORD * (or as a plain 64-bit value).  The
code therefore dereferenced the value unconditionally and performed
pointer arithmetic on it:
  * previous prototype
      FwLoadBlobsRepos(…, _QWORD *RepoHead, …)
      RepoHead[1]  ->  assumes forward link
  * same bug exists in FwIncrmAddBlob / FwIncrmSetRule where the code
    stores a rule pointer into a field that is later interpreted as a
    different structure.

If the caller supplied anything other than the expected list head, the
code would:
 1. interpret unrelated memory as a _tag_FW_BLOB_RULE_CONTAINER list
    link;
 2. write the new container’s address into *(RepoHead+0) and *(RepoHead+1);
 3. subsequently traverse the corrupted list, leading to arbitrary
    read/write and eventually to controlled kernel-pool corruption.

Because mpssvc runs as NT Authority\LocalSystem, a local user that can
reach the imported RPC/COM firewall APIs can craft malicious blob
records and provoke the vulnerable path, gaining SYSTEM privileges.

Patch  changes
  * the parameter type from “_QWORD *” to a plain 64-bit value and uses
    explicit “+8” arithmetic – making the dependence on the real list
    head layout obvious and preventing the compiler from treating the
    opaque handle as a structure pointer;
  * adds multiple feature-gated clean-ups (Feature_Firewall_BugFixes_
    25D_Memory_leak_ContainerBlobs etc.) that free the old encoded
    buffer (v44 / v41) once the container has been re-allocated;
  * introduces new IsEnabled() guards so that duplicate-state / name
    resolution logic runs only when the rule layout is correct;
  * updates helper functions (GetCurrentFeatureEnabledState) to remove
    stale self-referencing code, tighten flag masking and prevent mixed
    signed/unsigned promotion mistakes.

Together these changes guarantee that only correctly typed list heads
are used and that any temporary buffers are released, eliminating the
possibility to corrupt heap structures with an incompatible type.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before (mpssvc.dll)
_QWORD *BlobContainer = FwAllocateBlobContainer(a3);
*BlobContainer           = v18;         // rule pointer
*(_QWORD *)(BlobContainer+8) = a7;      // a7 treated as pointer
…
```
```c
// after
_QWORD *BlobContainer = FwAllocateBlobContainer(*((unsigned int *)a3 + 1), v18);
*BlobContainer       = v17;             // rule pointer
// list manipulation now uses (__int64) head + 8 and checks
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Local user calls firewall API (e.g. INetFwPolicy2::Rules.Add or
   BFE RPC) passing crafted rule/blobs.
2. mpssvc -> FwIncrmAddBlob / FwLoadBlobsRepos
3. Routine interprets caller-controlled value as list head and writes
   links via incorrect type.
4. Subsequent list walk corrupts pointer chain → heap corruption →
   arbitrary code-execution inside mpssvc.

Attack Vector
--------------------------------------------------------------------
Any local, authenticated user that can create or update firewall rules
(via the documented COM/RPC interfaces or via netsh) can feed
specially crafted rule/blobs that are processed by the vulnerable
functions.

Patch Description
--------------------------------------------------------------------
1. Corrects function prototypes – opaque list heads are now explicit
   “__int64” values and pointer arithmetic is performed only after
   validating the object.
2. Adds feature-gated clean-up logic to prevent stale pointers and
   double insertions (Feature_Firewall_BugFixes_25D_* flags).
3. Rewrites linked-list insertion with explicit forward/backward link
   checks (`if ( (_QWORD *)*v22 != a4 ) __fastfail(3u);`).
4. Hardened wil::GetCurrentFeatureEnabledState helpers – removed self
   recursion, tightened bitmask usage, replaced global variables, and
   eliminated race between g_enabledStateManager and SRW lock.

Security Impact
--------------------------------------------------------------------
Before the patch, a local attacker could coerce the firewall service to
write controlled data to an attacker-chosen address in the mpssvc
process heap, leading to heap corruption and reliable elevation to
SYSTEM.  No user interaction is required beyond possessing the
SeImpersonatePrivilege (standard for Users added to Firewall
configuration roles).

Fix Effectiveness
--------------------------------------------------------------------
The new parameter types, strict pointer sanity checks, and additional
feature gates prevent incompatible types from being dereferenced.  All
write operations now target correctly typed structures, and temporary
buffers are freed, fully removing the heap-corruption / privilege
escalation vector described above.
