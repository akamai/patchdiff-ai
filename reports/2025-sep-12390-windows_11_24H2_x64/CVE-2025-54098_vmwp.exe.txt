{'patch_store_uid': 'aa6cdbf6-89a6-44dd-b063-2bfd0d522b3b', 'cve': 'CVE-2025-54098', 'date': 1757853994.2197387, 'file': 'vmwp.exe', 'kb': 'KB5065426', 'change_count': 30, 'confidence': 0.25}
--------------------------------------------------------------------
CVE-2025-54098 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Hyper-V worker-process (vmwp.exe) – IGVM firmware loader and
virtual-machine initialisation logic.


Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Privilege-elevation via insecure file loading
(CWE-284).


Detailed Root Cause Analysis
--------------------------------------------------------------------
When a VM is configured to boot from an Isolated Guest Virtual-Machine
firmware image (IGVM), vmwp.exe calls
VirtualMachine::LoadIgvmInformationFromConfiguredFile() while still
running with full host privileges.  The original implementation made
the following mistakes:

1.  The   HCL   (Host  Client  Loader)  flag  (byte  v95)  was  trusted
    unconditionally.  If the flag was set the code dropped directly to
    the "custom" code path (label 58) and accepted a user-controlled
    firmware DLL name (vmfirmwarecvm.dll / …igvm.dll) without checking
    whether the file is shipped by Microsoft or is present on the
    system image.

2.  No build-time / SKU gating existed: even on production builds that
    never ship the so-called *OpenHCL* IGVMs the worker process tried
    to open whatever DLL path was provided through the VM’s registry
    hive.  Because vmwp runs as NT SYSTEM the attacker-supplied path
    was opened with host-level access and mapped into the address space
    (MappedFile::OpenFile → IgvmFile::IgvmFile).  This allowed a
    malicious tenant who could write to the VM configuration to load
    and execute arbitrary micro-code inside the privileged Hyper-V
    address space and to elevate to the host.

3.  The routine that selects the IGVM placement policy used the value
    HIDWORD(v77) before the structure was proven valid.  An attacker
    could force an un-initialised placement value and reach the custom
    IGVM path even when the policy had never been configured.

Because vmwp.exe opens and parses the IGVM before the partition is
created, a compromised image immediately gains the ability to tamper
with later hyper-visor initialisation and run with full ring-0
privilege on the host (Local EoP).


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before patch – always falls through to custom IGVM if v95 is set
if (!v95) { ... }
...
label_58:
  v30 = lambda_baffd...operator()(v66, v63, v22, v18, a3);
  std::optional<IgvmFile>::emplace<IgvmFile>(v89, v30);
  // user-controlled DLL already mapped here
```

```c
// patch – block OpenHCL on non-lab builds
if (v88) {
  _snwprintf_s(v94,16, L"%%%u", 2147942450);
  VmEventWriteAndReport(..., L"OpenHCL IGVM files are not present by default...");
  Throw_HrMsg(...);
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker edits the VM’s private registry (or VMCX) so that
   Config::VmWorkerProcess::HclSettings::OpenHcl == true and supplies a
   malicious DLL path.
2. vmwp.exe starts → InitializeInternal() →
   LoadIgvmInformationFromConfiguredFile().
3. Pre-patch code reaches label 58, builds a MappedFile for the path
   supplied by the attacker, parses the file as an IgvmFile and stores
   the object in the VM structure.
4. IgvmFile content is later used by Hyper-V; attacker-controlled code
   executes with host privileges.


Attack Vector
--------------------------------------------------------------------
Local, authorised tenant / management user who can modify the VM
configuration repository (VMCX / registry).  No administrator rights on
host required.


Patch Description
--------------------------------------------------------------------
• Added explicit OpenHCL/SKU gate.  On production builds the code now
  synthesises HRESULT 0x80070002 (2147942450) and aborts if an OpenHCL
  IGVM is requested.
• Added _wil_ Throw_HrMsg() so that execution stops before the file is
  opened.
• Re-structured temporary buffers and initialisation order, ensuring
  that placement-policy (HIDWORD(v70)) is initialised before use.
• All later callers updated to expect failure code 0x3147 instead of
  silently continuing.


Security Impact
--------------------------------------------------------------------
Pre-patch, a user inside the management guest or with write access to
VM configuration could coerce vmwp.exe into loading and mapping an
arbitrary DLL from the host file-system, thereby executing code as
NT SYSTEM and escaping the Hyper-V security boundary (local privilege
escalation).


Fix Effectiveness
--------------------------------------------------------------------
Blocking the OpenHCL path eliminates the only uncontrolled code-loading
route reachable by a normal tenant; the worker process now refuses to
start in such a configuration.  Added initialisation changes remove
uninitialised-field misuse.  No remaining path loads an IGVM without
first verifying that the image is part of the trusted, shipping build.
The fix is therefore judged effective.
