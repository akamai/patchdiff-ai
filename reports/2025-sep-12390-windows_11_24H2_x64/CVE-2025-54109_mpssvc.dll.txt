{'patch_store_uid': '55be8ad8-5a68-4e61-9274-e927d121c45f', 'file': 'mpssvc.dll', 'cve': 'CVE-2025-54109', 'date': 1757843450.17998, 'change_count': 45, 'kb': 'KB5065426', 'confidence': 0.38}
--------------------------------------------------------------------
CVE-2025-54109 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows – mpssvc.dll (Windows Defender Firewall service)
Functions affected:
  • FWAddressAndIPAddressIntersect
  • FwIntersectV4RangesAndLocalIPs
  • FwIntersectV6RangesAndLocalIPs
  • FwLoadBlobsRepos (collateral changes)

Vulnerability Class
--------------------------------------------------------------------
Type confusion / out-of-bounds memory access (CWE-843, side-effect is
potential out-of-bounds write/read)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The firewall service stores lists of IP address ranges in
_tag_FW_IPV4_RANGE_LIST and _tag_FW_IPV6_RANGE_LIST.  Each list has a
DWORD element count at offset 0 followed by a variable-length array of
range records (8-byte pairs for IPv4, 32-byte pairs for IPv6).

FwIntersectV{4,6}RangesAndLocalIPs() is supposed to calculate the
intersection of two range lists (a1 and a2) and write the resulting
ranges back into BOTH lists so that the caller may use either list.

Pre-patch logic:
  • The routine copied the intersected ranges into the buffer that
    belongs to the SECOND argument (a2).
  • It incremented a local output counter (v6 for IPv6, v5 for IPv4)
    while writing.
  • At function exit it only wrote this counter to *a1 (the first
    list).  The element count in *a2 was left unchanged.

Resulting state after intersection:
  a2->Count   (still original)
  a2->Ranges  (now contains fewer entries than Count advertises)

Any subsequent consumer that iterates a2 using its Count will walk past
valid memory and treat uninitialised memory as _tag_FW_*_RANGE
structures – a textbook type-confusion condition that can escalate into
out-of-bounds read or write, depending on the caller’s access pattern.
Because the objects are allocated inside privileged mpssvc and their
contents can be influenced indirectly by an unprivileged caller through
firewall RPC / WFP APIs, the flaw yields a local elevation of privilege.

Patch behaviour:
  • Introduces a second counter dedicated to the ranges written into
    a2 (v6 / v6 for IPv6, v6 for IPv4).
  • On return it updates BOTH length fields:
        *a1 = number_of_elements_in_a1;
        *a2 = number_of_elements_in_a2;   // new
  • Additional defensive rewrites protect loop indices and prevent the
    possibility of writing beyond the destination buffer.

Thus the two structures remain internally consistent and no over-run /
type confusion is possible.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// IPv6 – before (excerpt)
*(_OWORD *)(v10 + 32i64 * v6) = *v9;   // write into a2 buffer
...
*(_DWORD *)v2 = v6;                    // only a1->Count updated
```
```c
// IPv6 – after (excerpt)
*(_OWORD *)(v13 + i) = *v12;           // write into a2 buffer
...
*(_DWORD *)v2 = v4;                    // a1 count
*(_DWORD *)a2 = v6;                    // a2 count – FIXED
```
```c
// IPv4 – before (excerpt)
*(_DWORD *)(v4 + 8 * v5) = v9;         // write into a2 buffer
...
*(_DWORD *)a1 = v5;                    // only a1->Count updated
```
```c
// IPv4 – after (excerpt)
*(_DWORD *)(v4 + 8 * v6) = v10;        // write into a2 buffer
...
*(_DWORD *)a1 = v5;                    // a1 count
*(_DWORD *)a2 = v6;                    // a2 count – FIXED
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Unprivileged client supplies crafted firewall rules or address
   objects (via RPC, WMI, NetFirewall API, or WFP BFE).
2. mpssvc loads the objects (FwLoadBlobsRepos) and eventually calls
   FWAddressAndIPAddressIntersect.
3. FWAddressAndIPAddressIntersect dispatches to
   FwIntersectV4RangesAndLocalIPs and/or FwIntersectV6RangesAndLocalIPs.
4. Pre-patch, intersection corrupts the length field of list #2.
5. Later code trusts a2->Count and overruns the backing buffer,
   enabling memory corruption inside the service process.

Attack Vector
--------------------------------------------------------------------
Any local user who can create or modify firewall rules (e.g. through the
netsh advfirewall command or the Windows Filtering Platform API) can
supply maliciously-sized IPv4/IPv6 address ranges.  When the service
processes the rule set, the inconsistent length field triggers the type
confusion and memory corruption in the high-privilege mpssvc context.

Patch Description
--------------------------------------------------------------------
• Introduced dedicated destination counters so writes into the second
  range list are matched with a correct element count.
• Updated both list headers on exit.
• Added additional loop variables and flag logic to avoid stale state.
• Minor signature change in FWAddressAndIPAddressIntersect (now void)
  reflecting that no status code is returned.
• Ancillary hardening and clean-up in FwLoadBlobsRepos to remove memory
  leaks; unrelated to the core bug.

Security Impact
--------------------------------------------------------------------
Before the patch, inconsistent meta-data could lead to controlled
out-of-bounds access within the Windows Defender Firewall service,
allowing local attackers to corrupt heap structures and execute code
with service privileges (LOCAL SERVICE or, through further compromise,
SYSTEM).  Microsoft assigned CVE-2025-54109.

Fix Effectiveness
--------------------------------------------------------------------
The patched code now keeps the size fields of both range lists in sync
with the actual number of elements written.  No writes occur past the
allocated buffers, eliminating the immediate type-confusion vector.
Static inspection shows both IPv4 and IPv6 paths corrected; no legacy
callers rely on the previous return value of FWAddressAndIPAddressIntersect.
No residual pathway for mismatched size/count was observed, indicating
the fix is effective.
