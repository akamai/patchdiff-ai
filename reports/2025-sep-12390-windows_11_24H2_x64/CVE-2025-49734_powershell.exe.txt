{'cve': 'CVE-2025-49734', 'kb': 'KB5065426', 'change_count': 4, 'confidence': 0.19, 'date': 1757835035.0649962, 'file': 'powershell.exe', 'patch_store_uid': '1a748dde-bce7-4e09-9cd0-cc04adfec7a2'}
--------------------------------------------------------------------
CVE-2025-49734 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows PowerShell (powershell.exe) – command-line argument and
configuration‐string parser.  Affected routines:
 • sub_14000626C (renamed to
   NativeMsh::PwrshCommon::VerifyDOTNetVersionFormat)
 • sub_140001EE0  (renamed to ParseCommandLineArguments)
 • sub_140001410 (renamed to wmain)

Vulnerability Class
--------------------------------------------------------------------
Improper input validation / stack-based buffer overflow leading to
local privilege escalation (CWE-20, CWE-121).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Unpatched powershell.exe validates the string that represents the
required .NET / PowerShell engine version in several ad-hoc code
paths (sub_140001EE0 and wmain).  The legacy helper sub_14000626C is
supposed to vet this string, but it only checks that the last
extension equals “.psc1” and returns a boolean without touching the
caller-supplied out-parameters.

ParseCommandLineArguments and wmain therefore re-parse the same
string themselves.  They store every numeric component that appears
between dots into a fixed-length local array:

  int VersionParts[4];   // v66 in wmain

The index used for that array is cbData[0] which is incremented for
*every* successfully parsed component, yet it is never range-checked
(only a loose i<=2 loop guard is applied, but cbData[0] itself is
still used as an index).  A malicious version string containing more
than three dot-separated fields (e.g.  “9.9.9.9.9…”) therefore makes
the write

  VersionParts[cbData[0]] = wcstoul(...);

overflow the 4-element stack buffer, corrupting adjacent saved frame
state and enabling execution control inside a highly-privileged
powershell.exe instance (PowerShell Direct launches it as LOCAL
SYSTEM inside the guest).

Patch  introduces NativeMsh::PwrshCommon::VerifyDOTNetVersionFormat
and rewrites ParseCommandLineArguments/wmain so that ALL external
version strings flow through this single routine.  The new checker
safely:
  • zeros out the caller-supplied out-parameters
  • rejects empty or NULL strings
  • enforces max three ‘.’ separators
  • strips leading zeros
  • limits each numeric field to 10 digits and INT_MAX
  • verifies the wcstoul end-pointer
On any deviation it returns 0 and the caller aborts the start-up
sequence.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// old sub_14000626C – only checks for “.psc1”
bool __fastcall sub_14000626C(__int64 a1)
{
  const wchar_t *v2; // uninitialised copy of a1
  bool ok = 0;
  wchar_t *dot;
  int cmp;
  if (sub_140003730(a1,a1) ||                  // NULL / empty?
      (dot = wcsrchr(v2,'.'))==0 ||            // no dot
      (cmp = CompareStringW(0x7F,1,dot,-1,L".psc1",5))==0 ||
      (ok = (cmp==2), cmp!=2))                 // accept only “.psc1”
  {
      Log(26,a1);
  }
  return ok;                                   // out-parameters unused
}
```
```c
// new  VerifyDOTNetVersionFormat – tight format checking
bool __fastcall VerifyDOTNetVersionFormat(...,
        const unsigned __int16 *pszVer,
        unsigned int *Major,
        int *Minor)
{
   *Major = *Minor = -1;
   if (StringIsNullOrEmpty(pszVer)) return 0;
   const wchar_t *dot = wcschr(pszVer,'.');
   if (!dot) return 0;
   // strip leading zeros, max 10 digits
   ...
   *Major = wcstoul(...);
   for (int i=0;i<=2;++i) {          // at most three dots
       // repeat parsing, same length & range checks
   }
   *Minor = array[0];
   return 1;
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker launches powershell.exe (e.g. through PowerShell Direct)
   with a crafted “-version” or manipulates HKLM\…\PowerShellVersion.
2. wmain -> ParseCommandLineArguments copies the string into the
   stack array v66[4] without bounds checks (pre-patch).
3. More than four components overwrite the stack frame, allowing
   arbitrary code execution in the SYSTEM process.

Attack Vector
--------------------------------------------------------------------
Local attacker who can start PowerShell Direct or influence the
registry values read during start-up supplies an over-long version
string such as “9999999999.9999999999.9999999999.9999999999”.

Patch Description
--------------------------------------------------------------------
1. Introduced VerifyDOTNetVersionFormat() that performs strict, single
   point validation and sets out-parameters predictably.
2. ParseCommandLineArguments rewritten to call the new helper rather
   than hand-rolling the parse.
3. wmain updated accordingly; all manual loops and the fixed-size
   VersionParts buffer removed.
4. Related helper names were clarified and parameter lists fixed to
   use typed pointers instead of loosely-typed _DWORD/LPBYTE.

Security Impact
--------------------------------------------------------------------
Before the patch a non-admin user inside the guest could corrupt the
stack of the SYSTEM-owned powershell.exe process and execute code
with elevated privileges, leading to a full local elevation of
privilege.

Fix Effectiveness
--------------------------------------------------------------------
The new helper rejects every malformed input early; array writes have
been eliminated; out-of-range fields or too many components now cause
powershell.exe to abort start-up.  No uncontrolled write remains,
removing the exploitation primitive.
