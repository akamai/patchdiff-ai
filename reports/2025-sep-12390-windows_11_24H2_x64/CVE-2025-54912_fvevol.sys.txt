{'kb': 'KB5065426', 'patch_store_uid': '090f9405-7989-4bcd-ac06-e37b6069c85a', 'date': 1757854007.7322445, 'confidence': 0.18, 'cve': 'CVE-2025-54912', 'change_count': 32, 'file': 'fvevol.sys'}
--------------------------------------------------------------------
CVE-2025-54912 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows BitLocker driver (fvevol.sys).
All changed functions belong to the sub-request control path that
creates, schedules and completes encrypted read/write requests.


Vulnerability Class
--------------------------------------------------------------------
Race-condition Use-after-free (CWE-416) caused by unsynchronised
bit-field updates inside a shared control structure.


Detailed Root Cause Analysis
--------------------------------------------------------------------
Each encryption sub-request is described by a 0x120-byte
FVE_SUBREQUEST_CONTROL structure referenced by many worker and
completion routines (WriteEncrypt, ReadDecrypt, Ice paths, etc.).

Offset 0x110-0x11F of this structure previously contained a single
8-bit flag field (Flags byte @+272).  Different bits inside this byte
were reused for unrelated purposes:
  bit0 (0x01)   : completion marker
  bit1 (0x02)   : paging   request
  bit2 (0x04)   : Ice      request
  bit3 (0x08)   : status   merged-once guard
  bit4 (0x10)   : redirected range present
  ...
Most of those bits were modified by independent code paths while the
byte was updated with read-modify-write sequences that were only partly
protected by spin locks.  Two examples:
  • FveIoCryptoWorkSchedule set bit2 (Ice) under one lock.
  • MergeStatusIntoControl set bit3 (merged) under a different lock and
    cleared bit2&bit1 by re-writing the whole byte.

Because the whole byte was OR/AND-ed, one thread could silently drop
bits written by another thread.  If bit2 (Ice tag) was cleared after
the IRP extension had been allocated, later clean-up executed the ICE
free path while other threads were still using the extension.  This
results in a classic use-after-free on the per-IRP ICE extension
object, allowing a local attacker with the ability to trigger many I/O
requests to execute code with kernel privileges.

Corruption becomes observable inside
    FvePerIoCryptoThrottleStart
    WriteCompletionRoutine / ReadCompletionRoutine
when the freed work-item or spin-lock is accessed.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// old                       // patched
BYTE Flags = *(BYTE*)(ctrl+272);   BYTE isIce     = *(BYTE*)(ctrl+274);
Flags |= 8;                        BYTE mergedSet = *(BYTE*)(ctrl+275);
*(BYTE*)(ctrl+272) = Flags;        /* independent bytes, no bit-ops */
```
```c
if (!*(_BYTE *)(v10 + 272) & 4)      // old test
    ...

if (*(BYTE*)(v10+274))              // new test
    ...
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User space issues heavy, overlapped writes to a BitLocker volume.
2. FveTryInlineWriteEncrypt / WriteEncrypt builds several sub-requests.
3. FveIoCryptoWorkSchedule sets bit2 (Ice) in Flags.
4. Almost concurrently MergeStatusIntoControl sets bit3 (merged) and
   unintentionally clears bit2 due to byte-wide update.
5. Worker path believes request is NOT Ice, frees ICE extension while
   it is still referenced → dereference of freed object → EoP.


Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker triggers a high volume of overlapping
I/O on a BitLocker protected volume to create the racing conditions.
No admin rights are required; SYSTEM privileges are gained after the
use-after-free is exploited.


Patch Description
--------------------------------------------------------------------
Microsoft split the overloaded Flags byte into three independent
bytes:
  offset +273 : PagingRequest
  offset +274 : IsIceRequest
  offset +275 : StatusMergedOnce

All code paths were updated to access those dedicated bytes instead of
bit-operations on the original Flags field.  The byte at +272 is now
used only for immutable device properties.
Additionally, MergeStatusIntoControl was rewritten to avoid clearing
other state fields, and every previous "&4" / "|4" test was replaced
with a direct read of byte +274.


Security Impact
--------------------------------------------------------------------
The race allowed kernel-memory use-after-free that can be converted
into arbitrary kernel code execution.  Successful exploitation yields
local elevation of privilege (SYSTEM) and full machine compromise.


Fix Effectiveness
--------------------------------------------------------------------
After the patch each logical flag is stored in its own byte and is no
longer subject to lossy read-modify-write sequences.  Inter-thread
interference is therefore removed and the freed ICE extension can no
longer be double-freed or accessed after release, effectively fixing
CVE-2025-54912.
