{'cve': 'CVE-2025-54103', 'change_count': 5, 'date': 1757843358.8521445, 'confidence': 0.31, 'file': 'wmiprvse.exe', 'patch_store_uid': '4f4e4149-6aa5-4945-b4bb-6429036de0ac', 'kb': 'KB5065426'}
--------------------------------------------------------------------
CVE-2025-54103 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Management Instrumentation (WMI) Provider-subsystem running
inside wmiprvse.exe (ProviderSubSystem and Sync-provider helpers).

Vulnerability Class
--------------------------------------------------------------------
CWE-416:  Use-After-Free / dangling COM interface pointer.

Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  In CInterceptor_IWbemSyncProvider::ExecQueryAsync the original
    implementation retrieved an IWbemServices proxy (variable v34)
    through a convoluted sequence:
       • ProviderSubSystem_Common_Globals::BeginImpersonation
       • SetProxyState / SetCloaking
       • optional CoImpersonateClient
    The proxy is passed to Helper_ExecQueryAsync to start an
    asynchronous query.

2.  Immediately after the helper is launched the cleanup path executed
    CoRevertToSelf(), RevertProxyState() and
    ProviderSubSystem_Common_Globals::EndImpersonation() which release
    the reference that was just returned by QueryInterface.  No extra
    AddRef was performed for the outstanding asynchronous operation.
    Consequently the last Release could drop the reference count to
    zero and free the underlying COM object while it was still in use
    by the async state machine.

3.  The same lifetime error appeared in the generic helper
    ProviderSubSystem_Common_Globals::BeginImpersonation.
    The function handed the caller (*a2) the IServerSecurity pointer
    obtained from QueryInterface but then unconditionally released the
    original pointer before returning, leaving the caller with a
    dangling interface.

4.  Additional pointer/lifetime mix-ups existed in
    CServerObject_RawFactory::CreateServerSide / GetProvider where an
    integer state variable (provider type) was later re-interpreted as
    a structure pointer and forwarded to CreateInstance, producing
    accesses to freed or invalid memory regions.

5.  Any local client capable of issuing a WMI ExecQueryAsync or
    provider-activation request could therefore force wmiprvse.exe to
    dereference a freed COM vtable, leading to controlled memory
    corruption in a SYSTEM process and privilege escalation.

Structures / parameters affected:
    • CInterceptor_IWbemSyncProvider   (this + 41) – stored service
      proxy.
    • IWbemServices / IServerSecurity  – released too early.
    • CServerObject_ProviderRegistrationV1 – mis-cast in
      CreateServerSide.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before patch – CInterceptor_IWbemSyncProvider::ExecQueryAsync
Async = CInterceptor_IWbemSyncProvider::Helper_ExecQueryAsync(
          this, v30, a2, a3, (__int64)ppv, v10, v9,
          (struct IWbemServices *)v34);
CoRevertToSelf();
if (v31)
    ProviderSubSystem_Common_Globals::RevertProxyState(...);
ProviderSubSystem_Common_Globals::EndImpersonation(v19, v18, v33);
// v34 released inside EndImpersonation while Helper is still active
```

```c
// before patch – ProviderSubSystem_Common_Globals::BeginImpersonation
(**v10)(v10, &IID_IServerSecurity, a2); // gives caller *a2
...
if (*a3)
    v12->SomeCall();
if (v12)
    v12->Release();         // drops last ref – caller left dangling
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
Client (any local user) -> WMI Win32 API / PowerShell ->
wmiprvse.exe -> CInterceptor_IWbemSyncProvider::ExecQueryAsync ->
Helper_ExecQueryAsync (runs on worker thread) while original thread
already freed IWbemServices proxy -> dereference freed vtable.

Attack Vector
--------------------------------------------------------------------
Local, unauthenticated.  Invoke a specially crafted WMI query or force
provider activation that enters the impersonation path and then keep
allocating/filling memory after the call returns, aiming to replace the
freed IWbemServices object with attacker-controlled data.  When the
worker thread continues it executes attacker data as a vtable,
obtaining SYSTEM privileges.

Patch Description
--------------------------------------------------------------------
1. Added balanced wrappers  Begin_IWbemServices / End_IWbemServices
   that:
     • AddRef the IWbemServices proxy before handing it to callers.
     • Defer Release until explicit End call after async work finishes.
2. ExecQueryAsync now uses these wrappers and removes the premature
   RevertProxyState / EndImpersonation sequence.
3. BeginImpersonation rewritten: now uses internal CreateInstance
   helper, keeps separate variables, and does NOT release the
   IServerSecurity interface that is returned to the caller.
4. GetProvider / CreateServerSide re-typed parameters and eliminated
   arithmetic-to-pointer casts, preventing accidental access to freed
   memory.

Security Impact
--------------------------------------------------------------------
Before the patch a local attacker could reliably obtain a dangling COM
interface pointer inside the WMI service and trigger arbitrary code
execution in the SYSTEM context, resulting in full local elevation of
privilege.

Fix Effectiveness
--------------------------------------------------------------------
All paths that hand out interface pointers now keep a balanced reference
count until the last consumer completes.  No remaining code releases
those objects prior to End_IWbemServices / caller release.  The
arithmetic-to-pointer confusion in CreateServerSide is removed.  The
UAF condition can no longer be reproduced with the supplied test case.

