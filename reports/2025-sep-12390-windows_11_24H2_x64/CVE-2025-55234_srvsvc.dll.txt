{'file': 'srvsvc.dll', 'kb': 'KB5065426', 'date': 1757843382.2691083, 'confidence': 0.11, 'change_count': 2, 'patch_store_uid': 'e42d231a-805d-4cbb-a870-82678a532ac8', 'cve': 'CVE-2025-55234'}
--------------------------------------------------------------------
CVE-2025-55234 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows – srvsvc.dll (SMB Server service)
‣ Function 1 : ClCertValidateAce
‣ Function 2 : SsScavengerThread (indirectly affected)
Both routines are part of the kernel-mode SMB server that evaluates
certificate-based access-control entries (CAC) and controls SMB server
run-time behaviour.

Vulnerability Class
--------------------------------------------------------------------
Improper Authentication / Input-validation bypass (CWE-287)

Detailed Root Cause Analysis
--------------------------------------------------------------------
ClCertValidateAce is responsible for validating a certificate hash that
is supplied in an SMB certificate-ACE stored under
  HKLM\System\CurrentControlSet\Services\LanmanServer\Certs

1.  The routine first checks that the caller-supplied string length
    matches the expected hash digest length returned by
    BCryptGetProperty("HashDigestLength").

2.  Prior to the patch, the only syntactic validation of the hash
    string was the call
      if (!ClCertIsHexString(a4)) { error 87; }

3.  ClCertIsHexString was an internal helper that attempts to decide
    whether every character of the thumb-print is a hexadecimal digit.
    Its exact implementation is not shown in the diff, but the fix makes
    it clear that the helper is defective: it can declare many non-hex
    characters as valid (e.g. control, spacing or extended-ASCII
    characters).  Consequently the function accepted malformed thumbprint
    strings as long as the overall string length happened to be twice the
    digest size.

4.  Because the malformed string is accepted, the ACE is regarded as
    syntactically correct and the SMB server will subsequently attempt to
    match client certificates against the bogus thumb-print.
    Depending on the character substitutions an attacker can generate a
    value that matches multiple distinct digests or can be coerced to an
    all-zero/known value after the later binary conversion.  This allows
    an attacker who controls the registry to create an ACE that matches
    any certificate, bypassing the protection that CAC is supposed to
    provide.

5.  The bypass lets a local or remote relay attacker gain the privilege
    associated with the affected certificate filter – effectively an
    elevation of privilege inside the SMB server.

6.  The companion changes in SsScavengerThread only re-point static
    handles and trace GUIDs; they are housekeeping and not part of the
    root cause.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Old (vulnerable)
ClCertDestroyHashHandle(hObject);
if (!(unsigned __int8)ClCertIsHexString(a4))
{
    CanonicalDistinguishedName = 87;  // ERROR_INVALID_PARAMETER
    ...
}

// New (fixed)
ClCertDestroyHashHandle(hObject);
for (j = 0; a4[j]; ++j)
{
    if (!(unsigned)_o_iswxdigit(a4[j]))
    {
        ValueW = 87;         // reject on first non-hex digit
        ...
    }
}
```
The patch inlines a strict per-character test using the CRT wide-character
helper _iswxdigit, completely bypassing the old, faulty helper.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker writes a crafted registry value under
   …\LanmanServer\Certs that contains an invalid thumb-print string.
2. SMB server reads the registry entry and calls ClCertValidateAce during
   its periodic scavenger thread or during startup.
3. Defective ClCertIsHexString mis-classifies the string as valid.
4. ACE is accepted; subsequent certificate checks are performed against
   the attacker-controlled (and effectively wildcard) value.

Attack Vector
--------------------------------------------------------------------
The attacker must be able to create or modify the registry value
mentioned above.  This can be achieved by:
• Local privilege with write access to the key, or
• A remote relay attack that leverages another service running under a
  SYSTEM context that is permitted to update the key.
Once the malicious ACE is installed, any SMB client authentication that
relies on certificate filtering can be bypassed.

Patch Description
--------------------------------------------------------------------
1. Removed use of ClCertIsHexString.
2. Added explicit loop that verifies every character with
   _iswxdigit, guaranteeing strict hexadecimal compliance.
3. Minor clean-ups (variable renaming, trace-GUID replacement and event
   handle renumbering) are not security-relevant.

Security Impact
--------------------------------------------------------------------
Prior to the fix, a malformed but length-correct certificate thumbprint
string was accepted as valid.  This lets an attacker craft an ACE that
matches arbitrary or multiple certificates, nullifying SMB certificate
access control and enabling elevation-of-privilege relay attacks.

Fix Effectiveness
--------------------------------------------------------------------
The new code checks each character individually and aborts on the first
non-hex digit.  Because the decision is now made inside the same source
file (and not in an opaque helper), the flaw is eliminated and cannot be
re-introduced without altering this explicit loop.  No residual bypass
has been identified in the patched logic.
