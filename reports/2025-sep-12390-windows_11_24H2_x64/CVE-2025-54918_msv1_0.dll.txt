{'cve': 'CVE-2025-54918', 'change_count': 49, 'file': 'msv1_0.dll', 'patch_store_uid': '3c97029c-c2b8-4d7a-8ac7-639ad928acdb', 'confidence': 0.21, 'date': 1757853977.2752466, 'kb': 'KB5065426'}
--------------------------------------------------------------------
CVE-2025-54918 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows NTLM authentication package (msv1_0.dll – NTLM SSP).  The 
following routines are directly involved:
 • SsprMICHandshakeMessagesNew (replaces legacy CngRsa32Compat_MD5*  
   helpers)
 • NlpDecryptCacheEntry
 • SspSignSealHelper
 • SsprMakeSessionKey
 • LsaApLogonUserEx2
All belong to the authentication logic executed in LSASS on the
server-side as well as inside the client SSP.

Vulnerability Class
--------------------------------------------------------------------
Improper Authentication / weak cryptography (CWE-287, CWE-327).  The
original implementation relied on single-round MD5 and RC4 to build
or verify NTLM MICs, session keys and cached-credential HMACs.  Those
algorithms are no longer considered collision- or tamper-resistant and
can be forged by a network attacker that already possesses a valid
account.

Detailed Root Cause Analysis
--------------------------------------------------------------------
1. MIC / handshake hash
   Old code:
     CngRsa32Compat_MD5Init/Update/Final were fed by several NTLM
     messages and finally CngRsa32Compat_MD5Final returned the 16-byte
     MD5.  Nothing prevented an attacker from creating second
     pre-images – a well-known property of MD5 – so the MIC could be
     forged.

   Patch:
     New helper SsprMICHandshakeMessagesNew creates a *fresh* BCRYPT
     hash handle (ALG 0x91) every time and re-computes the digest over
     three explicit buffers that the caller passes (challenge,
     negotiate flags, channel-binding).  The handle is destroyed right
     afterwards, removing any attacker-controlled state.

2. Cached-credential decryption (NlpDecryptCacheEntry)
   Old path used RC4 and MD5-HMAC via the CngRsa32Compat stubs.
   Because RC4 is a stream cipher without integrity protection an
   offline attacker that reads NL$KM could tamper with the encrypted
   blob and then recompute the MD5 to keep the check value intact –
   LSASS would happily accept the modified cache entry.

   Patch introduces:
     • Optional feature switch 609789243 that replaces RC4 with AES-CBC
       (BCryptEncrypt/GenerateSymmetricKey).
     • Hash integrity moved from custom HMAC-MD5 to BCrypt SHA-256
       (same ALG 0x91) together with explicit length checks and zero
       clearing of secrets.

3. Message signing / sealing (SspSignSealHelper)
   The helper originally relied on RC4-KDF + CRC32 for integrity.  A
   forged CRC is trivial.  The new version, when the same feature flag
   is enabled, derives a keyed SHA-256 hash and uses AES or duplicated
   CNG keys; many fast-fail branches were replaced by proper NTSTATUS
   propagation.

4. Session-key creation (SsprMakeSessionKey)
   Legacy code directly inserted the 16-byte random challenge into the
   context; when NTLM2-session was negotiated the key was only RC4
   protected.  The patch generates an explicit symmetric AES key and
   encrypts the session key before it leaves kernel space.

5. Main logon routine (LsaApLogonUserEx2)
   Large patch but two relevant changes:
   • new call sites switched to the hardened helpers above; no MD5
     helper remains.
   • additional audit / telemetry but no functional change.

In short, every place where MD5/RC4 was still used to build or verify
an NTLM protection checksum is now replaced by SHA-256/AES through the
BCrypt API.  Because the old primitives are breakable, an attacker
could manufacture a handshake or cached entry that passes all
verifications and is accepted as authentic.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// old – MD5 on caller-supplied state
CngRsa32Compat_MD5Final(phHash);   // returns 16-byte digest

// new – re-compute inside function, caller cannot inject state
BCryptCreateHash(0x91, &hHash, 0,0,a1,0x10,0);
BCryptHashData(hHash, a3, a2, 0);
BCryptHashData(hHash, pbInput, a4,0);
BCryptHashData(hHash, a7, cbInput,0);
BCryptFinishHash(hHash, pbOutput, 0x10,0);
```
```c
// old – RC4 + HMAC-MD5 integrity (truncated)
CngRsa32Compat_rc4_key(&hKey);
CngRsa32Compat_rc4(&hKey, len, buf);
CngRsa32Compat_HMACMD5Final(&phHash, tag);

// new – AES + SHA-256 (behind feature flag)
BCryptGenerateSymmetricKey(0x71,&phKey,0,0,secret,0x10,0);
BCryptEncrypt(phKey, buf, len, NULL, NULL,0, buf,len,&cbOut,0);
BCryptCreateHash(0x91,&phHash,0,0,secret,0x10,0);
BCryptFinishHash(phHash, tag, 0x10,0);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Victim host accepts NTLM authentication.
2. Attacker crafts MD5-collision (or RC4 stream flip) so that
   a) MIC handshake in SsprMICHandshakeMessages validates, or
   b) Cached NL$ entries hash correctly, or
   c) CRC32 in SspSignSealHelper matches.
3. LSASS calls the old helper – returns success.
4. Logon is accepted and a token for the supplied LogonId is created.
5. Attacker now operates with elevated privileges (typically
   authenticated as the spoofed user or SYSTEM in a relay).

Attack Vector
--------------------------------------------------------------------
• Remote: Any protocol that supports NTLM (SMB, RPC, HTTP, etc.).
• Local: Tampering with %SYSTEMROOT%\System32\config\SECURITY cache to
  inject a forged NL$ entry.
In all scenarios the attacker must already possess *some* valid NTLM
credentials but can elevate or impersonate a different account by
bypassing integrity checks.

Patch Description
--------------------------------------------------------------------
1. Removed every call to legacy CngRsa32Compat_* MD5 / RC4 helpers.
2. Introduced SsprMICHandshakeMessagesNew that recomputes the MIC with
   a fresh BCrypt hash per call.
3. Re-implemented NlpDecryptCacheEntry, SspSignSealHelper and
   SsprMakeSessionKey to use BCrypt SHA-256 and AES (handles 0x91 /
   0x71) while preserving a fallback behind Feature_609789243.
4. Added extensive NTSTATUS propagation, WPP traces and zero-clearing
   of key material.
5. LsaApLogonUserEx2 updated to call the hardened helpers and to clear
   secrets after use.

Security Impact
--------------------------------------------------------------------
Before the patch an attacker could produce MD5 collisions or exploit
RC4 bit-flipping to spoof the MIC, cached credentials, or NTLM
sign/seal tags, allowing privilege escalation across the network or
from cached logon data.  After replacing the weak primitives with
modern, collision-resistant ones, forging those values is no longer
feasible, blocking the Elevation-of-Privilege vector.

Fix Effectiveness
--------------------------------------------------------------------
The old helpers are gone; every affected path now contains:
 • A fresh BCrypt* call chain (hash or AES) – state cannot be injected.
 • Strict status checking – any failure bubbles up.
 • Secret buffers are wiped and handles destroyed.
Because the vulnerable MD5/RC4 code is completely bypassed the issue
is effectively remediated. No regression paths that still reach the
legacy helpers were found in the patched binary.
