{'change_count': 7, 'confidence': 0.22, 'date': 1755086690.4374554, 'cve': 'CVE-2025-50173', 'patch_store_uid': '7e78f5de-adbb-43a3-90f6-d9a32e18bcd3', 'file': 'msi.dll', 'kb': 'KB5063878'}
--------------------------------------------------------------------
CVE-2025-50173 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows – msi.dll (Windows Installer)
Function: ElevatedCredentialsPromptRequired()

Vulnerability Class
--------------------------------------------------------------------
Logical privilege-escalation / weak authentication (CWE-1390)

Detailed Root Cause Analysis
--------------------------------------------------------------------
ElevatedCredentialsPromptRequired() determines whether Windows
Installer should display a UAC credential prompt before continuing an
operation that ultimately executes with SYSTEM privileges.  The
routine evaluates many policy and package flags and returns:
  0  – no prompt needed
  1  – credentials already supplied
  2  – prompt later (deferred)
 -1  – prompt required now

Before the patch, the decision tree contained a flaw in the branch that
handles a silent installation UI level (iuiEnum == 3, a4 == 3).  When
all of the following were true:
 • non-admin user (IsAdmin() == FALSE)
 • installation is silent (a4 == 3)
 • repair/uninstall is requested (a6 && a7)
 • product is in “deployment-compliant” state 3 (a10 == 3)
 • product is not group-policy managed ((a9 & 0x100000) == 0)
 • no additional elevation-compat policy is enabled

the function fell through to LABEL_54/LABEL_60 and finally returned 0
or 1, signalling that **no credentials were necessary**.  Control then
passed to msiexec.exe running as SYSTEM, giving the interactive user a
local privilege-escalation path: by triggering a silent repair of a
suitable MSI package the user executed arbitrary installer custom
actions at SYSTEM integrity without ever authenticating.

The missing test was whether the product’s current *deployment
compliance state* actually allows “no-prompt” repair when running
silently.  State 3 ("repair needed") must be blocked but was ignored.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE (simplified)
if (a4 == 3) {
    if (!a6 || !a7 || (a12 & 0x200) || a10 != 2 || IsEnableCompatPolicyValue())
    {
        // Silent install – incorrectly concludes prompt impossible
        return 0;                     // <== vulnerable
    }
    // Only deployment state 2 checked – state 3 not handled
}

// AFTER
if (a4 == 3) {
    if (Feature_2578215227_IsEnabled()) {
        if (a6 && a7 && !(a12 & 0x200) &&
            (a10 == 2 || (a10 == 3 && !(a9 & 0x100000) && !a11)) &&
            !IsEnableCompatPolicyValue()) {
            // Force credential prompt later; execution blocked now
            v18 = 2;                  // prompt later
        } else {
            // silent install still disallowed without credentials
            return 0;
        }
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privilege user launches msiexec /quiet REPAIR=<product>.
2. Windows Installer calls ElevatedCredentialsPromptRequired().
3. Pre-patch logic returns 0 (no prompt) for deployment state 3.
4. Service proceeds to execute repair actions as SYSTEM.
5. Custom action code supplied by attacker runs with full privilege.

Attack Vector
--------------------------------------------------------------------
Local – the authenticated user supplies a specially crafted or existing
MSI product in deployment-compliant state 3, invokes a silent repair or
uninstall, and gains SYSTEM privileges without UAC authentication.

Patch Description
--------------------------------------------------------------------
1. Added a WIL feature gate (Feature_2578215227) so the hardened path
   can be enabled via servicing without functional regression.
2. Introduced extra variable (v25) and extended IsEnableCompatPolicyValue()
   calls to include rcx.
3. For silent UI level (a4 == 3) the code now explicitly checks:
   • a10 == 3 (deployment compliance repair/uninstall)
   • group policy management flag and explicit elevation-allowed flag
   • elevation compatibility policy
   If conditions match, the function returns 2 (prompt later) instead of
   0, guaranteeing that a credential prompt will occur.
4. Similar tightened checks were added for the non-silent path where
   a6 && a7.
5. Old debug labels re-numbered; temporary objects now v32 instead of
   v31 to match new stack layout.

Security Impact
--------------------------------------------------------------------
Before the fix any non-admin user could obtain SYSTEM privileges by
silently repairing or uninstalling a deployment-compliant product.
After the patch, the same operation forces a credential prompt or is
blocked, eliminating the privilege-escalation path.

Fix Effectiveness
--------------------------------------------------------------------
The added conditional blocks ensure that all silent repair/uninstall
operations in deployment compliance state 3 (and related cases) pass
through a credential prompt path.  No paths that previously returned 0
(now labeled LABEL_54/LABEL_93) satisfy the vulnerable condition.  The
feature flag allows controlled rollout but, when enabled, fully closes
the privilege gap discovered in CVE-2025-50173.
