{'file': 'explorer.exe', 'cve': 'CVE-2025-50154', 'patch_store_uid': '3c0b3495-0f83-43fc-81ff-4c4fa9ed8024', 'confidence': 0.14, 'change_count': 112, 'date': 1755086651.0510354, 'kb': 'KB5063878'}
--------------------------------------------------------------------
CVE-2025-50154 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Explorer (explorer.exe) – CTray system-tray implementation,
function CTray::UpdateTrayAndDesktopCloaking.

Vulnerability Class
--------------------------------------------------------------------
Logic flaw / state-management error leading to information disclosure
(CWE-200 – Exposure of Sensitive Information to an Unauthorized
Actor).

Detailed Root Cause Analysis
--------------------------------------------------------------------
When a game enters "Gaming Full-Screen Experience" the shell is
supposed to cloak (DWMWA_CLOAK = 0x0D) every taskbar / notification
area window so they are no longer visible or capturable.  The routine
responsible for this is CTray::UpdateTrayAndDesktopCloaking().

Prior to the patch the function only applied the cloaking attribute to
three windows:
  1.  The primary taskbar window (v_hwndTray)
  2.  The desktop window (v_hwndDesktop)
  3.  No other taskbar host windows were considered.

On multi-monitor systems each additional monitor owns its own taskbar
host object.  Those HWNDs are held in a dynamic pointer array (HDPA)
referenced from CTray at offset *(this + 0x100) (32nd qword).  Because
UpdateTrayAndDesktopCloaking() never iterated over that list, every
secondary taskbar remained uncloaked.

If a game shared its full-screen surface (game streaming, RDP, Remote
Assistance, Miracast, etc.) the supposedly hidden secondary taskbars
were still rendered and therefore could be captured remotely.  The
unintended rendering exposed live notification icons, clock, Start
button, and application titles, giving an attacker visual (and thus
spoofable) information that the user expected to be hidden.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable version
pvAttribute = v2;
if (!v_hwndTray == 0 &&
    CTray::IsTrayCloaked(v3) != (v2 != 0))
{
    DwmSetWindowAttribute(v_hwndTray, 0xD, &pvAttribute, 4);
    *((BYTE*)this + 928) = 1;          // flag updated
}
...
if (v_hwndDesktop)
    DwmSetWindowAttribute(v_hwndDesktop, 0xD, &pvAttribute, 4);
```

```c
// fixed version (excerpt)
v4 = (int *)*((_QWORD *)this + 32);   // HDPA of host HWNDs
if (v4)
{
    v5 = *v4;
    while (v5--)
    {
        Ptr = (HWND *)DPA_GetPtr(*((HDPA *)this + 32), v5);
        if (Ptr && *((DWORD*)Ptr + 9))      // valid host HWND
            DwmSetWindowAttribute(*Ptr, 0xD, &pvAttribute, 4);
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User starts or switches to a title that enables Gaming Full-Screen
   Experience.
2. Explorer receives the state change and calls
   CTray::UpdateTrayAndDesktopCloaking().
3. Vulnerable build only cloaks v_hwndTray and the desktop, leaving any
   secondary taskbar HWNDs visible.
4. Remote-capture, screenshot, or spoofing code obtains the pixels of
   those windows, exposing UI information the user believes to be
   hidden.

Attack Vector
--------------------------------------------------------------------
Any remote or local actor able to capture the user’s screen (RDP,
Remote Assistance, game streaming, desktop sharing, or even a local
malicious process using the Graphics Capture API) while the user is in
full-screen gaming mode on a multi-monitor setup can obtain the leaked
UI data and craft spoofed overlays.

Patch Description
--------------------------------------------------------------------
The patch enumerates every taskbar host HWND stored in the per-tray
HDPA and applies the DWMWA_CLOAK attribute to each valid entry.  The
logic now honours Gaming Full-Screen state consistently across all
monitors, preventing residual visible taskbars.  Minor refactoring also
removed a stale variable alias but the functional fix is the new
iteration over the HDPA.

Security Impact
--------------------------------------------------------------------
Before the fix, secondary taskbars were still rendered when the system
believed they were cloaked, leaking current time, application names,
notification icons, and allowing attackers to present spoofed UI.  This
constituted an information disclosure and spoofing risk, rated by
Microsoft as CVE-2025-50154.

Fix Effectiveness
--------------------------------------------------------------------
The added enumeration covers every existing host HWND at the time of
the call, effectively cloaking all taskbars.  Provided future taskbar
hosts call UpdateTrayAndDesktopCloaking() after creation (the current
behaviour), the issue is resolved.  No residual pointers or NULL checks
appear to be missing, so the patch is considered complete.
