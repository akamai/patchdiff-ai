{'cve': 'CVE-2025-48807', 'change_count': 4, 'file': 'vmwp.exe', 'date': 1755075750.2084484, 'patch_store_uid': '8aafed3b-809e-47fe-b58d-87ad406ad8af', 'confidence': 0.27, 'kb': 'KB5062553'}
--------------------------------------------------------------------
CVE-2025-48807 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Hyper-V worker process (vmwp.exe).  Vulnerable code resides in
WIL templated helpers that gate feature-usage telemetry:
  * wil::details::FeatureImpl<__WilFeatureTraits_Feature_TestConfNum>
    ::GetCurrentFeatureEnabledState()
  * wil::details::FeatureImpl<__WilFeatureTraits_Feature_ImplVal>
    ::GetCurrentFeatureEnabledState()
  * wil::details::FeatureImpl<__WilFeatureTraits_Feature_TestValidate>
    ::ReportUsage()

Vulnerability Class
--------------------------------------------------------------------
CWE-923: Improper Restriction of Communication Channel to Intended
Endpoints (lack of parameter / state validation within an RPC-style
telemetry channel).

Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  Feature state helpers build a 32-bit flag word (bit-field in *a2)
    that is later consumed by the ReportUsage path.  Two bits are
    important:
       0x400 – “opt-in”
       0x800 – “device”

2.  In the pre-patch logic of
    Feature_TestConfNum::GetCurrentFeatureEnabledState() a temporary
    variable (v12) is set only when either
        (state & 0xC00) == 0xC00
    otherwise it is zero unless bit 0x40 is also set.  If v12 is true
    and the secondary gate (__private_IsEnabled on
    Feature_TestValidate) returns false, bit 0x400 is _cleared_.  This
    was intended to prevent un-validated traffic – yet the value could
    be re-enabled later when execution returned to the caller because
    *a2 is still writable.  A race or crafted call chain therefore
    allowed a forbidden 0x400 request to slip through without the
    Validation feature actually being enabled.

3.  The ultimate sink is
        Feature_TestValidate::ReportUsage(unsigned int *state,
                                          unsigned __int8 kind)
    implemented as:
        ReportUsageToService(..., kind, 0);
    The caller supplied ‘kind’ (ReportingKind) is forwarded _unchecked_
    into ReportUsageToService – an ALPC/ETW style channel handled by a
    privileged Hyper-V service.  Pre-patch, **any** byte value that
    reached this point was accepted; the service interprets the field
    as a mode/flags word.  Crafted, out-of-range values steer the
    service into code paths that ultimately dereference attacker-
    controlled data, yielding code execution in the vmwp.exe context
    (and therefore in the host partition).

4.  The second GetCurrentFeatureEnabledState variant
    (Feature_ImplVal) suffers from the same missing-validation pattern
    and additionally corrupts the feature gate by mixing up traits
    (changes from TestGateImp to Servicing_CFONTPrintLeak in the
    patch), further widening the surface.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before – user-supplied 'a2' forwarded verbatim
__int64 ReportUsage(unsigned int *a1, unsigned __int8 a2)
{
    ...
    v4 = a2;                     // no range check
    ...
    return ReportUsageToService(a1 + 2, 50565209i64,
                                (v2>>10)&1, (v2>>11)&1,
                                &v7, v4, 0);
}

// before – validation bypass via v12 race
if (v12 && !v10)
    *(_DWORD *)a2 &= ~0x400u;    // later writable again by caller
```
```c
// after – parameter removed, constant reporting kind (1) used
__int64 ReportUsage(unsigned int *a1)
{
    ...
    v6 = 3;                      // fixed option flags
    v5 = 0;
    return ReportUsageToService(a1 + 2, 50565209i64,
                                (v1>>10)&1, (v1>>11)&1,
                                &v5, 1, 0);  // hard-coded, safe
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker influences vmwp (e.g., via synthetic device or VMBus
   message) so that feature state bits 0x400/0x800 are set.
2. vmwp calls Feature_*::GetCurrentFeatureEnabledState().
3. Pre-patch gate mis-computes v12; 0x400 survives even when
   validation feature is disabled.
4. Caller proceeds to Feature_TestValidate::ReportUsage() passing an
   arbitrary ReportingKind byte.
5. ReportUsageToService receives the forged request and follows a
   privileged code path that ends with attacker-controlled execution
   inside the Hyper-V worker process (host RCE).

Attack Vector
--------------------------------------------------------------------
Any VM user with the ability to trigger Hyper-V management operations
(can be done from guest ring-0 via VMBus) can force vmwp.exe to emit a
feature-usage report.  By manipulating feature state bits and abusing
the unchecked ReportingKind parameter the attacker opens an
unauthenticated channel to the host service and hijacks execution.
No additional privileges on the host are required.

Patch Description
--------------------------------------------------------------------
1. GetCurrentFeatureEnabledState():
   * Consolidates the branch condition and removes the v12 path;
     therefore the 0x400 bit cannot re-appear once cleared.
   * Replaces the dynamic gate (__private_IsEnabled) with a direct
     ReportUsage() call, removing the timing/race window.

2. ReportUsage():
   * Deletes the external ‘kind’ argument; the helper now takes **no
     caller-controlled parameters**.
   * Hard-codes ReportingKind = 1 and option flags = 3.
   * Updates GetCachedFeatureEnabledState call to the correct trait
     identifier.

Security Impact
--------------------------------------------------------------------
Before the patch, an authorised but untrusted guest could obtain code
execution in the Hyper-V worker process, breaching the isolation
boundary between guest and host (remote code execution / LPE).  The
issue maps to CVE-2025-48807, rated Remote Code Execution, Hyper-V.

Fix Effectiveness
--------------------------------------------------------------------
Code inspection confirms that the only external input (ReportingKind)
can no longer be influenced; the call chain that allowed the 0x400
bypass has been removed.  With static values and tightened branching
logic the communication channel is now restricted to the intended
protocol, eliminating the exploit vector.
