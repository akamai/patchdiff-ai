{'file': 'win32k.sys', 'kb': 'KB5063878', 'confidence': 0.16, 'change_count': 4, 'cve': 'CVE-2025-50161', 'date': 1755089600.5582707, 'patch_store_uid': '6bf219c7-e158-4eeb-925e-32c7e52da820'}
--------------------------------------------------------------------
CVE-2025-50161 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
win32k.sys  (kernel-mode graphics subsystem)
API-set redirection helpers:
  • ApiSetResolveToHost
  • ApiSetpResolveHost (formerly ApiSetResolveToHost_V7)
  • ApiSetpGetContractKeyInfo
  • ApiSetpSearchForSectionIndex_V7

Vulnerability Class
--------------------------------------------------------------------
Heap-based buffer overflow / out-of-bounds read-write caused by
integer-truncation and wrong structure-offset calculations
(CWE-122)

Detailed Root Cause Analysis
--------------------------------------------------------------------
ApiSetpSearchForSectionIndex_V7 performs a binary search in a table of
section descriptors that is part of an ApiSet schema V7 block.  Prior
to the patch it used the following logic:

  1. The section count was read as a 32-bit value from (a2+4).
  2. Table address was computed as
       base = *DWORD(a2) + count * entry_size – *(WORD)(a1+6)
  3. The function returned the 32-bit index of the matching section, or
     0xFFFFFFFF on failure.

Problems:
  • V7 schemas store the section count as WORD; treating it as DWORD
    allows an attacker-controlled value to overflow the multiplication,
    positioning base far outside the real allocation.
  • The subtraction used the field at a1+6, which in V7 is *not* the
    schema header size (the correct field is at offset 18).  The
    resulting pointer may therefore precede the allocation.
  • The successful path returns the raw 32-bit index which is later
    trusted by ApiSetResolveToHost_V7 to compute further pointers and
    to copy host information into a caller-supplied buffer.

A malicious process can craft an ApiSet contract key such that the
section count (WORD) wraps around, causing base to reference memory
outside the legitimate heap block.  Subsequent dereferences and writes
in ApiSetResolveToHost_V7 corrupt heap memory located before or after
the schema allocation, yielding arbitrary kernel memory modification
and therefore local elevation of privilege.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// ApiSetpSearchForSectionIndex_V7 – old
v13 = *(_DWORD *)(a2 + 4);          // 32-bit count (attacker controlled)
...
v17 = v15 + 8 * v16 - *(WORD*)(a1+6);// uses wrong header field
...
return *(DWORD *)(v17 + a1 + 4);     // 32-bit index returned
```
```c
// ApiSetpSearchForSectionIndex_V7 – patched
v13 = *(WORD *)(a2 + 4);             // count limited to WORD
...
v17 = v15 + 8 * v16 - *(WORD*)(a1+18);// correct header offset
...
return *(WORD *)(v17 + a1 + 4);      // index truncated to WORD
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User-mode  GDI call
  -> CreatePerSessionWin32kCall
  -> ApiSetResolveToHost
     * if schema version == 7
       -> ApiSetResolveToHost_V7 (unpatched) / ApiSetpResolveHost (patched)
          -> ApiSetpGetContractKeyInfo   (parses attacker string)
          -> ApiSetpSearchForSectionIndex_V7 (calculates index)
          -> pointer arithmetic based on returned index
          -> copies host info into caller buffer (heap overwrite)

Attack Vector
--------------------------------------------------------------------
A local, low-privilege process supplies a specially crafted ApiSet
contract key (e.g. "api-ms-win-~99999-..." containing over-sized count
fields) via a win32k system-call that ultimately invokes
ApiSetResolveToHost.  No additional privileges are required.

Patch Description
--------------------------------------------------------------------
1. Re-implemented ApiSetResolveToHost_V7 as ApiSetpResolveHost with a
   new prototype and extensive bounds checks.
2. ApiSetpSearchForSectionIndex_V7
   • Treats section count and returned index as WORD (16-bit).
   • Uses 0xFFFF as the failure sentinel instead of 0xFFFFFFFF.
   • Corrects header-offset from +6 to +18.
3. ApiSetpGetContractKeyInfo adds stricter character parsing and an
   early-return path when a dash ("-") precedes a numeric sequence,
   preventing unintended state transitions.
4. ApiSetResolveToHost verifies header flags before delegating and
   passes pre-validated parameters to the new helper.

Security Impact
--------------------------------------------------------------------
Prior to the fix a crafted ApiSet name could drive win32k into writing
beyond the bounds of a heap allocation, leading to memory corruption in
kernel mode.  An attacker executing code in a local session could
leverage this to gain SYSTEM privileges (Elevation of Privilege).

Fix Effectiveness
--------------------------------------------------------------------
The patch constrains all critical indices to 16-bit ranges, corrects
header-offset usage, installs consistent 0xFFFF sentinels, and performs
additional validation in both the contract-key parser and the top-level
resolver.  These changes eliminate the arithmetic wraparound that led
to the out-of-bounds memory access; the vulnerability is considered
fully remediated.
