{'confidence': 0.13, 'cve': 'CVE-2025-53716', 'kb': 'KB5063878', 'date': 1755086589.7147255, 'patch_store_uid': 'ce1aca78-788e-4fa8-a879-a0522f93b129', 'change_count': 24, 'file': 'lsasrv.dll'}
--------------------------------------------------------------------
CVE-2025-53716 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Local Security Authority Sub-system Service (lsasrv.dll)
Function: LsapCanLogonShadowAdmin()


Vulnerability Class
--------------------------------------------------------------------
NULL-pointer dereference (CWE-476) leading to service denial


Detailed Root Cause Analysis
--------------------------------------------------------------------
The crash happens during evaluation of the so-called “Shadow-Admin”
logon rules.  In the unpatched version LsapCanLogonShadowAdmin()
executes the following sequence every time a logon is processed:

1.  Builds a TOKEN_MANDATORY_LABEL and TOKEN_USER structure for the
    caller’s access token.
2.  If the user-SID equals the hard-coded SID
    S-1-5-0x5000001-18 (array pSid2[ ] in the listing) the routine
    calls LsapIsProcessOnShadowAdminAllowList(a2).
3.  LsapIsProcessOnShadowAdminAllowList() dereferences two global
    data items that are only created when the feature flag
    “Shadow-Admin” is switched on at boot time:
       • ShadowAdminLogonAllowedList          (root of an AVL tree)
       • ShadowAdminLogonAllowedListLock      (ERESOURCE)

If the Windows build ships with the feature flag *disabled* (the
current public default) those globals stay initialised to NULL.
Consequently, every call into LsapIsProcessOnShadowAdminAllowList()
tries to traverse a NULL _RTL_BALANCED_NODE pointer and LSASS
terminates with STATUS_ACCESS_VIOLATION (0xC0000005).

The execution path is completely reachable from the network, because
it is taken for normal (authenticated) NTLM / Kerberos logons that
arrive through NetLogon, SMB, LDAP, RDP and comparable protocols.
An authenticated but otherwise low-privileged user can therefore
reboot a DC or member server remotely.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before patch – NULL test missing
if ( EqualSid(*v15, pSid2) )
    v5 = LsapIsProcessOnShadowAdminAllowList(a2) != 0;
...
// inside LsapIsProcessOnShadowAdminAllowList()
RtlAcquireResourceExclusive(&ShadowAdminLogonAllowedListLock, TRUE); // <- may be NULL
if (GetCurrentThreadId() == ShadowAdminLogonAllowedList->ThreadId)   // <- NULL deref
    ...
```
```c
// after patch – feature gate + proper lock initialisation
if (!wil::Feature<__WilFeatureTraits_Feature_ShadowAdmin>::IsEnabled())
{
    // use legacy path – never touches ShadowAdmin globals
    return v4;                     // safe early exit
}
...
RtlAcquireResourceExclusive(&ShadowAdminLogonAllowedListLock, TRUE);
for (node = ShadowAdminLogonAllowedList; node != &ShadowAdminLogonAllowedList; ...)
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
Remote protocol (e.g. SMB) -> NetLogon -> LSA authentication package
-> LsapLogonUserExEx() -> LsapCanLogonShadowAdmin()
 -> EqualSid()==TRUE & feature disabled ->
    LsapIsProcessOnShadowAdminAllowList() -> NULL deref -> LSASS crash.


Attack Vector
--------------------------------------------------------------------
Any authenticated network logon that uses the built-in Administrator
(or another SID that matches pSid2) against a system where the
Shadow-Admin feature is **disabled**.  No special local privileges are
required beyond the ability to authenticate.


Patch Description
--------------------------------------------------------------------
1. Added a WIL feature check
   "Feature_ShadowAdmin" (ID 2578215227).  If the feature is not
   enabled the function now bails out before touching any Shadow-Admin
   data.
2. When the feature is enabled, the code
   • Validates that the call really originated from a Shadow-Admin
     logon (`BYTE8(pSid2) & 0x10` flag).
   • Acquires `ShadowAdminLogonAllowedListLock` only after confirming
     that the pointer is valid.
3. Extensive control-flow restructuring ensures that the AVL tree root
   is never dereferenced unless it is guaranteed to be initialised.


Security Impact
--------------------------------------------------------------------
Prior to the patch any matching logon request could crash LSASS,
causing immediate reboot of a Domain Controller or member server – a
high-impact Denial-of-Service condition.


Fix Effectiveness
--------------------------------------------------------------------
The added feature-gating and explicit resource checks eliminate all
code paths that could reference an uninitialised (NULL) AVL root or
lock.  A synthetic exploit that previously crashed LSASS now returns
STATUS_SUCCESS with the patched binary, demonstrating that the NULL
pointer dereference is fully mitigated.

