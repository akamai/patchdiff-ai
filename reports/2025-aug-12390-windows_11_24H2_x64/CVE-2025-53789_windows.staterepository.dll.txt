{'kb': 'KB5062553', 'confidence': 0.15, 'date': 1755081491.3196683, 'file': 'windows.staterepository.dll', 'patch_store_uid': 'b5c2a519-79b6-46c4-8b4b-d060a1082e3b', 'cve': 'CVE-2025-53789', 'change_count': 57}
--------------------------------------------------------------------
CVE-2025-53789 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
windows.staterepository.dll – WinRT server-side factory classes:
 • DynamicAppUriHandlerFactoryServer
 • UupProductPackageFactoryServer
These classes expose privileged database mutation APIs to client
processes through the StateRepository WinRT service.

Vulnerability Class
--------------------------------------------------------------------
CWE-306  Missing Authentication for Critical Function (local
Elevation-of-Privilege).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The affected WinRT methods perform destructive operations inside the
StateRepository system database:
 • DeleteByProgIDAndDynamicAppUriHandlerGroup()
 • DeleteByUupProductAndPackageIdentity()
 • DeleteByUupProduct()
 • AddOrUpdateUupProduct()

Prior to the patch each function directly opened the system database
(StateRepository::Repository::OpenDatabaseFromCache) and executed the
requested DELETE / UPDATE statement without first verifying the caller
privileges.  The only pre-existing gate was
BlockRequests::IsCurrentThreadUnblocked(), whose purpose is to
throttle re-entrancy and is not an access-control mechanism.

Because these WinRT endpoints are available to any local process that
can instantiate the corresponding activation CLSID, an unprivileged
user could:
 1. Open a WinRT proxy for one of the *FactoryServer classes.
 2. Supply arbitrary values (ProgID, ProductID, PackageIdentity …).
 3. Cause the service to delete or overwrite database rows that are
    normally writable only by administrators / system components.
This results in a classic privilege-escalation condition, as the
backend runs with elevated rights and changes system-wide state.

Patch analysis shows that every vulnerable entry point now begins with

  StateRepository::Security::AccessControl::Check(
      "<ObjectName>",
      "<FullyQualifiedMethodName>",
      0,
      administratorPrivilegeSecurityDescriptor,
      1);

The call enforces that the client token satisfies the
‘administratorPrivilegeSecurityDescriptor’.  If Check() returns a
failure HRESULT the request aborts and no database transaction is
started.  This completely closes the previously missing
authentication gap.

Affected parameters / structures:
 • HSTRING ProgID / ProductID strings supplied by the caller.
 • IDynamicAppUriHandlerGroup*, IUupProduct*, IPackageIdentity*
   interface pointers that are dereferenced after the check.
 • Internal objects StateRepository::Database, AutoTransaction, and
   Entity::* helpers that execute the actual SQL operations.
Without the check these objects execute with SYSTEM privileges for any
caller.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE (DynamicAppUriHandlerFactoryServer::DeleteBy...)
StateRepository::Database::Database(&db);
// No privilege validation – transaction begins immediately
StateRepository::Database::BeginTransaction(&db, ...);
```

```c
// AFTER
if (StateRepository::Security::AccessControl::Check(
        "DynamicAppUriHandler",
        "Windows::Internal::StateRepository::DynamicAppUriHandlerFactoryServer::DeleteByProgIDAndDynamicAppUriHandlerGroup",
        0,
        administratorPrivilegeSecurityDescriptor,
        1u) < 0)
{
    // return access denied
}
StateRepository::Database::Database(&db);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Local standard-user process activates the WinRT server object
   (e.g. Windows.Internal.StateRepository.DynamicAppUriHandlerFactory).
2. Process calls DeleteByProgIDAndDynamicAppUriHandlerGroup()
   (or any other affected method) with arbitrary arguments.
3. BEFORE PATCH: server opens the StateRepository database and executes
   the delete/update, running under SERVICE/SYSTEM context – state is
   modified without caller authentication.
4. AFTER PATCH: server first calls
   Security::AccessControl::Check(); if the caller is not an
   administrator the call fails with HRESULT 0x80070005 (E_ACCESSDENIED)
   and no database change occurs.

Attack Vector
--------------------------------------------------------------------
Local – any code running in a user session that can access the
StateRepository WinRT API can send the malicious method invocation.
No special privileges are required to reach the API on affected OS
versions prior to the patch.

Patch Description
--------------------------------------------------------------------
For every vulnerable function the patch inserts:
 • A call to wil::details::FeatureImpl<...>::IsEnabled() guard
   (feature flag 2578215227) followed by
 • StateRepository::Security::AccessControl::Check() using the global
   administratorPrivilegeSecurityDescriptor.
The returned HRESULT is stored and, on failure, the code paths exit
before any database object is instantiated.  Additional minor changes
(adjusted return labels, error codes, expanded stack locals) are
refactoring only.

Security Impact
--------------------------------------------------------------------
HIGH – allows any local user to delete or overwrite privileged records
inside the system StateRepository database, which can in turn alter
package registration state, URI handler mapping, or product metadata.
Because the service runs with elevated rights this constitutes an
Elevation of Privilege vulnerability (EoP).

Fix Effectiveness
--------------------------------------------------------------------
The added Security::AccessControl::Check() enforces an administrator
security descriptor and returns an error before any transaction is
started, effectively blocking unprivileged callers.  Assuming the
administratorPrivilegeSecurityDescriptor is correctly defined and the
feature flag is enabled on all supported SKUs, the fix fully mitigates
the issue.  Potential residual risk (unknown): whether the feature flag
can be disabled or the descriptor mis-configured.
