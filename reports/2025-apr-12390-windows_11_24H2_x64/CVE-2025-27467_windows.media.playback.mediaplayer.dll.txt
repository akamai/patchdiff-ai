{'patch_store_uid': 'dde755f3-6cfd-4bb7-86ec-3f14fa2eea1c', 'change_count': 1, 'date': 1751828834.5726345, 'kb': 'KB5055523', 'file': 'windows.media.playback.mediaplayer.dll', 'confidence': 0.22, 'cve': 'CVE-2025-27467'}
--------------------------------------------------------------------
CVE-2025-27467 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
windows.media.playback.mediaplayer.dll – function
MediaPlayerImpl::WaitForVBlankLoop().  The code operates in the
Digital-Media playback stack and interacts with the DXGI IDXGIOutput
interface to wait on vertical-blank events.

Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use After Free

Detailed Root Cause Analysis
--------------------------------------------------------------------
The loop maintains two raw interface pointers:
  v6 – process-wide cache of IDXGIOutput* (owner, freed with
       Microsoft::WRL::ComPtr::<InternalRelease>).  
  v4 – per-iteration alias of v6, **copied without AddRef**.

Original logic:
 1. v4 = v6                                      // no AddRef
 2. if (!v6) {
        InternalRelease(&v6);                    // may free object
        GetDefaultDXGIOutput(&v6);               // may fail, v6==NULL
        v4 = v6;                                 // may stay NULL
    }
 3. ((IDXGIOutput*)v4)->WaitForVBlank(v4);       // unconditional call
 4. if call failed, InternalRelease(&v6).

If GetDefaultDXGIOutput() fails (for instance when no suitable
adapter/output exists or has just been hot-unplugged) the branch leaves
v4 pointing at the *previous* object that was just passed to
InternalRelease().  When the reference count hit zero, the underlying
IDXGIOutput is destroyed.  The unconditional dereference at step 3
therefore operates on freed memory – a classic Use-After-Free.

Because IDXGIOutput vtbl entries ultimately live inside the DirectX
kernel driver stack, control of the freed memory can be leveraged to
redirect execution flow inside a medium-integrity media process and
escalate privileges locally.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
v4 = v6;
if (!v6) {
    InternalRelease(&v6);
    GetDefaultDXGIOutput(&v6);
    v4 = v6;
}
if (((int (__fastcall *)(IDXGIOutput*))v4->lpVtbl->WaitForVBlank)(v4) < 0)
{
    InternalRelease(&v6);
    Sleep(0x10);
}

// after
if ( !v6 &&
     (InternalRelease(&v6),               // may delete object
      GetDefaultDXGIOutput(&v6),
      (v4 = v6) == 0)                     // bail out if still NULL
   || ((int (__fastcall *)(IDXGIOutput*))v4->lpVtbl->WaitForVBlank)(v4) < 0 )
{
    InternalRelease(&v6);
    Sleep(0x10);
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker arranges for MediaPlayerImpl::WaitForVBlankLoop() to run
   (e.g., start media playback).
2. Force the last cached IDXGIOutput to be freed (device removal,
   display-adapter surprise removal, or custom DXGI hook returning
   DXGI_ERROR_DEVICE_REMOVED).
3. Ensure subsequent GetDefaultDXGIOutput() fails, leaving v6==NULL.
4. Function dereferences stale v4 pointer, executing code from freed
   memory.

Attack Vector
--------------------------------------------------------------------
Local attacker with the ability to interact with the desktop stack can
unplug / re-plug displays or use crafted DXGI shims to control the
lifetime of IDXGIOutput objects.  When the UAF is hit the attacker can
reallocate the freed chunk with attacker-controlled data, obtain code
execution in the media process, and elevate privileges.

Patch Description
--------------------------------------------------------------------
The fix re-orders the control flow so that WaitForVBlank() is *only*
invoked when a valid IDXGIOutput pointer is present:
 • Releases the old object and attempts to reacquire a new one *inside*
   the same Boolean expression.
 • Immediately checks whether the reacquisition failed.  If it did, the
   left side of the expression is true and short-circuit evaluation
   prevents the call to WaitForVBlank(), eliminating the UAF
   dereference.

Security Impact
--------------------------------------------------------------------
Prior to the patch an attacker could execute code with the privileges of
any process using MediaPlayerImpl::WaitForVBlankLoop(), allowing local
Elevation of Privilege.  Impact scope is at least the media playback
service; full system compromise is possible but unconfirmed.

Fix Effectiveness
--------------------------------------------------------------------
The conditional short-circuit removes the only path that dereferenced a
freed IDXGIOutput pointer, effectively closing the UAF.  No residual
paths to the freed object are evident in the modified routine.  A full
code audit for similar AddRef/Release imbalances elsewhere in the
Digital-Media stack is still recommended.
