{'file': 'msi.dll', 'patch_store_uid': '513d4b7f-2b92-4b14-a5fe-15350cf20832', 'confidence': 0.33, 'kb': 'KB5055523', 'date': 1751820815.5366173, 'change_count': 9, 'cve': 'CVE-2025-27727'}
--------------------------------------------------------------------
CVE-2025-27727 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Installer (msi.dll) – class CMsiTransaction, method
SetEEUIDirectoryAndFilter()

Vulnerability Class
--------------------------------------------------------------------
CWE-59: Improper link resolution before file access ("link
following") – manifested through use of an uninitialised pointer that
causes Windows Installer to operate on an arbitrary path when
scheduling a privileged delete operation.

Detailed Root Cause Analysis
--------------------------------------------------------------------
SetEEUIDirectoryAndFilter() is invoked from privileged Windows
Installer code to register a directory for later deletion during the
rollback / commit phase of an MSI transaction.

The routine performs three logical steps:
 1. Validate the caller via IsValidCaller().
 2. Copy the caller-supplied directory path (arg a2) into the
    transaction object at offset +0x148 ("this + 82").
 3. Record a filter mask (arg a3) at *(this+0xA0).
 4. Schedule the directory for deferred deletion by calling
    CMsiTransaction::ScheduleFileOrFolderDelete().

Prior to the patch the final call is made with an uninitialised
register variable v7:

    return ScheduleFileOrFolderDelete(this, v7, 1);

No value is ever written to v7, so the second parameter (expected to be
a valid NT-style path) contains whatever 64-bit value happened to be in
R10 on entry.  Because R10 is call-preserved on x64 Windows, its
contents can be influenced by the unprivileged caller that triggered
the MSI operation.  When the service later dereferences this bogus
pointer it interprets random process memory as a wchar[] path.

If the data at that location happens to form a syntactically valid path
pointing at a reparse point (junction / symlink) under attacker
control, Windows Installer will follow the link and perform a SYSTEM
-level DeleteFile/DeleteDirectory against the resolved target.  The
result is an arbitrary directory delete primitive in the context of
NT AUTHORITY\SYSTEM, enabling privilege escalation through DLL planting
or destructive overwrite of security-sensitive files.

Patch analysis shows the developers corrected the root cause by passing
the path that was just copied into the object ( (ushort*)this+82 )
and, under a feature-flag, short-circuiting the operation entirely.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before
StringCchCopyW((ushort*)this + 82, 0x104, a2);
*((DWORD*)this + 40) = a3;
return CMsiTransaction::ScheduleFileOrFolderDelete(this, v7, 1);

// After
StringCchCopyW((ushort*)this + 82, 0x104, a2);
*((DWORD*)this + 40) = a3;
if (wil::details::FeatureImpl<...>::__private_IsEnabled(...))
    return 0;
else
    return CMsiTransaction::ScheduleFileOrFolderDelete(
              this,
              (const ushort*)this + 82,   // correct pointer
              1);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privilege user crafts or edits an MSI that ultimately calls
   CMsiTransaction::SetEEUIDirectoryAndFilter().
2. The call reaches the elevated Windows Installer service.
3. R10 is prepared by attacker-controlled code just before the service
   call, leaving a pointer to attacker data.
4. SetEEUIDirectoryAndFilter() passes the stale R10 value to
   ScheduleFileOrFolderDelete().
5. Installer dereferences attacker data as a path, follows any reparse
   points and deletes the resolved target with SYSTEM rights.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker supplies a crafted MSI package or
leverages any interface that reaches SetEEUIDirectoryAndFilter().  By
manipulating the preserved R10 register and preparing memory that looks
like a wide-string path to a reparse point, the attacker forces the
privileged service to delete arbitrary locations.

Patch Description
--------------------------------------------------------------------
The patch replaces the uninitialised v7 argument with a deterministic
pointer to the path previously stored in the object, eliminating the
undefined behaviour.  Additionally, a feature-flag gate was added that
can skip the delete scheduling entirely if the feature is enabled.

Security Impact
--------------------------------------------------------------------
Prior to the fix, an attacker could get SYSTEM-level arbitrary directory
or file deletion, leading to Elevation of Privilege through typical
junction/symlink planting techniques.  Integrity boundary breach from
Medium/Low to SYSTEM.

Fix Effectiveness
--------------------------------------------------------------------
Passing a valid, internal buffer pointer removes the ability to
redirect deletion to attacker-controlled paths, effectively mitigating
the vulnerability.  No further issues are observable in the modified
code; residual risk remains unknown without full context but appears
low.
