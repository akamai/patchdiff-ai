{'change_count': 8, 'cve': 'CVE-2025-27738', 'file': 'refs.sys', 'patch_store_uid': 'f5d0d5b0-b4fb-46c8-93df-c3b7984f791a', 'confidence': 0.19, 'date': 1751820827.661762, 'kb': 'KB5055523'}
--------------------------------------------------------------------
CVE-2025-27738 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Resilient File System (ReFS) kernel driver
(refs.sys) – directory-change notification path traversal logic


Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Logic error (CWE-284)


Detailed Root Cause Analysis
--------------------------------------------------------------------
Directory change notifications are delivered through
FsRtlNotifyFilterChangeDirectory().  ReFS supplies an optional
callback that is invoked for every directory element while the
notification code walks from the requested directory up to the tree
root.  The callback’s job is to verify that the caller holds
FILE_TRAVERSE (0x20) on *each* directory on that path.

Prior to the patch this callback was implemented in
RefsNotifyTraverseCheck():
  • v4 – current FCB being examined
  • v8 – pointer to the security descriptor used for SeAccessCheck()

Inside a do/while loop the code first loads the security descriptor of
v4 (RefsLoadSecurityDescriptor()) and stores its pointer in v8, but
only when v8 == NULL.  The pointer is never cleared when the loop
moves to the next directory (v4 is reassigned).  Consequently, after
the first successful iteration the variable still points to the *old*
security descriptor.  All subsequent SeAccessCheck() calls therefore
validate the *wrong* directory.

If the first directory in the chain grants FILE_TRAVERSE while a
deeper element denies it, the function nevertheless returns TRUE and
the notification request is accepted.  An attacker who can traverse a
parent directory but lacks permission on a protected subdirectory can
silently monitor that subdirectory and receive change‐notifications
containing file names and other metadata.

The bug is purely a logic flaw – no memory corruption is involved –
resulting in an unintended security bypass and information leakage.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// refssys ‑ before patch
if (!v8) {                              // v8 is never reset
    if (!v4->ScavengerFinalizationList.Flink)
        RefsLoadSecurityDescriptor(v10, v4);
    v8 = (char *)&v4->ScavengerFinalizationList.Flink[1].Flink + 4;
}
...                                     // later in same loop
v6 = SeAccessCheck(v8, SubjectContext, 1, 0x20, ...);
```
```c
// after patch
return RefsNotifyAccessCheck(a1, a2, a3, 0x20u); // per-directory check
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User opens a directory and issues
   NtNotifyChangeDirectoryFile(WatchTree = TRUE).
2. kernel32 → ntdll → NtSetInformationFile → IRP is queued.
3. RefsNotifyChangeDirectory() decides whether to use a traverse
   callback.
4. Before patch it selects RefsNotifyTraverseCheck().
5. For each ancestor directory the callback re-uses the first security
   descriptor, erroneously passing SeAccessCheck().
6. Notification request for a non-traversable subdirectory is allowed.
7. Subsequent file creations inside that directory generate
   notifications delivered to the attacker.


Attack Vector
--------------------------------------------------------------------
Local or remote authenticated user that can open a parent directory
(but not a protected child) submits a directory-change notification
with WatchTree enabled.  No special privileges are required.


Patch Description
--------------------------------------------------------------------
1. RefsNotifyTraverseCheck() was replaced by a thin wrapper that calls
   a new helper RefsNotifyAccessCheck().  The helper performs a fresh
   security-descriptor lookup for every directory, eliminating the
   stale-pointer reuse.
2. RefsNotifyChangeDirectory() was heavily refactored:
   • New feature flag check (Feature_H2E_WPA3SAE…).
   • Subject-context capture tightened.
   • Correct callback (RefsNotifyTraverseCheckEx /…AccessCheck) is
     chosen for both impersonation and admin tokens.
   • Additional admin/impersonation handling and token checks added.

Together these changes enforce a per-directory FILE_TRAVERSE check and
ensure the callback is always active when required.


Security Impact
--------------------------------------------------------------------
Before the fix an attacker could bypass traverse permissions and learn
file names and directory layout inside protected subdirectories,
resulting in an *information disclosure* vulnerability in the kernel
(ReFS) and elevating system-wide confidentiality risk.


Fix Effectiveness
--------------------------------------------------------------------
The patched code no longer re-uses a single security descriptor; a new
lookup is performed for every path element through
RefsNotifyAccessCheck().  Additional logic in
RefsNotifyChangeDirectory() guarantees the callback is engaged under
all relevant circumstances.  The vulnerable execution path has been
removed, fully addressing the improper access control.

--------------------------------------------------------------------
