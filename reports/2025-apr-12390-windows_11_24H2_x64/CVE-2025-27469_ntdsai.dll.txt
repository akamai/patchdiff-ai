{'date': 1751820879.7073095, 'patch_store_uid': 'a85e12c7-310f-4444-a434-b5b808f3b783', 'confidence': 0.27, 'change_count': 21, 'cve': 'CVE-2025-27469', 'file': 'ntdsai.dll', 'kb': 'KB5055523'}
--------------------------------------------------------------------
CVE-2025-27469 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Active Directory Domain Services – LDAP server implementation in
ntdsai.dll (functions LDAP_REQUEST::GrowReceive, ProcessAdminLimits,
ResetDefaultLimits and LDAP_CONN::BatchRequest)

Vulnerability Class
--------------------------------------------------------------------
CWE-400: Uncontrolled Resource Consumption (Denial-of-Service via
unbounded memory allocation)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The receive path for an LDAP connection grows its per-request receive
buffer through LDAP_REQUEST::GrowReceive(ULONG NewSize).

PRE-PATCH behaviour
•  The routine compared the requested size against the global
   LdapMaxReceiveBuffer (default 10 MB) for every connection, bound or
   not.
•  If the buffer in use was the stack-embedded 4 KB area the code
   executed:
        v8 = DSAllocAux(NewSize,…);
   with NewSize chosen as either the caller supplied value or
   CurrentSize+4096, whichever was larger but still <=
   LdapMaxReceiveBuffer.
•  For already heap-backed buffers DSReallocAux() was used and the size
   doubled until it also reached LdapMaxReceiveBuffer.
•  There was no separate cap for the *pre-authentication* phase.  An
   unauthenticated client could therefore force allocations up to
   LdapMaxReceiveBuffer (or up to 4 GB on some code paths) simply by
   sending oversized BER encoded PDUs before BIND completed.
•  Multiple such connections quickly exhaust paged-pool/heap memory and
   stop the DC from servicing further requests (= DoS).

PATCH behaviour (feature flag 0x824731960)
•  ResetDefaultLimits now initialises a new global
   LdapMaxPreAuthReceiveBuffer to 0x40000 (256 KB).
•  ProcessAdminLimits also clamps this value to 0x80000000 and exposes
   it to SASL so that admin policy cannot raise it beyond 2 GB.
•  GrowReceive detects whether the connection is authenticated via
   LDAP_CONN::IsBound():
      maxAllowed = IsBound ? LdapMaxReceiveBuffer
                           : LdapMaxPreAuthReceiveBuffer;
  Every subsequent size comparison (growth, caller supplied a2 etc.)
  uses maxAllowed, guaranteeing that an unauthenticated connection can
  never obtain a buffer larger than LdapMaxPreAuthReceiveBuffer.
•  The rest of the logic is unchanged; once the client successfully
   binds, the higher (administrator configurable) limit applies.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// pre-patch (simplified)
if (requestBuf == stackBuf) {
    if (NewSize > LdapMaxReceiveBuffer) return FAIL;
    p = DSAllocAux(NewSize, TAG);
    memcpy(p, stackBuf, used);
}
...
// post-patch
IsBound = LDAP_CONN::IsBound(conn);
maxCap  = IsBound ? LdapMaxReceiveBuffer
                  : LdapMaxPreAuthReceiveBuffer;
if (requestBuf == stackBuf) {
    if (NewSize > maxCap) return FAIL;
    ...
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Remote unauthenticated client opens an LDAP TCP session.
2. Sends a crafted BER element whose length field advertises an overly
   large payload size.
3. ntdsai!LDAP_CONN::BatchRequest → ..GrowReceive(AdvertisedLen).
4. Before patch: AdvertisedLen passes the single global cap, DSAllocAux
   allocates AdvertisedLen bytes.
5. Repeat on many sockets → memory exhaustion → LSASS/NTDS service
   crash or unresponsiveness.

Attack Vector
--------------------------------------------------------------------
Unauthenticated network attacker sending oversized LDAP packets to port
389/636.  No credentials or special permissions are required.

Patch Description
--------------------------------------------------------------------
• Introduced new configurable limit LdapMaxPreAuthReceiveBuffer; default
  256 KB, enforceable upper bound 2 GB.
• GrowReceive now selects per-connection cap based on
  LDAP_CONN::IsBound().
• ResetDefaultLimits initialises the new limit; ProcessAdminLimits
  validates administrator overrides.
• Additional WPP logging and feature-flag plumbing were added but do
  not affect the fix logic.

Security Impact
--------------------------------------------------------------------
Before the fix, each unauthenticated connection could claim up to the
full LdapMaxReceiveBuffer (default 10 MB, potentially higher via admin
configuration).  Hundreds of parallel connections could therefore
exhaust heap/paged pool, leading to denial of service of the Domain
Controller.  After the fix, pre-auth connections are constrained to
256 KB, reducing worst-case memory use by ~40× and eliminating the easy
DoS condition.

Fix Effectiveness
--------------------------------------------------------------------
The allocation path is now guarded by a hard cap that applies *before*
authentication completes.  Attempts to exceed 256 KB cause GrowReceive
to fail, the request is rejected, and no large allocation occurs.  Once
bound, allocations are still allowed up to the (administrator-controlled)
higher limit, preserving normal functionality.  The patch fully
mitigates the uncontrolled resource consumption vector described.
