{'confidence': 0.82, 'patch_store_uid': '38b57009-9f8e-4426-8142-2d7f8db5f6f2', 'change_count': 2, 'cve': 'CVE-2025-21221', 'kb': 'KB5055523', 'date': 1751822585.9034166, 'file': 'tapisrv.dll'}
--------------------------------------------------------------------
CVE-2025-21221 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Telephony Service (tapisrv.dll) – server-side RPC routine
LGetAddressStatus.

Vulnerability Class
--------------------------------------------------------------------
Heap-based buffer overflow / out-of-bounds write (CWE-122).

Detailed Root Cause Analysis
--------------------------------------------------------------------
LGetAddressStatus receives from the RPC client a TAPI structure
containing a forward list.  The relevant fields are
  dwTotalSize          = a4[0]
  dwForwardListEntries = a4[9]
  dwForwardListOffset  = a4[11]

After calling into the TSP the service iterates over every forward
entry:
  base = (BYTE *)a4 + dwForwardListOffset
  for (i = 0; i < dwForwardListEntries; i++)
      mutate 4-byte flag at base + i*32

In the pre-patch build no sanity check is performed to verify that
(dwForwardListEntries * 32) + dwForwardListOffset is still inside
(dwTotalSize).  Because all three fields are controlled by the remote
caller, an attacker can set a large dwForwardListEntries or a small
(dwTotalSize / dwForwardListOffset) so that the computed pointer moves
past the end of the heap buffer allocated by InitTapiStruct.  The
subsequent write
    *entry = (*entry & 0xFFFCFFFE) | 1;
corrupts adjacent heap memory, enabling heap grooming and ultimately
arbitrary code execution in the tapisrv service, which runs as
NT AUTHORITY\SYSTEM.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// pre-patch (tapisrv.dll)
if (v8 == 65539)                    // LINE_ADDRESSSTATUS
{
    v11 = a4[9];                    // dwForwardListEntries
    if (v11)
    {
        v12 = (_DWORD *)((char *)a4 + a4[11]); // no bounds check
        v13 = v11;
        do
        {
            if ((*v12 & 0x30000) != 0)
                *v12 = *v12 & 0xFFFCFFFE | 1;  // OOB write
            v12 += 8;                          // +32 bytes
        }
        while (--v13);
    }
}

// patched
if (Feature_IsEnabled())
{
    size = 32ULL * a4[9];
    offset = a4[11];
    if (size > 0xFFFFFFFF || offset + size < offset ||
        a4[0] < offset + size)
    {
        TRACE("invalid forward list");
        a4[9] = 0;
        *a2 = 0x8000000D;          // TAPIERR_STRUCTURETOOSMALL
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Unprivileged network client opens the Telephony RPC endpoint.
2. Client calls llineGetAddressStatus (maps to server stub that
   invokes LGetAddressStatus) and supplies a crafted TAPI buffer.
3. Server allocates dwTotalSize bytes and passes it to the TSP.
4. Function loops over dwForwardListEntries without validating range.
5. Heap memory after the buffer is overwritten, leading to corruption
   and potential code execution.

Attack Vector
--------------------------------------------------------------------
Any user able to reach the Telephony RPC interface (ncacn_ip_tcp or
ncalrpc) can send a malicious llineGetAddressStatus request containing
inconsistent dwTotalSize / dwForwardListOffset / dwForwardListEntries
values to trigger the overflow.

Patch Description
--------------------------------------------------------------------
Microsoft added explicit bounds checking guarded by an internal feature
flag:
  • Calculates required_size = 32 * dwForwardListEntries (64-bit).
  • Rejects if multiplication overflows 32 bits.
  • Rejects if offset + required_size wraps 32-bit arithmetic.
  • Rejects if required_size + offset exceeds dwTotalSize.
On failure the forward list is nulled and error 0x8000000D is returned
without touching the list memory, eliminating the out-of-bounds write.

Security Impact
--------------------------------------------------------------------
Prior to the patch a remote, unauthenticated attacker could corrupt the
heap of the Telephony service and execute arbitrary code as SYSTEM,
resulting in full machine compromise.  The issue is rated Remote Code
Execution.

Fix Effectiveness
--------------------------------------------------------------------
The added size/overflow checks correctly gate every write to the
forward list and abort the operation on invalid input, removing the
primitive.  Because the mitigation is wrapped in a feature flag,
correct deployment of that feature is required; if the flag were ever
disabled the original vulnerability would reappear.  No other residual
paths leading to unchecked writes were observed in this routine.
