{'file': 'refsv1.sys', 'patch_store_uid': 'd188d36e-152c-48bc-8731-8679b14f6069', 'date': 1751820831.8431823, 'confidence': 0.35, 'change_count': 3, 'kb': 'KB5055523', 'cve': 'CVE-2025-27738'}
--------------------------------------------------------------------
CVE-2025-27738 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Resilient File System (ReFS) kernel driver –
refsv1.sys, functions handling directory–change notification
(RefsNotifyChangeDirectory, RefsNotifyTraverseCheck) and dynamic
policy loader (RefsUpdateDynamicRegistrySettings).

Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Authorization Bypass leading to
information disclosure (CWE-284).

Detailed Root Cause Analysis
--------------------------------------------------------------------
When a user calls ReadDirectoryChangesW (IRP_MJ_DIRECTORY_CONTROL
/ IRP_MN_NOTIFY_CHANGE_DIRECTORY) with the WatchTree flag set,
ReFS must verify that the caller possesses FILE_TRAVERSE (0x20)
permission on every sub-directory that will be walked by the file
system run-time library (FsRtl).  This per-node check is performed
through an optional callback supplied to FsRtlNotifyFilterChange
Directory.

PRE-PATCH behaviour (refsv1.sys prior to the fix):
  • RefsNotifyChangeDirectory decides whether to set the callback
    based only on an internal flag test:
        if (FsContext[1] & 0x80) TraverseCallback = RefsNotifyTraverseCheck;
    For ordinary user-mode opens this bit is normally clear, so
    TraverseCallback remains NULL.
  • FsRtl therefore walks the entire sub-tree without ever invoking
    an access check.  The caller receives change notifications for
    objects located in directories to which it has no TRAVERSE
    access, leaking file names and metadata.
  • Even when the callback is used, the original
    RefsNotifyTraverseCheck implements a hand-rolled access check
    that caches the first security descriptor it encounters
    (v10).  If deeper directories carry a different SD the check is
    silently bypassed for them, further weakening security.

POST-PATCH behaviour:
  • RefsNotifyChangeDirectory is completely re-written.  When the
    WatchTree flag is set the driver now evaluates several policy
    sources – a feature switch, a new registry value
    "EnforceDirectoryChangeNotificationPermissionCheck", caller
    impersonation state, and token admin status – before deciding
    whether the callback is mandatory.  In all default
    configurations the callback is enabled.
  • A fresh subject security context is captured (SeCaptureSubject
    Context) and passed to FsRtl together with the new callback.
  • The old, error-prone RefsNotifyTraverseCheck has been replaced
    by a thin wrapper that forwards to a shared routine
        RefsNotifyAccessCheck(a1, a2, a3, 0x20)
    guaranteeing a correct, stateless SeAccessCheck for every
    directory visited.
  • RefsUpdateDynamicRegistrySettings loads the new registry value
    and stores the result in byte_1C00887AC, allowing the policy to
    be toggled at run-time without reboot.

Affected data structures / parameters
  – FsContext[1]    : internal per-handle flag used to decide if a
                      traverse check was attached.
  – WatchTree       : IO_STACK_LOCATION::Flags bit 0 controlling
                      sub-tree notifications.
  – SubjectContext  : security context captured from the caller.
  – FILE_TRAVERSE   : desired access mask (0x20) now passed
                      explicitly to RefsNotifyAccessCheck.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// pre-patch RefsNotifyChangeDirectory
if ((FsContext[1] & 0x80u) != 0) {
    SubjectContext = ExAllocatePool(...);
    SeCaptureSubjectContext(SubjectContext);
    TraverseCallback = RefsNotifyTraverseCheck; // else NULL
}
...
FsRtlNotifyFilterChangeDirectory(..., TraverseCallback, SubjectContext, 0);
```
```c
// pre-patch RefsNotifyTraverseCheck (excerpt)
if (!v10) {
    if (!a2[23])
        RefsLoadSecurityDescriptor(v12, a2);
    v10 = (void *)(a2[23] + 20);
}
GenericMapping = IoGetFileObjectGenericMapping();
v8 = SeAccessCheck(v10, a3, 1, 0x20, 0, &Privileges,
                   GenericMapping, 1, &GrantedAccess, &Status);
```
```c
// post-patch replacement
__int64 __fastcall RefsNotifyTraverseCheck(__int64 vcb,
                                           __int64 fcb,
                                           __int64 subj)
{
    return RefsNotifyAccessCheck(vcb, fcb, subj, 32); // 0x20
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User-mode -> ReadDirectoryChangesW(handle, TRUE /*WatchTree*/)
    -> nt!NtQueryDirectoryFile               (kernel system call)
    -> IopSynchronousServiceTail / IoMgr      builds IRP
    -> refsv1!RefsFsdDirectoryControl         dispatches
    -> refsv1!RefsNotifyChangeDirectory
         (fails to attach TraverseCallback)   [vulnerable]
    -> FsRtlNotifyFilterChangeDirectory       walks sub-tree
    -> Notifications for objects in
       unauthorised directories are queued
    -> user receives leaked metadata.

Attack Vector
--------------------------------------------------------------------
A low-privileged local attacker opens any directory to which they
have read permission and issues ReadDirectoryChangesW with the
WatchTree flag.  Because ReFS neglects to run FILE_TRAVERSE checks
on descendant directories, the attacker gains real-time
information about file creations, deletions, renames, and
attribute changes inside directories they are not authorised to
traverse – including other users' private folders or sensitive
system locations – resulting in information disclosure.

Patch Description
--------------------------------------------------------------------
1. Replaced hand-rolled RefsNotifyTraverseCheck with a call to
   common helper RefsNotifyAccessCheck, eliminating state leakage
   and guaranteeing a correct SeAccessCheck on every node.
2. Re-implemented RefsNotifyChangeDirectory:
   • Evaluates feature flag + registry value
     "EnforceDirectoryChangeNotificationPermissionCheck".
   • Always captures the caller's SECURITY_SUBJECT_CONTEXT when
     subtree watching is requested.
   • Selects between RefsNotifyTraverseCheck, new
     RefsNotifyTraverseCheckEx (non-admin), or no callback,
     depending on policy and token privileges.
   • Passes correct parameters to FsRtlNotifyFilterChangeDirectory.
3. Added registry-driven runtime policy loader in
   RefsUpdateDynamicRegistrySettings; sets global
   byte_1C00887AC so the new behaviour can be enabled without a
   reboot.

Security Impact
--------------------------------------------------------------------
Before the patch, any authenticated user could observe the names
and metadata of files located in directories for which they lacked
security access, violating Windows discretionary access control
and potentially exposing confidential information over local or
network shares.  No code-execution is involved, but privacy and
confidentiality are compromised.

Fix Effectiveness
--------------------------------------------------------------------
The new code unconditionally performs a SeAccessCheck for
FILE_TRAVERSE on every directory when the default policy is in
force, closing the information-disclosure gap.  Because the check
is implemented in a shared, well-tested helper and the behaviour
can be toggled only by an administrator-controlled registry key,
the fix is expected to be effective.  If administrators manually
clear the new registry value the previous behaviour resurfaces;
otherwise the vulnerability is removed.
