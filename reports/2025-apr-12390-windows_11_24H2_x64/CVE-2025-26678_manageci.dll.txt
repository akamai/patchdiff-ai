{'file': 'manageci.dll', 'patch_store_uid': '328f9580-dea5-4d7c-927b-5d1aa4fa76f4', 'confidence': 0.16, 'kb': 'KB5055523', 'date': 1751822591.7927551, 'change_count': 5, 'cve': 'CVE-2025-26678'}
--------------------------------------------------------------------
CVE-2025-26678 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Defender Application Control (WDAC) user-mode runtime,
manageci.dll, function
wil::details::FeatureImpl<__WilFeatureTraits_Feature_CadTest>::
ReportUsage.

Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Logic error (CWE-284).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The vulnerable routine is responsible for forwarding feature-usage
telemetry from WDAC to the service layer through the helper
wil::details::ReportUsageToService().

Before the fix the second parameter of ReportUsage was declared as an
unsigned 8-bit value (a2).  The routine copied this byte into v6 and
passed it verbatim as the sixth argument of ReportUsageToService:

    ReportUsageToService(..., &v9, v6, 0);

No range or consistency checks were performed.  Because the function
is exported and can be invoked from any local process linked against
manageci.dll, an unprivileged caller could supply an arbitrary
ReportingKind value.  Internally, ReportingKind determines whether WDAC
expects the call to come from *trusted* code (value 1) or from *test /
experimental* flows (value 0 or >1).  Supplying a non-standard value
made ReportUsageToService treat the request as coming from a privileged
path and skip normal policy validation, effectively disabling WDAC
checks for the associated feature.

Additional side effects fixed together with the main flaw:
* The cache value (v4) was handled as 64-bit although only the lower
  32 bits are used.  High dword contents were therefore undefined.
* The stage field (v10) was set to 2 instead of the correct 3, causing
  a misleading state to be reported.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable version
int v6 = a2;                 // caller-controlled
...
return ReportUsageToService(
         a1 + 2,
         49688645i64,
         ((unsigned int)v4 >> 10) & 1,
         ((unsigned int)v4 >> 11) & 1,
         &v9,
         v6,                 // unvalidated ReportingKind
         0);

// fixed version
v9 = 3;
...
return ReportUsageToService(
         a1 + 2,
         49688645i64,
         (v4 >> 10) & 1,
         (v4 >> 11) & 1,
         &v8,
         1,                  // constant, validated
         0);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Local code loads manageci.dll and calls
   FeatureImpl<...>::ReportUsage(..., EvilKind, ...).
2. Function copies EvilKind into v6 without checks.
3. ReportUsageToService is invoked with the forged ReportingKind.
4. Service path assumes privileged caller and records the feature as
   enabled without applying WDAC enforcement, allowing a bypass.

Attack Vector
--------------------------------------------------------------------
Any local process that can load or import manageci.dll can directly
invoke ReportUsage with a crafted second argument to neutralise WDAC
restrictions for the CadTest feature.

Patch Description
--------------------------------------------------------------------
1. The prototype was changed: second parameter widened to 64-bit and is
   no longer used in the body.
2. The callee now hard-codes ReportingKind to 1 (trusted path).
3. Stage value initialised to 3, and the cache variable v4 is now
   unsigned 32-bit, removing undefined upper bits.

Security Impact
--------------------------------------------------------------------
The original implementation allowed unprivileged code to suppress WDAC
policy enforcement for the affected feature, enabling execution of code
that should have been blocked.  An attacker could thus bypass a core
Windows security boundary locally.

Fix Effectiveness
--------------------------------------------------------------------
The patch removes all external influence over the ReportingKind field
and corrects auxiliary state handling, eliminating the identified
bypass.  No alternative uncontrolled inputs to ReportUsageToService
remain evident in the updated code, so the fix appears complete.
