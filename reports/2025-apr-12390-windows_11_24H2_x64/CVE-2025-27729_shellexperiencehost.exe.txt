{'confidence': 0.29, 'cve': 'CVE-2025-27729', 'change_count': 40, 'file': 'shellexperiencehost.exe', 'date': 1751822697.0374112, 'patch_store_uid': '808e6476-270e-4069-a8a5-be5e20cb8882', 'kb': 'KB5055523'}
--------------------------------------------------------------------
CVE-2025-27729 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows ShellExperienceHost.exe  (IApplicationOverrides::OnActivated
handler).  The affected routine sits in the ShellExperienceHost
application that processes protocol / experience activation events
coming from the Windows Shell.


Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use After Free (lifetime-mismatch on a COM interface pointer).


Detailed Root Cause Analysis
--------------------------------------------------------------------
Prior to the patch the handler compiled as sub_14001E154 received a
pointer in RDX (a2) that represents the COM interface
Windows::ApplicationModel::Activation::IActivatedEventArgs.  The code
performed three consecutive calls to sub_14005B010(a2) without first
calling AddRef and without balancing Release when it returned:

    if (a2)
        sub_14005B010(a2);      // #1 – may internally call Release
    v3 = sub_14005B010(a2);     // #2 – object may already be freed
    if (v3 < 0)
        raiseException(v3);
    return sub_14005B010(a2);   // #3 – derefs again

Because sub_14005B010 is a helper that ultimately issues a virtual
method call on the interface (QueryInterface / GetKind etc.), the first
invocation can legitimately end with the object’s reference count being
brought to zero by another thread or by the helper itself.  The second
and third invocations therefore dereference memory that may already be
freed, turning the pointer into a dangling reference.  A malicious
actor that can influence the vtable contents of the freed block (by
heap spraying or re-allocation) gains the ability to redirect the next
virtual call and execute arbitrary code inside ShellExperienceHost.exe.

Key objects and parameters involved
  a2  – IActivatedEventArgs * (COM pointer under ref-count control)
  sub_14005B010 – helper that queries the object and may drop ref-count
  vtable[8] / vtable[16] – AddRef / Release entries added by the patch

The lifetime mismatch is fully contained inside the Shell process; no
kernel interaction is required.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Vulnerable (before)
__int64 __fastcall sub_14001E154(__int64 a1, __int64 a2)
{
    if (a2)
        sub_14005B010(a2);       // no AddRef held
    int hr = sub_14005B010(a2);  // UAF if object freed
    if (hr < 0)
        __abi_WinRTraiseException(hr);
    return sub_14005B010(a2);    // third deref on same ptr
}

// Patched (excerpt)
if (a2)
    (*(void (**)(__int64))( *(_QWORD *)a2 + 8 ))(a2); // AddRef
...
ret = (*( __int64 (**)(__int64))( *(_QWORD *)a2 + 16 ))(a2); // Release
```
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. A protocol / shell experience activation is delivered to
   ShellExperienceHost.
2. Windows Runtime dispatch invokes
   ShellExperienceHost!QIApplicationOverrides::OnActivated.
3. The vulnerable routine uses the supplied IActivatedEventArgs pointer
   multiple times without holding a reference.
4. Concurrent activity (or attacker-controlled data inside the call)
   drives the object’s ref-count to zero between uses.
5. Subsequent virtual call dereferences freed memory, leading to EIP/RIP
   control via a forged vtable.


Attack Vector
--------------------------------------------------------------------
An unprivileged attacker can trigger the handler through a crafted
protocol activation (ms-actioncenter, ms-notificationcenter, etc.) sent
locally or remotely (e.g. by persuading a victim to visit a web page or
open a link).  By manipulating heap layout around the activated object
and racing the reference-count drop, the attacker can hijack execution
inside ShellExperienceHost.


Patch Description
--------------------------------------------------------------------
The function was completely rewritten.  The security-relevant changes
are:
  * Immediate AddRef (vtable[8]) on the IActivatedEventArgs pointer at
    entry, guaranteeing a stable lifetime while the routine runs.
  * Matching Release (vtable[16]) just before return.
  * All previous duplicate calls to sub_14005B010 were removed.
  * Large additional logic was introduced, but is orthogonal to the
    fix; the crucial element is proper COM reference counting.


Security Impact
--------------------------------------------------------------------
Without the fix, an attacker gains a reliable use-after-free primitive
inside a high-value, always-running user-mode process.  Successful
exploitation yields arbitrary code execution in the context of the
logged-on user (medium integrity) and can be combined with elevation
bugs to gain full system compromise.  The issue is remotely triggerable
through crafted activation links, therefore classified as Remote Code
Execution (RCE).


Fix Effectiveness
--------------------------------------------------------------------
The AddRef/Release pattern fully eliminates the dangling pointer path
observed in the original code, making the handler safe against UAF.  No
new dereference sites without a matching lifetime guarantee are
introduced, so the patch is considered effective.  Residual risk is
limited to other, unrelated logic paths.
