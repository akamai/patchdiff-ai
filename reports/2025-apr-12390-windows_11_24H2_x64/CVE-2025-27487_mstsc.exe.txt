{'date': 1751820782.347168, 'kb': 'KB5055523', 'change_count': 1, 'cve': 'CVE-2025-27487', 'file': 'mstsc.exe', 'confidence': 0.23, 'patch_store_uid': '6ac90ed5-5317-4c94-9515-964f72139790'}
--------------------------------------------------------------------
CVE-2025-27487 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Remote Desktop Client (mstsc.exe) – WIL (Windows Implementation
Library) feature-reporting cache code inside
wil_details_FeatureReporting_RecordUsageInCache().

Vulnerability Class
--------------------------------------------------------------------
CWE-122: Heap-based buffer overflow arising from an out-of-bounds bit
index / insufficient input validation.

Detailed Root Cause Analysis
--------------------------------------------------------------------
The helper wil_details_FeatureReporting_RecordUsageInCache() records
feature-usage information in a two-DWORD cache pointed to by parameter
"a2".  For feature-ID values a3 >= 320 the routine compresses the ID
into a 6-bit field (bits 5-10) of the second DWORD and sets bit 4 as a
valid flag:

    v5 = a3 - 320;              // logical index 0-63
    bits 5-10 = v5;             // (v6 ^ (32*v5)) & 0x7E0
    bit   4   = 1;              // validity

Prior to the patch the code executed the compress/write logic whenever
(a3-6) >= 2, **without confirming that (a3-320) actually fits in the
6-bit field**.  If the caller supplied a3 >= 384 the value written was
silently truncated (v5 mod 64).  The compare-exchange still asserted
the validity bit, leaving the cache in a corrupted state that later
callers treat as having length "1" entry yet referring to an out-of-
range feature-ID.

Subsequent consumer code allocates or indexes per-feature heap
structures using the cached value; because the bitfield no longer
matches the real feature-ID, the size calculation is smaller than the
amount of data copied, leading to a heap overwrite controlled by the
attacker-chosen a3.

Key parameters/structures affected
  • a3 – external feature identifier (attacker influenced)
  • *(a2+1) – 32-bit cache word whose bits 5-10 and 4 are modified
  • result buffer at a1 – receives stale/incorrect status flags

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE
if ((unsigned int)(a3 - 6) >= 2) {
    v5 = a3 - 320;
    if ((int)a3 - 320 < 64) {
        // write compressed index
    }
    ...
}

// AFTER – new bounds enforcement
if ((unsigned int)(a3 - 6) >= 2) {
    v5 = a3 - 320;
    if ((int)a3 - 320 >= 64)
        goto LABEL_16;      // bail out – out of range
    ...
    if (!*(DWORD *)(a1 + 0x10)) {
        LABEL_16:
        // safely treat as generic path
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. RDP client processes a server-provided capability/feature value.
2. Value propagates into wil::details::FeatureImpl::ReportUsage(),
   which calls wil_details_FeatureReporting_RecordUsageInCache().
3. Crafted a3 >= 384 bypasses original length check.
4. Cache word is corrupted; later allocations rely on it and overflow
   a heap buffer.

Attack Vector
--------------------------------------------------------------------
An authenticated RDP server can send a crafted feature identifier
>= 384 during session negotiation or telemetry prompting the client to
call the vulnerable path with a malicious a3 value.

Patch Description
--------------------------------------------------------------------
The update introduces a **strict upper-bound check**:
    if ((int)a3 - 320 >= 64) goto fallback;
Thus the compression routine is executed only for the valid 0-63
index range.  If the index is out of range the code now routes to the
generic path that merely records a safe usage entry without touching
the bitfield.  An additional guard ensures the fallback executes when
no new usage bit was set.

Security Impact
--------------------------------------------------------------------
Prior to the fix, remote attackers controlling a3 could corrupt the
feature cache, cause a heap-based buffer overflow, and ultimately
achieve remote code execution in the context of the RDP client user.

Fix Effectiveness
--------------------------------------------------------------------
The added range check eliminates the only evident path for writing an
out-of-bounds index, preventing further cache corruption and the
follow-on heap overwrite.  No residual write-primitive remains in this
routine; however, code outside the shown diff was not audited here
(unknown).  The fix appears sufficient for the described flaw.
