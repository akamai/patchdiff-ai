{'patch_store_uid': '38b57009-9f8e-4426-8142-2d7f8db5f6f2', 'confidence': 0.25, 'file': 'tapisrv.dll', 'cve': 'CVE-2025-27481', 'change_count': 2, 'date': 1751828771.0959182, 'kb': 'KB5055523'}
--------------------------------------------------------------------
CVE-2025-27481 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Telephony Service (tapisrv.dll), server-side routine
LGetAddressStatus used by the TAPI RPC interface that services
lineGetAddressStatus requests.

Vulnerability Class
--------------------------------------------------------------------
Stack-based / heap-based out-of-bounds write (CWE-121, buffer overflow)
caused by missing bounds and integer-overflow checks on a variable-
length sub-structure inside LINEADDRESSSTATUS.

Detailed Root Cause Analysis
--------------------------------------------------------------------
LINEADDRESSSTATUS is a self-describing variable-length structure
returned by the TSP (driver).  Relevant fields (dword offsets shown
with their a4 index inside this function):
  a4[0]  = dwTotalSize
  a4[2]  = dwNeededSize
  a4[9]  = dwForwardNumEntries      (number of LINEFORWARD records)
  a4[11] = dwForwardOffset          (offset to first record)
Each LINEFORWARD record is 32 bytes.  Before the patch the code

a) computes a base pointer
       v12 = (DWORD *)((char *)a4 + a4[11]);

b) loops dwForwardNumEntries times, modifying each 32-byte record:
       if ((*v12 & 0x30000) != 0)
           *v12 = (*v12 & 0xFFFCFFFE) | 1;
       v12 += 8;                   // 8 dwords == 32 bytes

No validation is performed that
    dwForwardOffset + dwForwardNumEntries*32 <= dwTotalSize, or that
    the multiplication does not overflow 32-bit arithmetic.

A malicious TSP or attacker able to influence the buffer can set
  dwForwardNumEntries = 0x40000000 and dwForwardOffset = 0x40
so that  num*32 overflows to a small value and the computed pointer
lies inside, or just past, the stack frame.  The subsequent in-place
rewrite corrupts stack memory, ultimately leading to control-flow
hijack in the tapisrv service.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
/* BEFORE */
v12 = (DWORD *)((char *)a4 + a4[11]);
for (i = 0; i < a4[9]; i++) {
    if ((*v12 & 0x30000) != 0)
        *v12 = *v12 & 0xFFFCFFFE | 1;   // unchecked write
    v12 += 8;                           // 32-byte stride
}

/* AFTER  */
listSize = (uint64)a4[9] * 32;
if (listSize > 0xFFFFFFFF ||         // mul overflow
    listSize + a4[11] < a4[11] ||    // add overflow
    a4[0] < listSize + a4[11]) {     // exceeds buffer
    TRACE("invalid forward list");
    a4[9] = 0;
    *a2 = 0x8000000D;                // TAPIERR_STRUCTURETOOSMALL
} else {
    /* safe loop unchanged */
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
Client / attacker -> TAPI RPC -> tapisrv!RemoteGetAddressStatus ->
server-side marshalling -> LGetAddressStatus
    -> driver callback (*v19) fills LINEADDRESSSTATUS in caller buffer
    -> unchecked forward-list loop clobbers stack -> EIP / RIP smash.

Attack Vector
--------------------------------------------------------------------
An unauthenticated network attacker that can reach the Telephony RPC
endpoint (ncacn_np: \\pipe\tapi) sends a crafted lineGetAddressStatus
request causing the server to build a malicious LINEADDRESSSTATUS with
manipulated dwForwardNumEntries and dwForwardOffset values.

Patch Description
--------------------------------------------------------------------
The patch introduces explicit 64-bit arithmetic and three boundary
checks that ensure:
 1. 32*dwForwardNumEntries does not overflow 32 bits.
 2. offset + size does not wrap around.
 3. offset + size is bounded by dwTotalSize.
On failure the function logs an error, zeros the entry count, and
returns 0x8000000D.  The fix is guarded by a feature flag but is
expected to be enabled on all supported systems.

Security Impact
--------------------------------------------------------------------
Prior to the patch the unchecked loop allowed writes beyond the caller
buffer, corrupting the tapisrv stack and enabling arbitrary code
execution in the Telephony Service, leading to a SYSTEM-level remote
code execution (RCE) vulnerability.  Successful exploitation provides
full OS compromise.

Fix Effectiveness
--------------------------------------------------------------------
The added 64-bit size calculations and three relational checks fully
cover the integer-overflow and bounds-checking gaps that led to the
overflow.  Provided the feature flag remains enabled, the patch is
considered effective; no residual write primitive is observable in the
updated code path.
