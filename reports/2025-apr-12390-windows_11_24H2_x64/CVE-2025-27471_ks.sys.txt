{'cve': 'CVE-2025-27471', 'confidence': 0.11, 'file': 'ks.sys', 'date': 1751822661.8651147, 'kb': 'KB5055523', 'change_count': 16, 'patch_store_uid': '70e3bf67-1567-411c-af77-267a00e80496'}
--------------------------------------------------------------------
CVE-2025-27471 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Kernel Streaming driver (ks.sys) – MDL-cache handling, post-
probe processing, queue transfer, and KsProbeStreamIrp routines.

Vulnerability Class
--------------------------------------------------------------------
Input-validation error leading to NULL-pointer dereference / kernel
crash (Denial-of-Service).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Streaming IRPs contain a sequence of 0x38-byte KSPMDLCACHED buffer
headers.  Offset +0x30 of each header holds a 64-bit data pointer;
offset +0x30 of dword[12] (flags) contains bits 0x8000 / 0x10000 /
0x18000 that indicate the pointer refers to user memory, device
memory, or a special 4-k page.

Before the patch three different paths –
  • CKsMdlcache::MdlCacheHandleThunkBufferIrp
  • KsProbeStreamIrp
  • CKsQueue::TransferKsIrp
validated the pointer only when an internal diagnostic switch
("Feature_2092524859__private_IsEnabledDeviceUsageNoInline") was
enabled.  With the switch disabled (default on production builds)
a header could set 0x8000/0x18000 while leaving the data pointer
NULL.

The code then executed
    IoAllocateMdl(ptr /*==NULL*/, length, …)
producing an MDL whose StartVa is 0.  Later stages tried to map or
copy the payload:
    MappedSystemVa = MmMapLockedPagesSpecifyCache(mdl,…);
    memmove(dst, *(void **)header+0x28, length);
Dereferencing address 0 or mapping page frame 0 causes a bugcheck
(PAGE_FAULT_IN_NONPAGED_AREA or IRQL_NOT_LESS_OR_EQUAL), crashing the
system and denying service to all users.  No privileges are required
beyond the ability to send a crafted KS streaming request.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before (MdlCacheHandleThunkBufferIrp)
if ((UserHdr[12] & 0x8000) &&
    Feature_2092524859__private_IsEnabledDeviceUsageNoInline() &&
    !*((uint64_t*)UserHdr + 5))
        goto error;
// after – feature gate removed, check is unconditional
if (!*((uint64_t*)UserHdr + 5))
        return STATUS_INVALID_PARAMETER;
```
```c
// before (KsProbeStreamIrp)
if ((Flags & 0x18000) &&
    Feature_2092524859__private_IsEnabledDeviceUsageNoInline() &&
    !DataPtr)
        ExRaiseStatus(STATUS_INVALID_PARAMETER);
// after – always enforced
if ((Flags & 0x18000) && !DataPtr)
        ExRaiseStatus(STATUS_INVALID_PARAMETER);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker sends crafted KS IRP with at least one 0x38-byte header.
2. Header sets Flags bit 0x8000 or 0x18000 and Length > 0.
3. Data pointer field is NULL.
4. CKsMdlcache::MdlCacheHandleThunkBufferIrp / KsProbeStreamIrp calls
   IoAllocateMdl(NULL,…), building MDL with StartVa==0.
5. Subsequent MmMapLockedPagesSpecifyCache or memmove touches the NULL
   address in kernel context ⇒ bugcheck ⇒ system reboot.

Attack Vector
--------------------------------------------------------------------
Any local or network client that can issue IOCTL_KS_READ_STREAM or
similar streaming requests to ks.sys can supply the malformed header.
No authentication or code-execution privilege is required – only the
ability to open the KS filter pin.

Patch Description
--------------------------------------------------------------------
• Removed all feature-flag gates around pointer validation.
• Added unconditional NULL-pointer checks in
  - CKsMdlcache::MdlCacheHandleThunkBufferIrp
  - KsProbeStreamIrp
  - CKsMdlcache::MdlCacheProcessPostProbeIrp
  - CKsQueue::TransferKsIrp
• Early returns STATUS_INVALID_PARAMETER when pointer is NULL.
• Minor refactors (variable renames, tracing GUIDs) but no functional
  impact on the fix.

Security Impact
--------------------------------------------------------------------
Unauthenticated attackers could reliably crash Windows systems,
causing a complete denial of service.  No information disclosure or
privilege escalation is implied, but the crash interrupts all running
workloads.

Fix Effectiveness
--------------------------------------------------------------------
After the patch, every path that handles a descriptor with 0x8000 /
0x18000 / 0x10000 now refuses the IRP when the associated data pointer
is NULL.  Because MDLs are never created for address 0, subsequent
mapping/dereference cannot occur, eliminating the crash condition.
Static inspection shows no remaining path bypassing the new check and
no new attack surface introduced.

