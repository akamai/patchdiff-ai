{'kb': 'KB5055523', 'change_count': 2, 'confidence': 0.29, 'file': 'tapisrv.dll', 'date': 1751822576.089497, 'patch_store_uid': '38b57009-9f8e-4426-8142-2d7f8db5f6f2', 'cve': 'CVE-2025-21222'}
--------------------------------------------------------------------
CVE-2025-21222 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Telephony Service (tapisrv.dll).  Vulnerable routine
is LGetAddressStatus, which is exposed through the Telephony API (TAPI)
RPC interface.

Vulnerability Class
--------------------------------------------------------------------
Heap-based buffer overflow / out-of-bounds write (CWE-122).

Detailed Root Cause Analysis
--------------------------------------------------------------------
LGetAddressStatus receives a LINE_ADDRESS_STATUS structure from an
untrusted telephony provider or RPC client.  Parameter a4 points to the
buffer; element 0 (a4[0]) contains dwTotalSize.  When message type
65539 (LINE_ADDRESS_STATE) is processed the function sanitises each
LINEFORWARD entry that starts at offset a4[11] (dwForwardOffset) and is
repeated a4[9] (dwForwardNumEntries) times, each 32 bytes long.

Prior to the patch the code built the pointer

    v12 = (DWORD *)((BYTE*)a4 + dwForwardOffset);

and iterated a4[9] times, writing one DWORD within every 32-byte slot
without checking that

    dwForwardOffset + (dwForwardNumEntries * 32) <= dwTotalSize

or that the 32-bit arithmetic did not overflow.  A malicious caller can
supply a small dwTotalSize together with a large offset/count so that
v12 points beyond the allocated heap block, causing multiple four-byte
writes past the end of the buffer.  The overwritten memory belongs to
the process heap, enabling controlled heap corruption and code
execution in the Telephony Service (runs as NT AUTHORITY\NetworkService
by default).

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
/* vulnerable loop – before patch */
v11 = a4[9];
if (v11) {
    v12 = (DWORD *)((char *)a4 + (unsigned int)a4[11]);
    do {
        if ((*v12 & 0x30000) != 0)
            *v12 = *v12 & 0xFFFCFFFE | 1;   // out-of-bounds write
        v12 += 8;                           // 32-byte stride
    } while (--v11);
}

/* fix – after patch */
if (Feature_3235131707__private_IsEnabledDeviceUsageNoInline()) {
    req = 32ull * a4[9];
    if (req > 0xFFFFFFFF || req + a4[11] < a4[11] || a4[0] < req + a4[11]) {
        TRACELogPrint(65538, "LGetAddressStatus: invalid forward list");
        a4[9] = 0;                 // stop processing
        *a2 = -2147483595;         // ERROR_INVALID_PARAMETER
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Remote attacker sends a crafted TAPI RPC request.
2. Request reaches LGetAddressStatus with attacker-controlled
   LINE_ADDRESS_STATUS buffer.
3. InitTapiStruct allocates dwTotalSize bytes and copies the buffer.
4. Unchecked loop writes past the end of the allocation.
5. Heap corruption leads to process control and remote code execution.

Attack Vector
--------------------------------------------------------------------
Unauthenticated network traffic to the Telephony Service’s RPC endpoint
carrying a malicious LINE_ADDRESS_STATUS structure.

Patch Description
--------------------------------------------------------------------
The patch adds explicit integer-overflow and bounds checks before the
loop executes:
  • requiredSize = 32 * dwForwardNumEntries (performed in 64 bits).
  • Fail if multiplication exceeds 4 GB, wraps, or the resulting end
    offset exceeds dwTotalSize.
  • On failure the code logs, zeroes dwForwardNumEntries, and returns
    ERROR_INVALID_PARAMETER, preventing any out-of-bounds access.

Security Impact
--------------------------------------------------------------------
Exploitation of the overflow allows a remote attacker to execute
arbitrary code in the Telephony Service context, leading to a complete
break of service isolation and potential system compromise.

Fix Effectiveness
--------------------------------------------------------------------
The added size and overflow validations guarantee that the forward list
lies fully inside the allocated structure, closing the only path that
led to heap corruption.  No other writes to the list are performed
without the same checks, so the remediation is considered complete.
