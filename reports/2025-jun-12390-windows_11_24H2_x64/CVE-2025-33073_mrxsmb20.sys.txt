{'kb': 'KB5060842', 'patch_store_uid': '17962b99-8d67-4355-a10e-0dc627626a42', 'confidence': 0.17, 'date': 1763417318.511233, 'file': 'mrxsmb20.sys', 'cve': 'CVE-2025-33073', 'change_count': 1}
--------------------------------------------------------------------
CVE-2025-33073 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows SMB v2/v3 client driver (mrxsmb20.sys) – routine
Smb2Fsctl_Finalize that completes SMB2 IOCTL/FSCTL requests.


Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Missing Output-buffer Validation (CWE-284).


Detailed Root Cause Analysis
--------------------------------------------------------------------
Smb2Fsctl_Finalize is invoked when an SMB2 IOCTL (FSCTL) operation
completes.  The RxContext for the request is referenced through

  v4 = *(QWORD *)(a1 + 48);           // RX_CONTEXT
  *(DWORD *)(v4 + 524)                // IoControlCode
  *(QWORD *)(v4 + 184)                // Output-buffer length
  *(QWORD *)(a1 + 1992)               // Mdl / system address of buffer

For the FSCTL whose code equals 0x90444 (decimal 590468) the routine
used to return to caller without validating that the server-supplied
FILE_REGION output structure actually fits into the user-supplied
buffer.

If a malicious SMB server set an artificially large Length field in the
network response, *(DWORD *)(v4 + 184) would contain the oversized
value.  The driver would later copy that many bytes into the caller’s
buffer (or into kernel bookkeeping structures) leading to:

  • Out-of-bounds read/write in kernel address space
  • Potential kernel stack/heap corruption
  • Privilege escalation for the local caller that issued the FSCTL.

The patch introduces a size/veracity check by calling:

  FsRtlValidateFileRegionOutputBuffer(
        v4 + 184,                // reported size
        *(DWORD *)(a1 + 2000),   // element size / alignment
        *(QWORD *)(a1 + 1992),   // buffer base
        v2);                     // NTSTATUS

The validation is only executed when

  * IoControlCode == 0x90444, and
  * the operation completed with an error (NT_ERROR(status) ||
    status == STATUS_BUFFER_OVERFLOW), and
  * the Feature_H2E_WPA3SAE feature flag is enabled (gating for
    down-level OS builds).

Prior to the patch no analogous check existed, leaving the kernel state
fully trusting the remote server’s length field.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE
if (*(DWORD *)(v4 + 524) == 589992 &&
    ((int)(v2 + 0x80000000) < 0 || v2 == -2147483643))
{
    v2 = FsRtlValidateReparsePointBufferEx(...);
}
// no handling for IoControlCode 590468 (0x90444)

// AFTER
if (*(DWORD *)(v4 + 524) == 589992 &&
    (((v2 + 0x80000000) & 0x80000000) != 0 ||
     v2 == -2147483643))
{
    v2 = FsRtlValidateReparsePointBufferEx(...);
}

if (Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_0() &&
    *(DWORD *)(v4 + 524) == 590468 &&
    (((v2 + 0x80000000) & 0x80000000) != 0 ||
     v2 == -2147483643))
{
    v2 = FsRtlValidateFileRegionOutputBuffer(
            v4 + 184,
            *(DWORD *)(a1 + 2000),
            *(QWORD *)(a1 + 1992),
            v2);
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Local low-privilege process issues DeviceIoControl to the SMB RsFx
   redirector targeting a remote share with FSCTL code 0x90444.
2. Malicious SMB server replies with crafted FILE_REGION response where
   Length > real buffer size.
3. Smb2Fsctl_Finalize trusts *(DWORD *)(v4 + 184) and later copies that
   many bytes to user buffer or internal kernel memory.
4. Memory corruption or privilege escalation occurs in kernel context.


Attack Vector
--------------------------------------------------------------------
Authenticated network attacker controlling an SMB server that the
victim machine connects to.  The local victim process only needs the
ability to open the share – no special privileges required.  The server
sends an oversized FILE_REGION reply to elevate the local user or
execute code in kernel mode on the client machine.


Patch Description
--------------------------------------------------------------------
1. Added explicit size validation for FSCTL 0x90444 via
   FsRtlValidateFileRegionOutputBuffer.
2. Corrected logic that determines whether the earlier operation status
   is success or failure (reversed sign checks).
3. Minor refactoring/renaming; no functional impact beyond validation.

The new validation aborts the request with STATUS_INVALID_PARAMETER if
any of the following is true:
   • Reported length < required header size
   • Reported length not aligned
   • Reported length would overflow the caller’s buffer.


Security Impact
--------------------------------------------------------------------
Before the fix, remote servers could coerce the Windows SMB client into
kernel memory corruption, allowing local elevation of privilege or
potential remote code execution in kernel context.  Exploitation does
not require administrator rights on the client.


Fix Effectiveness
--------------------------------------------------------------------
The added FsRtlValidateFileRegionOutputBuffer routine centrally
verifies buffer boundaries, fully preventing the length mismatch that
enabled the overwrite.  The validation is performed before any data is
consumed or copied, and negative status is propagated back to user
mode, eliminating the vulnerability.

--------------------------------------------------------------------
