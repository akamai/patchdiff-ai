{'kb': 'KB5060842', 'change_count': 1, 'file': 'schedsvc.dll', 'date': 1763415484.284712, 'patch_store_uid': '5224ce6c-53d8-4d16-9ea7-a9aee7a1ccf2', 'confidence': 0.47, 'cve': 'CVE-2025-33067'}
--------------------------------------------------------------------
CVE-2025-33067 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Task Scheduler service (schedsvc.dll), function
JobStore::RegFolderEntryCreate, which is responsible for creating
registry keys representing task folders below
HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree.

Vulnerability Class
--------------------------------------------------------------------
Improper Privilege Management / Access-control flaw (CWE-269).

Detailed Root Cause Analysis
--------------------------------------------------------------------
JobStore::RegFolderEntryCreate runs in the Task Scheduler service
context (NT AUTHORITY\SYSTEM).  It receives:
  a2  -> UTF-16 folder path requested by the client
  a3  -> JobSecurity object containing a caller-supplied security
         descriptor (SD)

Before the patch the function executed the following sequence:
1. Build a full registry path
   "TaskCache\\Tree\\<folder>" and call RegCreateKeyExW.
2. Ignore the value returned in the out parameter
   "lpdwDisposition" (always passed as NULL).
   Therefore the code could not know whether the key was
   newly created (REG_CREATED_NEW_KEY) or whether it already
   existed (REG_OPENED_EXISTING_KEY).
3. Immediately call JobSecurity::StreamOut(a3, hKey) to write the
   caller-controlled SD into the just opened key, regardless of
   whether the key pre-existed.

If a low-privileged user called ITaskFolder::CreateFolder with a
path that already existed and supplied a permissive SD, the service
would reopen that existing key under SYSTEM and overwrite its
security.  Because the key controls access to all tasks inside the
folder, the attacker could afterwards create or tamper with tasks
that run with higher privileges, achieving local elevation.
No validation of the caller’s right to change the SD was done; the
only gate was the ability to call the public COM API.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE
RegCreateKeyExW(this[2], lpSubKey, 0, NULL, 0,
               KEY_ALL_ACCESS, &SecurityAttributes, &hKey, NULL);
...
JobSecurity::StreamOut(a3, hKey);   // always executed

// AFTER
DWORD dwDisposition = 0;
RegCreateKeyExW(v8, lpSubKey, 0, NULL, 0,
               KEY_ALL_ACCESS, &SecurityAttributes,
               &phkResult, &dwDisposition);
if (dwDisposition == REG_OPENED_EXISTING_KEY) {
    v11 = ERROR_ALREADY_EXISTS;     // bail out, do NOT write SD
} else {
    v11 = JobSecurity::StreamOut(a3, phkResult);
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker (standard user) obtains an ITaskFolder interface.
2. Calls ITaskFolder::CreateFolder(L"\\ExistingFolder", <crafted SD>).
3. Scheduler service reaches JobStore::RegFolderEntryCreate.
4. RegCreateKeyExW re-opens already existing registry key;
   dwDisposition == REG_OPENED_EXISTING_KEY.
5. In vulnerable build, StreamOut overwrites the SD with the
   attacker’s descriptor, giving the attacker full control.
6. Attacker creates/modifies tasks inside that folder that execute
   as SYSTEM, escalating privileges.

Attack Vector
--------------------------------------------------------------------
Local.  Any authenticated user able to reach the Task Scheduler COM
API can exploit the flaw; no administrative privileges are
required.

Patch Description
--------------------------------------------------------------------
1. Adds an out variable dwDisposition and requests it from
   RegCreateKeyExW.
2. If the disposition equals REG_OPENED_EXISTING_KEY (2), the
   function returns ERROR_ALREADY_EXISTS (0x80070059) and skips
   JobSecurity::StreamOut, preventing SD overwrite.
3. Keeps former behaviour only when the key is newly created.
4. Surrounds new logic with a feature flag but the correct path is
   executed when the flag is enabled.
5. Minor clean-ups: initializes BSTR with operator=, zeroes the
   SECURITY_ATTRIBUTES tail, uses typed variable names.

Security Impact
--------------------------------------------------------------------
Before the fix a non-privileged user could replace the security
descriptor of any pre-existing task folder registry key, thereby
gaining the ability to create or manipulate scheduled tasks that run
under higher privileges (up to SYSTEM).  This yields full local
privilege escalation.

Fix Effectiveness
--------------------------------------------------------------------
The new disposition check blocks security-descriptor rewriting for
existing keys, eliminating the direct privilege-escalation path.
The change is scoped to the only code path that handled folder
creation, so the mitigation appears complete.  Remaining risk is the
feature-flag gate; if the flag is disabled the old vulnerable path
is still present.  Assuming the flag ships enabled to all users, the
fix is effective.
