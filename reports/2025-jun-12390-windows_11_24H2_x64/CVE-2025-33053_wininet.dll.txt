{'patch_store_uid': '3994ce08-e0d7-4ec7-b96d-025a28c3b2b1', 'change_count': 232, 'confidence': 0.24, 'cve': 'CVE-2025-33053', 'date': 1763415642.1830914, 'file': 'wininet.dll', 'kb': 'KB5060842'}
--------------------------------------------------------------------
CVE-2025-33053 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
wininet.dll – mainly the helper routine CreateUrlCacheEntryHelper(), with
collateral hardening in NewStringW(), CCacheClientConfig::
GetCookiesContainerInfo() and CCacheServerContainer::AddUrl().  These
routines are involved in creating the on-disk file that backs a URL
cache entry (e.g. when an Internet Shortcut *.url file is processed).

Vulnerability Class
--------------------------------------------------------------------
Path traversal / arbitrary file creation (CWE-73: External Control of
File Name or Path), which can be leveraged for remote code execution.

Detailed Root Cause Analysis
--------------------------------------------------------------------
Before the patch CreateUrlCacheEntryHelper() executed the following
sequence:

 1. UrlCacheGetContainer(url, &Container)
 2. CCacheClientContainer::CreateUniqueFile(Container, url, a2, a3,
    a4, …)

Parameter a4 is the caller-supplied *local file name* that should be
placed inside the cache directory.  The function passed this buffer
verbatim to CreateUniqueFile() without any validation or canonicalisa-
tion.  CreateUniqueFile() concatenates the container root with the
string in a4 and then calls NtCreateFile.  If a4 contains components
such as "..\..\Windows\Start Menu\Programs\Startup\evil.bat" or an
absolute path beginning with "C:\", the resulting fully-qualified path
escapes the cache directory.  Because wininet runs in the context of
the current user, the attacker gains the ability to create or overwrite
arbitrary files, enabling code execution on next logon or at system
start-up.

Key parameters/structures involved
• a4 (unsigned __int16 *): untrusted local-file string coming from the
  Internet Shortcut or HTTP redirect.
• CCacheClientContainer: holds the trusted base directory in members
  +0x30/0x40.
• CreateUniqueFile(): ultimately issues the file create with
  FILE_GENERIC_WRITE.

No check was performed for:
• presence of "..", drive letters, or UNC prefixes
• maximum path length or NT prefix ("\\?\").

Patch behaviour (new flow)
1. Container initialisation is re-validated by
   CCacheClientContainer::InitializeFileManager().
2. The base directory (Container->Path, Container->Suffix) is copied
   while the structure is protected by a critical section.
3. CWxString::SetPath() is invoked to concatenate and *canonicalise*
   the parts; the routine returns an HRESULT on failure.
4. The validated, canonical path is given to CreateUniqueCacheFile()
   (note the new name) instead of passing user data directly.
5. Error codes are normalised and extensive tracing added for auditing.
6. The a4 parameter is now declared const, making in-place mutation
   impossible.

The additional hardening in NewStringW() prevents NULL-pointer
processing and length overflow when converting wide strings; other
helper changes only add bookkeeping and error propagation and are not
security relevant by themselves.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// pre-patch CreateUrlCacheEntryHelper()
Container = UrlCacheGetContainer(a1, &v13);
if (Container >= 0)
    Container = CCacheClientContainer::CreateUniqueFile(
                  v13, a1, a2, a3, a4, a5, a6, a7); // a4 unvalidated
```

```c
// patched flow (excerpt)
Container = CCacheClientContainer::InitializeFileManager(v12);
...
Container = CWxString::SetPath((CWxString *)v31,
                               *(const unsigned __int16 **)(v13+48),
                               *(const unsigned __int16 **)(v13+64),
                               0, ...);
...
Container = CreateUniqueCacheFile(v17, a1, a2, a3, a4, ...);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User opens a malicious Internet Shortcut (*.url) hosted remotely.
2. ShellExecute() loads wininet which calls CreateUrlCacheEntryHelper()
   to materialise the shortcut in the cache.
3. Unpatched code propagates the attacker-controlled path to
   NtCreateFile, creating arbitrary files.
4. Attacker writes a payload (e.g. DLL, BAT, MSI) into a privileged
   location such as the Startup folder -> code executes on next logon.

Attack Vector
--------------------------------------------------------------------
Remote delivery of a crafted *.url file (e-mail, web download, shared
folder).  No user interaction beyond opening/saving the shortcut is
required.

Patch Description
--------------------------------------------------------------------
• Introduced thorough path construction via CWxString::SetPath() which
  strips traversal elements and guarantees the final path is rooted
  under the container directory.
• Wrapped access to container fields in a critical section.
• Converted *a4 to const and renamed the sink to CreateUniqueCacheFile()
  to emphasise isolation.
• Added status propagation, InitOnce gating, extensive WPP and ETW
  tracing, and hardened wide-string helper (NewStringW) to avoid
  secondary overflows.

Security Impact
--------------------------------------------------------------------
Before the fix a remote attacker could create or overwrite arbitrary
files anywhere writable by the current user, enabling reliable remote
code execution.  The vulnerability is therefore rated high/critical.

Fix Effectiveness
--------------------------------------------------------------------
The canonicalisation step now rejects invalid components and guarantees
that only a descendant of the cache directory is used, effectively
removing the directory-traversal primitive.  Unless CWxString::SetPath()
contains logic errors (not observable from the diff) the patch fully
addresses the reported issue.
