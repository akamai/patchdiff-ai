{'kb': 'KB5060842', 'patch_store_uid': 'fc8f3bd4-dcdd-48c9-ad3f-47132b7cc84f', 'date': 1763417304.7010572, 'cve': 'CVE-2025-33065', 'change_count': 67, 'confidence': 0.14, 'file': 'mispace.dll'}
--------------------------------------------------------------------
CVE-2025-33065 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
mispace.dll  (Windows Storage Management Provider – Storage           
Management WMI/shims).  Affected helper routines are                  
Pmc_StorageJob_WriteMessage, Pmc_Disk_CreateVolume and                
CPmEnumerationFilter::Extract.

Vulnerability Class
--------------------------------------------------------------------
Out-of-bounds read (CWE-125) leading to information disclosure to     
local, authorised callers.

Detailed Root Cause Analysis
--------------------------------------------------------------------
The provider receives a caller-supplied binary blob that is expected  
to contain an internal “Enumeration Filter / Storage Job” structure   
followed by an optional UTF-16 string.  Two critical fields inside    
this blob are                                                     
  • DWORD 0  – total buffer length                                   
  • DWORD 7  – offset to the tail string (words from buffer start)    

Prior to the patch, routines validated only two conditions:           
    (bufferLen > 8) && (blob->TotalLength <= bufferLen)               
No verification was performed on the embedded offset, the string      
termination, or the minimum structure size.                          
                                                                     
In Pmc_StorageJob_WriteMessage:                                       
    v9  = a3[12];                      // severity / type             
    v10 = (char*)a3 + a3[7];           // pointer to message string   
    WspWriteMessage(&guid, v9, v10);   // blind read of memory        
If a3[7] is larger than the input buffer, v10 points outside the      
caller-supplied region and WspWriteMessage dereferences arbitrary     
kernel memory, returning its content to user mode.                    
                                                                     
The same offset is copied and trusted by CPmEnumerationFilter::Extract
and Pmc_Disk_CreateVolume, allowing the same memory disclosure path   
through multiple public entry points.                                 

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before
if (a2 <= 8 || *(_DWORD *)a3 > a2) return 87;   // weak check
v10 = (char *)a3 + *((unsigned int *)a3 + 7);    // unvalidated
WspWriteMessage(&v15, a3[12], v10);              // OOB read

// After
if (a2 < 0x20) return 87;                        // min size
if (*a3 > a2) return 87;                         // total <= buf
v10 = a3[7];                                     // offset
if ( v10 < a3[1] || v10 > *a3 || (v10 & 1) ||    // range/align
     StringCbLengthW((WCHAR*)a3 + v10/2,         
                     *a3 - v10, &len) < 0 )      // NUL-terminated
     return 87;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User calls a storage-management API (e.g., via WMI / Storage       
   Management cmdlets) that ultimately marshals to                   
   Pmc_StorageJob_WriteMessage / Pmc_Disk_CreateVolume.              
2. Craft the on-wire blob so that                                    
      TotalLength == declared length                                  
      Offset-to-string  > declared length                             
3. mispace.dll copies Offset into v10 and passes the pointer to       
   WspWriteMessage without further checks.                           
4. Kernel reads memory past the end of the caller buffer and sends it 
   back to user space, disclosing arbitrary kernel memory.           

Attack Vector
--------------------------------------------------------------------
Local, authenticated user who can invoke the Storage Management       
provider (for example PowerShell cmdlet Connect-MSiSCSIInitiator,     
Disk Management snap-in, or direct WMI calls) supplies a malicious    
parameter blob.  No special privileges beyond provider access are     
required.

Patch Description
--------------------------------------------------------------------
1. Changed buffer parameter type from WORD* to DWORD* to enforce      
   DWORD granularity.                                                
2. Added explicit size/offset/alignment validation:                   
      • minimum structure size (>=0x20 / 0x30 bytes)                  
      • offset must be >= header, <= total, even-aligned              
      • string length validated with StringCbLengthW                  
3. Added guard using Feature flag 2578215227 to enable new checks     
   without breaking older deployments.                                
4. Similar length-range checks added to CPmEnumerationFilter::Extract 
   and Pmc_Disk_CreateVolume.                                         
5. Error logging line numbers/tags updated accordingly.               

Security Impact
--------------------------------------------------------------------
Prior to the fix an attacker could cause the provider to copy and     
return arbitrary kernel memory, potentially exposing sensitive data   
such as kernel pointers or credentials, facilitating further local    
attacks (KASLR bypass etc.).  Scope is information disclosure; no     
code execution identified.

Fix Effectiveness
--------------------------------------------------------------------
Added validations correctly reject malformed blobs that previously    
triggered the out-of-bounds read.  Remaining legacy path is executed  
only when the new Feature flag is disabled; default Windows builds    
enable the feature, so the risk is mitigated in practice.  No         
residual read beyond bounds observed under the new validation logic.  
Nevertheless, disabling the feature would re-activate the legacy path
(unknown deployment scenarios).  Regression testing recommended.

