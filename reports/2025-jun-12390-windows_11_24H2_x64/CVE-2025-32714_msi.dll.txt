{'kb': 'KB5060842', 'change_count': 13, 'confidence': 0.27, 'cve': 'CVE-2025-32714', 'date': 1763416843.9731092, 'patch_store_uid': 'a368fe0d-9e6c-4521-9671-fa9b783254fa', 'file': 'msi.dll'}
--------------------------------------------------------------------
CVE-2025-32714 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Installer (msi.dll) –  runtime file-operation helpers:
 • CMsiOpExecute::ReplaceFileOnReboot
 • CMsiOpExecute::ixfFileRemove
 • CMsiOpExecute::CreateFileFromData
 • CMsiExecute::RunInstallScript
 • VerifyMsiObjectAgainstSAFER


Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Privilege-elevation through unsafe system
file replacement (CWE-284).


Detailed Root Cause Analysis
--------------------------------------------------------------------
Prior to the patch, CMsiOpExecute::ReplaceFileOnReboot() blindly
invoked
    MoveFileExW(src,dst,MOVEFILE_DELAY_UNTIL_REBOOT|…)
under the SYSTEM account.  The routine was reachable from a user-
provided MSI script (ixfFileRemove → ReplaceFileOnReboot).  Nothing
verified that
  • the caller owned the source file, or
  • the destination path was outside the protected system drive, or
  • the invoking token was administrative.

Consequently a non-privileged user could embed a crafted
FileRemove/FileReplace action in a locally-run MSI.  When the
installer service (msiexec.exe, running as NT AUTHORITY\SYSTEM)
processed the script it scheduled an arbitrary, attacker-controlled
file to overwrite a high-integrity system file after reboot, leading
to full SYSTEM code execution.

Patch  adds:
 1.  A feature-gate (Feature_3843093816) and helper class
     AppIdHelper used to collect operation context.
 2.  CheckSystemDrivePath() – validates the *source* path lies on the
     system drive and returns a classification.
 3.  Enforcement logic:
        if (!IsAdmin() && !GetAISToken() && !GetAISFlag() &&
            CheckSystemDrivePath()!=1)
            abort;
 4.  Early returns (goto LABEL_28) before the dangerous MoveFileExW
     call when the above test fails.

Similar privilege / path-validation hooks are inserted in
CreateFileFromData(), ixfFileRemove() and RunInstallScript() so that
file creation, deletion and script execution now collect file
information and respect the same policy checks.  VerifyMsiObject-
AgainstSAFER() is instrumented to reset AppIdHelper state so that the
new policy is consistently applied.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before – ReplaceFileOnReboot, no privilege / path checks
CElevate elev(1);
MoveFileExW(src,dst, MOVEFILE_DELAY_UNTIL_REBOOT);
```

```c
// after – privilege & path validation
if (FeatureEnabled()) {
    AISToken = GetAISToken();
    AISFlag  = GetAISFlag();
    if (CheckSystemDrivePath(src,&flag)!=1)      goto fail;
    if (!IsAdmin() && !AISToken && !AISFlag && flag!=1)
        goto fail;              // blocks un-privileged caller
}
CElevate elev(1);
MoveFileExW(src,dst, MOVEFILE_DELAY_UNTIL_REBOOT);
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privilege attacker launches msiexec /i evil.msi
2. CMsiExecute::RunInstallScript parses embedded actions
3. ixfFileRemove → ReplaceFileOnReboot executed as SYSTEM
4. Pre-patch: MoveFileExW schedules overwrite of
   %SystemRoot%\system32\drivers\vuln.sys with attacker file
5. Reboot → system file replaced → attacker gains SYSTEM


Attack Vector
--------------------------------------------------------------------
Local.  An authenticated user crafts / modifies an MSI package that
contains a FileRemove or ReplaceFile action targeting an arbitrary
system-drive file and installs it on the machine.


Patch Description
--------------------------------------------------------------------
• Introduces new WIL feature gate “AutoIdentityGenerationHook”.
• Adds AppIdHelper to collect user SID, package name and per-file
  metadata.
• Inserts privilege & path checks (IsAdmin, AIS token, system-drive
  path) before any MoveFileExW / Delete / CreateFile that targets
  reboot-time replacement.
• Blocks the operation and returns error 0/3 when validation fails.
• Additional instrumentation in helper functions ensures the same
  policy is enforced for file creation and removal during install.


Security Impact
--------------------------------------------------------------------
Before the fix, any local user could escalate to NT AUTHORITY\SYSTEM
by scheduling the replacement of a protected system file via Windows
Installer.  The patch prevents non-elevated callers from touching
system-drive paths unless they possess administrative rights or a
special AIS token.


Fix Effectiveness
--------------------------------------------------------------------
The added privilege and path validation removes the direct
vulnerability surface.  File-replace requests from non-administrators
now fail early, and normal administrative installs continue to work.
No bypass is known with the patched logic; residual risk is
considered low.

