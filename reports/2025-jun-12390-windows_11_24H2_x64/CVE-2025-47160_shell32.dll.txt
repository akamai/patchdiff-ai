{'date': 1763415683.5856595, 'kb': 'KB5060842', 'cve': 'CVE-2025-47160', 'file': 'shell32.dll', 'confidence': 0.2, 'change_count': 621, 'patch_store_uid': '64ea4d34-cd00-491c-9cb4-69ae2c642f68'}
--------------------------------------------------------------------
CVE-2025-47160 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Shell (shell32.dll) shortcut (.LNK) handling, new helper
function IsLinkTargetUnusual() introduced in the patch.

Vulnerability Class
--------------------------------------------------------------------
Protection-mechanism failure / security feature bypass (CWE-693).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Before the patch the Shell validation logic had no dedicated test to
classify a shortcut target as "unusual".  Down-stream code therefore
assumed that the target string returned by IShellLinkW::GetPath fitted
into the classic MAX_PATH sized buffer (260 WCHARs) and contained no
problematic characters.  Two separate edge cases were not covered:

1. Long target paths – when the real link target exceeded 260
   characters IShellLinkW::GetPath replied with
   HRESULT = 0x8007007A (ERROR_INSUFFICIENT_BUFFER) but the caller did
   not treat this as a failure.  The truncated path was consequently
   handled as if it had been completely validated.

2. Embedded command-line arguments – a shortcut can contain additional
   arguments stored in the PKEY_Link_Arguments property. These
   arguments were not inspected for shell-meta characters.  Crafting a
   string such as "powershell.exe -Command … &" allowed an attacker to
   smuggle special characters that should have triggered a warning.

Because of these omissions the overall "is this link suspicious?"
heuristic could be bypassed.  A remote attacker able to supply a LNK
file (for example over SMB/WebDAV or in a ZIP) could construct a path
longer than 260 characters and/or inject special characters into the
argument property.  The shell would fail to classify the file as
unusual and would therefore skip subsequent security checks or user
prompts that rely on that classification.

Structures/parameters involved:
• IShellLinkW vtable – GetPath, QueryInterface
• PROPERTYKEY PKEY_Link_Arguments
• 260-WCHAR stack buffer supplied to GetPath
• Link flags returned by SetLinkFlags(); bits 0x20 and 0x1000 were
  consulted by the new routine.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// NEW in patch – shortened for clarity
bool __fastcall IsLinkTargetUnusual(IShellLinkW *psl)
{
    WCHAR sz[264] = {0};
    WORD flags = SetLinkFlags(psl, 0, 0);
    if (flags & 0x1000)           // early exit for some benign flags
        return false;

    HRESULT hr = psl->lpVtbl->GetPath(psl, sz, 260, 0, 0);
    if (hr == 0x8007007A)         // ERROR_INSUFFICIENT_BUFFER
        return true;              // path did not fit – unusual

    if (SUCCEEDED(hr)) {
        PathQuoteSpacesW(sz);
        size_t len = wcslen(sz);
        if (flags & 0x20) {       // link has extra arguments
            /* fetch argument string and scan for specials */
            if (HasSpecialChars(argString))
                return true;
            len += wcslen(argString) + 1;
        }
        return len >= 0x104;      // >260 characters → unusual
    }
    return false;
}
```
Prior to the patch the above routine did not exist; the caller simply
proceeded after GetPath(), ignoring both the 0x8007007A error and the
argument string contents.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User opens or previews a crafted .LNK file obtained over the network.
2. Shell32 calls IShellLinkW::GetPath with a 260-char buffer.
3. Long path causes ERROR_INSUFFICIENT_BUFFER or is truncated.
4. Because the pre-patch code never classified the link as unusual,
   downstream security prompts (SmartScreen, Zone checks, etc.) are
   skipped.
5. Shortcut executes the attacker-controlled target / arguments without
   usual user consent.

Attack Vector
--------------------------------------------------------------------
Malicious shortcut file delivered over SMB, WebDAV, email attachment or
inside an archive.  Victim only needs to browse to or open the file;
no administrative privileges required.

Patch Description
--------------------------------------------------------------------
The update adds a new helper function IsLinkTargetUnusual() that is
called from the decision path that previously lacked validation.  The
routine:
• Detects ERROR_INSUFFICIENT_BUFFER from GetPath.
• Calculates the total length of target + arguments and flags anything
  >=0x104 (260) characters.
• Extracts PKEY_Link_Arguments and invokes HasSpecialChars() to search
  for shell-meta characters.
• Treats any of the above conditions as "unusual", causing the caller
  to fall back to a safer execution path that invokes additional
  security checks or user warnings.

Security Impact
--------------------------------------------------------------------
Without the patch an attacker could reliably bypass the Windows Shell
"unusual link" heuristic, causing shortcuts with excessively long paths
or dangerous command-line arguments to execute without the standard
security prompt.  This yields a security feature bypass that may be
combined with other vulnerabilities to achieve remote code execution or
privilege escalation.

Fix Effectiveness
--------------------------------------------------------------------
The new code explicitly handles buffer size errors, validates total
length, and scans arguments for special characters.  These checks cover
the previously missed cases and force the caller to treat such links as
unusual.  Assuming all call sites now invoke the helper, the patch
fully addresses the identified bypass.  No residual paths are visible
in the provided diff.
