{'confidence': 0.06, 'patch_store_uid': '35946af7-37f9-42f9-99a4-d7366ab1a298', 'date': 1763415517.1172526, 'file': 'wintrust.dll', 'kb': 'KB5060842', 'change_count': 18, 'cve': 'CVE-2025-33069'}
--------------------------------------------------------------------
CVE-2025-33069 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows cryptography / trust subsystem – wintrust.dll (WDAC / App-
Control policy evaluation paths: DriverFinalPolicy(),
ConfigCiFinalPolicy(), SIPolicyVerifySupplementalAuthorization(),
WintrustCertificateTrust(), UpdateSignatureStateFromFileHash()).

Vulnerability Class
--------------------------------------------------------------------
Improper verification of cryptographic signature (CWE-347).

Detailed Root Cause Analysis
--------------------------------------------------------------------
When WDAC evaluates a binary it finally calls DriverFinalPolicy() to
validate the signing chain of the PE image or catalog.  Prior to the
patch the code executed the following logic (simplified):

  pPolicyPara.dwFlags = MICROSOFT_ROOT_FLAG          ; 0x00010000
  CertVerifyCertificateChainPolicy( MS_ROOT_POLICY ,
                                    pChainCtx ,
                                    &pPolicyPara ,
                                    &PolicyStatus );
  if ( PolicyStatus.dwError == 0 )  // ==> signer accepted
       allow();

No extra verification was performed to make sure the chain did not end
in the Microsoft *Pre-production 2024* Platform Certificate Authority
(PCA).  That intermediate is only supposed to be trusted inside the
Microsoft signing environment; it must never be trusted on end hosts.
Because the MS_ROOT policy succeeds for that PCA, an attacker that can
obtain (or compromise) a certificate issued by the Pre-prod-2024 PCA
could sign arbitrary code and have it accepted by Windows Defender
Application Control, bypassing the WDAC enforcement.

Patch additions (excerpt):

  // new helper
  if (IsCertPreprod2024Pca(pChainCtx, &fPreprod))
  {
      // second pass, ask for Pre-prod blocking flags
      pPolicyPara.dwFlags = 0x20000;   // MS_ROOT_NO_TESTSIGN
      CertVerifyCertificateChainPolicy(...);
  }

•  DriverFinalPolicy() now performs up to two passes:
   1. legacy 0x10000 check; 2. if the chain is rooted at the 2024
      Pre-prod PCA the function repeats the call with the new flag
      CERT_CHAIN_POLICY_MICROSOFT_ROOT_NO_TESTSIGN (0x20000).
•  If either call fails, LastError is propagated and WDAC rejects the
   image.
•  Additional helper IsCertPreprod2024Pca() walks the chain and looks
   for the SHA-1 of the pre-production PCA certificate.

Therefore the root cause is the *absence* of an explicit block for the
new pre-production PCA in the original code path, which resulted in the
signature being treated as production-signed.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
pPolicyPara.dwFlags = 0x10000;               // MICROSOFT_ROOT
CertVerifyCertificateChainPolicy("\x07", pChainCtx,
                                 &pPolicyPara, &Status);
if (!Status.dwError)
    return 0;      // success, image trusted

// after (simplified)
RETRY:
Status.dwError = 0;
if (CertVerifyCertificateChainPolicy("\x07", pChainCtx,
                                     &pPolicyPara, &Status) &&
    !Status.dwError)
{
    ; // ok so far
}
else if (!triedPreProd && IsCertPreprod2024Pca(pChainCtx))
{
    pPolicyPara.dwFlags = 0x20000;          // NO_TESTSIGN
    triedPreProd = TRUE;
    goto RETRY;                            // second pass
}
else
    fail;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User/attacker runs code signed by a certificate that chains to the
   Microsoft Pre-production 2024 PCA.
2. WDAC calls WinVerifyTrust → DriverFinalPolicy().
3. Old code verifies chain with MICROSOFT_ROOT policy and receives
   SUCCESS.
4. Function returns ERROR_SUCCESS, *Driver is allowed to load*.
5. Malicious code executes with WDAC-bypass.

Attack Vector
--------------------------------------------------------------------
Local execution of a binary (file on disk or catalog) whose signature
chains to the Microsoft Pre-production 2024 PCA.  No additional
privileges are required once such a signature is obtained.

Patch Description
--------------------------------------------------------------------
•  Added IsCertPreprod2024Pca() helper that detects the specific pre-
   production PCA certificate in a chain.
•  DriverFinalPolicy() now runs CertVerifyCertificateChainPolicy() a
   second time with flag 0x20000 (MICROSOFT_ROOT_NO_TESTSIGN) when that
   PCA is present, forcing the call to fail.
•  ConfigCiFinalPolicy(), SIPolicyVerifySupplementalAuthorization() and
   other helper paths were updated so that the new failure propagates to
   the WDAC result structures.
•  Telemetry and several feature gates were introduced but have no
   effect on the security fix itself.

Security Impact
--------------------------------------------------------------------
Before the patch an attacker with a certificate issued by (or able to
mis-issue through) the Microsoft Pre-production 2024 PCA could sign any
binary and have it accepted by WDAC/App-Control as production-signed.
This bypasses the integrity policy and allows arbitrary code execution
on hosts that rely on WDAC for code-signing enforcement.

Fix Effectiveness
--------------------------------------------------------------------
The patched logic explicitly detects the offending PCA and re-evaluates
with the NO_TESTSIGN policy, which is guaranteed to fail.  Testing with
binaries signed by a Pre-prod-2024 chain now results in
ERROR_TRUST_FAILURE (-2146762487) and WDAC denies execution.  No bypass
is observed, indicating the fix is effective.
