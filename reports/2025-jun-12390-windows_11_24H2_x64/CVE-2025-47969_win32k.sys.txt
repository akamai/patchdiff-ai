{'file': 'win32k.sys', 'change_count': 9, 'date': 1763417322.5600278, 'kb': 'KB5058411', 'patch_store_uid': '3e3672c9-11f7-46a4-b039-e6038df70db6', 'confidence': 0.11, 'cve': 'CVE-2025-47969'}
--------------------------------------------------------------------
CVE-2025-47969 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
win32k.sys  (Windows Graphics subsystem) – WIL (Windows Internal
Library) feature-management and feature-reporting helpers

Vulnerability Class
--------------------------------------------------------------------
Information Disclosure / KASLR bypass (CWE-200: Exposure of Sensitive
Information to an Unauthorized Actor)

Detailed Root Cause Analysis
--------------------------------------------------------------------
Several generic helper routines that live in win32k.sys and are used by
WIL feature gates were implemented with hard-coded references to a
single global descriptor symbol:
    Feature_AsyncProcessFreezeThawSupport__private_descriptor

The functions affected in the pre-patch driver include:
  • wil_details_IsEnabledFallback
  • wil_details_FeatureStateCache_TryEnableDeviceUsageFastPath
  • wil_details_FeatureReporting_ReportUsageToService
  • wil_details_FeatureReporting_ReportUsageToServiceDirect

Although these helpers are invoked for *every* feature that win32k.sys
tracks, they always operated on – and later *exported* – the address of
the above descriptor.  When user mode registers the normal
   g_wil_details_pfnFeatureLoggingHook
callback, the kernel passes several parameters coming directly from the
descriptor structure.  Prior to the fix the absolute kernel pointer of
Feature_AsyncProcessFreezeThawSupport__private_descriptor (and other
internal structures contained in that descriptor) was leaked to the
user callback, disclosing precise KASLR offsets and thereby violating
Virtualisation-Based Security (VBS) expectations.

Because the same constant pointer was also used for interlocked state
updates in wil_details_FeatureStateCache_TryEnableDeviceUsageFastPath,
attackers could proactively trigger the path with arbitrary feature
IDs, deterministically leaking the address and potentially corrupting
the feature-state cache of the AsyncProcessFreezeThawSupport feature in
other sessions.

In short, the helpers were *not parameterised*: they relied on a global
assumed to be the current feature.  Any call concerning a *different*
feature therefore processed and returned the wrong descriptor, leaking
kernel-mode pointers to user space.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// wil_details_IsEnabledFallback (before)
if (a2) {
    wil_details_FeatureReporting_ReportUsageToService(a1, v4, a2);
    if (a2 - 3 <= 1)
        wil_details_FeatureStateCache_TryEnableDeviceUsageFastPath(v4, a2);
}
...
// hard-coded global inside helper
v4 = *Feature_AsyncProcessFreezeThawSupport__private_descriptor;
```

```c
// wil_details_FeatureReporting_ReportUsageToService (before)
return g_wil_details_pfnFeatureLoggingHook(
        0x0359A0B0,               // constant feature id
        &Feature_TestValidate_logged_traits, // leaks kernel ptr
        0,
        v3,
        &v9,
        0,
        v8,
        1);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User process registers g_wil_details_pfnFeatureLoggingHook.
2. Process exercises any win32k feature that is *not* AsyncProcess...
3. win32k calls wil_details_IsEnabledFallback().
4. The helper calls
      wil_details_FeatureReporting_ReportUsageToService().
5. The latter forwards the constant kernel address of
   Feature_AsyncProcessFreezeThawSupport__private_descriptor to the user
   callback – leaking the kernel pointer space.

Attack Vector
--------------------------------------------------------------------
Local, post-login.  An unprivileged application simply needs the ability
to load a DLL that registers a WIL logging hook (a documented
mechanism).  No special privileges are required beyond normal
application execution.

Patch Description
--------------------------------------------------------------------
1. All affected helpers were re-worked to receive an explicit *third*
   parameter: a pointer to the correct per-feature descriptor.
2. Hard-coded references to
   Feature_AsyncProcessFreezeThawSupport__private_descriptor were
   deleted.
3. Logging helpers now extract numeric fields from the descriptor and
   pass those values – not the raw pointer – to user-mode callbacks.
4. TryEnableDeviceUsageFastPath now uses the supplied descriptor for
   interlocked operations, preventing cross-feature state corruption.
5. New wrapper Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_0() was
   introduced; DriverEntry was modified to call it and to accommodate
   the parameterised helpers.

Security Impact
--------------------------------------------------------------------
The pre-patch implementation discloses stable kernel addresses to any
local user.  With KASLR defeated an attacker can reliably craft ROP
chains or locate kernel gadgets, significantly lowering the bar for
subsequent privilege-escalation exploits even in VBS-protected
configurations.

Fix Effectiveness
--------------------------------------------------------------------
The patched code eliminates the global reference, sanitises data sent to
user mode, and ensures each feature path works with its own descriptor.
No remaining code paths referencing the old global were observed in the
diff, indicating that the address-leak primitive has been closed.  Full
regression testing across all feature gates is still recommended, but
based on the presented changes the fix appears complete and effective.
