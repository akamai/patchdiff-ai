{'kb': 'KB5060842', 'change_count': 9, 'file': 'mstsc.exe', 'cve': 'CVE-2025-32715', 'date': 1763415523.033708, 'patch_store_uid': '0b61dfb1-c5c4-4dc3-9b9a-958674f888c0', 'confidence': 0.34}
--------------------------------------------------------------------
CVE-2025-32715 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Remote Desktop Protocol (RDP) client – mstsc.exe
Function: CRailContWndExt::AddRemoteApplicationToQueueUi()
This helper is used by the RemoteApp (RAIL) feature to insert a
server-supplied application entry – together with its icon – into the
local Connection Queue UI.

Vulnerability Class
--------------------------------------------------------------------
Out-of-Bounds Read / Un-trusted File Loading (CWE-125)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The RAIL protocol allows the server to provide an icon path (argument
`a2`) for every published application.  Prior to the patch the client
code performed **no validation** of this path:

1. `LoadImageW(NULL, a2, IMAGE_ICON, …, LR_LOADFROMFILE | … )` was
   invoked unconditionally.
2. When the path pointed to a UNC or other network location the RDP
   client fetched and parsed the file fully on the local system.
3. The ICO parser (inside USER32/GDI) is not hardened against malformed
   data; a specially-crafted icon can trigger an out-of-bounds read
   during parsing, causing disclosure of adjacent memory to the
   attacker-controlled channel (the RDP virtual channel or a crash with
   memory dump).

No size / scheme / network checks were executed before accessing the
icon, therefore any RDP server, even one without file-share access, was
able to point the client at an SMB/WebDAV share containing a malicious
ICO and force the vulnerable read.

Patch-added logic introduces two independent gates before the icon is
loaded:

• Feature flag  `Feature_MSRC88443` (WinExp feature mechanism).
• Registry key  `HKCU\Software\Microsoft\RemoteApplications\
  AllowRemoteAppIconFromNetworkPath` (DWORD, default 0).

Only if *either* gate explicitly allows remote icons **and** the path is
not a network location (`!PathIsNetworkPathW(a2)`) will `LoadImageW` be
executed.  Otherwise a local fallback icon is used.  As a result network
content is no longer parsed in the normal configuration and the OOB read
condition is removed.

Additional hardening added by the patch:
• Symmetric cleanup for every early-return path (`DestroyIcon`,
  `LocalFree`).
• Double `memset` to clear the `lParam` stack buffer before use.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE – unconditionally load server-supplied file
ImageW = (HICON)LoadImageW(NULL, a2, IMAGE_ICON, 0, 0, 0x2050);

// AFTER – reject network paths unless explicitly allowed
if ((!wil::Feature<Feature_MSRC88443>().IsEnabled() ||
     CUT::UT_ReadRegistryInt(L"RemoteApplications",
       L"AllowRemoteAppIconFromNetworkPath", 0, 1)) &&
    a2 && (RegistryInt || !PathIsNetworkPathW(a2)) &&
    (IconW = (HICON)LoadImageW(NULL, a2, IMAGE_ICON, 0, 0, 0x2050)))
{
    v31 = 1; // custom icon accepted
}
else
{
    IconW = LoadIconW(hInst, MAKEINTRESOURCEW(0x65));
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Malicious RDP server advertises a RemoteApp with `RAIL_ICON_PATH` set
   to `\\attacker\share\bad.ico`.
2. mstsc.exe receives the message and calls
   CRailContWndExt::AddRemoteApplicationToQueueUi().
3. On an unpatched client the function calls `LoadImageW` on the remote
   file.
4. The crafted ICO triggers an out-of-bounds read inside USER32 as the
   parser processes invalid directory/data offsets.
5. Memory content is returned to the attacker (e.g., via RDP channel or
   crash dump), constituting information disclosure.

Attack Vector
--------------------------------------------------------------------
Network-borne.  Any RDP server (including malicious or compromised ones)
that can reach the client can supply a UNC path to a crafted icon file
and cause the vulnerable code path to be executed automatically when the
user connects.

Patch Description
--------------------------------------------------------------------
• Introduced a feature flag plus registry override controlling whether
  remote icon paths are permitted.
• Added `PathIsNetworkPathW` check – by default network locations are
  rejected and a built-in resource icon is used.
• Ensured proper cleanup on all exit paths and avoided destroying icons
  when the new feature flag keeps them alive.
• Updated tracing GUIDs (cosmetic).

Security Impact
--------------------------------------------------------------------
Before the fix, a malicious RDP server could coerce the client into
loading and parsing attacker-supplied ICO data, enabling an
out-of-bounds read that may leak process memory and potentially assist
in further exploitation.  The issue is classified as Information
Disclosure with network attacker context (CVE-2025-32715).

Fix Effectiveness
--------------------------------------------------------------------
The patched code prevents remote paths from reaching `LoadImageW` unless
an administrator explicitly opts-in via registry or feature flag.  This
removes the ability for an attacker to supply arbitrary icon data and
therefore eliminates the immediate OOB read condition.  Added cleanup
paths also ensure no new resource leaks or double frees were
introduced.  The fix is considered effective for the described issue.
