{'change_count': 17, 'patch_store_uid': 'e357b706-c599-45dd-b928-3b319eb9aed7', 'confidence': 0.37, 'cve': 'CVE-2025-33055', 'kb': 'KB5060842', 'file': 'storsvc.dll', 'date': 1763416823.3207529}
--------------------------------------------------------------------
CVE-2025-33055 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Storage Management Provider (storsvc.dll) – kernel-mode
service that manages Storage Spaces, pools, tiers and provisioning
operations.

Vulnerability Class
--------------------------------------------------------------------
Out-of-bounds Read / Information Disclosure (CWE-125).

Detailed Root Cause Analysis
--------------------------------------------------------------------
User-mode callers that possess STORAGE
authority can send crafted provisioning requests to the Storage
Management Provider.  The request is marshalled into an internal
_SP_PROVISIONING_INFO structure and is validated by
ScValidateProvisioning().  Before the patch the function only ensured:

  • field 0  (ProvisioningType)   was 0 or 1
  • field 4  (LayoutVersion)      <= 5
  • field 5  (MinTier)            in range 1-4
  • field 6  (MaxTier)            in range 1-4 and >= MinTier

Field 7 (DesiredTier) was never range-checked and the ordering
relationship between the three tier fields was incomplete.  An
attacker could therefore supply:

  MinTier      = 1
  DesiredTier  = 0xFFFFFFFF (or any value >= 5)
  MaxTier      = 1

a combination that passes the old validation but is later used as an
index into tier tables (_SP_TIER_INFO) in code such as
SiCreateReadCache().  When the tier value exceeds the available
_SP_TIER_INFO array (four entries) storsvc reads past the end of the
allocation, copying uninitialised kernel memory into user-accessible
buffers returned through WMI / VDS / StorageSpacesMgmt APIs.  The read
occurs in kernel context, so any kernel memory located immediately
after the allocation is disclosed.

New checks added in 23H1 / March 2025 ensure:

  • MinTier, DesiredTier, MaxTier each lie in [1,4]
  • if DesiredTier is present (non-zero)   Min <= Desired < Max
  • MaxTier obeys Min <= Max <= 4

If any rule fails ScValidateProvisioning() now returns
0xC03A0021 (STATUS_OBJECT_NAME_INVALID) and the request is aborted.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
if ( *(DWORD*)a1 == 1 && !flagWrite) return ERROR;
if (fields[4] <= 5) {
    v7 = fields[5];                // MinTier
    if (v7-1 > 4) return ERROR;
    v8 = fields[6];                // MaxTier
    if (v8-1 > 4 || v7 > v8) return ERROR;  // no check for field[7]
}
```
```c
// after
if ((v6-1) > 1 || (v6==1 && !flagWrite)) return ERROR;
...
if (fields[4] <= 5) {
    if ((fields[5]-1) > 4) return ERROR;
    if ( Feature_IsEnabledDeviceUsage() ) {
        v8 = fields[6];            // DesiredTier
        if (v8 && (v8-1 > 4 || fields[5] > v8 || v8 >= fields[7]))
            return ERROR;
    }
    v9 = fields[7];                // MaxTier
    if (v9-1 > 4 || fields[5] > v9) return ERROR;
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker issues a provisioning request (e.g. via
   IVdsStoragePool::CreateVirtualDisk or corresponding WMI).
2. User buffer is copied into _SP_PROVISIONING_INFO and passed to
   ScValidateProvisioning().
3. Pre-patch validation accepts malicious DesiredTier / MaxTier.
4. SiCreateReadCache() allocates an _SP_TIER_INFO array of four
   entries and writes past the end when DesiredTier or MaxTier >= 5.
5. Kernel memory beyond the array is later returned to user space,
   disclosing sensitive contents.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker with the ability to call storage
management interfaces (Storage Spaces, VDS, WMI, or IOCTLs exposed by
StorSvc) sends a crafted provisioning structure.

Patch Description
--------------------------------------------------------------------
The update only modifies validation logic; no data structures change.
Key points:

  • Added Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage() wrapper
    and call-site in ScValidateProvisioning() to gate new checks.
  • Introduced full range and ordering validation for fields 6 and 7
    (DesiredTier and MaxTier).
  • Returns early with STATUS errors when invalid.
  • No change to downstream algorithms – they now receive only
    well-formed values.

Security Impact
--------------------------------------------------------------------
Before the fix an attacker could read arbitrary kernel memory located
just after an _SP_TIER_INFO allocation, possibly gaining information
about kernel ASLR, pool metadata, or other privileged data.  The bug
cannot write memory, but disclosure may be chained with other
vulnerabilities for elevation of privilege.

Fix Effectiveness
--------------------------------------------------------------------
The added bounds and order checks cover all tier-related fields before
those fields are trusted anywhere else in storsvc.  No other code path
writes to the fields without first calling ScValidateProvisioning().
Therefore the out-of-bounds read is fully mitigated.
