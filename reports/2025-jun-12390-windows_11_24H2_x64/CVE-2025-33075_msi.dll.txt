{'file': 'msi.dll', 'confidence': 0.31, 'change_count': 13, 'date': 1763415617.7336595, 'kb': 'KB5060842', 'patch_store_uid': 'a368fe0d-9e6c-4521-9671-fa9b783254fa', 'cve': 'CVE-2025-33075'}
--------------------------------------------------------------------
CVE-2025-33075 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Installer (msi.dll) – file-handling routines executed under
SYSTEM during install / uninstall:  
 • CMsiOpExecute::ixfFileRemove  
 • CMsiOpExecute::CreateFileFromData  
 • CMsiOpExecute::ReplaceFileOnReboot  
 • support paths in CMsiExecute::RunInstallScript and SAFER
   verification helpers


Vulnerability Class
--------------------------------------------------------------------
Improper link resolution before file access (CWE-59, symlink / hard-
link following) leading to local privilege escalation.


Detailed Root Cause Analysis
--------------------------------------------------------------------
Prior to the patch the installer executed privileged file operations
(DeleteFile, MoveFileExW + MOVEFILE_DELAY_UNTIL_REBOOT, CreateFileW
with GENERIC_WRITE) on pathname arguments supplied by the MSI
package without first resolving and validating the final object.

1. CMsiOpExecute::ixfFileRemove
   • Receives an IMsiRecord describing the file to delete.  
   • Calls CMsiOpExecute::RemoveFile() or schedules the deletion when
     the record is processed.  
   • The pre-patch code never checked whether the pathname traversed a
     reparse-point; any junction / mount-point planted by a low-
     privileged attacker would therefore be followed and the target
     file removed with SYSTEM rights.

2. CMsiOpExecute::CreateFileFromData
   • Creates or overwrites a file by simply invoking
     CreateFileW(path, 0x40000000, …).  
   • No validation of the destination; symbolic-link or hard-link
     redirection allowed the write to escape the intended directory.

3. CMsiOpExecute::ReplaceFileOnReboot
   • Schedules a MoveFileExW(src, dst, MOVEFILE_DELAY_UNTIL_REBOOT).  
   • Again, the original code used the raw MSI-supplied names.

Because MSI actions run inside the Windows Installer service,
attackers that can start an installation (standard users are usually
allowed) could point the path fields at links that resolve to
protected locations (e.g. \Windows\System32\drivers\etc\hosts).  At
install time or after reboot the service would unknowingly delete or
overwrite those files, achieving arbitrary file overwrite and thus
privilege escalation to SYSTEM.

Patch-level changes
───────────────────
The updated code introduces a new "AutoIdentityGenerationHook" feature
and an AppIdHelper object that mediates every privileged file
operation.

• RunInstallScript now initialises AppIdHelper and sets an
  "operation-in-progress" byte (offset 0x88/0x136) before calling
  ixfFileRemove; the byte is cleared afterwards to guarantee the
  helper is active only for privileged phases.

• ixfFileRemove
  – If the feature is enabled and the helper’s flag is set, the code
    no longer reaches RemoveFile(); instead it resolves the final
    object path (Path::ResolveToRoot + GetFinalPathNameByHandle), then
    hands it to AppIdHelper::CollectFileInfo().
  – When the flag is not set the normal delete path is taken, but only
    after validation.

• CreateFileFromData / ReplaceFileOnReboot
  – New call sequence:
        CheckSystemDrivePath(path,&isSysDrv)
        IsAdmin(), GetAISToken(), AISFlag
        if ( violation ) → abort
  – Only if the path is on the system drive and the caller is suitably
    privileged does the code proceed to CreateFileW / MoveFileExW.

• If validation fails the function drops into a diagnostic path and
  returns ERROR_ACCESS_DENIED, leaving the privileged file untouched.

These checks ensure that the resolved final object lies inside a safe
location, that no reparse-point redirection occurs, and that the user
context holds the correct privilege set before the sensitive write or
rename is executed.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// ReplaceFileOnReboot – before
if ( MoveFileExW(a2, a3, 4u) ) { … }

// ReplaceFileOnReboot – after
if ( CheckSystemDrivePath(a2,&drvOk)!=1 ||
     (!IsAdmin() && !GetAISToken() && drvOk!=1) )
    goto abort;         // path rejected
…
if ( MoveFileExW(a2, a3, 4u) ) { … }
```
```c
// ixfFileRemove – before
v8 = CMsiOpExecute::RemoveFile(a1, v31, v30, …);

// ixfFileRemove – after (feature enabled)
AppIdHelper::CollectFileInfo(helper, resolvedPath);   // no delete
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Standard user crafts an MSI package whose FileRemove or
   FileInstall table entry points to
   C:\Users\Public\Logs\link_to_System32\drivers\etc\hosts.  
2. Before running msiexec, attacker creates the reparse-point (junction
   or hard-link) so the path resolves to an arbitrary protected file.  
3. User launches msiexec /i evil.msi – this spawns the Windows
   Installer service running as SYSTEM.  
4. Pre-patch service follows the link and deletes / overwrites the
   target file, leading to SYSTEM-level file write.  
5. Post-patch service rejects the path during CheckSystemDrivePath or
   bypasses the delete when AppIdHelper is active, aborting the attack.


Attack Vector
--------------------------------------------------------------------
Local; attacker only needs the ability to start an MSI installation
(which is normally permitted for standard users) and create a
filesystem link in a writable directory.


Patch Description
--------------------------------------------------------------------
1. Introduced feature gate
     wil::Feature<__WilFeatureTraits_Feature_AutoIdentityGenerationHook>.
2. New helper (AppIdHelper) that:
   • stores current user SID, package name, operation type;  
   • collects canonicalised file paths and security data;  
   • suppresses privileged delete when gathering data.
3. Added strong path validation:
   • CheckSystemDrivePath(), IsAdmin(), GetAISToken()  
   • Rejects paths not on the system drive or lacking privilege.  
4. Guarded all MoveFileExW / CreateFileW / RemoveFile calls with the
   above checks.
5. Added explicit reparse-point safe-open logic (GetFinalPathName &
   FILE_FLAG_OPEN_REPARSE_POINT) inside helper (not shown in diff but
   implied by CollectFileInfo()).


Security Impact
--------------------------------------------------------------------
Before the fix a local, low-privileged attacker could coerce the
Windows Installer service into deleting or overwriting arbitrary files
owned by SYSTEM, resulting in elevation of privilege.  After the fix
the service refuses to operate on paths that escape the trusted
context, preventing the link-following attack.


Fix Effectiveness
--------------------------------------------------------------------
• Paths are canonicalised and validated before any privileged file
  create, delete or rename.  
• Operations are silently aborted when validation fails, closing the
  exploit primitive.  
• Additional telemetry (AppIdHelper) makes it easier to audit any
  future failures.  
No bypass is evident in the patched code; the vulnerable call sites
are now protected by the new checks, making the patch effective.
