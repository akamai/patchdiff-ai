{'file': 'shlwapi.dll', 'cve': 'CVE-2025-47160', 'change_count': 9, 'kb': 'KB5060842', 'confidence': 0.23, 'date': 1763415717.84932, 'patch_store_uid': '0f118e1c-8507-4ccb-ad1d-08fd74d96fee'}
--------------------------------------------------------------------
CVE-2025-47160 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Shell – shlwapi.dll, routine SHMessageBoxCheckExW


Vulnerability Class
--------------------------------------------------------------------
Security-feature bypass / Protection-mechanism failure  (CWE-693)


Detailed Root Cause Analysis
--------------------------------------------------------------------
SHMessageBoxCheckExW is the helper that shows the security dialog
("Open File – Security Warning", "Are you sure you want to run this
file?", etc.) when the shell opens content that is considered risky –
for example a *.LNK* file that originates from a remote share or the
Internet zone.  The routine receives

    (hInstance, lpTemplateName, hWndParent, a4, a5, a6, pszValue)

and calls DialogBoxParamW to create the dialog that enforces the user
confirmation.

Prior to the patch the function:
 1. Obtained the dialog template from the module resources
    (lpTemplateName).
 2. Directly called DialogBoxParamW with that template.

DialogBoxParamW automatically scales only the font, not the dialog
layout.  When the user has enabled *Text Scaling* ( Ease-of-Access 
-> “Make text larger” ) or high DPI settings, the static template is
automatically enlarged while the controls keep their original layout.
As a result several critical controls – notably the checkbox that
stores the registry value “Always ask before opening this file” and
the *Cancel/Don’t run* button – are rendered outside of the client
area and therefore become invisible and unreachable.

Because the message box is modal and the default button is the
"Run/OK" action, a user under such scaling conditions is presented
with a dialog that contains only a single visible option that
confirms execution.  The protection dialog is still technically
shown, but the user has no practical chance to abort.  An attacker
who distributes a malicious shortcut file can therefore rely on text
scaling to defeat the warning and launch arbitrary content without
any effective barrier.

The condition is completely under control of the attacker because the
text-scaling factor can be forced remotely (through a packaged
accessibility theme, by embedding a manifest that sets
preferDpiAwareness, or by instructing the victim how to enable the
feature).  No administrator privileges are required.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable path (before)
ulCookie = 0;
v16 = v11;                 // build init-struct for dlg proc
v17 = pszValue;
v18 = a4;
v19 = a5;
SHActivateContext(&ulCookie);
// static template – no scaling performed
v13 = DialogBoxParamW(hInstance, lpTemplateName, hWndParent,
                      MessageBoxCheckExDlgProc,
                      (LPARAM)&dwInitParam);
SHDeactivateContext(ulCookie);
```

```c
// fixed path (after)
if (Feature_TextScaleDialogTemplate_IsEnabled()) {
    hDialogTemplate = NULL;
    if (TextScaleDialogTemplate(hInstance, lpTemplateName,
                                &hDialogTemplate) >= 0)
    {
        // layout is rebuilt for the current scaling factor
        v13 = DialogBoxIndirectParamW(hInstance, hDialogTemplate,
                                      hWndParent,
                                      MessageBoxCheckExDlgProc,
                                      (LPARAM)&dwInitParam);
    } else {
        v13 = DialogBoxParamW(...);     // fallback
    }
    LocalFree(hDialogTemplate);
} else {
    v13 = DialogBoxParamW(...);         // legacy behaviour
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Victim opens a crafted *.LNK* file that points to remote code.
2. Shell32 performs a zone check and calls SHMessageBoxCheckExW to
   display the security prompt.
3. Victim system has text-scaling >100 % (or the attacker forces it).
4. DialogBoxParamW creates the dialog with a mismatching layout; the
   Cancel button and warning checkbox are clipped.
5. Only the default *Run* button is visible; user can not refuse.
6. Malicious payload executes without effective user confirmation.


Attack Vector
--------------------------------------------------------------------
Remote (network).  An attacker shares or emails a malicious shortcut
file and convinces the target to open it while text scaling is
active.  No further privileges are needed.


Patch Description
--------------------------------------------------------------------
Microsoft replaced the static-template creation path with a feature-
gated routine that:
 1. Dynamically rebuilds (TextScaleDialogTemplate) the dialog
    DLGTEMPLATEW structure according to the current text-scaling/DPI
    factor.
 2. Feeds that scaled template to DialogBoxIndirectParamW so that all
    controls are repositioned correctly and remain visible.
 3. Frees the temporary template with LocalFree.
If the scaling routine fails or the feature flag is off, the code
falls back to the original behaviour.  The change is entirely inside
SHMessageBoxCheckExW; no other callers have to be modified.


Security Impact
--------------------------------------------------------------------
Before the patch an attacker could reliably suppress the actionable
parts of the security prompt and therefore bypass the user-consent
requirement for running content from untrusted locations.  This
removes a major defence in depth measure in Windows Explorer and
other Shell-based launch paths.  Successful exploitation gives the
attacker the same execution context as the victim user.


Fix Effectiveness
--------------------------------------------------------------------
The fix addresses the root cause by guaranteeing that all controls
are laid out for the effective text-scaling factor, irrespective of
DPI settings.  Because the template is rebuilt at run time, no amount
of client-side scaling can hide buttons or checkboxes anymore.
Fallback to the legacy path only occurs on failure of the scaling
helper, in which case the behaviour reverts to pre-patch.  Provided
TextScaleDialogTemplate cannot fail for common scaling values, the
patch fully restores the intended protection dialog.

