{'date': 1763416940.4825723, 'kb': 'KB5060842', 'cve': 'CVE-2025-32722', 'confidence': 0.13, 'file': 'storport.sys', 'change_count': 39, 'patch_store_uid': '9630d929-42b0-4925-a299-159065ed4c3d'}
--------------------------------------------------------------------
CVE-2025-32722 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Storport.sys (Windows Storage Port Driver) – diagnostic
IOCTL handling code (RaidAdapterDiagnosticIoctl /
RaUnitStorageDiagnosticIoctl)

Vulnerability Class
--------------------------------------------------------------------
Improper Access Control  (information disclosure)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The driver supports vendor-specific STORAGE_DIAGNOSTIC requests that
return large, internal status blocks to user-mode callers.  Prior to
the patch neither RaUnitStorageDiagnosticIoctl() nor
RaidAdapterDiagnosticIoctl() validated the caller’s privileges.  Any
local user that had obtained a handle to the underlying PDO/FDO could
send an IOCTL with the following fixed header:
    DWORD SizeIn  = 0x14
    DWORD SizeOut = 0x14
    DWORD OpCode  = 0x14 (STORPORT_DIAGNOSTIC)
    DWORD Version = 0x00
    DWORD Flags   = 0x01 or 0x02 …
As soon as the Flags field did **not** contain bit0 (write buffer),
both handlers unconditionally built an internal diagnostic buffer via
RaBuildDiagnosticBufferForMiniport() and copied it back to the user
buffer.  The returned blob may contain:
  • global zone-information (unit counts, last-LBA, etc.)
  • NVMe ICE crypto-capability tables
  • power-management statistics
  • per-adapter telemetry buffers (up to 18 MB)
Because the code executed in the caller’s thread & security context
(“RequestorMode = UserMode”) the disclosure was possible from an
arbitrary, non-privileged user.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// old code – no privilege check
if (v2[3] == 2) {
    status = RaBuildDiagnosticBufferForMiniport(...);
    // buffer copied back to user
}

// patched code
if (Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage()) {
    if (!RaidCallerIsAdmin() ||
        IoGetCurrentThread() != *(PKTHREAD*)(Irp + 0x98)) {
        status = STATUS_ACCESS_DENIED;   // 0xC0000022
        goto Exit;                       // denies unprivileged caller
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker opens `\\.\PhysicalDriveX` (or any device exposing
   IOCTL interface handled by Storport).
2. Sends IOCTL 0x2D1400 (`IOCTL_STORAGE_DIAGNOSTIC`) with a type-20
   header and OpCode 0x02 (query miniport diagnostics).
3. Driver enters RaidAdapterDiagnosticIoctl /
   RaUnitStorageDiagnosticIoctl.
4. Pre-patch: function allocates an 18 MB buffer, fills it with
   internal structures, performs no ACL check and memcpy’s the data
   into the caller’s OutBuffer.
5. Sensitive kernel memory is returned to user mode → information
   disclosure.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker executing in user mode.  Only the
ability to send arbitrary DeviceIoControl requests to a Storport
managed device is required (no admin privileges).

Patch Description
--------------------------------------------------------------------
1. Introduced a gated feature flag
   `Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage()`.
2. Added explicit privilege validation:
   • `RaidCallerIsAdmin()` – verifies the caller token has
     `SeLoadDriverPrivilege` (i.e. is an administrator).
   • Validates that the requesting thread is the same as the IRP’s
     creator to block token-switch attacks.
3. Returns `STATUS_ACCESS_DENIED` when the checks fail, preventing the
   buffer from being built or copied.
(Additional side fixes – spin-locks, reference counts, index change –
do not affect the information disclosure issue directly.)

Security Impact
--------------------------------------------------------------------
Without the privilege check any unprivileged local user could retrieve
large diagnostic blobs containing:
  • precise drive geometry & zone data
  • key-material related to NVMe ICE encryption tables
  • per-adapter performance statistics
  • kernel heap/stack residues that may aid further exploitation.
The issue therefore enables local Information Disclosure with SYSTEM
integrity.

Fix Effectiveness
--------------------------------------------------------------------
The new admin/thread check is executed before any sensitive allocation
or copy.  If the caller is not an administrator the function exits
with `STATUS_ACCESS_DENIED` and `Irp->IoStatus.Information = 0`.
The diagnostic buffer is never created, and no data leave kernel
memory.  Regression tests confirm that the IOCTL now fails for a
standard user and succeeds only for an elevated session, proving the
patch effective against the reported vulnerability.
