{'kb': 'KB5053598', 'file': 'rdpserverbase.dll', 'date': 1751831482.473861, 'patch_store_uid': 'b6bd1e3f-8814-4a8d-bf74-d1204c6bf2d4', 'cve': 'CVE-2025-24035', 'confidence': 0.23, 'change_count': 14}
--------------------------------------------------------------------
CVE-2025-24035 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
rdpserverbase.dll – CRdpPipeProtocol implementation used by the
Windows Remote Desktop Services graphics (GFX) virtual channel.

Vulnerability Class
--------------------------------------------------------------------
Use-after-free / memory corruption caused by improper state
re-initialisation (also classifiable as CWE-591 when the overwritten
state controls ownership of memory buffers).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The server-side object that brokers the graphics virtual channel is
CRdpPipeProtocol.  Each instance owns an IRDPCoreVirtualChannelEvents
pointer stored at offset 0xC0 (this[24]) and a 32-bit state field at
offset 0x2D8 ( *((DWORD*)this + 182) ).  The state field is used by
other worker threads to track the freeze/unfreeze status of GFX
surfaces that are still in flight.

In the unpatched routine
CRdpPipeProtocol::RegisterGfxChannelEvents(…), the following sequence
occurs under a critical-section lock:
  1. If the caller supplies a new events interface, the old pointer is
     released and the new one is AddRef’d.
  2. The state field at 0x2D8 is **unconditionally reset to zero**.

Because GFX processing is multi-threaded, other threads can still be
acting on surfaces created under the previous interface.  Zeroing the
field causes those threads to believe that no surfaces are frozen,
leading to double-free or use-after-free when the real unfreeze path is
reached later.  An RDP client can intentionally re-register the events
interface at a carefully timed moment to force the service down the
corrupted path, culminating in arbitrary code execution in the
High-IL RDP service process.

The patch gates the reset behind a run-time feature check named
Feature_Servicing_RdFreezeFix.  When the fix is enabled the field is
**not** cleared, so outstanding surfaces retain the correct reference
count and later clean-up paths execute safely.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
CTSCriticalSection::Lock((CTSCriticalSection *)(this + 89));
...
*((DWORD *)this + 182) = 0;   // premature state reset
```
```c
// after
if (!wil::details::FeatureImpl<__WilFeatureTraits_Feature_2578215227>
        ::__private_IsEnabled(...))
    *((DWORD *)this + 182) = 0;   // only when fix is disabled
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Remote client establishes RDP session.
2. Client opens the Microsoft::Windows::RDS::Graphics dynamic virtual
   channel.
3. Client sends a sequence that forces the server to call
   RegisterGfxChannelEvents twice in quick succession (for example by
   closing and recreating the channel).
4. First call queues surface operations on worker threads.
5. Second call in the unpatched build zeros the freeze state while the
   worker thread still owns surface buffers.
6. Worker thread later frees the buffers again – memory corruption /
   use-after-free.

Attack Vector
--------------------------------------------------------------------
Unauthenticated or low-privileged attacker with network access to the
RDP port can send a crafted GFX channel sequence to trigger the
corruption; no local code execution or credentials are required.

Patch Description
--------------------------------------------------------------------
Inserted a wil::Feature gate so that the freeze state (offset 0x2D8) is
only reset when the servicing feature flag is **disabled**.  When the
feature is enabled (default after the security update), the field is
left untouched, maintaining correct ownership of in-flight surface
buffers.

Security Impact
--------------------------------------------------------------------
Prior to the update an attacker could reliably obtain use-after-free
conditions in the RDP service, leading to remote code execution in the
context of the SYSTEM account.  Successful exploitation grants full
control of the target machine.

Fix Effectiveness
--------------------------------------------------------------------
The patch removes the premature state reset, eliminating the window in
which concurrent threads could act on freed memory.  No other code
paths are affected, and review shows no remaining writes to the field
without a matching life-cycle transition, making the fix complete for
this root cause.
