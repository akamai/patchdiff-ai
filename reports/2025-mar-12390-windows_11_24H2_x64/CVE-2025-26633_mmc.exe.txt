{'kb': 'KB5053598', 'change_count': 4, 'cve': 'CVE-2025-26633', 'confidence': 0.2, 'patch_store_uid': '3ba97ef7-aa43-419e-99be-296dcef29324', 'file': 'mmc.exe', 'date': 1751831459.3739293}
--------------------------------------------------------------------
CVE-2025-26633 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Management Console (mmc.exe) – feature-flag handling code
   in wil::details::FeatureImpl::<T>::GetCurrentFeatureEnabledState()
   and the console loading routine CAMCDoc::ScOnOpenDocument().

Vulnerability Class
--------------------------------------------------------------------
Security-feature bypass / logic error (CWE-707 Improper Neutralization).

Detailed Root Cause Analysis
--------------------------------------------------------------------
MMC relies on Windows Internal Lib (wil) feature flags to decide if
additional protections ("Block opening untrusted .msc files") must be
applied.  For every feature, wil converts the raw
FEATURE_ENABLED_STATE value returned by WilApi_GetFeatureEnabledState()
into an internal 32-bit bitfield that is later queried through
__private_IsEnabled().  

Buggy algorithm (pre-patch):
  1. The helper zeroed the output buffer, forced bit 6 to 1 (0x40) or 0
     depending on partially-evaluated state, copied three other
     condition bits to 0x400 / 0x800, and finally copied **bit 6 into
     bit 0**:
        dst = v7 | v8 | (((v7 | v8) >> 6) & 1);
  2. No verification was performed that policy-blocking bits (0x400 and
     0x800) were mutually exclusive with the enable bit (0x40).

Result: if both policy bits (0x400|0x800 == 0xC00) and 0x40 were set the
last line always propagated an **Enabled = 1** flag even though policy
explicitly disabled the feature.  __private_IsEnabled() therefore
returned FALSE (feature OFF) when it should have been TRUE (feature ON /
blocking active).

CAMCDoc::ScOnOpenDocument() uses two wil features:
  * 2578215227  – "BlockUntrustedConsoleFiles"
  * 2408386874 / 220736827 – related companion switches
The routine checks IsEnabled() first and only denies loading a console
file when the feature is ON *and* the file originates from an
untrustworthy source (MOTW / URL ZONE).

Because GetCurrentFeatureEnabledState() could erroneously clear the
feature-enabled bit, ScOnOpenDocument() concluded that the blocking
feature was disabled and proceeded to load the file, bypassing the
intended protection.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// mmc.exe, before patch (simplified)
*(_DWORD *)a2 = v7 | v8 | ((v7 | (unsigned)v8) >> 6) & 1; // bit-0 mirrors bit-6
```
```c
// after patch
v9  = v8 | v7;              // merged flags
v10 = ((v9 & 0xC00) == 0xC00); // both policy bits?
...
if (!((v9 & 0x40) && v10))   // only set Enabled when legal
    v11 = 0;
*(_DWORD *)a2 = v11 | v9;    // correct final bitmap
```
```c
// ScOnOpenDocument – old gating
if (!IsEnabled(BlockUntrusted) || !IsFileSourceUntrustworthy(path))
    load_file();
```
```c
// ScOnOpenDocument – new gating and fallback
if (!IsEnabled(BlockUntrusted)) goto normal_path;
if (!path || !*path) fail;
if (!_IsFileSourceUntrustworthy(path)) goto normal_path;
// otherwise: abort with SC_E_UNTRUSTED_SOURCE
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User double-clicks a malicious .msc file that carries a Mark-of-the-
   Web (untrusted zone).
2. MMC invokes CAMCDoc::ScOnOpenDocument().
3. ScOnOpenDocument() queries
   FeatureImpl<BlockUntrustedConsoleFiles>::__private_IsEnabled().
4. GetCurrentFeatureEnabledState() returns bitmap with bit-0 cleared due
   to the faulty calculation even though policy demands blocking.
5. IsEnabled() therefore returns FALSE; the OR-clause in the caller is
   satisfied and the console file is loaded normally.
6. Malicious snap-ins or configuration inside the .msc file execute with
   the user’s privileges.

Attack Vector
--------------------------------------------------------------------
Local – the attacker convinces a victim to open a crafted console file
(.msc) that is tagged as coming from the Internet or another untrusted
location.  No additional privileges are required.

Patch Description
--------------------------------------------------------------------
1. Re-implemented the bit-aggregation logic in
   GetCurrentFeatureEnabledState():
   • Separately tracks the raw FEATURE_ENABLED_STATE (v6).
   • Validates conflicting combinations (0xC00 vs 0x40).
   • Calculates the final "Enabled" bit only when the combination is
     semantically valid.
2. Added extra sanity checks in ScOnOpenDocument():
   • Early exit when feature is disabled *before* any trust checks.
   • Uses the correct file-path pointer type.
   • Adds secondary condition that blocks if Feature 2408386874/​
     220736827 is enabled while the primary feature is disabled.
   • Consolidates error handling and resource cleanup.

Security Impact
--------------------------------------------------------------------
A malicious .msc file originating from an untrusted source could be
opened without warning, bypassing the intended protective feature.  Once
loaded, MMC snap-ins can instantiate arbitrary COM objects, potentially
leading to code execution in the context of the current user.  The issue
is therefore a local security-feature bypass with high exploitation
potential.

Fix Effectiveness
--------------------------------------------------------------------
The new bitmap construction enforces correct mutual exclusion between
policy bits and the enable bit, eliminating the scenario where a feature
is silently treated as disabled.  Additional guard code in
ScOnOpenDocument() performs explicit source-trust checks independent of
feature-flag ambiguities.  No residual bypass has been identified in the
patched paths based on the supplied diff.
