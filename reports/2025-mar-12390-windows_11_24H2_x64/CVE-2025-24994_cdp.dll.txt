{'patch_store_uid': '3f49ae9d-f63d-4771-89cb-ee0eed639f83', 'date': 1751831486.206324, 'file': 'cdp.dll', 'cve': 'CVE-2025-24994', 'kb': 'KB5053598', 'change_count': 84, 'confidence': 0.11}
--------------------------------------------------------------------
CVE-2025-24994 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Cross-Device Platform (cdp.dll); specifically the two helper
routines
  • shared::ActivityPolicies::CanPerformOperation(ActivityData&, …)
  • shared::ActivityPolicies::CanPerformOperation(CDPActivityType,…)
Both are used by the Cross-Device Service (CDPSvc) to decide whether a
caller may execute a requested activity (sync, backup/restore, etc.)
under the current enterprise policy set.

Vulnerability Class
--------------------------------------------------------------------
Improper Access Control – CWE-284

Detailed Root Cause Analysis
--------------------------------------------------------------------
CDPSvc keeps an in-memory tree of ActivityPolicy objects.  Each policy
node contains, among other fields:
  +0x20 WORD  LengthOfPermissionScopeString   (offset 0x32 in diff)
  +0x28 char* PermissionScopeString           (offset 0x48 in diff)
  +0x28 DWORD ActivityType                    (offset 0x40 in diff)
  +0x50 WORD  BlockMask                       (offset 0x80 in diff)

When a caller requests an operation, CanPerformOperation() retrieves
the caller-provided permission scope string into the local std::string
v26 and walks the policy tree.  Prior to the patch the check was:

    if (policy->ActivityType == Request.ActivityType) {
        if (IsActivityPermissionScopeAffectedByPolicy(v26,
                                                     policy->Scope)) {
            if ((Request.BlockFlags & policy->BlockMask) == …)
                deny();
        }
    }

Critically, *no* guard existed to make sure that the policy’s
PermissionScopeString was actually populated.  Enterprise-State
Roaming (ESR) policies are stored with Scope == "" (length == 0).  The
 helper IsActivityPermissionScopeAffectedByPolicy() treats an empty
string as a wildcard, so an ESR policy applied to ActivityType X would
also silently apply to the Backup/Restore permission scope although
the admin never intended that.  Because Backup/Restore operations are
executed in a higher-privilege context, a low-privileged user could
leverage the unintended wildcard match to make CDPSvc believe a
high-privilege Backup/Restore operation was *not* blocked, thereby
gaining elevated capability.

Both overloads of CanPerformOperation() therefore allowed the bypass.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Old logic (before)
while (!policy->IsDeleted) {
    if (policy->ActivityType == RequestedActivityType) {
        // EMPTY policy->Scope matches everything!
        if (IsActivityPermissionScopeAffectedByPolicy(reqScope,
                                                     policy->Scope)) {
            if ((reqBlockMask & policy->BlockMask) == reqBlockMask)
                deny();             // v7 / v6 = 0
        }
    }
    ++it;
}

// New logic (after)
if (Feature_SeparateBRFromESR.Enabled() &&
    policy->LengthOfPermissionScopeString == 0 &&
    IsBackupRestorePermissionScope(reqScope)) {
    Log("Ignore EnterpriseStateRoaming policy for permission scope");
    // skip this policy node
} else if (policy->ActivityType == RequestedActivityType) {
    ... (unchanged access check) ...
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privileged code requests a Backup/Restore CDP operation.
2. CDPSvc invokes CanPerformOperation().
3. Function pulls the caller’s permission scope string ("br_scope")
   from the caller-supplied app-ID.
4. The policy tree is enumerated; the first ESR policy node has
   PermissionScopeString length == 0.
5. Empty string matches "br_scope" ➜ access check passes ➜ operation
   proceeds in service context.
6. Attacker gains capabilities reserved for higher-privileged
   principals (EoP).

Attack Vector
--------------------------------------------------------------------
Local attacker already able to call CDPSvc IPC endpoints (any
authenticated user).  By crafting a Backup/Restore request the service
mistakenly authorises the operation despite enterprise policy.

Patch Description
--------------------------------------------------------------------
The update introduces a new feature flag
Feature_SeparateBRFromESR (2578215227).  When the flag is enabled the
code path adds an early filter in both overloads:
  • If the policy entry’s PermissionScopeString length is zero *and*
    the caller’s requested scope is recognised as Backup/Restore, the
    policy node is ignored and a diagnostic message is logged.  All
    other policies are evaluated as before.

Security Impact
--------------------------------------------------------------------
The wildcard match for empty-scope ESR policies allowed Backup/Restore
operations, which run with elevated service privileges, to bypass
administrative intent.  An authenticated local attacker could therefore
escalate privileges (EoP).  The patch restores proper separation of
policy scopes and closes the privilege-escalation path.

Fix Effectiveness
--------------------------------------------------------------------
Effective only when Feature_SeparateBRFromESR is turned on; roll-out is
controlled by a WIL feature switch.  With the feature enabled, empty
permission-scope policies can no longer influence Backup/Restore
requests, removing the improper access.  No memory-safety or logic
regression is observable from the diff, and new logging aids further
validation.  Residual risk: environments where the feature flag is
left disabled remain vulnerable.
