{'date': 1751831482.6771922, 'patch_store_uid': 'e7ca9e07-1f84-451f-a10b-8a79bb74c0cb', 'file': 'ntfs.sys', 'confidence': 0.14, 'cve': 'CVE-2025-24992', 'change_count': 17, 'kb': 'KB5053598'}
--------------------------------------------------------------------
CVE-2025-24992 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows kernel driver ntfs.sys – restart-area processing
logic inside ReadRestartTable() and callers during volume mount and
log-file recovery.

Vulnerability Class
--------------------------------------------------------------------
Buffer Over-read (CWE-126)

Detailed Root Cause Analysis
--------------------------------------------------------------------
NTFS mounts or recovers a volume by reading the first restart log
record from $LogFile and then extracting the embedded Restart Table.

Before the patch ReadRestartTable() trusted the 16-bit field at offset
+0x04 of the restart record (RestartTableOffset).  The code used that
value directly:
    table_ptr = record_base + *(USHORT *)(record_base+4);
    table_len = RestartAreaLength – RestartTableOffset;
    NtfsCheckRestartTable(table_ptr, table_len,…);

No check guaranteed that RestartTableOffset was large enough to cover
the fixed 40-byte header or the variable Update Sequence Array.  A
crafted log record could set the offset to a value smaller than the
minimal header size (or even to 0).  NtfsCheckRestartTable then walked
entries beyond the caller-supplied buffer, causing a linear read past
the end of the mapped log page held in non-paged pool.

Because the over-read data is later copied into user-controlled error
buffers or can be returned through STATUS_DISK_CORRUPT bug-check
information, an attacker with write access to a raw NTFS image can
disclose adjacent kernel memory.  On debug builds the stale read may
also raise an access violation leading to a system crash.

Affected parameters / structures
  • RESTART_AREA.RestartOffset (ushort @ +0x04)
  • Update Sequence Array count (ushort @ +0x0E)
  • restart table body pointed to by the untrusted offset

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
if (!NtfsCheckRestartTable(                     
        rec+*(USHORT *)(rec+4),                 // unchecked offset
        RestartLen-*(USHORT *)(rec+4),          // unchecked length
        ctx))                                   
    NtfsRaiseStatusInternal(...);

// after
header = *(USHORT *)(rec+14);                   // entry count
safe_ofs = (header<=1 ? 40 : 8*header+32);      // min hdr size
if (!NtfsCheckRestartTable(                     
        rec+safe_ofs,                           // validated offset
        RestartLen-*(USHORT *)(rec+4),          
        ctx))                                   
    goto corrupted_path;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
Mount / boot → NtfsRestartVolume → InitializeRestartState →
ReadRestartTable → NtfsCheckRestartTable (over-read occurs)

Attack Vector
--------------------------------------------------------------------
A local, low-privilege attacker supplies or mounts a malicious NTFS
volume (e.g., VHD, USB, or raw disk) whose $LogFile contains a crafted
restart record with a small RestartTableOffset.  When Windows mounts
or checks the volume the driver processes the record and performs the
out-of-bounds read.

Patch Description
--------------------------------------------------------------------
• Recomputes a minimum safe offset (40 bytes or 32+8*N) from the
  Update-Sequence-Array count instead of trusting the on-disk
  RestartTableOffset.
• Adds a secondary validation branch gated by
  Feature_1347162426__private_IsEnabledDeviceUsageNoInline().
• Introduces additional corruption-handling labels (LABEL_14 / 17) that
  raise STATUS_DISK_CORRUPT rather than continuing with invalid data.
• Updates related callers (InitializeRestartState, NtfsAbortTransaction
  etc.) to use the hardened helper and new ETW guids.

Security Impact
--------------------------------------------------------------------
Successful exploitation lets an attacker read beyond the mapped
restart record buffer, potentially disclosing uninitialized kernel
memory, and may also cause a bug-check (0x24 or 0xC0000225) leading to
a DoS during system boot or volume attach.

Fix Effectiveness
--------------------------------------------------------------------
The patch removes all trust in the attacker-controlled offset and
performs explicit size calculations before touching the restart table.
All corruption cases now terminate with STATUS_DISK_CORRUPT, stopping
further processing.  No remaining uncontrolled reads from the restart
record have been observed, indicating the patch fully mitigates the
reported CWE-126 issue.

