{'kb': 'KB5053598', 'cve': 'CVE-2025-24988', 'confidence': 0.28, 'patch_store_uid': '13c1e87d-a065-4d51-b526-a46f95d9c939', 'file': 'usbvideo.sys', 'date': 1751865237.720494, 'change_count': 27}
--------------------------------------------------------------------
CVE-2025-24988 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
usbvideo.sys – Windows USB Video Class (UVC) kernel-mode driver
responsible for enumerating and operating USB camera devices.

Vulnerability Class
--------------------------------------------------------------------
Out-of-bounds read due to missing length validation while parsing
variable-size USB descriptors (CWE-125).

Detailed Root Cause Analysis
--------------------------------------------------------------------
During device enumeration usbvideo.sys scans the USB configuration
buffer that a camera reports.  Many helper routines – e.g.
CountTopologyComponents, GetVideoSpecificDescriptor, GetEndpoint
Descriptor, GetStatusInterruptEndpointIndex, BuildUSBVideoFilter
Topology, … – walk the descriptor chain by adding the current
bLength (
  i = (UCHAR*)((UCHAR*)i + i->bLength)
) until a termination condition is met.  In the vulnerable build the
code only checked the **first** descriptor retrieved via
USBD_ParseDescriptors and thereafter trusted every embedded
bLength.  If a crafted descriptor advertises a length that extends
past the end of the real configuration buffer the pointer arithmetic
moves outside the caller-supplied memory.  Subsequent reads (and in a
couple of sites writes) are therefore performed on unrelated kernel
memory.

The defect is reachable from user mode with **no special
privileges** provided the attacker can insert (or emulate) a USB
camera.  The offending value is fully attacker-controlled: it is the
bLength field inside the malicious descriptor.

Individual functions add further, related flaws such as trusting a
UnitID < 8/0x16 and blindly indexing arrays allocated for the number
of units; these are blocked in the patch by explicit range checks.

Affected parameters / structures
 • ConfigurationDescriptor->wTotalLength
 • Each UVC class-specific descriptor’s bLength and bDescriptorType
 • Unit IDs copied into driver arrays (GetUnit*/Process* functions)

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
for ( i = USBD_ParseDescriptors(v12, total, v12, 36); ;
      i = (UCHAR *)((uint64)&i[*i] & -(uint64)(&i[*i] < end)) )
{
    if (!i) break;          // no bounds check after this point
    ...
}

// after
v11 = USBParseDescriptorWrapper(cfg, total, v8, 36, 12);
while (v11) {
    ...                               // uses wrapper again
    v11 = USBParseDescriptorWrapper(cfg, total,
                                    (DWORD)v11 + v11->bLength,
                                    36, 12);
}
```
`USBParseDescriptorWrapper` rejects a descriptor if
  • bLength == 0,
  • descriptor end crosses wTotalLength,
  • requested subtype does not match.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
PnP start → SelectDeviceConfiguration → BuildUSBVideoFilterTopology →
CountTopologyComponents / GetVideoSpecificDescriptor … → crafted
bLength makes pointer walk past end → kernel reads memory outside the
USB buffer.

Attack Vector
--------------------------------------------------------------------
Physical or emulated USB camera that advertises a malformed UVC
configuration descriptor.  No additional privileges are required;
Windows automatically enumerates the device when inserted.

Patch Description
--------------------------------------------------------------------
1. Replaced direct pointer arithmetic with
   USBParseDescriptorWrapper(), a helper that verifies that the next
   descriptor fits inside the original wTotalLength.
2. Added explicit *UnitID* upper-bound checks (`if (*a2 < 7/0x16/9)
   return STATUS_INVALID_PARAMETER`).
3. Added consistent error returns (0xC0000245 / 0xC0000005) instead
   of continuing on failure.
4. Updated all descriptor-parsing helpers to use the wrapper when the
   new feature flag `Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage`
   is enabled (enabled by default after patch).
5. Added fallback logging but aborted processing on validation
   failure instead of proceeding.

Security Impact
--------------------------------------------------------------------
A local attacker that can attach a malicious USB UVC device can force
kernel-mode code to read beyond the supplied configuration buffer.
Information disclosure and, in some cases, memory corruption that can
be turned into elevation of privilege (EoP) are possible.  The issue
is assigned CVE-2025-24988 and was rated Elevation of Privilege.

Fix Effectiveness
--------------------------------------------------------------------
All descriptor walks now go through a single length-checked helper;
any attempt to supply an over-long bLength is rejected and the driver
returns STATUS_INVALID_PARAMETER.  UnitID and endpoint counts are
validated before use.  No remaining unchecked arithmetic paths were
observed in the patched diff, so the fix is considered complete and
effective.
