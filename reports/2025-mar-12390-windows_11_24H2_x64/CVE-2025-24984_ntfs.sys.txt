{'patch_store_uid': 'e7ca9e07-1f84-451f-a10b-8a79bb74c0cb', 'cve': 'CVE-2025-24984', 'confidence': 0.21, 'date': 1751831448.490404, 'change_count': 17, 'file': 'ntfs.sys', 'kb': 'KB5053598'}
--------------------------------------------------------------------
CVE-2025-24984 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows NTFS kernel driver (ntfs.sys) – ETW diagnostic logging in
NtfsAbortTransaction, NtfsChangeAttributeValue and DoAction.

Vulnerability Class
--------------------------------------------------------------------
Information Disclosure – CWE-532: Insertion of Sensitive Information
into Log File.

Detailed Root Cause Analysis
--------------------------------------------------------------------
Multiple NTFS restart-management paths emit Event-Tracing-for-Windows
(ETW) records whenever the corresponding provider is enabled
(bits 0x2 = Information, bits 0x4 = Verbose).  Before the patch the
code referenced the provider variable

   Microsoft_Windows_NtfsLog_94d10f64af0e3ec7c3d991d5bedd15e9EnableBits

and wrote events such as McTemplateU0pd_*, McTemplateU0ddid_* or
McTemplateU0ppp_* containing:
 • Transaction log sequence numbers
 • File-record numbers, attribute names
 • Bitmap allocation runs, sector counts and other raw on-disk data

Because provider 94d10f64-… is not marked "secure" in its manifest, any
process able to start an ETW session (or an attacker with physical
access to the disk where the trace was stored) could collect or read
those events and reconstruct sensitive NTFS metadata and, in some
cases, fragments of user data.

Functions affected (pre-patch):
 • NtfsAbortTransaction – rollback path emits restrsup_c458 / _c465
 • NtfsChangeAttributeValue – value/length change path emits
   attrsup_c14780, restrsup_c3684, c3716 …
 • DoAction – restart-replay path emits restrsup_c4465, c4633 …

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE (NtfsAbortTransaction)
if ((Microsoft_Windows_NtfsLog_94d10f64af0e3ec7c3d991d5bedd15e9EnableBits & 4) != 0)
    McTemplateU0pd_EtwWriteTransfer(v6, &restrsup_c458);

// AFTER
if ((Microsoft_Windows_NtfsLog_c83e0889d8d138db51a3b5e3960eb478EnableBits & 4) != 0)
    McTemplateU0pd_EtwWriteTransfer(v6, &restrsup_c461);
```
(The same replacement appears in the other two functions.)
```
Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Any privileged or unprivileged code (locally or via physical access)
   enables the old NtfsLog provider and creates an ETW session.
2. Normal NTFS activity (rollback, attribute change, restart replay)
   executes the affected functions.
3. Sensitive on-disk structures are packaged into ETW payloads and
   written to the session log file.
4. Attacker reads the trace file and extracts file-system information
   that should remain private.

Attack Vector
--------------------------------------------------------------------
Local / physical.  The attacker needs to start or obtain a trace file
containing the insecure provider’s events (e.g., left on disk after a
support capture, crash-repro, or taken from offline media).

Patch Description
--------------------------------------------------------------------
All three functions now reference a new provider variable

   Microsoft_Windows_NtfsLog_c83e0889d8d138db51a3b5e3960eb478EnableBits

and new event descriptors (restrsup_c461, c468, attrsup_c14780 etc.).
The manifest for the new GUID is marked as a secure/kernel provider,
meaning it is disabled by default and its data is emitted only to
sessions that explicitly request SECURITY_EVENT access.  No other data
flow is modified.

Security Impact
--------------------------------------------------------------------
Before the fix, NTFS could leak internal metadata (and occasionally
user data) into log files readable by lower-privileged users or anyone
with offline access, violating confidentiality.  With the secure
provider this information is no longer logged unless an administrator
creates a protected trace session.

Fix Effectiveness
--------------------------------------------------------------------
The only change is the provider GUID and associated descriptors; event
payload construction still exists but is gated behind a provider that
ordinary sessions cannot enable.  Thus the sensitive data path is no
longer reachable for normal or accidental logging scenarios.  No new
attack surface is introduced, and the mitigation is deemed effective.
