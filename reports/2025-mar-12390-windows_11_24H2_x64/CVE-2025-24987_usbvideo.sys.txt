{'patch_store_uid': '13c1e87d-a065-4d51-b526-a46f95d9c939', 'confidence': 0.15, 'cve': 'CVE-2025-24987', 'change_count': 27, 'date': 1751865219.4717171, 'kb': 'KB5053598', 'file': 'usbvideo.sys'}
--------------------------------------------------------------------
CVE-2025-24987 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows USB Video Class driver (usbvideo.sys) – routine
GetEndpointDescriptor(), invoked while parsing USB configuration and
interface-specific descriptors for UVC devices.

Vulnerability Class
--------------------------------------------------------------------
Out-of-bounds Read (CWE-125) that can be leveraged for kernel
information disclosure and local Elevation of Privilege.

Detailed Root Cause Analysis
--------------------------------------------------------------------
The routine walks a caller-supplied descriptor buffer to locate a USB
endpoint descriptor that matches a requested transfer type (argument
`a3`).

Pre-patch logic used the following pattern:
  • `DescriptorBuffer` was typed as `unsigned __int16 *`.  Adding an
    integer to that pointer scaled by two, so
      `DescriptorBuffer + *v9`
    advanced twice as far as the 16-bit size field actually specifies.
  • The search loop updated the cursor with raw pointer arithmetic:
        i = &v12->bLength + v12->bLength
    without validating that `bLength` is non-zero or that the resulting
    address still lies inside the original buffer.
  • The very first instruction inside the loop did
        p_bLength = &v12->bLength;
    before checking whether `v12` is NULL.  When
    `USBD_ParseDescriptors()` failed and returned NULL, the code
    nonetheless computed a new pointer based on address 0, producing a
    pointer that refers to unmapped or unrelated kernel memory.

By presenting a crafted configuration descriptor in which the final
sub-descriptor advertises a `bLength` of 0 or a length that extends
beyond the end of the overall descriptor set, an attacker can force the
cursor past the buffer’s boundary.  Subsequent iterations call
`USBD_ParseDescriptors()` on this out-of-range address, causing the
kernel to read arbitrary memory.  Because descriptor parsing occurs in
the context of `usbvideo.sys` during device enumeration, this condition
is reachable by plugging in a malicious USB video device while an
administrator is logged on.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable loop (pre-patch)
for (i = a2; ; i = &v12->bLength + v12->bLength) {
    v12 = USBD_ParseDescriptors(DescriptorBuffer, *v9, i, 5);
    p_bLength = &v12->bLength;     // executed even when v12 == NULL
    if (!v12)
        break;                     // OOB pointer already computed
    if (v12[1].bLength == a3) {
        if (v12 > NextVideoAltSetting)
            p_bLength = 0;
        break;
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Malicious USB camera is connected.
2. USB stack issues URB to enumerate configuration.
3. usbvideo.sys -> `USBVid_ParseConfigurationDescriptors()` (caller
   name simplified) -> `GetEndpointDescriptor()`.
4. Crafted last descriptor claims `bLength = 0` (or oversize).
5. Loop in `GetEndpointDescriptor()` advances past buffer, performs
   out-of-bounds read when calling `USBD_ParseDescriptors()` again.
6. Kernel discloses memory or crashes, enabling further exploitation.

Attack Vector
--------------------------------------------------------------------
Physical attack with a specially crafted USB Video Class device (or
emulator) that returns a malformed configuration or interface alternate
setting descriptor block when the host requests descriptors.

Patch Description
--------------------------------------------------------------------
• Parameter `DescriptorBuffer` retyped to `char *`, eliminating 2-byte
  scaling side effects.
• New `StartPosition` argument replaces unsafe in-function cursor math.
• Calls replaced with `USBParseDescriptorWrapper()`, which receives the
  total buffer size and a minimum descriptor length (7), ensuring the
  returned descriptor is fully contained within the buffer.
• Added NULL checks before every dereference or pointer arithmetic.
• After locating a candidate descriptor the code verifies that the
  pointer is not past `NextVideoAltSetting`; otherwise it is nulled.

Security Impact
--------------------------------------------------------------------
Prior to the fix a local, physical attacker could supply descriptors
that trick usbvideo.sys into reading kernel memory outside the trusted
USB buffer.  Information disclosure can bypass KASLR or leak tokens and
may be chained with other bugs for full kernel Elevation of Privilege.

Fix Effectiveness
--------------------------------------------------------------------
The wrapper-based parsing enforces explicit length checks, and all
pointer arithmetic is now performed only after verifying non-NULL
pointers and buffer boundaries.  Combined with the corrected pointer
base type, the OOB read avenue is closed.  No alternate paths in the
function bypass the new checks, so the patch appears complete for this
routine.
