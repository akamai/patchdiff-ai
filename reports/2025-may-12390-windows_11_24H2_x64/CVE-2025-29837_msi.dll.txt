{'date': 1751781027.6298983, 'file': 'msi.dll', 'cve': 'CVE-2025-29837', 'patch_store_uid': '53dca6a2-4438-46c8-80db-00ae8ec17e3c', 'confidence': 0.18, 'kb': 'KB5058411', 'change_count': 8}
--------------------------------------------------------------------
CVE-2025-29837 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Installer (msi.dll) – functions CMsiOpExecute::RemoveFile() and
CMsiTable::AllocateData().  Only RemoveFile() is relevant to the
information-disclosure bug fixed under CVE-2025-29837.

Vulnerability Class
--------------------------------------------------------------------
Improper link resolution before file access (CWE-59, Link­-following).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The privileged MSI engine (running as SYSTEM) removes files during
un-install by calling CMsiOpExecute::RemoveFile().  When the target
lies inside the product’s backup folder the old code executed the
following sequence:

 1. IsInBackupFolder() => sets flag = TRUE.
 2. Immediately calls CElevate::CElevate() to obtain full SYSTEM
    privileges.
 3. Calls LockdownPath(targetPath, 0) and later CreateFileW() with
    GENERIC_READ | FILE_SHARE_READ, **without** validating that
    targetPath is on the system drive *or* that it is free of reparse
    points / junctions.

Because CreateFileW is invoked without the FILE_FLAG_OPEN_REPARSE_POINT
flag the API follows reparse points.  A local attacker who can create a
junction/symlink under the product’s backup folder can therefore coerce
Windows Installer into opening an arbitrary file elsewhere on the
system.  Subsequent code paths (e.g. BackupFile(), VerifyAccessibility
and MoveFileW()) may copy or log that data, resulting in unintended
information disclosure from SYSTEM to the attacker’s account.

Patch version inserts an optional WIL feature gate
`Feature_Servicing_MSI_GlobalAlloc_buffer_fixes` (id 2578215227) and,
more importantly, a new gate `Feature_2684632377` around additional
validations:

 • Before LockdownPath() the code now calls
   CheckSystemDrivePath(path,&flag).  If the candidate points outside
   the system drive the function logs an error and aborts.
 • Additional AIS (Advanced Installer Service) token / flag checks are
   performed; if the caller is non-admin and neither AIS nor SYSTEM
   applies, the removal is denied.
 • The junction-safety CreateFileW probe remains, but is now executed
   only after the above validations succeed.

Fail-fast returns (value 0 / 1) replace the old behaviour, stopping the
flow before any privileged file handle is obtained on an unsafe path.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
/* BEFORE – no system-drive or junction check */
if ( (_BYTE)v74 )
{
    CElevate::CElevate((CElevate *)&v74, 1);
    v32 = (...)(v69, 80);           // target path
    v33 = LockdownPath(v32, 0);
    ...                             // continues with CreateFileW()
}

/* AFTER – added validation */
if ( (_BYTE)v81 )
{
    if (CheckSystemDrivePath(v30, &v81) != 1) {
        DebugString(... "ERROR: Check System Drive Path %s unsuccessful");
        goto bailout;
    }
    if (IsAdmin() || GetAISToken() || GetAISFlag() || (_DWORD)v81==1)
        CElevate::CElevate((CElevate *)&v81, 1);
    else {
        StartImpersonating();
        LockdownPath(...);
        StopImpersonating(...);
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker installs a package whose backup folder is writable.
2. Attacker creates a junction inside that folder pointing to a
   sensitive file (e.g. C:\Windows\System32\config\SAM).
3. Package uninstall calls CMsiOpExecute::RemoveFile().
4. Old code elevates and opens the junction, leaking the SAM file’s
   contents (via backup or logging).
5. Patch aborts at CheckSystemDrivePath(), preventing the open.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker with write access to a product’s backup
folder (typically the user performing the install) creates a reparse
point to an arbitrary target.  Windows Installer running as SYSTEM then
follows the link during RemoveFile(), exposing the target’s data.

Patch Description
--------------------------------------------------------------------
 • Introduced CheckSystemDrivePath() verification before any privileged
   access to a backup-folder file.
 • Added AIS token / flag logic to decide whether full elevation is
   necessary; otherwise operates under impersonation.
 • Wrapped new logic in a WIL feature gate (id 2684632377) for safe
   rollout.
 • Numerous variable renames/refactors; functional change is confined
   to the new validations and early exits.

Security Impact
--------------------------------------------------------------------
Before the fix a non-privileged user could cause Windows Installer to
open (and potentially copy or log) arbitrary files with SYSTEM
privilege, resulting in local information disclosure and a breach of
the NTFS security boundary.

Fix Effectiveness
--------------------------------------------------------------------
The added CheckSystemDrivePath() plus AIS/admin gating blocks paths that
resolve outside the system drive or through reparse points, removing
the unsafe link-following scenario.  Provided the WIL feature flag is
deployed/enabled globally the patch fully mitigates the described
attack.
