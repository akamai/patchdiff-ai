{'confidence': 0.21, 'file': 'printworkflowservice.dll', 'date': 1751781017.058594, 'change_count': 61, 'patch_store_uid': '63bab86f-6596-41af-a752-9d67983f99a7', 'cve': 'CVE-2025-29841', 'kb': 'KB5058411'}
--------------------------------------------------------------------
CVE-2025-29841 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Universal Print Management Service (printworkflowservice.dll)
Affected routines
  • PrintSupportVirtualPrinterSession::RequestPreferredPdlHandleForWrite()
  • DuplicateHandleToClient()
The service runs inside the PrintWorkflow host under Local System.

Vulnerability Class
--------------------------------------------------------------------
Improper access-control / local privilege-escalation caused by mishandled
handle duplication (closely maps to CWE-362 “race condition” in the MS
bulletin, but the concrete defect is missing validation of pseudo
handles).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The service must pass two internal file handles (this->50 and this->53)
from the privileged workflow process to the calling user process.  In
pre-patch code the control flow was split by a feature flag
Feature_2578215227:

  if (FeatureEnabled)
       DuplicateHandleToClient(priv_handle,…);
  else
       OpenProcess(callerPid);
       DuplicateHandle(GetCurrentProcess, priv_handle, callerProc,…);

When the flag was disabled the fallback branch executed a raw
DuplicateHandle() on “priv_handle” *without* any validation.  If the
stored value happened to be a pseudo handle (-1, ‑2, etc.) or was
already freed, the call duplicated the service’s own privileged process
handle (pseudo handle ‑1) straight into the unprivileged caller.  The
caller thus received a Local System process handle with full access and
could elevate privileges.

DuplicateHandleToClient() itself contained a guard against pseudo
handles, but that guard was only executed when the same feature flag was
active:

    if (FeatureEnabled && IsPseudoHandle(src)) Throw(E_HANDLE);

Hence, as long as Feature_2578215227 was OFF (default on affected
builds), the unsafe path was taken and the guard was skipped – a classic
logic flaw introduced by inconsistent gatekeeping.

Structures / parameters involved
  • this+0x190 (index 50) – read-write PDL file handle
  • this+0x1A8 (index 53) – preferred PDL handle
  • HANDLE a2/a3 – out parameters returned to caller
  • DuplicateHandleToClient(HANDLE hSourceHandle,…)

No additional locking is performed; multiple callers can race the state
of the stored handles, which could also convert the bug into an
in-service use-after-free, explaining Microsoft’s secondary CWE-416
classification.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// RequestPreferredPdlHandleForWrite – vulnerable branch removed
- if (!FeatureEnabled) {
-     HANDLE hCaller = OpenProcess(PROCESS_DUP_HANDLE, 0, callerPid);
-     DuplicateHandle(GetCurrentProcess(), this->hPref, hCaller, …);
- }
+ // Always use validated helper
+ DuplicateHandleToClient(this->hPref, a2);
```

```c
// DuplicateHandleToClient – validation widened
- if (FeatureEnabled && IsPseudoHandle(src)) Throw(E_HANDLE);
+ if (IsPseudoHandle(hSourceHandle)) Throw(E_HANDLE);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privileged client calls the WinRT projection that reaches
   RequestPreferredPdlHandleForWrite().
2. Feature_2578215227 is disabled → old fallback path followed.
3. Service reads a pseudo handle value (-1) from its session object
   (attacker can race or coerce this beforehand).
4. DuplicateHandle() is invoked, duplicating the service’s own process
   handle into the attacker’s process.
5. Attacker now holds a Local System process handle → privilege
   escalation.

Attack Vector
--------------------------------------------------------------------
Local.  Requires the ability to start a Print Support app / Virtual
Printer session, which is allowed to any authenticated user.
No special privileges are needed beyond that.

Patch Description
--------------------------------------------------------------------
• Removed the entire fallback code path that manually opened the caller
  process and duplicated raw handles.
• RequestPreferredPdlHandleForWrite() now *always* routes through
  DuplicateHandleToClient().
• DuplicateHandleToClient() renamed its first parameter to HANDLE and
  performs an unconditional IsPseudoHandle() test, independent of any
  feature flag.
• Telemetry IDs updated; no behavioural change.

Security Impact
--------------------------------------------------------------------
Before the patch an unprivileged local user could obtain a full-access
handle to the service process (Local System).  With that handle the user
can inject code, manipulate memory, or duplicate further privileged
handles, achieving complete local privilege escalation.

Fix Effectiveness
--------------------------------------------------------------------
The insecure branch has been entirely excised and the helper routine now
rejects all pseudo handles by design, closing the direct privilege
escalation vector.  Unless other unchecked handle sources exist, the fix
is effective.  No regression paths were observed in the diff.
