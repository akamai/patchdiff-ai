{'change_count': 15, 'file': 'provcore.dll', 'cve': 'CVE-2025-62218', 'patch_store_uid': 'e0153e30-b6d6-4f95-a5e6-5c7ee980e3fc', 'kb': 'KB5068861', 'date': 1763409893.2063422, 'confidence': 0.17}
--------------------------------------------------------------------
CVE-2025-62218 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
provcore.dll – Microsoft Wireless Provisioning System (COM class
ProvisioningEngine) and related ATL wrapper objects.

Vulnerability Class
--------------------------------------------------------------------
Race condition / improper synchronisation (CWE-362).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The ProvisioningEngine class maintains a deque (member
m_msgTimeWindow) that records timestamps used by
IsMessageThrottlingRequired().  Prior to the patch this container was
accessed from different threads by
ProvisioningEngine::ProcessNotification() without any mutual exclusion
and its dedicated critical section was never created.

Constructor chain before the patch
  ATL::CComObject<ProvisioningEngine>::CComObject<>()
  • no call to InitializeCriticalSection on m_msgTimeWindowLock

Process flow before the patch
  ProcessNotification() → IsMessageThrottlingRequired(*deque)
  → direct container access (read/write) while other threads can enter
the same code path concurrently.

Because the deque can reallocate its internal buffer, concurrent
push/pop operations lead to use-after-free or memory corruption in the
address space of the privileged COM service.  An attacker able to send
parallel provisioning notifications can trigger the corrupt state and
execute arbitrary code in the service context, thereby elevating local
privileges.

Structures/fields affected
  • ProvisioningEngine::m_msgTimeWindow (std::unique_ptr<deque<u64>>)
  • ProvisioningEngine::m_msgTimeWindowLock (RTL_CRITICAL_SECTION)
  • ATL wrapper objects that embed a ProvisioningEngine instance
    (CComObject / CComAggObject).

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE – no lock, CS never initialised
if (IsMessageThrottlingRequired(
        *(std::deque<unsigned __int64> **)&this->m_critsec.m_bInitialized))
{
    CurrentThread = GetCurrentThread();
    SetThreadPriority(CurrentThread, 0x10000);
}
```
```c
// AFTER – critical section created and used
EnterCriticalSection(&this->m_msgTimeWindowLock.m_cs);
wil::unique_any lock(&this->m_msgTimeWindowLock.m_cs);
bool throttle = IsMessageThrottlingRequired(
        *(std::deque<unsigned __int64> **)&this->m_critsec.m_bInitialized);
// lock goes out of scope -> LeaveCriticalSection()
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
Client thread(s) → IProvisioningEngine::ProcessNotification()
 → unsynchronised access to m_msgTimeWindow deque → concurrent thread
enters same path → container reallocation/use-after-free → memory
corruption → attacker-controlled code execution in service process.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker launches multiple threads (or processes)
that simultaneously invoke the COM interface
IProvisioningEngine::ProcessNotification on the Wireless Provisioning
System service, racing the shared deque manipulation.

Patch Description
--------------------------------------------------------------------
1. Added member m_msgTimeWindowLock (RTL_CRITICAL_SECTION).
2. ProvisioningEngine::ProvisioningEngine now calls
   InitializeCriticalSectionEx(&m_msgTimeWindowLock).
3. Destructor deletes the critical section.
4. ProcessNotification now wraps the throttle-check inside
   Enter/LeaveCriticalSection using wil::unique_any_t helper.
5. ATL wrapper constructors/destructors updated to invoke the new
   constructor/destructor so the critical section is correctly created
   and destroyed for every object instance.
6. Allocation sizes in CreateInstance adjusted for the larger object.

Security Impact
--------------------------------------------------------------------
Before the patch, concurrent unsynchronised access allowed memory
corruption in a privileged service, resulting in a local Elevation of
Privilege (EoP).

Fix Effectiveness
--------------------------------------------------------------------
All entry points that access m_msgTimeWindow are now protected by a
properly initialised critical section, eliminating the race window.
No remaining unsynchronised accesses were observed in the diff,
indicating the fix is sufficient as long as future code paths respect
the same locking discipline.
