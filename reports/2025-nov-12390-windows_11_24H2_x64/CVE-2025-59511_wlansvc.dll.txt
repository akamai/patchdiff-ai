{'patch_store_uid': 'f4cabb51-c354-4ee2-9887-6663abafd439', 'date': 1763410002.7088022, 'kb': 'KB5068861', 'file': 'wlansvc.dll', 'confidence': 0.2, 'cve': 'CVE-2025-59511', 'change_count': 202}
--------------------------------------------------------------------
CVE-2025-59511 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows WLAN AutoConfig service (wlansvc.dll) – Cloud-Store profile
synchronisation helpers:
 • CdsTriggerSyncWithProfileDeletion()
 • CdsTriggerSyncIfNeededForLoggedInUsers()
 • CdsTriggerSyncIfProfileEligible()

Vulnerability Class
--------------------------------------------------------------------
Privilege-escalation caused by External Control of File Name or Path
(CWE-73) due to missing impersonation while performing privileged file
/ registry writes.

Detailed Root Cause Analysis
--------------------------------------------------------------------
wlansvc runs as LocalSystem.  When a WLAN profile is added, removed or
modified the service records synchronisation state through the internal
call
    Windows::Internal::WiFiCloudStore::StoreSyncNeededProfileInRegistry()
which ultimately touches files / registry locations that depend on the
user SID and a profile-supplied GUID.

Before the patch the three helper functions accepted an optional user
TOKEN handle but used it only to query TOKEN_USER in order to obtain the
SID:
    get_token_information_nothrow<_TOKEN_USER>()  ->  SID
The service then passed that SID and attacker-controlled profile data to
StoreSyncNeededProfileInRegistry **while still executing in the
LocalSystem security context**.  No DuplicateToken/Impersonate* call was
performed.  Consequently all filesystem / registry activity happened
with SYSTEM privileges, yet the destination path was entirely derived
from external input (profile GUID, metadata fields such as
LastModified, CreatorSID, etc.).  A normal user could craft those inputs
(e.g. through a malicious WLAN XML profile) so that wlansvc wrote or
created arbitrary paths, allowing a full local elevation of privilege.

Patched code shows the exact fix:
 • a real user token is obtained (either supplied by the caller or via
   GetFirstLoggedOnUserToken/UMgrQueryUserToken).
 • DuplicateToken(SecurityImpersonation) is called.
 • wil::impersonate_token_nothrow() impersonates the user **before** any
   call to StoreSyncNeededProfileInRegistry() or
   IsSyncNeededForUser().
 • After the operation the thread reverts to self and all handles are
   closed.
Additional error checking, feature-flag gating and detailed logging were
added.  Because the privileged write now runs under the unprivileged
user’s identity, the user can affect only paths he already owns and can
no longer abuse wlansvc to write system-protected locations.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
if (aTokenHandle)
    get_token_information_nothrow(&_sidBuf, aTokenHandle);
StoreSyncNeededProfileInRegistry(pGuid, sid, name, &ft, 1, MAXGEN, &f);
```
```c
// after
if (!DuplicateToken(aTokenHandle, SecurityImpersonation,
                    &dupTok) ||
    wil::impersonate_token_nothrow(dupTok) < 0)
    goto error;
StoreSyncNeededProfileInRegistry(pGuid, sid, name, &ft, 1, MAXGEN, &f);
// revert & clean-up follows
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Unprivileged user installs / deletes / edits a WLAN profile.
2. wlansvc processes the notification and calls one of the CdsTrigger*
   helpers.
3. Helper previously wrote synchronisation state with SYSTEM rights
   using attacker-controlled profile data -> arbitrary file/registry
   write.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker provides a specially crafted WLAN XML
profile (or repeatedly removes profiles) whose metadata embeds
path-traversal or reparse-point tricks.  When wlansvc processes the
profile it writes the attacker-chosen path as SYSTEM, enabling local
privilege escalation.

Patch Description
--------------------------------------------------------------------
• Added acquisition of a real user token (GetFirstLoggedOnUserToken /
  UMgrQueryUserToken).
• Added DuplicateToken(SecurityImpersonation) and
  wil::impersonate_token_nothrow() so that the thread executes as the
  target user while writing synchronisation data.
• Introduced extensive error handling and logging for all token and
  impersonation operations.
• Updated trace-IDs (WPP) and guarded new behaviour behind a feature
  flag to maintain compatibility.

Security Impact
--------------------------------------------------------------------
Prior to the fix a normal user could coerce wlansvc to create or
overwrite arbitrary files or registry keys with SYSTEM privileges,
leading to full local elevation of privilege.  The vulnerability is
tracked as CVE-2025-59511.

Fix Effectiveness
--------------------------------------------------------------------
By executing StoreSyncNeededProfileInRegistry under impersonation, all
subsequent file or registry operations inherit the user’s security
context.  Therefore the service no longer performs privileged writes on
attacker-supplied paths.  The added clean-up and error checks prevent
handle leaks and fallback-to-SYSTEM scenarios.  No residual privileged
write path was observed in the patched functions, so the fix appears
complete.
