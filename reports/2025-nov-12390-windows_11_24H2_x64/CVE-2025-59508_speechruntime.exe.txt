{'date': 1763409912.5921514, 'file': 'speechruntime.exe', 'patch_store_uid': 'ac1e457b-c56f-4ee7-b47c-3c0a37f29444', 'change_count': 25, 'cve': 'CVE-2025-59508', 'confidence': 0.19, 'kb': 'KB5068861'}
--------------------------------------------------------------------
CVE-2025-59508 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows 10/11 speechruntime.exe –  Voice Activation Controller
(NLInternal::CVoiceActivationController) and related helper
wrappers (CVAEngineModelWrapper / CAudioPolicyWrapper).

Vulnerability Class
--------------------------------------------------------------------
Race Condition – concurrent access to shared controller state
(CWE-362).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The Voice-Activation controller keeps a per-instance flag that
tracks whether the speech engine is running in "training" mode.
In the original build this flag resided at offset +128 in the
object (DWORD 0 or 1).  Several public methods manipulate this flag
and then forward the value to the underlying
ISpAudioOrchestrator[Input|Policy] objects:

 • StartModelTraining[ _Old ]
 • CommitModelTraining
 • CancelModelTraining
 • ProcessAudioForModelTraining
 • SetAudioOrchestratorTrainingMode

Prior to the patch the helper
NLInternal::CVoiceActivationController::SetAudioOrchestratorTrainingMode
executed without any synchronisation; it simply checked the field
and – if different – called
ISpAudioOrchestratorInput::SetTrainingMode(…) and wrote the new
value back.  All callers relied on that routine and therefore were
also unsynchronised.

Because the controller object is COM-exposed (ImplementsHelper
<IWeakReferenceSource, …>) multiple threads in the same process can
obtain a reference and call those APIs concurrently.  Two threads
executing StartModelTraining / CancelModelTraining at the same time
could interleave as follows:

  T0: reads TrainingMode = 0
  T1: reads TrainingMode = 0
  T0: sets orchestrator to 1 (training) …
  T1: sets orchestrator back to 0 …
  T0: continues under the assumption that training is active

The window allows a caller that controls timing to force the engine
into an undocumented internal state in which privileged operations
(e.g. access to microphone data guarded by the training gate) are
executed while the policy layer believes training is disabled.  The
result is a local privilege escalation inside the Speech service.

Affected data:
  Offset +128 (old layout) / +56 (new layout) : DWORD
  this->m_spAudioOrchestratorInput           : ISpAudioOrchestrator*

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE (no locking)
__int64 SetAudioOrchestratorTrainingMode(__int64 a1, UINT mode)
{
    if (*(DWORD*)(a1+128)==mode) return 0;
    ISpAudioOrchestratorInput* ao = GetAO(a1,&ptr);
    ao->SetTrainingMode(mode);
    *(DWORD*)(a1+128)=mode;          // unprotected write
}

// AFTER
EnterCriticalSection(this+184);      // new CS
if (this->m_trainingMode!=mode) {
    ao->SetTrainingMode(mode);
    this->m_trainingMode = mode;     // protected write
}
LeaveCriticalSection(this+184);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker obtains two (or more) COM references to
   IVoiceActivationController.
2. Thread-A calls StartModelTraining() and is pre-empted after
   SetAudioOrchestratorTrainingMode writes 1 but before the engine
   call.
3. Thread-B calls CancelModelTraining(), resets the mode to 0.
4. Thread-A resumes and executes sensitive engine calls while the
   rest of the subsystem assumes training is disabled.

Attack Vector
--------------------------------------------------------------------
Local – any low-privileged process that can load the Speech runtime
and obtain a controller interface.  No admin rights required; only
local code execution on the same machine.

Patch Description
--------------------------------------------------------------------
1. Introduced a dedicated critical section at offset +184 and added
   Enter/LeaveCriticalSection around all accesses to the training
   mode field when the new platform setting feature is enabled.
2. Updated SetAudioOrchestratorTrainingMode to perform the entire
   get-AO / SetTrainingMode / state-update sequence inside the
   critical section.
3. Migration to a new code path (StartModelTraining_New etc.) that
   consistently uses the protected helper.
4. Added extensive DoTraceMessage() calls for easier failure audit
   and feature-flag gating via
   Feature_UseSpeechPlatformSettings.

Security Impact
--------------------------------------------------------------------
Without the fix an attacker can win a race and execute privileged
speech-engine operations in a context where access should be
prohibited, effectively elevating privileges in the Windows Speech
service (EoP).

Fix Effectiveness
--------------------------------------------------------------------
The patch serialises all state transitions through a private
critical section, eliminating the time-of-check/time-of-use gap and
preventing concurrent threads from observing stale training state.
No remaining unsynchronised writes to the field were observed in the
updated code paths, so the fix is considered effective.
