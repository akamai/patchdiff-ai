{'cve': 'CVE-2025-60721', 'file': 'peauth.sys', 'change_count': 2, 'kb': 'KB5068861', 'confidence': 0.15, 'date': 1763409834.6257224, 'patch_store_uid': '41b13c75-ed0a-4f1b-9b2e-0cb89f0cc6c9'}
--------------------------------------------------------------------
CVE-2025-60721 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
peauth.sys  (Windows Administrator Protection driver)
Affected
routine: SymCryptRsaPkcs1ApplySignaturePadding
(sub_14000A1E8) and associated higher-level caller
sub_14000B710.

Vulnerability Class
--------------------------------------------------------------------
Memory corruption / buffer overflow caused by insufficient argument
validation (CWE-120 / CWE-131).  Public bulletin lists it under
"Privilege Context Switching Error" but the observable root cause is
a kernel-mode write beyond the supplied output buffer.

Detailed Root Cause Analysis
--------------------------------------------------------------------
The helper routine SymCryptRsaPkcs1ApplySignaturePadding is used by the
PEAuth driver to build PKCS#1 v1.5 signature blocks inside a caller
supplied buffer (argument a6, size a7).

1.  Before the fix the function only rejected unexpected flag bits and
    performed the check
       if (v11 > 0x80 || v11 + 11 > a7) return 32782;
    where v11 is the computed payload length.  No limit existed for the
    original message length (a2) with respect to the destination size
    a7, so a2 could be chosen equal to a7 or larger, making the final
    memmove() copy overlap or run past the end of the caller supplied
    buffer.

2.  In addition, the combination logic for optional parameters a3/a4
    (ASN.1 encoded algorithm identifier) accepted the illegal state
    "a3 == NULL && a4 != 0" or "a3 != NULL && a4 == 0".  For the latter
    case v11 was calculated as a2 + 6 even though nothing was actually
    copied from a3, shifting every subsequent write six bytes further
    than intended.

3.  Caller sub_14000B710 allocates several temporary buffers and then
    re-uses the padded signature blob produced by
    SymCryptRsaPkcs1ApplySignaturePadding.  Because the routine could
    overrun its output, adjacent heap arenas allocated through
    SymCryptCallbackAlloc are corrupted.  The corrupted data are later
    interpreted as big-integer limbs or EC points, ultimately allowing a
    local attacker to pivot the execution flow inside the kernel and
    run arbitrary code with SYSTEM privileges.

Affected structures / parameters
    a1  : pointer to message to be signed (user controlled)
    a2  : length of message (user controlled)
    a3  : optional algorithm identifier
    a4  : length of a3
    a5  : option flags (only bit 0 valid)
    a6  : kernel buffer supplied by caller of peauth.sys
    a7  : size of a6 in bytes

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Old code – missing upper bound for a2
if ( (a5 & 0xFFFFFFFE) != 0 )
    return 32782;
...
if ( v11 > 0x80 || v11 + 11 > a7 )
    return 32782;
...
memmove(v14, a1, a2);     // may write past end of buffer a6
```
```c
// Patched code – extra checks
if ( (a5 & 0xFFFFFFFE) != 0 || a2 >= a7 )
    return 32782;          // new size gate
...
if ( v11 > 0x80 )
    return 32782;
if ( v11 + 11 > a7 )
    return 32782;          // split for clarity
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User-mode -> IOCTL to peauth.sys -> sub_140044E74 … ->
sub_14000A1E8 (build padding) -> corrupted heap in
sub_14000B710 -> subsequent big-integer operations use corrupted
memory -> arbitrary kernel memory overwrite / EOP.

Attack Vector
--------------------------------------------------------------------
A local, authenticated attacker sends a crafted request that reaches the
peauth.sys signature-creation path (e.g., through the Windows
Administrator Protection service).  By selecting
    a2 >= a7  and mismatching a3/a4 parameters
he forces SymCryptRsaPkcs1ApplySignaturePadding to write beyond the end
of the kernel buffer, leading to privilege escalation to SYSTEM.

Patch Description
--------------------------------------------------------------------
1. Added explicit size gate  "a2 >= a7".
2. Separated the two length tests to guarantee both conditions are
   evaluated after v11 is known.
3. Re-worked the a3/a4 decision table: only exact (ptr+len) pairs are
   accepted; any mismatch now returns 32782.
4. Caller function migrated to safer helper routines
   (sub_1400118A0, sub_14000B650, sub_14000AC20, etc.) and changed
   several magic parameters from 0 to 1, indicating hardened
   semantics.

Security Impact
--------------------------------------------------------------------
Prior to the fix, an authorized but unprivileged local user could
corrupt kernel heap structures and execute arbitrary code in kernel
context, resulting in a full privilege escalation to SYSTEM.

Fix Effectiveness
--------------------------------------------------------------------
The additional bounds check ensures that the source length (a2) can no
longer exceed the destination, and the stricter parameter validation
eliminates inconsistent (a3/a4) combinations.  Together with the switch
to hardened helper functions in the caller, the patch fully prevents the
observed overflow condition.  No residual write past end-of-buffer path
could be identified during diff analysis, though a comprehensive audit
of surrounding SymCrypt helpers is still recommended.
