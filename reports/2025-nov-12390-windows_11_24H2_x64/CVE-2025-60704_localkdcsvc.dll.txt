{'date': 1763412297.0907602, 'patch_store_uid': 'ebb48eb1-5fd3-42d4-bbd5-4d85861cfac1', 'kb': 'KB5068861', 'confidence': 0.18, 'change_count': 8, 'file': 'localkdcsvc.dll', 'cve': 'CVE-2025-60704'}
--------------------------------------------------------------------
CVE-2025-60704 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Kerberos Key Distribution Center (KDCSVC)
Function: localkdcsvc!HandleTGSRequest()
Module: localkdcsvc.dll (all server editions of Windows)

Vulnerability Class
--------------------------------------------------------------------
CWE-325: Missing Cryptographic Step / logic flaw in the generation of
S4U-to-Self service tickets.

Detailed Root Cause Analysis
--------------------------------------------------------------------
When the KDC processes a TGS-REQ that includes S4U-to-Self or
S4U-to-Proxy data it may have to generate an additional PA-DATA item
(type 130 – PA_S4U_X509_USER) that is **encrypted with a key that is
cryptographically bound to the request**.  In the unpatched routine the
code executed the following sequence:

1. Construct the reply body.
2. Unconditionally call
   KdcAddEncryptedS4uPaData(&replyInfo,&paList)                                
   even if the current KDC account did **not** possess a suitable key
   (AES/RC4 attributes not checked) or the pointer to a key was NULL.
3. The function therefore produced an S4U_X509_USER blob that was either
   – encrypted with a caller-controlled weak key, or
   – contained **no encryption at all** (zero-length key) and was merely
     copied into the ticket.
4. The forged blob is later honoured by every domain controller that
   validates the ticket, resulting in the PAC being accepted as
   originating from the KDC itself.

Because no cryptographic binding existed between the generated PA data
and a strong server key, a normal domain user could craft a TGS-REQ that
caused the local KDC to emit a service ticket containing a malicious
S4U_X509_USER entry that represents an arbitrary principal.
Possession of such a ticket allows the attacker to request additional
service tickets (S4U2proxy) and ultimately impersonate any domain
account – a full elevation of privilege across the network.

Vulnerability Code Snippets
--------------------------------------------------------------------
Pre-patch excerpt (simplified):
```c
// key pointer may be NULL or weak RC4 key
enckey = KerberosCryptoPolicy::GetKey(policy, 0x200000011, 0);
// ... return value not verified ...
KdcSignS4UPreauthData(enckey, ...);
...
KdcAddEncryptedS4uPaData(s4uInfo, &PaList);   // always executed
```

Post-patch excerpt:
```c
// Validate cipher capability first
key = KerberosCryptoPolicy::GetKey(policy, 0x200000011, 0);
if (!key) FAIL;
BOOL isStrong = KerberosCryptoPolicy::CipherHasAttribute(
                   key->EType, ENC_ATTR_STRONG, &flag);
if (isStrong && flag)
    KdcAddEncryptedS4uPaData(s4uInfo, &PaList); // only with strong key
```
The patch introduces CipherHasAttribute() and conditional execution so
unencrypted/weak blobs are no longer produced.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker authenticates as any domain user.
2. Sends a crafted TGS-REQ containing PA-S4U-X509-USER and PA-PAC-OPTIONS.
3. HandleTGSRequest builds the reply, hits the vulnerable block and
   returns a service ticket with an unsigned / weakly-signed S4U blob.
4. Attacker presents this ticket to other DCs or services, gaining the
   identity of an arbitrary account (including Domain Admin).

Attack Vector
--------------------------------------------------------------------
Remote, unauthenticated network attacker (any AD account) sends a single
malformed TGS-REQ to the domain controller’s Kerberos service (UDP/TCP
port 88).

Patch Description
--------------------------------------------------------------------
The fix adds a **cryptographic capability check** before the PA data is
produced:
• KerberosCryptoPolicy::CipherHasAttribute() verifies that the selected
  encryption type supports the required attributes (AES/HMAC, key
  usage 0x40000000).
• If the check fails the code skips KdcAddEncryptedS4uPaData(), so no
  unprotected S4U data is ever emitted.
• Additional refactoring (variable renames) and stricter PAC-OPTIONS
  handling were added, but the essential change is the key-attribute
  verification gate.

Security Impact
--------------------------------------------------------------------
Prior to the patch a standard domain user could manufacture a service
(ticket-granting-service) ticket containing arbitrary PAC/S4U data and
escalate to any domain identity.  This yields full domain compromise
(EoP, confidentiality/integrity breach).  The bug is therefore rated
Elevation of Privilege with network vector and high / critical
severity.

Fix Effectiveness
--------------------------------------------------------------------
The added CipherHasAttribute() gate prevents the generation of
unauthenticated PA-S4U-X509-USER blobs; without such a blob the attack
cannot proceed.  No alternate path that bypasses the new check was
observed in the diff.  The fix is considered effective for the specific
flaw addressed.

