{'change_count': 18, 'cve': 'CVE-2025-59510', 'patch_store_uid': 'bfe08754-bf6e-4c08-b544-c34f3a92fb8c', 'file': 'rasmans.dll', 'kb': 'KB5068861', 'confidence': 0.22, 'date': 1763413598.149982}
--------------------------------------------------------------------
CVE-2025-59510 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Routing and Remote Access Service (RRAS) – rasmans.dll

Vulnerability Class
--------------------------------------------------------------------
Improper link resolution before file access (link-following)
CWE-59

Detailed Root Cause Analysis
--------------------------------------------------------------------
RRAS keeps a per-component WPP trace file ( <TracingDir>\<Comp>.BIN ).
The helper path chain before the patch is:
    EnableAutoWPPTracingForSubComponent → GetTracingDir →
    (registry or %windir%\Tracing) → _wfopen_s("w").

1. GetTracingDir():
   • Expands the registry value
     HKLM\SOFTWARE\Microsoft\Tracing\FileDirectory.
   • Simply LocalAlloc()s a buffer, copies the resulting string and
     returns it.  No attempt is made to detect NTFS reparse points,
     junctions or absolute NT paths ("\\?\\", "\\.\\", etc.).

2. EnableAutoWPPTracingForSubComponent():
   • Builds the final path …\Tracing\<Component>.BIN.
   • If it already exists, it is blindly re-created with
     _wfopen_s(path,"w") from a SYSTEM service context.

Because _wfopen_s honours reparse points, an attacker that can
redirect <TracingDir> to a junction/symlink or to an NT device path
can force the service to open, truncate or write to an unexpected
object.  When the target is a device, a non-regular file or points
back into the service’s own image, RRAS dereferences invalid handles
and terminates, producing a denial-of-service condition.

The attacker controls the path via either
    • The writable "FileDirectory" registry value, or
    • Creating a junction named %windir%\Tracing that points elsewhere.
No further validation is performed, so any link that resolves under
SYSTEM privileges is followed.

Patched behaviour:
   • A new GetFolderHandle() / GetFileHandle() pair is used everywhere
     a path is consumed.  These open with FILE_FLAG_OPEN_REPARSE_POINT
     and perform attribute checks; if the object is a reparse point or
     not a directory/file as expected, the call fails.
   • GetTracingDir() now receives an extra out-parameter that returns a
     verified file handle and aborts when the directory fails the safe
     open.  Old registry logic is kept but protected by the new checks.
   • EnableAutoWPPTracingForSubComponent() keeps the safe handle open
     until the trace file is finished and explicitly closes it.
   • A feature-flag gate (Feature_185375035) is present, but when
     enabled the vulnerable code path is no longer reachable.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before – EnableAutoWPPTracingForSubComponent()
TracingDir = GetTracingDir();        // unvalidated path
...
StringCchCatW(pszDest, 0x105, L"\\");
StringCchCatW(pszDest, 0x105, CompName);
StringCchCatW(pszDest, 0x105, L".BIN");
_wfopen_s(&Stream, pszDest, L"w");    // follows links
```

```c
// After – GetTracingDir()
FolderHandle = GetFolderHandle(Path);
if (FolderHandle == INVALID_HANDLE_VALUE) FAIL;
FileHandle   = GetFileHandle(Path, FolderHandle);
if (FileHandle == INVALID_HANDLE_VALUE) FAIL;
*a1 = FileHandle;   // validated handle bubbled up
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker sets HKLM...\Tracing\FileDirectory to "C:\redirect" or
   crafts %windir%\Tracing as a junction.
2. RRAS starts → EnableAutoWPPTracingForSubComponent() executed.
3. Old GetTracingDir() returns attacker-controlled path.
4. Service (SYSTEM) executes _wfopen_s() on the link-controlled path.
5. The link resolves to an unexpected object → service crash / hang →
   denial of service.

Attack Vector
--------------------------------------------------------------------
Local authorised attacker (requires write access to the Tracing
registry key or the ability to create a reparse point under
%windir%).  No network interaction is required.

Patch Description
--------------------------------------------------------------------
1. Introduced GetFolderHandle() / GetFileHandle() helpers that open the
   directory/file with FILE_FLAG_OPEN_REPARSE_POINT and validate
   FILE_ATTRIBUTE_DIRECTORY / FILE_ATTRIBUTE_REPARSE_POINT.
2. Re-wrote GetTracingDir() and GetDefaultDir() to use the safe
   helpers and to return validated handles to callers.
3. Updated all callers (EnableAutoWPPTracingForSubComponent,
   ReadWPPTracingState, TraceEnableDisableWPPComponent, etc.) to work
   with the new safe path-handling functions and close handles
   explicitly.
4. Added a feature-flag gate so that older behaviour can be disabled
   should regression require.

Security Impact
--------------------------------------------------------------------
Prior to the patch a non-privileged but authorised local user could
cause RRAS to follow a malicious link and open a crafted object,
leading to a controlled crash or hang of the Routing and Remote Access
Service.  This denies VPN/RRAS functionality on the host.
No privilege escalation or information disclosure was observed.

Fix Effectiveness
--------------------------------------------------------------------
The new code refuses to work when the directory or file handle
attributes indicate a reparse point, eliminating unintended link
resolution.  All write operations now occur through the validated
handle, and handles are closed deterministically.  The mitigation is
comprehensive provided the new feature flag is enabled system-wide.
