{'file': 'rdpcorets.dll', 'patch_store_uid': '4ed0a982-85fb-4282-a728-b199816a2a22', 'cve': 'CVE-2025-60703', 'confidence': 0.2, 'date': 1763409903.1195471, 'change_count': 10, 'kb': 'KB5068861'}
--------------------------------------------------------------------
CVE-2025-60703 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
rdpcorets.dll – Remote Desktop clipboard helper classes
(CRemapHdropFormatNamePacker, CLongFormatNamePacker) and related
feature-flag helpers in WIL (Feature_EnableZoneIDInRdpClip).


Vulnerability Class
--------------------------------------------------------------------
Untrusted pointer dereference / heap buffer overwrite resulting from
inconsistent size calculation (CWE-822, CWE-122).


Detailed Root Cause Analysis
--------------------------------------------------------------------
Clipboard redirection uses a two-phase contract:
  1.  GetPackageSpaceRequired() scans all clipboard formats that will
      be transferred and returns the number of bytes the caller must
      allocate.
  2.  PackageFormatNames() is then handed that buffer and serialises
      every selected format name.

Prior to the patch the Enterprise/HTML/Rich-Text logic in
CRemapHdropFormatNamePacker::GetPackageSpaceRequired() **never adds the
size for the CF_ZONEIDENTIFIER format** (a 17-character name plus the
length header – 34 bytes) because the code simply did not test the
format id returned by CClipFormatTypes::ZoneIdentifier().  The routine
only counts 122 bytes for the mandatory FileGroupDescriptorW block and
optionally 58 bytes for EnterpriseID.

PackageFormatNames(), however, *does* serialise ZoneIdentifier whenever
it encounters the format during EnumClipboardFormats(), unless the name
is on an internal exclusion list.  Because the buffer was sized without
those extra 34 bytes the routine writes past the caller-supplied
allocation.  The overwrite corrupts the adjacent heap metadata, later
causing a dereference of an attacker-controlled pointer and allowing
local elevation of privilege in the RDP service process.

The issue can be triggered by any session that is allowed to place
arbitrary private clipboard formats on the shared clipboard.  No
administrator rights are required.

Impacted structures / parameters:
  • local variable *a3 (requiredSize) in GetPackageSpaceRequired()
  • memcpy destination in PackageFormatNames() (argument *a2)
  • format id  ZoneIdentifier = CClipFormatTypes::ZoneIdentifier()


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before – GetPackageSpaceRequired()
if ((_BYTE)v15 == 0xFF) {
    *a3 += 122;              // FileGroupDescriptorW
    if (v14) *a3 += 6;       // +FileContents
    if (*((_DWORD*)this+22) && v11)
        *a3 += 58;           // +EnterpriseId
    // ZoneIdentifier NOT added -> size mismatch
}
```
```c
// after – GetPackageSpaceRequired()
if (Feature_EnableZoneIDInRdpClip && v13) {
    *a3 += 34;               // add space for "ZoneIdentifier"
}
```
```c
// before – PackageFormatNames(), inner loop (simplified)
if (format != Html || !v32 || v6 || v39) {
    // writes name + 6 bytes length header into buffer a2
    v7 = CLongFormatNamePacker::PackageFormatName(...);
}
// no size check against original allocation
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
Client clipboard offers private format CF_ZONEIDENTIFIER
→ rdpcorets!CRemapHdropFormatNamePacker::GetPackageSpaceRequired()
   under-allocates buffer (missing +34)
→ caller allocates buffer of that size and calls
   PackageFormatNames(buffer, size)
→ CF_ZONEIDENTIFIER is serialised, memcpy overruns buffer
→ heap metadata / vtable pointer corrupted
→ subsequent service code dereferences corrupted pointer → EoP.


Attack Vector
--------------------------------------------------------------------
From an authenticated RDP session, post a clipboard chain that includes
a custom format with the registered numeric id of
"ZoneIdentifier".  No further privileges are required; clipboard
redirection must be enabled (default).


Patch Description
--------------------------------------------------------------------
1. Added new feature flag Feature_EnableZoneIDInRdpClip and helper code
   (wil::details::FeatureImpl changes).
2. In GetPackageSpaceRequired():
   • Detect ZoneIdentifier when the feature is on and add a fixed
     34-byte contribution to *a3.
3. In PackageFormatNames():
   • Honour the same feature flag before writing the format name.
   • Re-worked enumeration loop and logging; keeps `v54` (remaining
     size) in sync with every successful write.
4. Numerous WPP tracing guids changed (defensive logging only).
No other functional changes were introduced.


Security Impact
--------------------------------------------------------------------
A non-admin user connected through Remote Desktop can corrupt heap
memory inside the RDPCoreTS service and hijack a function pointer,
resulting in local privilege escalation to SYSTEM.


Fix Effectiveness
--------------------------------------------------------------------
With the patch, the buffer size returned by GetPackageSpaceRequired()
now exactly matches what PackageFormatNames() will write.  All writes
stay within bounds and no pointer corruption is possible.  The added
feature gate also allows Microsoft to disable the new path via
configuration if required.  No residual paths that bypass the size
update were observed in the diff.
