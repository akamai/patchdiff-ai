{'patch_store_uid': '6e89b61c-bd67-4d2a-9782-fd415c123ea5', 'date': 1763409824.1461997, 'confidence': 0.12, 'change_count': 7, 'kb': 'KB5068861', 'file': 'consent.exe', 'cve': 'CVE-2025-60718'}
--------------------------------------------------------------------
CVE-2025-60718 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
consent.exe  (UAC / AppInfo –  Administrator-Protection  logic)
The vulnerable code sits in WinMain() and supporting  WIL telemetry
helpers contained in consent.exe.


Vulnerability Class
--------------------------------------------------------------------
Untrusted search path / DLL-search-order hijacking (CWE-426)
This is an Elevation-of-Privilege flaw that lets a local, already
signed-in attacker plant a rogue DLL that will be loaded by the highly
privileged consent.exe process.


Detailed Root Cause Analysis
--------------------------------------------------------------------
1. consent.exe is started by the AppInfo service whenever UAC
   elevation is requested.  Because the binary runs as high-integrity
   it must prevent loading modules from attacker-controlled paths.
2. Microsoft uses PROCESS_MITIGATION_IMAGE_LOAD_POLICY with the flag
   PreferSystem32Images=1 to make the loader always search %SystemRoot%
   \System32 first, thereby neutralising classic DLL planting attacks.
3. In the unpatched WinMain the mitigation was only applied through
   the following sequence:

      if (Feature_ShadowAdmin_IsEnabled())                <-- A
          SetProcessMitigationPolicy(ImageLoadPolicy,1);  <-- B

   a) The feature gate in line A only checked the regular
      ShadowAdmin feature bit.
   b) When the feature was **disabled** (standard client & many server
      SKUs), line B never executed and no image-load policy was set.
4. Once the policy is missing, the default Windows search order
   (current directory –  PATH  –  System32) is used.  During early
   start-up consent.exe implicitly loads several DLLs (faultrep.dll,
   Version.dll, UXTHEME.dll …) by name only.  If an attacker is able to
   place a spoofed copy in the current directory he gains code
   execution inside the high-integrity consent.exe context and can
   elevate privileges.
5. Nothing else in the binary locked down the search path, therefore
   exploitation is fully local and only requires the user to trigger a
   UAC prompt from a writable directory (e.g. the attacker’s own
   Downloads folder).


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// WinMain – BEFORE (excerpt)
if (wil::Feature<ShadowAdmin>::IsEnabled()) {
    ReturnLength = 1;
    SetProcessMitigationPolicy(8, &ReturnLength, 4); // may be skipped
}
```
```c
// WinMain – AFTER (excerpt)
if (wil::Feature<ShadowAdmin>::IsEnabled()) {
    int flags = 0;
    if (Feature_ShadowAdmin__private_IsEnabledDeviceUsageNoInline() &&
        RtlQueryElevationFlags(&flags) >= 0 && (flags & 0x18) == 0x10) {
        ReturnLength = 1;
        SetProcessMitigationPolicy(8, &ReturnLength, 4); // always hit
    }
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User executes a program from an attacker-writable directory.
2. Program requests elevation –> service launches consent.exe.
3. ShadowAdmin feature is disabled –> image-load mitigation **not** set.
4. Loader resolves implicit DLL import; current directory searched
   before System32.
5. Attacker-planted DLL is found and executed with elevated rights.


Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker places a malicious DLL (matching any
imported module name) in the working directory and then triggers a UAC
prompt from that same location.  When consent.exe starts it loads the
malicious DLL and the attacker gains high-integrity code execution.


Patch Description
--------------------------------------------------------------------
• Introduced helper  Feature_ShadowAdmin__private_IsEnabledDeviceUsage
  NoInline() and an additional call to RtlQueryElevationFlags().
• The result gates the call to
  SetProcessMitigationPolicy(PROCESS_MITIGATION_IMAGE_LOAD_POLICY)
  guaranteeing that PreferSystem32Images=1 is applied whenever the
  Administrator-Protection feature is in use on a device that supports
  it.
• Ancillary clean-ups in several GetCurrentFeatureEnabledState()
  helpers do not affect the vulnerability but were refactored while
  touching the same code region.


Security Impact
--------------------------------------------------------------------
Prior to the patch an attacker could reliably load an arbitrary DLL
into a high-integrity consent.exe process, thereby escaping the current
integrity level and achieving local elevation of privilege.  The fix
removes the current-directory element from the search order, closing
this classic DLL planting vector.


Fix Effectiveness
--------------------------------------------------------------------
The patched binary unconditionally sets PreferSystem32Images before any
optional module is loaded, and the check is performed at the very start
of WinMain.  No further calls that could revert the mitigation were
observed.  Therefore the repair is complete and the untrusted search
path is eliminated.

