{'kb': 'KB5068861', 'file': 'termsrv.dll', 'date': 1763409897.8426695, 'confidence': 0.2, 'cve': 'CVE-2025-60703', 'patch_store_uid': '01094cac-7c98-4051-a3df-9110ca0520f4', 'change_count': 49}
--------------------------------------------------------------------
CVE-2025-60703 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Remote Desktop Services (termsrv.dll).  Affected internal COM-
style helper classes include CExecSessionApps::CEventSink, CHybridTeminal,
CConnectionEx and CTSTimerHandlerManager.

Vulnerability Class
--------------------------------------------------------------------
Untrusted Pointer Dereference / Call-through Function Pointer
(CWE-822).

Detailed Root Cause Analysis
--------------------------------------------------------------------
Several IUnknown-like methods inside termsrv.dll were implemented with
unsafe pointer arithmetic that forwarded the call to an adjacent
object by blindly subtracting eight bytes from the supplied this
pointer:

   return sub_180045680(a1 - 8);          // AddRef before patch

Because no validation is performed, any caller that can obtain a
pointer to one of the exposed interfaces may pass a forged address.
The callee will then:
1. Read the vtable pointer found at *(a1-8).
2. Indirectly branch to the function located at vtable[?].

If the attacker places controlled data at that forged address, the
service will dereference an attacker-controlled function pointer and
execute it in the security context of TermService (LOCAL_SYSTEM),
resulting in privilege escalation.

Similar unsafe patterns existed in other wrapper methods
(PreCreate, GetParent, GetLastInputTime, CreateDynamicVirtualChannel,
SessionArbitrationEnumeration, Release, etc.).  Each of them accessed
an internal interface pointer by simple fixed offsets (1592, 1608,
1648) without confirming that the pointer originated from the object’s
constructor or was still valid.

The patch replaces all arithmetic-based delegation with a much safer
lookup:
  vptr = *((QWORD *)this + <constant>);   // <constant> == 199, 201, 206 …
  if (vptr)
      return vtable_call(vptr …);
  return ERROR_ACCESS_DENIED;             // 0x8007001F / 2147943759

The pointer is now obtained from an internal field initialised during
construction and therefore not directly influenceable by the caller.
No subtraction or other address manipulation remains, eliminating the
possibility of redirecting execution through an untrusted pointer.

Structures / parameters affected:
• CExecSessionApps::CEventSink   – member index 199 (0x638) now stores
  the authoritative parent interface pointer used by AddRef.
• CHybridTeminal                 – member index 206 provides the
  SessionArbitrator / ChannelManager interface used by multiple helper
  methods.
• CConnectionEx, CTSTimerHandlerManager – identical changes using
  member indices 201 / 199 respectively.

Vulnerability Code Snippets
--------------------------------------------------------------------
Before (termsrv.dll  pre-patch)
```c
__int64 __fastcall CEventSink::AddRef(__int64 this)
{
    return sub_180045680(this - 8);   // unsafe: a - 8 is attacker-supplied
}
```
After (patched)
```c
__int64 __fastcall CEventSink::AddRef(CEventSink *this)
{
    __int64 parent = *((QWORD *)this + 199);
    if (parent)
        return ((FnAddRef)(*(QWORD *)parent + 8))(parent);
    return 0;
}
```
(Equivalent defensive changes were applied to the other helper
functions listed above.)

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker obtains an interface pointer routed to one of the affected
   COM helpers (e.g. IDynamicVirtualChannelManager, ISessionAppsSink).
2. Attacker crafts a fake object in user memory and passes the fake
   pointer to AddRef / Release / other vulnerable method.
3. Method subtracts eight bytes, reads fake vtable -> controlled
   pointer.
4. TermService jumps to the supplied address and executes attacker code
   as SYSTEM.

Attack Vector
--------------------------------------------------------------------
Requires local RDP session or any context that can call into the
affected in-process COM interfaces exposed by termsrv.  No admin
rights are needed; only the ability to invoke the vulnerable methods
with a crafted pointer, making this an Elevation-of-Privilege scenario.

Patch Description
--------------------------------------------------------------------
• Removed the unsafe "this-8" delegation pattern.
• All methods now retrieve the true parent/interface pointer from a
  dedicated, constructor-initialised member slot.
• Added explicit NULL checks and return standardized error code
  (0x8007001F) when the internal pointer is not present.
• Where appropriate, fixed the vtable index to the correct slot (e.g.
  AddRef uses +8, Release uses +16, functional callbacks use +88/+256
  etc.).
• Large helper that previously duplicated initialization logic
  (SessionArbitrationEnumeration) was replaced by a thin validated
  wrapper.

Security Impact
--------------------------------------------------------------------
Before the patch a local, authenticated RDP user could execute
arbitrary code inside TermService and elevate to SYSTEM by supplying a
fake interface pointer.  Exploitation requires no memory corruption –
only the ability to pass a crafted pointer – making the bug reliable
and low-complexity.  Post-patch the untrusted pointer path is gone,
removing the EoP primitive.

Fix Effectiveness
--------------------------------------------------------------------
The new implementation ensures that only an internally stored, trusted
pointer is dereferenced and that the call is skipped when the pointer
is NULL.  No arithmetic manipulation of the attacker’s input remains.
Barring additional memory corruption elsewhere that could overwrite
the member field, the fix fully closes the described CWE-822 issue.
