{'change_count': 3, 'cve': 'CVE-2025-60708', 'file': 'storvsp.sys', 'kb': 'KB5068861', 'confidence': 0.19, 'patch_store_uid': '21cb550f-dde2-4e2c-9107-72cbda61b7e7', 'date': 1763409892.7953272}
--------------------------------------------------------------------
CVE-2025-60708 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Hyper-V storage virtualization driver  
(storvsp.sys) – routines handling VSP SCSI request validation and  
VSMB file-open validation.

Vulnerability Class
--------------------------------------------------------------------
CWE-822: Untrusted Pointer Dereference (kernel NULL/invalid pointer  
access causing denial-of-service).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The structure VSP_REQUEST_PRIVATE (hereafter "REQ") is created by   
upper layers and passed to several helper routines prior to being    
dispatched to a virtual disk (VDEVICE_OBJECT). Field index 10 of    
this structure ( *(QWORD*)REQ + 10 ) is expected to hold a valid     
VDEVICE_OBJECT pointer.                                              
                                                                     
1. In VspIsValidSgRequest(REQ) the original code unconditionally     
   dereferenced this pointer at offset +2184 to test a flag that     
   indicates whether the associated virtual disk supports scatter/   
   gather (SG) I/O:                                                  
       *(_BYTE*)( (*(QWORD*)REQ + 10) + 2184 )                       
                                                                     
2. If REQ arrives before a device is associated (the field is NULL)  
   the read is performed against address 0x000000000000088, causing   
   a kernel bugcheck (PAGE_FAULT_IN_NONPAGED_AREA).                  
                                                                     
3. The pointer originates from user-controlled / guest-controlled    
   input paths (e.g. IOCTL_VSMB_OPEN_FILE and SCSI SRB processing),  
   so a malicious caller running with ordinary guest privileges can  
   craft a request that triggers the dereference.                    
                                                                     
4. Similar unchecked uses existed further down the call chain –      
   VspVsmbFileIoctlVstorVsmbOpenFileValidate() and VspStartJob() –   
   but these depended on VspIsValidSgRequest() succeeding first,     
   making the first crash site easy to reach.                        
                                                                     
Consequence: Local code running in the guest (or in the root part    
of the host that can open the StorVSP device) can reliably crash     
the host kernel, resulting in denial of service. No memory-safety    
violation beyond the faulting read occurs.                           

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE
if (!*(_BYTE*)(*((QWORD*)a1 + 10) + 2184) || ... )
    return 0;        // unchecked pointer at +10
```
```c
// AFTER (simplified)
if (Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage() &&
    !*((QWORD*)a1 + 10)) {
    StorVspTrace(..., "No device associated while validating SG request");
    return 0;        // bail out before dereference
}
// safe to access *(_QWORD*)a1 + 10 beyond this point
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker issues crafted IOCTL / SCSI SRB to storvsp device.        
2. VspStartJob() is invoked -> calls VspIsValidSgRequest().           
3. VspIsValidSgRequest() dereferences REQ->Device (+10) at +2184      
   without validity check (pre-patch).                                
4. NULL pointer access -> bugcheck.                                   

Attack Vector
--------------------------------------------------------------------
Any local guest or host process capable of sending virtual-storage   
requests to storvsp.sys can supply a SRB whose REQ structure has a   
NULL Device pointer, immediately triggering the fault path.          
Typical paths:                                                       
• IOCTL_VSMB_OPEN_FILE from vmstor-client.                            
• Hyper-V SCSI passthrough requests.                                  
No special privileges beyond access to the device interface are      
required.                                                            

Patch Description
--------------------------------------------------------------------
1. Added explicit NULL check for REQ->Device before the flag access   
   in VspIsValidSgRequest(); if NULL the routine now logs and        
   returns failure.                                                  
2. Updated VspVsmbFileIoctlVstorVsmbOpenFileValidate() and           
   VspStartJob() to adjust trace IDs and to propagate the new        
   failure path without further dereference.                         
3. Additional defensive size / range checks were tightened, but the  
   critical fix is the early NULL-pointer guard.                     

Security Impact
--------------------------------------------------------------------
Pre-patch, an unprivileged local caller could force storvsp.sys to   
dereference a NULL function-controlled pointer, immediately causing  
a system crash (blue-screen). This yields a reliable local denial    
of service on the host. No privilege escalation or data disclosure   
was observed.                                                        

Fix Effectiveness
--------------------------------------------------------------------
The new NULL-pointer guard removes the only path that allowed a NULL 
Device pointer to reach the +2184 flag access. Combined with extra   
bounds checks in related functions, the issue is effectively         
mitigated. A targeted crash is no longer reproducible with a NULL    
Device pointer, indicating the patch is effective.                   
