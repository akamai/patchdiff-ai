{'change_count': 19, 'confidence': 0.28, 'file': 'rasapi32.dll', 'cve': 'CVE-2025-59510', 'patch_store_uid': '50da1722-5494-4eba-8bb7-c2c609bc7b42', 'kb': 'KB5068861', 'date': 1763413598.3314266}
--------------------------------------------------------------------
CVE-2025-59510 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Routing and Remote Access Service (RRAS) tracing              
implementation in rasapi32.dll (public functions GetTracingDir,       
ClearFiles, ReadWPPTracingState).

Vulnerability Class
--------------------------------------------------------------------
CWE-59: Improper Link Resolution Before File Access ("link            
following") resulting in unintended file truncation/deletion.        

Detailed Root Cause Analysis
--------------------------------------------------------------------
1. RRAS periodically purges old trace output through                  
   ClearFiles().                                                      
                                                                      
2. The helper GetTracingDir() returns the directory in which trace    
   files are stored.  Prior to the patch it simply returned a heap    
   copy of a path taken from                                         
   HKLM\SOFTWARE\Microsoft\Tracing\FileDirectory (default           
   "%windir%\tracing").  No handle to the directory was kept and    
   no inspection for reparse-points was performed.                    
                                                                      
3. ClearFiles() constructs the full path                               
        <TracingDir>\<Component>.(LOG|OLD)                           
   and, if GetFileAttributesW() says the file is present, opens it    
   with _wfopen_s(...,"w") which truncates the file.  The open       
   occurs through the legacy Win32 path API.  Therefore, if any       
   element of <TracingDir> or <Component> is a directory junction,    
   mount-point, symlink, or hard-link, the function will follow it    
   and operate on the final target, not on the intended trace file.   
                                                                      
4. ReadWPPTracingState() performs a similar operation when            
   validating the logfile configured in the registry.  It copies the  
   path into a buffer, removes the filename, and later accesses the   
   folder with conventional path APIs, again without checking for     
   reparse points.                                                    
                                                                      
5. Because both functions run inside the RRAS service (LOCAL SYSTEM)  
   and are reachable from code that processes user-controlled         
   registry sub-keys, a non-privileged but authenticated attacker     
   can:                                                               
   • Create a directory inside %windir%\tracing (write permissions    
     are granted to Authenticated Users).                             
   • Replace that directory or one of its sub-directories with an NTFS
     junction/hard-link that points to an arbitrary writable system   
     file (e.g. another service configuration file).                  
   • Trigger ClearFiles() or ReadWPPTracingState() through normal     
     RRAS administration.                                             
   The service follows the link and truncates the attacker-chosen     
   file, denying service or corrupting configuration.                 
                                                                      
6. The vulnerability is caused by the absence of                     
   FILE_FLAG_OPEN_REPARSE_POINT / FILE_FLAG_BACKUP_SEMANTICS and by   
   the lack of canonicalisation or handle-based relative opens.       

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// rasapi32.dll before patch (ClearFiles)                             
StringCchCopyW(pszSrc, 0x105, TracingDir);                            
StringCchCatW(pszSrc, 0x105, L"\\");                                 
StringCchCatW(pszSrc, 0x105, v8);                                     
StringCchCatW(pszSrc, 0x105, L".LOG");                               
if (GetFileAttributesW(pszSrc) != -1) {                               
    _wfopen_s(&Stream, pszSrc, L"w");  // truncates arbitrary file   
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker prepares junction/hard-link inside %windir%\tracing.      
2. Administrative action (or timer) makes RRAS call ClearFiles().     
3. GetTracingDir() returns the unvalidated directory path.            
4. ClearFiles() builds full file name and calls _wfopen_s("w").      
5. The junction is resolved and RRAS truncates the linked target,     
   causing denial of service.

Attack Vector
--------------------------------------------------------------------
Local, authenticated.  Requires ability to create a malicious         
directory entry under %windir%\tracing or to set up a rogue tracing   
sub-key that RRAS later cleans.  No admin rights are needed because   
Authenticated Users have write permission on the tracing folder.      

Patch Description
--------------------------------------------------------------------
1. GetTracingDir() is now __fastcall GetTracingDir(__int64 *DirHandle)
   and, besides the path string, returns an open HANDLE to the        
   directory obtained via new helper GetFolderHandle().               
                                                                      
2. ClearFiles() and ReadWPPTracingState() were rewritten to:          
   • Maintain the directory HANDLE.                                   
   • Open target files through GetFileHandle(dirPath, dirHandle)      
     which uses NtOpenFile with OBJ_DONT_REPARSE /                    
     FILE_FLAG_OPEN_REPARSE_POINT semantics.                          
   • Bail out when a file or directory handle equals INVALID_HANDLE.  
                                                                      
3. Additional conversions (PathCchRemoveFileSpec, ConvertString2Guid) 
   do not affect security but accommodate the new handle-based logic. 
                                                                      
4. Legacy code path GetTracingDir_Old() is left for systems where the 
   internal feature flag is disabled, but that flag check is placed   
   early so production builds always use the safe path.               

Security Impact
--------------------------------------------------------------------
Pre-patch, SYSTEM-level RRAS could be coerced into truncating or       
deleting arbitrary files, leading to service outages or persistent    
denial-of-service conditions.  Post-patch, file operations are        
performed through verified handles that do not follow reparse points, 
eliminating the link-following primitive.  No privilege escalation    
was observed; impact is limited to DoS.                               

Fix Effectiveness
--------------------------------------------------------------------
The patch removes TOCTOU exposure by:                                 
• Opening the parent directory with FILE_FLAG_OPEN_REPARSE_POINT and  
  refusing if it is itself a reparse point.                           
• Opening target files relative to that verified directory handle.    
• Aborting the operation if any handle acquisition fails.             
Given these changes, the attacker can still create junctions but they 
will no longer be traversed, so arbitrary files cannot be touched.    
Regression risk is minimal because the new helpers fall back to the   
old logic only when the internal feature flag is disabled.            
