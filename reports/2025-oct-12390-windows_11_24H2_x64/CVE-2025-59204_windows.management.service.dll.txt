{'patch_store_uid': 'd607904b-7b77-4d7f-bd9c-133cd1022400', 'date': 1763406133.9936168, 'kb': 'KB5066835', 'confidence': 0.31, 'cve': 'CVE-2025-59204', 'change_count': 4, 'file': 'windows.management.service.dll'}
--------------------------------------------------------------------
CVE-2025-59204 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
EnterpriseDeviceManagement.Service.AutoPilot
DeviceEnrollmentResultAsync (in windows.management.service.dll)


Vulnerability Class
--------------------------------------------------------------------
Use of uninitialized memory / resource (CWE-908)


Detailed Root Cause Analysis
--------------------------------------------------------------------
DeviceEnrollmentResultAsync objects are instantiated through two helper
routines generated by WRL:
  • MakeAndInitialize<…DeviceEnrollmentResultAsync,IInspectable>
  • MakeAndInitialize<…DeviceEnrollmentResultAsync,DeviceEnrollmentResultAsync>

Both helpers allocate 0x28 bytes with operator new (nothrow) and then
return the object to the caller without invoking any explicit per-object
initialisation.  Because operator new does not clear the allocation, the
four bytes located at dword indices 8 and 9 of the object (offsets
0x20-0x27) contain indeterminate heap data.

Those members represent result/status fields that are later surfaced via
the IDeviceEnrollmentResultAsync interface.  When user code, scripts, or
other system components query these properties the stale heap contents
are copied into the caller’s buffer, disclosing data that originated
elsewhere in the same process.

Patch analysis shows that a previously unused slot in the vtable was
re-purposed as a proper constructor-style routine named
DeviceEnrollmentResultAsync::RuntimeClassInitialize().  The new routine
is now called by both MakeAndInitialize helpers immediately after the
object is attached to a smart pointer.  If the associated Flighting
feature flag (Feature_2578215227) is enabled the routine performs:
    *((DWORD*)this + 8) = 0;
    *((DWORD*)this + 9) = 0;
thereby clearing the two status fields before the object is made
visible.

Before the fix there was no equivalent code path, so the members were
left uninitialised throughout the object’s lifetime, causing
information disclosure.

Structurally the problem is therefore:
   new() -> object with garbage data -> returned -> getter leaks data

Affected members (offsets relative to this):
   +0x20 DWORD  m_status   (index 8)
   +0x24 DWORD  m_reason   (index 9)


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// New in 2024-11 patch
__int64 __fastcall DeviceEnrollmentResultAsync::RuntimeClassInitialize( 
        DeviceEnrollmentResultAsync *this) 
{ 
    if (wil::details::FeatureImpl<__WilFeatureTraits_Feature_2578215227>
            ::__private_IsEnabled(&impl))
    {
        *((DWORD*)this + 9) = 0;   // clear m_reason
        *((DWORD*)this + 8) = 0;   // clear m_status
    }
    return 0i64; 
}

// MakeAndInitialize snippet (old vs. new)
// Old code returned object immediately, new code calls RuntimeClassInitialize
Interface = DeviceEnrollmentResultAsync::RuntimeClassInitialize(v6);
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Client code (any local user) calls public WRL factory helper to obtain
   IDeviceEnrollmentResultAsync.
2. Helper allocates object with operator new (memory not zeroed).
3. [Before patch] helper returns object without further init.
4. Client invokes get_Status(), get_Reason(), or similar.
5. Getter copies uninitialised heap data to caller buffer -> information
   disclosure.
6. [After patch] RuntimeClassInitialize zeros both fields, removing leak.


Attack Vector
--------------------------------------------------------------------
Local, authorised code that can load the windows.management.service.dll
COM server and request an IDeviceEnrollmentResultAsync object.  No
special privileges are required beyond the ability to use the public
API.


Patch Description
--------------------------------------------------------------------
1. Introduced DeviceEnrollmentResultAsync::RuntimeClassInitialize that
   zero-initialises two DWORD members when the related Feature flag is
   enabled.
2. Modified both MakeAndInitialize helper templates to invoke the new
   initialiser and to abort object publication if it returns an error.
3. Minor type clean-ups (Interface variable changed from unsigned int to
   int) – functional impact is negligible.


Security Impact
--------------------------------------------------------------------
Prior to the patch, every DeviceEnrollmentResultAsync instance leaked
8 bytes of uninitialised heap memory to any caller that read the exposed
status fields.  The heap may contain pointers, GUIDs, or other
sensitive process data, allowing an attacker to glean information about
process layout or internal state.  The issue is classified as an
information disclosure vulnerability (CVE-2025-59204).


Fix Effectiveness
--------------------------------------------------------------------
The added initialisation code reliably clears the affected members when
the Feature_2578215227 flag is active and the helper functions always
invoke the routine before returning the object, effectively eliminating
the leak in normal configurations.  If the feature flag were disabled
initialisation would still be skipped; the vendor presumably guarantees
that the flag is permanently enabled after the patch, but this cannot be
verified from the diff alone.

