{'cve': 'CVE-2025-49708', 'kb': 'KB5066835', 'file': 'dwm.exe', 'change_count': 10, 'date': 1763407737.9800522, 'patch_store_uid': '91050652-618e-4355-8ff5-2ed2c31bf876', 'confidence': 0.16}
--------------------------------------------------------------------
CVE-2025-49708 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Graphics Component (Desktop Window Manager – dwm.exe)


Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use-After-Free (heap object shared through an ALPC port
section)


Detailed Root Cause Analysis
--------------------------------------------------------------------
The vulnerable code lives in the CPortClient helper that handles the
client side of an ALPC channel used by DWM.  The object layout that is
relevant to the bug is:
  +0x00  vftable
  +0x10  hPort                (ALPC port handle)
  +0x20  SectionHandle        (handle returned by
                               NtAlpcCreatePortSection)
  +0x28  pSectionMem          (heap pointer to the local view of the
                               port section)      <-- freed in dtor
  +0x30  hHeap                (heap handle, GetProcessHeap())

Old life-cycle
1. Constructor stored the process heap handle into hHeap.
2. During connection setup (code not shown in diff) the helper creates
   an ALPC port section; the returned local view pointer is saved in
   pSectionMem and the handle in SectionHandle.
3. Disconnect() closed hPort but **did not delete the port section**;
   the server side therefore still had a valid mapping that referenced
   the client’s memory.
4. The destructor then executed
       HeapFree(hHeap, 0, pSectionMem);
   which releases the heap block while the server mapping remains
   active.  Subsequent activity on the server causes read/write
   access into memory that has already been returned to the heap – a
   classic use-after-free.

Because the freed region comes from the default process heap, an
attacker that can influence subsequent allocations in the DWM process
can get the block re-allocated with attacker-controlled contents, and
those contents are then accessed with the privileges of dwm.exe
(SESSION-1, same integrity level as the windowing system), resulting in
local elevation.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// old Disconnect – no section deletion
if (*((BYTE *)this + 24))
{
    CloseHandle(this->hPort);
    *((BYTE *)this + 24) = 0;
}
// section left alive, server still holds it

// old destructor
v2 = this[5];                 // pSectionMem
if (v2)
{
    HeapFree(this[6],0,v2);   // use-after-free when server touches it
    this[5] = 0;
}
```
```c
// fixed Disconnect
if (FeatureEnabled && this->SectionHandle)
    NtAlpcDeletePortSection(this->hPort, 0);
```
```c
// fixed destructor – skip free when feature is enabled
if (!FeatureEnabled)
{
    if (pSectionMem)
        HeapFree(GetProcessHeap(),0,pSectionMem);
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privileged client connects to the DWM ALPC interface.
2. Client requests creation of a port section.
3. Client forces a protocol error that makes DWM call
   CPortClient::Disconnect() followed immediately by object
   destruction.
4. Disconnect() (old build) closes only the port handle; server still
   owns SectionHandle and keeps accessing the mapped view.
5. Destructor frees pSectionMem.
6. Subsequent server access -> use-after-free -> memory corruption ->
   privilege escalation.


Attack Vector
--------------------------------------------------------------------
Any process that can open the public DWM ALPC port can drive the object
lifecycle.  No special privileges are required beyond the ability to
communicate with DWM (default for desktop apps).  The attack is purely
local; network is not involved despite the CVE blurb.


Patch Description
--------------------------------------------------------------------
• Introduces Feature_2578215227 gate.  When the feature is enabled:
  1. Disconnect() now calls NtAlpcDeletePortSection() to tear down the
     shared section before any heap memory is reclaimed.
  2. The destructor no longer frees pSectionMem – the section deletion
     already breaks the mapping.
• The object no longer caches hHeap; constructor sets that field to
  zero, and all helpers obtain the process heap directly with
  GetProcessHeap().
• SendComplexSyncRequest() allocates/free buffers with
  GetProcessHeap() instead of the cached handle, avoiding the stale
  pointer field altogether.


Security Impact
--------------------------------------------------------------------
Prior to the fix, code in dwm.exe could be tricked into accessing heap
memory after it had been freed and potentially re-allocated with
attacker-supplied data.  Because DWM runs in the window session and has
additional UI-privileged capabilities, successful exploitation results
in elevation of privilege in the local session.


Fix Effectiveness
--------------------------------------------------------------------
The patch removes the double lifetime problem by either:
  • Deleting the ALPC port section before freeing the local view, or
  • Skipping the heap free entirely when the section is deleted.

No stale view remains that the server can dereference; therefore the
use-after-free condition is closed.  Secondary changes (removing the
cached heap handle) further harden the code against similar mistakes.
