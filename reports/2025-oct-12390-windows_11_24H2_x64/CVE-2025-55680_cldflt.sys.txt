{'kb': 'KB5066835', 'patch_store_uid': 'e5e62bad-a2f3-4d0f-94ea-dfaa6633dc2d', 'date': 1763407712.3234496, 'file': 'cldflt.sys', 'confidence': 0.28, 'cve': 'CVE-2025-55680', 'change_count': 4}
--------------------------------------------------------------------
CVE-2025-55680 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows – Cloud Files Mini-Filter Driver (cldflt.sys)
Primary affected routines:
 • HsmpOpCreatePlaceholders
 • CldStreamQueryProgress
 • CldiPortProcessAbortHydration

Vulnerability Class
--------------------------------------------------------------------
Time-of-check / time-of-use (TOCTOU) race condition (CWE-367)

Detailed Root Cause Analysis
--------------------------------------------------------------------
All three affected helpers parse variable-length user-supplied
structures that are passed from user mode through FSCTL/ALPC control
ports.  In the pre-patch code the driver

  1. probes the caller buffer with ProbeForRead/ProbeForWrite;
  2. locks it into an MDL with MmProbeAndLockPages; and
  3. directly dereferences the still-user-writable pages while it
     performs multiple rounds of validation and later consumes the
     same fields (file names, lengths, attribute flags, USNs …).

Because the pages remain writable by the originating process during the
whole operation, a local attacker can flip individual fields between
"check" and "use" phases.  Typical abuse scenarios include

  • lowering length fields so that later memmove/ExAllocatePool2 uses a
    smaller size than actually copied – heap overwrite;
  • raising counters after validation so that the loop walks past the
    mapped buffer – arbitrary kernel read/write;
  • changing CreateOptions / FileAttributes after the security check so
    that privileged files are created/modified – privilege escalation.

Example in HsmpOpCreatePlaceholders (before patch):
  - MmProbeAndLockPages(.., UserMode, 1);
  - if (!(Mdl->MdlFlags & 5))
        MappedSystemVa = MmMapLockedPagesSpecifyCache(..);
  - ...parse headers repeatedly using *MappedSystemVa.

Nothing prevents the caller from changing MappedSystemVa in between the
length sanity checks and its final consumption.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE – user buffer is used directly after validation
v9  = IoAllocateMdl(a4, Length, 0, 0, 0);
MmProbeAndLockPages(v9, 1, (LOCK_OPERATION)v13);
MappedSystemVa = (char *)v9->MappedSystemVa;   // still user writable
...
LastEffectiveUsn = HsmpRpBuildBuffer(..., (char *)v54 + WORD6(v74[0]), ...);
```
```c
// AFTER – immutable kernel copy is taken first
Pool2 = ExAllocatePool2(NonPagedPoolNx, Length, 'HSRp');
ProbeForWrite(a4, Length, 4);
memmove(Pool2, a4, Length);      // snapshot
Src = Pool2;                     // all later parsing uses Src
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User process crafts a valid placeholder-creation blob in user memory.
2. User issues device-control/ALPC request to cldflt (e.g.
   FSCTL_HSM_CREATE_PLACEHOLDERS).
3. Driver validates header fields (size/count/offset).
4. Parallel malicious thread flips one of the validated fields.
5. Driver continues, trusts the stale value, and performs kernel memory
   operations with attacker-controlled sizes or attributes.

Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker running in the same session.  Requires
only the ability to send the normal Cloud-Files control messages – no
special privileges beyond the calling handle.

Patch Description
--------------------------------------------------------------------
The update converts all affected code paths to work on an immutable
kernel-mode snapshot:
 • If the Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_5() flag is
   on (default after patch), ExAllocatePool2(NonPagedPoolNx) is used
   and the entire user buffer is memcpy()’d before *any* parsing.
 • The MDL/MmMapLockedPages fallback path is kept for legacy, but is no
   longer taken on supported systems.
 • Subsequent structure walks operate exclusively on the kernel copy;
   the original pages are never referenced again, eliminating the race.
Additional clean-ups were made in CldStreamQueryProgress and
CldiPortProcessAbortHydration to apply the same pattern.

Security Impact
--------------------------------------------------------------------
Prior to the fix a local attacker could reliably race the driver and
cause:
 • arbitrary kernel heap overwrite/reads → LPE;
 • creation of files/streams with elevated attributes → LPE;
 • denial of service through bug-check.
Exploitability is high because the attacker controls both the buffer
and the timing window.

Fix Effectiveness
--------------------------------------------------------------------
The kernel now parses only a private, read-only copy.  Modifying the
original user pages after the syscall no longer influences the driver
logic, closing the TOCTOU window.  No residual path that accesses the
user buffer directly could be found in the patched code, so the fix is
considered effective.
