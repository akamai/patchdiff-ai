{'date': 1763403052.4327414, 'change_count': 147, 'patch_store_uid': '0c6d392d-ad52-4695-a133-d4c1c4ac14a6', 'kb': 'KB5066835', 'file': 'windows.staterepository.dll', 'cve': 'CVE-2025-59203', 'confidence': 0.27}
--------------------------------------------------------------------
CVE-2025-59203 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows StateRepository API user-mode Windows DLL (windows.staterepository.
dll).  Affected routines are the cache management and statement helper
functions that wrap sqlite3_* calls: 
  • StateRepository::StatementCache::{Get,Add}
  • StateRepository::DatabaseCache::{Get,Add}
  • StateRepository::Statement::{dal_reset,dal_finalize}
  • StateRepository::Database::{Close,ClearCache}
All are compiled into the public OneCore image that services the State
Repository service.


Vulnerability Class
--------------------------------------------------------------------
Information Disclosure – CWE-532 “Insertion of Sensitive Information into
Log File”.  Internal helpers produced overly-verbose sqlite3_log / ETW
records that embed file-system paths, full SQL text and raw kernel virtual
addresses that can later be read by low-privileged users.


Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  Every high-level data-access helper in staterepository.dll wraps a
    lower-level sqlite3_* API.  Before and after the call the code calls
    sqlite3_log() (and in some cases ETW EventWriteTransfer) with a hard
    coded format string.

2.  Prior to the patch the format strings always contained "%p" or "%s"
    tokens that passed the following run-time data directly to the log:
      • Full database file name (supplied by higher layers or user
        configuration) – "%s".
      • SQL text of the prepared statement – "%s".
      • Raw pointers for Database*, Statement*, StatementCache*, etc –
        "%p".

3.  Example (DatabaseCache::Get, pre-patch):
      sqlite3_log(0,
        "[pre-DatabaseCache.Get] #%u DatabaseCache %p: Cache Size/Hits/"
        "Misses %u/%llu/%llu: Filename %s", …, a2);
    ‘a2’ is the caller-supplied UTF-16 file name which may point to any
    user-accessible path including user profiles.

4.  The same pattern is repeated after every sqlite3_reset/finalize/close
    call and when moving statements between caches.  Because these helpers
    are executed in many Windows processes, the information ends up in the
    global ETW provider "Microsoft-Windows-StateRepository" whose log files
    are world-readable by default (Authenticated Users).  No sanitisation
    took place.

5.  The patch introduces a new feature flag
       __WilFeatureTraits_Feature_2578215227
    queried through wil::details::FeatureImpl::IsEnabled().  When the flag
    is ON, the code switches to *sanitised* format strings that remove
    pointer values and in several cases replace the database handle
    pointer with a constant 0 or %llu placeholder.  Example (after patch):
      sqlite3_log(0,
        "[pre-DatabaseCache.Get] #%u DatabaseCache Size/Hits/Misses %u/"
        "%llu/%llu: Filename %s", …);
    Similar changes have been applied to every other logging site.

6.  No functional logic changed – only the strings and the decision to log
    sensitive details were modified, proving that the original risk was an
    unintended disclosure via log files.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
sqlite3_log(0,
  "[pre-DatabaseCache.Get] #%u DatabaseCache %p: Cache Size/Hits/Misses "
  "%u/%llu/%llu: Filename %s",
  _InterlockedIncrement(&dword_1804D4858),
  StateRepository::DatabaseCacheSingleton::s_cache,
  *, *, *, a2);

// after
if (Feature_IsEnabled())
  sqlite3_log(0,
    "[pre-DatabaseCache.Get] #%u DatabaseCache Size/Hits/Misses %u/%llu/"
    "%llu: Filename %s",
    _InterlockedIncrement(&dword_1804D48C8),
    *, *, *, a2);
```
(The "%p" pointer is gone; similar diffs exist in all other edited
functions.)
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Any client of the StateRepository API opens a database →
   StatementCache::Get / DatabaseCache::Get is invoked.
2. Function logs pre-call telemetry containing filename/path and pointers.
3. User with low privileges opens the ETL / circular log file
   (\Windows\System32\LogFiles\...) and reads the sensitive strings.

No special privileges, no malformed inputs, only legitimate API use is
required to leak the data.


Attack Vector
--------------------------------------------------------------------
Local information disclosure.  Any local authenticated user that can read
StateRepository ETW traces (default Authenticated Users) obtains:
  • Absolute paths to databases belonging to other users
  • Full SQL statements which may embed user data
  • Memory layout information (pointers)
This may facilitate further attacks or reveal privacy-sensitive details.


Patch Description
--------------------------------------------------------------------
• Introduced run-time feature gate (__WilFeatureTraits_Feature_2578215227).
• When the flag is enabled the code switches to *redacted* format strings
  that no longer embed:
    – Raw pointers (%p)
    – Database handle addresses
    – Statement pointer addresses
• Some logs replace the filename/SQL with "<null>" if unavailable.
• Additional calls to StateRepository::Database::LogStatistics were moved
  and code was refactored, but functional behaviour is unchanged.


Security Impact
--------------------------------------------------------------------
Before patch: Any local user could collect sensitive file system and SQL
information from logs, violating confidentiality and assisting ASLR bypass.
After patch: When the privacy flag is on, logs contain only counters and
identifiers; no file paths or raw addresses are emitted, stopping the
information leak.


Fix Effectiveness
--------------------------------------------------------------------
Diff shows *all* sqlite3_log / EventWriteTransfer format strings updated to
privacy-safe variants gated by the new feature flag.  No remaining "%p"
format specifiers are used in the ‘enabled’ path, eliminating pointer /
path disclosure.  Effectiveness depends on the flag being enabled system-
wide; if disabled, legacy verbose logging still occurs, but that is a
policy decision, not a code defect.  Therefore the patch fully remediates
CVE-2025-59203 when the privacy feature is active.

