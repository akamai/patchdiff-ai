{'confidence': 0.16, 'date': 1763402995.0283902, 'kb': 'KB5066835', 'file': 'srv.sys', 'change_count': 1, 'patch_store_uid': '27610275-7ed4-47bf-b772-9560a968ff37', 'cve': 'CVE-2025-58726'}
--------------------------------------------------------------------
CVE-2025-58726 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows kernel-mode driver  "srv.sys"  (SMB server).  Affected routine
is BlockingSessionSetupAndX(), responsible for processing legacy
SESSION_SETUP_ANDX requests and building the session object held in
the connection control block.

Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Authorization-bypass that results in
Elevation of Privilege (CWE-284).

Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  During processing of a SESSION_SETUP_ANDX request the server
    eventually reaches a point where the caller has either been fully
    authenticated or is a NULL/ANONYMOUS session (byte flag at
    Session+0xCA == 0x202).

2.  For anonymous sessions the legacy implementation unconditionally
    set
        *(BYTE *)(Connection + 0x410) = 1   ; field @ offset 0x1040
    which later marks the connection as a **local loopback** session.
    Internal policy code treats such sessions as coming from the
    machine itself and grants them additional privileges (e.g. bypass
    of SPN validation, access to administrative named pipes, etc.).

3.  No verification was performed to prove that the socket peer address
    is really a loopback address (127.0.0.0/8 or ::1).  A remote client
    could therefore craft a valid SESSION_SETUP_ANDX, claim an
    anonymous logon, and obtain the elevated capabilities reserved for
    genuine local callers.

4.  The patch inserts an explicit call to the new helper
        SrvValidateLoopbackAddress( CtxtHandle )
    right before the flag is set.  The flag is now set **only** if
    a) the H2E feature gate is disabled, or
    b) the helper returns STATUS_SUCCESS, proving the peer really uses
       a loopback address.

5.  If the validation fails, ExtraSmbBuffer receives the error code and
    the execution path is redirected to the common error exit
    (LABEL_143), causing the request to be rejected.

6.  Therefore the vulnerability was a missing address-origin check when
    assigning privileged local status to a session.

Parameters / structures involved
    Connection +0x1040   (BYTE)   IsLoopback / LocalMachine flag
    Session    +0x202    (BYTE)   IsNullSession flag
    Session    +0x203    (BYTE)   IsAdmin flag (later affected)

Vulnerability Code Snippets
--------------------------------------------------------------------
Before patch (simplified):
```c
if (!*(BYTE *)(Session + 0x202))        // NOT authenticated
{
    *(BYTE *)(Connection + 0x1040) = 1; // Mark as local – NO CHECK!
    goto AuthenticatedLabel;
}
```
After patch:
```c
if (!Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_0() ||
    (ExtraSmbBuffer = SrvValidateLoopbackAddress(
                         (PCtxtHandle)(*(QWORD *)(Session+0xB0)+8)),
     ExtraSmbBuffer >= 0))
{
    if (!*(BYTE *)(Session + 0x202))
    {
        *(BYTE *)(Connection + 0x1040) = 1; // set only after check
        goto AuthenticatedLabel;
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Remote client establishes SMB connection and sends crafted
   SESSION_SETUP_ANDX packet.
2. BlockingSessionSetupAndX() parses the request and reaches the branch
   where Session->IsNullSession is true.
3. Prior to the patch the code sets Connection->IsLoopback = 1 without
   verifying the peer address.
4. Subsequent policy code identifies the session as local and grants
   higher privileges, leading to privilege escalation.

Attack Vector
--------------------------------------------------------------------
Authenticated (or anonymous) attacker that can reach the SMB port
(445/TCP) submits a specially-crafted SESSION_SETUP_ANDX sequence from
any remote machine.  Because the server never validated that the
endpoint is loopback, the session is treated as if it were initiated
locally, enabling privileged operations.

Patch Description
--------------------------------------------------------------------
• Introduces a call to SrvValidateLoopbackAddress() that checks the
  socket’s peer address.
• Sets Connection+0x1040 only after the validation succeeds.
• Propagates STATUS_ errors when validation fails, redirecting control
  flow to the common failure handler.
• Label renames and extensive WPP tracing updates are cosmetic; the
  security fix is the new validation gate.

Security Impact
--------------------------------------------------------------------
Successful exploitation lets a remote network user obtain the
privileges reserved for local (loopback) sessions, effectively turning
an unauthenticated or low-privileged account into an elevated one on
 the target machine.  This is an Elevation of Privilege in the SMB
server context.

Fix Effectiveness
--------------------------------------------------------------------
The added explicit validation closes the direct bypass; the privileged
flag is no longer set for remote addresses.  Assuming
SrvValidateLoopbackAddress() correctly recognises loopback addresses
and cannot be spoofed, the fix fully mitigates the discovered issue.
Regression risk is minimal because the change only affects the single
code path that grants the local privilege flag.

