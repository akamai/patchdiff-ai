{'change_count': 160, 'patch_store_uid': '0f2e33f7-3143-4f1b-8865-2b030f23c6e2', 'cve': 'CVE-2025-50175', 'date': 1763403170.819818, 'confidence': 0.19, 'file': 'windows.media.dll', 'kb': 'KB5066835'}
--------------------------------------------------------------------
CVE-2025-50175 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
windows.media.dll – Digital-Media stack (Media Foundation helper
templates handling asynchronous MediaSource open operations and MF
work-queue scheduling).

Vulnerability Class
--------------------------------------------------------------------
Use After Free  (CWE-416)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The Media Foundation helper template
    MFPutWorkItem< _lambda_ad0ac243… >
creates a TMFWorkItem object that captures several COM interfaces that
must out-live the asynchronous callback executed later on a Media
Foundation work-queue (queue id 5).

Prior to the patch the lambda constructor responsible for copying the
captures was emitted by a WRL template instantiation that:
  • copied the raw pointer from the caller-supplied ComPtr into the new
    work-item instance, but
  • never performed an InternalAddRef on the weak-reference parameter
    that represents the object state returned to the caller, and
  • in error paths relied on the local ComPtr variable instead of the
    newly allocated work-item to hold a reference.

As a consequence the reference count of the captured object(s) could
reach zero as soon as the calling thread released its last reference.
When the MF work-queue later executed the callback the internal
pointers (for example IMFTimedTextTrack or IRandomAccessStreamWith­
ContentType) were already freed, leading to a classic use-after-free
in privileged code.

Key structures / fields that were affected:
  • this->spThis            (MediaSource)           – strong ref needed
  • this->spOp              (IAsyncOperation<…>)     "
  • this->spSourceResolver  (IMFMediaEngineSourceResolver) – "
  • this->spState           (IUnknown)              – "
  • <weakRef>               (IMFTimedTextTrack)     – missing AddRef

Because the work-item executes inside a high-integrity Media
Foundation process, successful exploitation lets a low-privileged
attacker run arbitrary code in that security context.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Patched constructor (cuts down to the essential lines)
this->spThis  = (MediaSource*)      <spThis>->ptr_;
InternalAddRef(&this->spThis);
this->spOp.ptr_ = *v7;                      // now AddRef’ed
InternalAddRef(&this->spOp);
...
<weakRef>->ptr_ = (IMFTimedTextTrack*)*a2;  // NEW
InternalAddRef(<weakRef>);                  // NEW – prevents UAF
```
Before the patch the assignment to <weakRef> existed without the
InternalAddRef, leaving the pointed object unprotected.

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User code calls MediaSource::StartAsyncOpenOp().
2. StartAsyncOpenOp instantiates the problematic lambda and queues it
   via MFPutWorkItem2(queue 5).
3. Caller releases the MediaSource / related state quickly.
4. Reference count drops to zero because the lambda failed to AddRef.
5. MF work-queue later runs the callback and dereferences the freed
   object – memory corruption / UAF.

Attack Vector
--------------------------------------------------------------------
Any local, sandboxed or low-integrity code that can load
windows.media.dll and invoke Media Foundation APIs can trigger the
bug. No user interaction is required beyond opening a crafted media
source that is closed immediately after queuing the operation.

Patch Description
--------------------------------------------------------------------
Microsoft replaced the template-generated helpers with hand-written
constructors that explicitly call
    Microsoft::WRL::ComPtr::<type>::InternalAddRef()
for every captured interface, including the previously unprotected weak
reference.  Error logging was also consolidated by adding a new
CallStackTracing::InitInstance helper but this is cosmetic.

Security Impact
--------------------------------------------------------------------
The use-after-free occurs in a high-integrity MF worker thread.
Attacker-controlled memory contents can be dereferenced, enabling local
privilege escalation (EoP) or code execution in the Media Foundation
host process.  The CVSS impact is therefore Elevation of Privilege.

Fix Effectiveness
--------------------------------------------------------------------
The new code takes an explicit strong reference for every captured
interface, guaranteeing that their lifetime extends until the work
item finishes and releases them. No paths remain where the object can
be freed early, so the specific UAF is eliminated.  No obvious new
issues were introduced; effectiveness appears solid.

