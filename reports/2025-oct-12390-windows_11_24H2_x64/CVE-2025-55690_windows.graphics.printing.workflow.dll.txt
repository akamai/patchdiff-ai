{'confidence': 0.11, 'change_count': 37, 'kb': 'KB5066835', 'cve': 'CVE-2025-55690', 'date': 1763404439.946167, 'patch_store_uid': 'c26aee8f-3ff1-4193-91b6-648f5f63ddec', 'file': 'windows.graphics.printing.workflow.dll'}
--------------------------------------------------------------------
CVE-2025-55690 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows PrintWorkflowUserSvc – function
PrintSupportUtil::IppDevObjectHelper::GetIppSoftwareDeviceObject
in windows.graphics.printing.workflow.dll.


Vulnerability Class
--------------------------------------------------------------------
Use-After-Free (CWE-416).


Detailed Root Cause Analysis
--------------------------------------------------------------------
The helper routine is in charge of translating a printer friendly
name into a DEV_OBJECT that represents the corresponding software
device (IPP or MCP queue).

1.  The function allocates an *array* of DEV_OBJECT pointers by
    calling DevGetObjects().  The returned buffer (first element in
    v32 before patch, v38 after patch) is registered for automatic
    clean-up through the stack-allocated structure ‘v34/ v40’ whose
    lifetime is controlled by the flag byte v35 (old) / v41 (new).

2.  On the success path the first DEV_OBJECT is copied for the
    caller by
        PrintCore::DevObjectHelpers::DevObjectCopy(v32, a1);
    but **no reference is taken** – the copy is only a shallow
    structure containing the same internal pointers as the original
    enumeration buffer.

3.  Immediately afterwards the code executes the clean-up lambda
    _lambda_8e6c..., which frees every DEV_OBJECT that still has its
    ‘owning’ flag set.  Because the flag is never cleared for the
    element copied into the caller’s buffer, that object is freed
    while the pointer stored in the output parameter ‘a1’ is still
    returned to the caller.

4.  Subsequent use of the DEV_OBJECT by PrintWorkflowUserSvc
    dereferences the dangling pointer, resulting in a use-after-free
    in the service’s SYSTEM context.  A local attacker able to make
    the code path run (adding/connecting a printer, or by using a
    crafted per-user printer name) can exploit the dangling pointer
    to gain arbitrary code execution in the service and therefore
    elevate privileges.

Affected structures / parameters
    • v32  – first DEV_OBJECT returned by DevGetObjects
    • v34  – stack array managing auto-free of the buffer (flag v35)
    • a1   – OUTPUT DEV_OBJECT supplied by the caller


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before patch
PrintCore::DevObjectHelpers::DevObjectCopy(v32, a1); // shallow copy
v35 = 0;                                             // <== does NOT
                                                     // clear per-item
_lambda_...::operator()(v34);                       // frees v32

// After patch
PrintCore::DevObjectHelpers::DevObjectCopy(v38, a1); // same call
v41 = 0;                                             // flag cleared
// but entry for the selected object is also removed from
// the auto-free list, so the following clean-up does not
// touch it.
_lambda_...::operator()(v40);
```
(The patch also replaces the property-list initialiser value 0x2 with
0x20002 (131074) so DevGetObjects now returns an *independent* object
instance.)
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User (low priv) installs or connects to a per-user printer.
2. PrintWorkflowUserSvc receives the request and calls
   IppDevObjectHelper::GetIppSoftwareDeviceObject.
3. Function returns dangling DEV_OBJECT pointer as described.
4. Service performs further operations on the freed object – UAF.


Attack Vector
--------------------------------------------------------------------
Local attacker with the ability to add or rename a printer so that
PrintWorkflowUserSvc is forced through the IPP branch can trigger the
flaw.  No additional privileges are required beyond the default ones
needed to create a per-user printer connection.


Patch Description
--------------------------------------------------------------------
1. Introduces a feature-flag gate so the dangerous path is taken only
   when Feature_IppPsaForEnterprise is enabled.
2. Corrects property initialisers passed to DevGetObjects (switch
   from 0x0002 to 0x20002) so a fully independent object is
   allocated.
3. Ensures the element copied to the caller is *removed* from the
   auto-free list before the clean-up lambda executes (flag handling
   re-worked around v41 / v40).
4. Adds stronger bounds-checking (v33 > 1) and tidies several
   uninitialised variables.


Security Impact
--------------------------------------------------------------------
The dangling DEV_OBJECT pointer can be dereferenced with attacker
controlled timing and content.  Because the service runs as SYSTEM on
Windows, successful exploitation yields local elevation of privilege
in the kernel print workflow component.


Fix Effectiveness
--------------------------------------------------------------------
The patch severs the lifetime coupling between the caller’s DEV_OBJECT
and the temporary enumeration buffer by (a) producing an independent
copy and (b) preventing the clean-up routine from touching the object
handed back to the caller.  No code path returns a pointer that is
later released in the same function, so the original UAF is removed.
No alternative dangling references were observed in the modified
routine.
