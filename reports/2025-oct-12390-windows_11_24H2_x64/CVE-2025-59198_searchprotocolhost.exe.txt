{'kb': 'KB5066835', 'date': 1763407713.6998787, 'change_count': 38, 'patch_store_uid': '4d862698-3c26-4890-a42d-1e3fbd91ca45', 'confidence': 0.23, 'file': 'searchprotocolhost.exe', 'cve': 'CVE-2025-59198'}
--------------------------------------------------------------------
CVE-2025-59198 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Search Service – ImageEmbedding subsystem inside
searchprotocolhost.exe (CImageHandler::ConvertPBGRA8ToBGRA8Buffer)

Vulnerability Class
--------------------------------------------------------------------
Improper Input Validation / Type-confusion leading to out-of-bounds
read and service crash (Denial-of-Service)

Detailed Root Cause Analysis
--------------------------------------------------------------------
When ConvertPBGRA8ToBGRA8Buffer detects an unsupported pixel format it
raises a WinRT exception to signal the error.  The pre-patch code
constructs the diagnostic message as follows:

  winrt::param::hstring::hstring( (winrt::param::hstring*)v17,
                                 (const wchar_t* const)a2 );

The second parameter, a2, is actually a pointer to an IMAGE_INFO
structure (layout unknown) – *not* a wide-character string.  Because
the hstring constructor interprets its argument as a "ushort const *"
string, it immediately iterates byte-by-byte until a NUL terminator is
found:

  do ++v2; while ( a2[v2] );

This uninformed walk continues outside the bounds of the  IMAGE_INFO
buffer and into unallocated pages if the structure contains no early
zero word.  Accessing a guard or unmapped page triggers an access
violation, crashing searchprotocolhost.exe and stopping the Windows
Search Service for the current user session.  No special privileges
are required – any local process that is able to feed malformed image
data to the indexer can trigger the buggy code path by forcing a pixel
format that is not equal to 1.

The bug is pure read OOB, therefore exploitation is limited to a
reliable denial of service; no attacker-controlled writes occur.

Structures / parameters involved
  IMAGE_INFO
    offset 0 : width   (DWORD)
    offset 4 : height  (DWORD)
    offset 8 : format  (DWORD)   <-- compared against constant 1
  winrt::param::hstring
    +0 : pointer to buffer (wchar_t*)
    +8 : length (DWORD)
    +C : flags  (DWORD)

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// in CImageHandler::ConvertPBGRA8ToBGRA8Buffer (before patch)
if ( *((_DWORD *)a2 + 2) != 1 ) {
    ...
    winrt::param::hstring::hstring( (winrt::param::hstring *)v17,
                                    (const wchar_t *const)a2 );
    ...
}
```
```c
// old winrt::param::hstring ctor (simplified)
*((DWORD*)this + 2) = 1;
*((DWORD*)this + 3) = 33;
*((QWORD*)this + 3) = L"non-supported pixel format passed";
```
```c
// new ctor – now walks the incoming buffer
v2 = -1;
do ++v2; while ( a2[v2] );   // unbounded read in old call site
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Malformed image is supplied to Windows Search indexer.
2. searchprotocolhost.exe calls CImageHandler::ConvertPBGRA8ToBGRA8Buffer.
3. Unsupported pixel format (format != 1) hits exception path.
4. Function casts IMAGE_INFO* to wchar_t* and calls hstring ctor.
5. hstring ctor walks memory past the structure, crosses a page
   boundary and raises AV.
6. Process terminates, Windows Search Service stops – DoS achieved.

Attack Vector
--------------------------------------------------------------------
Local attacker places or modifies a file that is automatically scanned
by Windows Search so that the embedded image has an unexpected pixel
format value.  The crafted IMAGE_INFO reaches ConvertPBGRA8ToBGRA8Buffer
through normal indexing.  No elevated privileges or user interaction
are needed beyond triggering content indexing (e.g., saving the file in
an indexed location).

Patch Description
--------------------------------------------------------------------
Two complementary fixes were delivered:
1. ConvertPBGRA8ToBGRA8Buffer now passes a constant, in-module wide
   string literal L"non-supported pixel format passed" to the hstring
   constructor, eliminating the incorrectly typed cast.

2. winrt::param::hstring ctor was hardened:
   • Measures the string length safely.
   • Verifies NULL termination and aborts if the buffer is not
     correctly terminated.
   These changes mitigate any future misuse where non-string data might
   be forwarded.

Security Impact
--------------------------------------------------------------------
Before the patch a local, non-privileged attacker could reliably crash
searchprotocolhost.exe, causing Windows Search to stop working for the
current session and requiring a service restart or logoff/logon – a
Denial of Service.  No information disclosure or code execution has
been observed.

Fix Effectiveness
--------------------------------------------------------------------
The immediate crash vector is removed because the function no longer
passes attacker-controlled data to the hstring constructor.  Additional
constructor hardening further reduces the risk of similar mistakes
elsewhere.  Residual risk is judged low; only a silent abort (fast
fail) remains if future callers supply a non-terminated buffer.
