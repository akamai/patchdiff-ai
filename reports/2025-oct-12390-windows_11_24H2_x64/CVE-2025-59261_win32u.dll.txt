{'kb': 'KB5066835', 'patch_store_uid': 'f9f0aa35-d986-4de8-b881-61d6011afd48', 'cve': 'CVE-2025-59261', 'confidence': 0.29, 'file': 'win32u.dll', 'date': 1763403019.8378174, 'change_count': 1}
--------------------------------------------------------------------
CVE-2025-59261 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Graphics Component (win32u.dll), exported routine
 gDispatchTableValues, which lives in the user-mode side of the
 win32k system-call dispatcher table.

Vulnerability Class
--------------------------------------------------------------------
Improper function-pointer dereference resulting from a missing
 stack-cookie / TOCTOU safeguard (CWE-367 – Time-of-check Time-of-use
 Race Condition).

Detailed Root Cause Analysis
--------------------------------------------------------------------
In the vulnerable build gDispatchTableValues is compiled as a variadic
thunk that receives up to 63 integer parameters originating from the
user-mode system-call stub.  Instead of forwarding the call to a
legitimate kernel entry point, the routine performs the following
sequence:

 1. On function entry the compiler saves the caller’s return address at
    [rsp] into a local array named retaddr.
 2. The code constructs a far pointer with MK_FP(retaddr[0],
    retaddr[0]).  In effect it interprets the *saved* return address as
    a callable function pointer.
 3. The constructed pointer is invoked with no validation.

Because the return address originates from the user stack, an attacker
running in the same process can win a race between the time the address
is saved ("check") and the moment it is called ("use").  By modifying
that stack slot after the function has started executing but before the
call instruction is reached, the attacker can redirect execution to an
arbitrary user-supplied address.  The new code runs in the security
context of the graphics component, allowing elevation to the privileges
held by the win32k subsystem (typically SYSTEM in a GUI session).

There is no stack cookie or any other integrity mechanism in the old
binary, so the illicit modification is not detected.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable version (excerpt)
void *retaddr[2];           // [rsp+0h]
return MK_FP(retaddr[0],     // turn saved return address
             retaddr[0])();  // into callable pointer and jump
```
```c
// fixed version (excerpt)
void __fastcall gDispatchTableValues(uintptr_t StackCookie)
{
    __debugbreak();          // no operational code remains
    ...                      // eight identical debugbreaks
    _security_check_cookie(StackCookie); // verify stack integrity
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User process issues a crafted win32k system call that resolves to
   gDispatchTableValues in win32u.dll.
2. The dispatcher stub pushes its return address and up to 63 user
   parameters onto the user stack and transfers control.
3. Attacker races to overwrite the saved return address on the same
   thread’s stack (e.g., via ROP self-modification or APC).
4. gDispatchTableValues builds a function pointer from the now-tainted
   slot and calls it.
5. Execution continues at an attacker-controlled address with elevated
   privileges.

Attack Vector
--------------------------------------------------------------------
Local – a non-privileged user runs a specially crafted GUI application
that triggers the vulnerable export and manipulates its own user stack
in a race window.

Patch Description
--------------------------------------------------------------------
The routine has been rewritten:
• The massive variadic parameter list was replaced by a single
  StackCookie argument.
• All functional code was stripped and replaced by nine consecutive
  int3 (debugbreak) instructions, making the routine inert in release
  builds.
• A call to _security_check_cookie() was added to validate that the
  saved return address has not been tampered with before control
  returns to user mode.

Security Impact
--------------------------------------------------------------------
Prior to the patch, successful exploitation allowed arbitrary code
execution in the win32k component’s context, resulting in a full local
privilege escalation to SYSTEM.  Post-patch the attack surface is
 removed; any tampering triggers a stack-cookie violation and process
 termination.

Fix Effectiveness
--------------------------------------------------------------------
The vulnerable indirect call is gone; the function performs no work
other than validating the stack cookie.  Because the attacker can no
longer influence a function pointer that gets executed, the original
privilege-escalation path is effectively closed.  No bypass is evident
in the diff.

