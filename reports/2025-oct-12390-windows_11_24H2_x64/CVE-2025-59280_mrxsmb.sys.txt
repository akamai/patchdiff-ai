{'confidence': 0.11, 'cve': 'CVE-2025-59280', 'change_count': 5, 'file': 'mrxsmb.sys', 'patch_store_uid': 'f4fee038-764d-48c2-9d27-bd240669ee66', 'kb': 'KB5066835', 'date': 1763407722.7358737}
--------------------------------------------------------------------
CVE-2025-59280 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows SMB Client – kernel-mode redirector (mrxsmb.sys).
Affected routines include:
 • SmbCeCreateSrvCall (srv-call construction)
 • SmbNegotiate_Start          (build SMB1 multi-protocol block)
 • SmbNegotiate_Continue       (dialect / capability negotiate)

Vulnerability Class
--------------------------------------------------------------------
Improper Authentication / Credential-injection (CWE-287).

Detailed Root Cause Analysis
--------------------------------------------------------------------
When a new UNC path is opened the client enters
SmbCeCreateSrvCall().  The function extracts the server portion of
the path (UNICODE_STRING held in RDX => v32) and **should** verify
that the string does *not* already contain a marshalled
CREDENTIAL_TARGET_INFORMATION structure (a binary blob produced by
CredMarshalTargetInfo()).

• Vulnerable code (before patch) only called
  CredUnmarshalTargetInfo() when the internal feature flag
  Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_2() was set.  On
  normal systems that flag is clear, therefore the check is skipped
  entirely.

• If an attacker supplies a server name that is itself a marshalled
  blob, the string passes through as a legitimate host name.  The
  blob is copied into the server-entry area (offsets 640/648) and is
  later forwarded during SMB negotiation and authentication.

• Down-stream authentication code interprets the injected TargetInfo
  as if it had been generated locally.  The attacker can therefore
  tamper with channel bindings, supplied SPN, or other target-info
  fields and force the client to accept a spoofed server or weaker
  security settings.

Secondary hardening:  In SmbNegotiate_Start the hand-rolled logic
that copied cipher-suite data and assembled the multi-protocol
negotiate string used a 1115-byte on-stack buffer, complex index
math, and multiple nested loops.  Although not directly responsible
for the credential injection, this code trusted the same attacker
controlled input and could be used to corrupt the buffer.  The patch
replaced it with safe helpers (MRxSmbCopyCipherSuiteInfoFromGlobalConfig
and SubRdrBuildMultiProtocolNegotiateString) that perform explicit
length checks.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE
if ( Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_2() ) {
    v9 = STATUS_NO_SUCH_LOGON_SESSION;
    if ( CredUnmarshalTargetInfo(ServerName, ServerLen, NULL, NULL) !=
         STATUS_NO_SUCH_LOGON_SESSION ) {
        // connection continues even though a marshalled blob was found
    }
}

// AFTER – feature flag removed, always validated and treated as fatal
v9 = STATUS_NO_SUCH_LOGON_SESSION;
if ( CredUnmarshalTargetInfo(ServerName, ServerLen, NULL, NULL) !=
     STATUS_NO_SUCH_LOGON_SESSION ) {
    // abort: 806355194
    goto error;
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Victim application issues I/O on path such as
   "\\<marshalled-blob>\share".
2. MRxSmb!MRxSmbCreateSrvCall -> SmbCeCreateSrvCall().
3. Feature flag is clear; CredUnmarshalTargetInfo() is **not** called
   in vulnerable build – blob accepted as server name.
4. Server entry is constructed; attacker data copied to offsets
   640/648 and later incorporated in NEGOTIATE and session setup.
5. Authentication layer consumes forged TargetInfo, enabling server
   tampering / downgrade.

Attack Vector
--------------------------------------------------------------------
A remote attacker controlling (or relaying) an SMB server induces a
Windows client to access a UNC path whose host component is replaced
with a marshalled CREDENTIAL_TARGET_INFORMATION blob.  No local
privileges are required; the vector is a normal network share access
(e.g. via \Run dialogue, Office macro or WebDAV to UNC path).

Patch Description
--------------------------------------------------------------------
1. Always call CredUnmarshalTargetInfo() irrespective of private
   feature flags and abort connection unless the routine returns
   STATUS_NO_SUCH_LOGON_SESSION.
2. Added MRxSmbCopyCipherSuiteInfoFromGlobalConfig() and
   SubRdrBuildMultiProtocolNegotiateString() to replace manual buffer
   construction and enforce strict bounds.
3. Minor correctness fixes (bitmask merge, tracing GUIDs) in
   SmbNegotiate_Continue().

Security Impact
--------------------------------------------------------------------
An unauthenticated attacker could inject crafted TargetInfo data and
alter parameters used in SMB authentication, resulting in tampering
of the negotiated security context.  This could permit server spoofing,
credential relay with modified bindings, or downgrading of expected
protection levels.

Fix Effectiveness
--------------------------------------------------------------------
The patched code removes the feature-flag bypass, validates every
incoming server name through CredUnmarshalTargetInfo(), and aborts on
unexpected results, closing the credential-injection hole.  Moving
buffer assembly to dedicated helpers additionally eliminates latent
memory-corruption risks.  No alternative unchecked code path was
observed, indicating the fix is effective.
