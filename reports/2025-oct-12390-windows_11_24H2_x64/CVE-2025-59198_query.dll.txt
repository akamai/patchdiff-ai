{'kb': 'KB5066835', 'cve': 'CVE-2025-59198', 'date': 1763407743.954297, 'file': 'query.dll', 'patch_store_uid': 'f3b2cbb6-3e7f-40c8-be8c-eadc8c8e841f', 'change_count': 7, 'confidence': 0.28}
--------------------------------------------------------------------
CVE-2025-59198 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Search service (query.dll) – functions
CShtOle::Bind (two variants at 0x1800049A0 and 0x180017E10) that
instantiate IFilter handlers for file-name extensions.

Vulnerability Class
--------------------------------------------------------------------
Improper input validation resulting in a denial-of-service (CWE-20).

Detailed Root Cause Analysis
--------------------------------------------------------------------
1. Both CShtOle::Bind implementations parse the caller-supplied file
   name, obtain the extension with PathFindExtensionW and search an
   internal singly-linked list of CShtOle::CClassNode objects for a
   matching entry.

2. In the vulnerable build the search is performed through the helper
   routine CShtOle::CClassNode::IsMatch():

        for ( i = *this; i; i = *i )
            if ( IsMatch( i, ExtensionW ) ) break;

   The contents of IsMatch are not shown in the diff, but the patch
   removes every use of that helper and replaces it with the CRT
   function _o__wcsicmp().  This demonstrates that IsMatch contained a
   flaw and has been completely bypassed.

3. Because the extension originates in user input no validation was
   performed before IsMatch was called.  A malformed, over-long or
   non-terminated extension such as ".<64K of A’s>" is therefore passed
   straight into the buggy comparison routine.  When query.dll is
   loaded in the SearchIndexer.exe service this leads to an access
   violation inside IsMatch, crashing the process and stopping the
   Windows Search service – a denial of service condition.

4. The patch also rewrites the code that constructs registry key names
   ("\Registry\Machine\Software\Classes\%ws[..]"):
        • Fixed-size 200-wide-char stack buffers are replaced by heap
          buffers whose size is calculated with saturated_mul().
        • Length checks are introduced (>0x64 triggers allocation),
          preventing integer overflows and out-of-bounds copies.
   These defensive changes ensure that extremely long extensions no
   longer corrupt memory even before the comparison step.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Old logic
for ( i = *(_QWORD *)this; i; i = *(_QWORD *)i )
{
    if ( (unsigned int)CShtOle::CClassNode::IsMatch(
             (CShtOle::CClassNode *)i, ExtensionW ) )
        break;
}

// Patched logic
for ( i = *(_QWORD **)this; i; i = (_QWORD *)*i )
{
    if ( !(unsigned int)_o__wcsicmp( ExtensionW, (wchar_t *)(i + 1) ) )
        break;
}
```
```c
// New dynamic allocation guarding against huge paths
size_t len = wcslen(Src) + 1;
if ( len > 0x64 )
    buf = (wchar_t *)operator new[]( saturated_mul(len, 2) );
memcpy_0(buf, Src, len * 2);
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User API (e.g. BindIFilterFromStream or SHCreateDataObject) →
CShtOle::Bind → PathFindExtensionW → vulnerable IsMatch comparison →
access-violation → SearchIndexer.exe crash → Windows Search stops.

Attack Vector
--------------------------------------------------------------------
A local, authenticated user places or indexes a file whose name
contains a deliberately malformed or extremely long extension and then
invokes any Windows Search operation that causes query.dll to bind an
IFilter for that file.  No elevated privileges are required.

Patch Description
--------------------------------------------------------------------
1. Eliminates the unsafe CShtOle::CClassNode::IsMatch routine by
   replacing it with the well-tested _o__wcsicmp.
2. Introduces size-checked, dynamically allocated buffers for all
   registry-path construction, using saturated_mul() to avoid integer
   overflow and memcpy_0 for bounded copies.
3. Adjusts clean-up code paths so that the new allocations are freed
   correctly and the linked list remains consistent.

Security Impact
--------------------------------------------------------------------
Before the fix a crafted file name could crash the Windows Search
service, causing a persistent denial of service for the local system
(user queries, Outlook indexing, Explorer search, etc.) until the
service is manually restarted.  No privilege escalation or remote code
execution is involved.

Fix Effectiveness
--------------------------------------------------------------------
The vulnerable helper is no longer reachable; string comparison now
uses a hardened CRT call that tolerates malformed input.  All dynamic
allocations are size-checked and freed.  No obvious alternative path
into IsMatch remains, so the patch fully mitigates the described DoS.
