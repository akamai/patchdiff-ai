{'kb': 'KB5066835', 'file': 'combase.dll', 'change_count': 13, 'confidence': 0.18, 'cve': 'CVE-2025-58730', 'patch_store_uid': 'd1e9d746-720d-4647-8cb2-ec67327d5cc6', 'date': 1763407735.6470878}
--------------------------------------------------------------------
CVE-2025-58730 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft COM runtime (combase.dll) – class-information cache
(CClassCache) handling of CLSID entries.

Vulnerability Class
--------------------------------------------------------------------
Use After Free (CWE-416).

Detailed Root Cause Analysis
--------------------------------------------------------------------
CClassCache keeps a global hash table ( _ClassEntries ) that maps one
or more GUIDs to a CClassEntry structure.  New entries are allocated by
CClassEntry::CreateIncomplete(), then finalised by
CClassEntry::Complete().  While Complete() is running the global writer
lock may be released so other threads can populate the cache.

1.  Create() calls Complete(); if Complete() sets *fLockReleased = 1,
    the writer lock was temporarily dropped.
2.  After the lock is reacquired, Create() performs a
    CCEHashTable::LookupCE() to see whether another thread has already
    inserted an equivalent entry ( v14 is the newly allocated entry,
    v13 the lookup result).
3.  Prior to the patch:
        if (v13)              // duplicate found
        {
            CDropTargetAdapter *p = *pCE; // pCE still points at v14
            if (p) delete p;  // free v14
            // *** pCE IS NOT UPDATED ***
        }
    The function then returns success, leaving the caller with *pCE
    pointing to freed memory.  Subsequent field access or virtual calls
    on that pointer cause a use-after-free.
4.  A very similar pattern existed in Complete(); when it had to create
    a TreatAs entry it could free a temporary object, return, and leave
    the outer entry holding an invalid list pointer.

The affected members:
  _dwFlags   – bit 0x02 marks an "incomplete" entry.
  _hashNode  – embedded list node added to _ClassEntries.
  _pTreatAsList – circular list of TreatAs relationships.

Failure is purely logical – no bounds/overflow – therefore any caller
using the returned CClassEntry can corrupt the process heap and
redirect execution.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before patch – CClassEntry::Create()
if ( !v13 ) {
    // insert brand-new entry
    ...
    return Incomplete;
}
if ( v14 ) {
    v19 = (CDropTargetAdapter *)*v9; // *pCE
    goto LABEL_13;                   // delete v14
}
...
// *pCE still holds freed v14 on return
```
```c
// after patch
if (wil_feature && v14) {
    if (*v10) delete *v10;       // free old entry
    if (Incomplete >= 0)
        *v10 = (CDropTargetAdapter *)v14; // replace with live one
    return Incomplete;
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Client thread A calls a COM API that causes CClassEntry::Create().
2. Create() releases the writer lock during Complete().
3. Thread B creates and inserts the same CLSID entry.
4. Thread A resumes, finds the duplicate, frees its own entry, returns
   with *pCE still referencing the freed memory.
5. Any subsequent COM operation that touches that pointer triggers a
   UAF.

Attack Vector
--------------------------------------------------------------------
Local or remote code that can create racing activation requests for the
same CLSID can force the UAF.  In practice a malicious document or
script can spin up parallel COM activations inside the same process to
win the race and then spray heap data to hijack the dangling pointer.
No special privileges are required beyond the ability to load COM
objects.

Patch Description
--------------------------------------------------------------------
1. Create()
   • Introduces logic to replace *pCE with the existing cache entry
     after the temporary one is freed.
   • Centralises hash-table insertion through CHashTable::Add().
   • Adds feature-flag gating and telemetry assertion.

2. Complete()
   • Factors Treat-As processing into CompleteTreatAs().
   • Adds explicit tests for the feature flag and _dwFlags to decide
     whether another pass of Complete() is needed.
   • Ensures _dwFlags is cleared only after the entry is stabilised.

Together these changes guarantee the caller never receives a pointer to
freed memory.

Security Impact
--------------------------------------------------------------------
Exploiting the dangling CClassEntry pointer allows an attacker to
corrupt heap metadata or object vtables, leading to arbitrary code
execution in the context of the current process (preview pane / Outlook
/ Explorer etc.).  Because many Microsoft applications use combase.dll,
this constitutes a high-risk local RCE.

Fix Effectiveness
--------------------------------------------------------------------
The patched code updates *pCE to point at the live duplicate entry
before returning, and identical safeguards were added to the TreatAs
path.  No remaining paths free the entry without simultaneously
nullifying or replacing external references, therefore the original
UAF is eliminated.
