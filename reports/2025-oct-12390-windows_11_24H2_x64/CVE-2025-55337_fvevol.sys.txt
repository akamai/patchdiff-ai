{'change_count': 6, 'kb': 'KB5066835', 'patch_store_uid': 'efb29de7-ce28-4d45-a691-32e878d118b2', 'confidence': 0.24, 'cve': 'CVE-2025-55337', 'date': 1763398969.678887, 'file': 'fvevol.sys'}
--------------------------------------------------------------------
CVE-2025-55337 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows fvevol.sys (BitLocker filter driver).  Affected
routine: FveFilterDeviceControl.


Vulnerability Class
--------------------------------------------------------------------
Improper enforcement of behavioural workflow / logical state machine
error (CWE-841).


Detailed Root Cause Analysis
--------------------------------------------------------------------
FveFilterDeviceControl handles private BitLocker IOCTLs that manage the
read/write lock protecting a device’s encryption keys.  Two paired
control codes are relevant:
  • 0x455610D8  – FVE_READ_WRITE_DEVICE_INIT  (locks driver)
  • 0x455610DC  – FVE_READ_WRITE_DEVICE_CLEANUP (unlocks driver)

The driver extension (pointer stored in RCX == v2) keeps a 32-bit
reference counter at offset 0x11B4 ( *(volatile LONG *)v2+1133 ).
When CLEANUP is received the counter is decremented with
_InterlockedDecrement().  In the pre-patch build the following sequence
was executed:
  1. refcount--
  2. if result < 0 -> KeBugCheckEx(0x120)
  3. FveReadWriteDeviceCleanup()
  4. FveUnlockDriver()   <-- always called when refcount >= 0

Thus a single, syntactically valid CLEANUP request could reduce the
counter to zero even while other INIT owners were still active.  The
filter was then unlocked although outstanding users still expected the
driver to be enforcing encryption.  A local attacker able to issue this
IRP (e.g. from a malicious early-boot driver or with physical access
via Direct-IO) could deliberately mis-balance the pair, cause the
unlock, and subsequently access the underlying block device without the
BitLocker transform – effectively bypassing the protection while the
OS remained running.

The only safeguard was the bugcheck on underflow, but the attack does
not need to drive the counter negative: decrementing it to exactly zero
is sufficient to reach FveUnlockDriver and clear the lock.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before
if (_InterlockedDecrement((volatile LONG *)v2 + 1133) < 0)
    KeBugCheckEx(...);
FveReadWriteDeviceCleanup(v2, 0);
FveUnlockDriver(v2);            // unconditional unlock
```
```c
// After
v23 = _InterlockedDecrement((volatile LONG *)v2 + 1133);
...
if (!Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_1())
{
    if (v23 < 0)
        KeBugCheckEx(...);
    FveUnlockDriver(v2);        // unlock only on legacy path
}
// When the feature flag is ON (default after patch) the driver stays
// locked; only diagnostic trace is emitted.
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker opens the BitLocker device stack in kernel context.
2. Sends IOCTL 0x455610D8 once to increment lock (optional).
3. Sends IOCTL 0x455610DC repeatedly until internal counter reaches
   zero.
4. FveUnlockDriver is invoked, removing the encryption filter.
5. Further raw disk I/O bypasses BitLocker.


Attack Vector
--------------------------------------------------------------------
Local, physical or kernel-mode attacker capable of submitting crafted
DeviceIoControl IRPs to fvevol.sys.  No user-mode privilege is
required if the attacker operates from boot-time code, removable media
or malicious DMA device.


Patch Description
--------------------------------------------------------------------
1. Stores the post-decrement value in a local variable.
2. Introduces Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_1()
   gate:
   • When enabled (default), negative counts no longer crash the OS but
     are logged, and FveUnlockDriver is purposely skipped.
   • When disabled, legacy behaviour (bugcheck + unlock) is retained.
3. Adds WPP/ETW tracing structures and corrects event parameter
   packing; unrelated cosmetic renames removed.


Security Impact
--------------------------------------------------------------------
Pre-patch, a malicious actor could force the BitLocker filter into an
unlocked state while the operating system believed the volume was still
protected, giving plaintext read/write access to sensitive data.
Integrity and confidentiality of the encrypted volume could therefore
be violated without knowing the BitLocker key.


Fix Effectiveness
--------------------------------------------------------------------
Skipping FveUnlockDriver unless the internal reference count is
balanced and the new feature flag is disabled closes the logic gap.
Because unlocking is now impossible through an unmatched CLEANUP
request, the workflow enforcement is restored and the bypass path is
eliminated.  No further ways to clear the driver lock were identified
in this code path, so the patch is assessed as effective.

