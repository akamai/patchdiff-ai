{'cve': 'CVE-2025-53717', 'file': 'vmwp.exe', 'date': 1763403065.4230146, 'patch_store_uid': '4de479d1-4f75-495b-8dfb-39c940b3fadc', 'change_count': 4, 'kb': 'KB5066835', 'confidence': 0.1}
--------------------------------------------------------------------
CVE-2025-53717 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Hyper-V worker process (vmwp.exe) – code that restores a saved VM and
that evaluates WIL (Windows-in-box Limiter) feature flags.

Vulnerability Class
--------------------------------------------------------------------
CWE-807  Reliance on Untrusted Inputs in a Security Decision.

Detailed Root Cause Analysis
--------------------------------------------------------------------
Two independent code paths used attacker-controllable data when
building a security decision.

1.  wil::details::FeatureImpl::<TestLabVal/TestGateImp>::
    GetCurrentFeatureEnabledState()
    • The function receives an opaque FEATURE_ENABLED_STATE value that
      can be influenced through registry and policy overrides.
    • Before the patch the code derived a 32-bit result mask (bits
      encode Enabled / Disabled / Variant, Mandatory-Telemetry etc.).
      Bit 0 (“state valid”) was cleared again if the combination of
      bits 0x40/0x400/0x800 did not match a set of hard-coded
      predicates (v10/v11 logic).
    • An attacker could therefore arrange for the mask to indicate
      “feature enabled” (bit 0x40) while simultaneously clearing the
      “state valid” flag (bit 0).  Down-stream consumers treated
      “!bit0” as “trust the caller”, effectively bypassing the normal
      enforcement path.
    • Patch effect: the whole predicate block was deleted and the
      result is now built as   *mask = (flags | 1);  i.e. bit 0 is set
      unconditionally and can no longer be suppressed by the caller.

2.  WorkerTaskStarting::RunRestoreStartSteps()
    • During restore the worker decides whether it is allowed to write
      an optimisation buffer that bypasses zero-initialisation of
      secret RAM pages (variable v57 before patch, v58 after).
    • The old decision was based solely on the registry value
      HKLM\…\EnableAllZeroBufferWrite.  Any local admin – or code
      running in a VBS enclave – could toggle that value and force the
      worker to **skip** the zero-fill, leaving sensitive data in
      cleartext inside the VM RAM image.
    • The patch adds a second gate: the operation is now permitted only
      if BOTH the registry key is set and an internal
      wil::Feature_Servicing_MktmeVmRestoreCrash is enabled *and* the
      underlying hardware exposes a safe capability via a VID call.
      This removes the sole reliance on the untrusted registry input.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before – bit0 could be cleared again
v11 = 1;
if ( (*mask & 0x40) == 0 || !v10 )
    v11 = 0;
*mask = v11 | *mask & 0xFFFFFFFE;   // may clear bit0

// After – bit0 forced to 1
*mask = v7 | v8 | 1;                // cannot be cleared by caller
```
```c
// Before – single-factor decision
if (!QueryValue(...,"EnableAllZeroBufferWrite", v46) || v46[0] != 1)
    v57 = 1;        // allow optimisation

// After – additional feature + HW check
if ((queryFailedOrNot1) &&
    (!Feature_IsEnabled(...Servicing_MktmeVmRestoreCrash) ||
     !PartitionHwCap()))
    v58 = 1;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privileged attacker modifies HKLM key or WIL policy in the host.
2. Hyper-V manager (vmwp.exe) starts VM restore.
3. GetCurrentFeatureEnabledState builds a malformed mask with bit 0
   cleared while keeping enable bits set.
4. WorkerTaskStarting consumes this mask / registry flag and enables
   the fast RAM path.
5. Secret pages are restored without mandatory zeroing, allowing local
   read-out from the saved-state file and privilege escalation inside a
   VBS enclave.

Attack Vector
--------------------------------------------------------------------
Local – attacker needs the ability to modify virtualisation registry
keys or WIL per-feature overrides.  No administrator rights inside the
host kernel are required; the exploit is carried out from user mode
inside a VBS enclave process running with normal user privileges.

Patch Description
--------------------------------------------------------------------
1. Simplified feature-state construction – removed complex secondary
   predicate and forces STATE_VALID (bit0) to 1.
2. Removed unused __private_IsEnabled branch and redundant variable
   juggling.
3. Hardened RestoreStartSteps: now requires *both* a feature gate and
   a hardware capability in addition to the registry toggle before the
   optimisation is used.
4. Minor clean-ups: variable renaming, dead-code removal, consistent
   initialisation.

Security Impact
--------------------------------------------------------------------
Before the patch a local attacker could make Hyper-V restore a VM with
unencrypted or non-zeroed memory pages.  Those pages can contain host
physical addresses mapped into the VBS enclave, allowing execution of
arbitrary code in the worker process context and ultimately SYSTEM-
level privilege escalation (EoP).

Fix Effectiveness
--------------------------------------------------------------------
The patch removes the possibility to fabricate an "enabled yet
untrusted" feature mask and no longer makes a security decision based
solely on a registry key.  Because both conditions are now
simultaneously required and bit 0 is enforced, the previously reachable
bypass state cannot be reproduced.  No residual paths that still rely
on the untrusted inputs were observed in the updated diff.
