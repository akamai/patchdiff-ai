{'kb': 'KB5066835', 'date': 1763407735.4787972, 'confidence': 0.23, 'change_count': 6, 'patch_store_uid': 'efb29de7-ce28-4d45-a691-32e878d118b2', 'file': 'fvevol.sys', 'cve': 'CVE-2025-55330'}
--------------------------------------------------------------------
CVE-2025-55330 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows BitLocker filter driver (fvevol.sys).
Vulnerable routine: FveFilterDeviceControl.


Vulnerability Class
--------------------------------------------------------------------
Improper enforcement of behavioral workflow / reference-count misuse
(CWE-841).


Detailed Root Cause Analysis
--------------------------------------------------------------------
The BitLocker filter exports two private IOCTLs used by upper‐level
BitLocker components:
  • 0x455610D8  –  FVE_RW_DEVICE_INIT     (locks the driver)
  • 0x455610DC  –  FVE_RW_DEVICE_CLEANUP (unlocks the driver)

On INIT the driver increments a 32-bit reference counter located at
(DeviceCtx + 0x11B4) – the decompiler shows this as
  _InterlockedIncrement((int *)v2 + 1133)
followed by a call to FveLockDriver().

On CLEANUP the counter is decremented and FveUnlockDriver() is invoked
*unconditionally*:
  if (_InterlockedDecrement((int *)v2 + 1133) < 0)
      KeBugCheckEx(...);
  ...
  FveUnlockDriver(v2);

Two problems arise:
1. Workflow is not validated.  A CLEANUP request can be issued when the
   counter is already zero (i.e. no preceding INIT), causing the count
   to under-flow to ‑1.
2. Even though an under-flow is detected, FveUnlockDriver() is still
   reached whenever the fatal call to KeBugCheckEx() is compiled out or
   otherwise bypassed (e.g. by certain feature flags or by attacking in
   a pre-OS environment where the bugcheck cannot be serviced).

Because FveUnlockDriver() removes the global volume lock, subsequent
I/O bypasses BitLocker’s encryption path, giving the attacker raw
sector access and therefore a BitLocker security-feature bypass.
Nothing prevents a physical attacker from sending the single IOCTL to a
blocked volume before the OS fully boots.


Vulnerability Code Snippets
--------------------------------------------------------------------
Before patch:
```c
// case IOCTL_FVE_RW_DEVICE_CLEANUP (0x455610DC)
if (_InterlockedDecrement((int *)v2 + 1133) < 0)
    KeBugCheckEx(0x120, 0xC, 0, 0, 0);
...
FveUnlockDriver(v2);          // always executed
```
After patch:
```c
v23 = _InterlockedDecrement((int *)v2 + 1133);
if (Feature_IsEnabled()) {
    if (v23 < 0)
        WPP_SF_qd(...);       // log only
} else if (v23 < 0) {
    KeBugCheckEx(...);
}
...
if (!Feature_IsEnabled())     // unlock only for correct workflow
    FveUnlockDriver(v2);
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker opens the volume device exposed by fvevol.sys.
2. Sends DeviceIoControl with code 0x455610DC (CLEANUP) without ever
   sending the matching 0x455610D8 (INIT).
3. Reference count becomes ‑1.
4. FveUnlockDriver() executes and clears the BitLocker filter lock.
5. Subsequent read/write requests reach the underlying block device in
   clear-text.


Attack Vector
--------------------------------------------------------------------
Requires physical access to the machine (e.g. booting from external
media) or any context able to issue raw device-control requests before
BitLocker is fully engaged.  No authentication is needed – the IOCTL is
accepted as long as RequestorMode == KernelMode, which is satisfied in
boot or recovery environments under attacker control.


Patch Description
--------------------------------------------------------------------
The fix adds a feature-guarded branch that:
1. Stores the post-decrement value in a temporary variable.
2. When the value is negative, merely logs an ETW event instead of
   allowing execution to proceed directly.
3. Crucially, the subsequent call to FveUnlockDriver() is placed behind
   the same feature gate.  If the guard is active (i.e. fix enabled)
   and the workflow is broken, the driver is *not* unlocked.

Additional non-security changes (trace-GUID updates, signature change of
FveDiscoverVolume, ETW metadata relocation) are incidental.


Security Impact
--------------------------------------------------------------------
Prior to the patch an attacker could issue a single malformed IOCTL to
force FveUnlockDriver() and thereby gain unencrypted access to the disk
contents.  This constitutes a BitLocker security-feature bypass with
physical-access threat model.  Integrity and confidentiality of the
protected volume are lost.


Fix Effectiveness
--------------------------------------------------------------------
By withholding FveUnlockDriver() when the reference count becomes
negative, the patch closes the workflow gap: an unmatched CLEANUP no
longer removes the BitLocker driver lock.  The vulnerability is
therefore effectively mitigated as long as the new feature flag is
present and enabled on all affected systems.


