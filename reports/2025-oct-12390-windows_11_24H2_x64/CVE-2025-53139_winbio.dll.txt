{'date': 1763407727.5264385, 'confidence': 0.26, 'kb': 'KB5066835', 'patch_store_uid': '2fe1d4ac-1727-4c13-9443-7570b45992bf', 'file': 'winbio.dll', 'change_count': 8, 'cve': 'CVE-2025-53139'}
--------------------------------------------------------------------
CVE-2025-53139 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Hello / winbio.dll (biometric service common & policy code)

Vulnerability Class
--------------------------------------------------------------------
Logic-error / type-confusion leading to security-feature bypass

Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  The helper  winbio::GetRegKeyPathFromRegKeyName() is supposed to
    translate an enum value (RegKeyName) into the corresponding
    registry-value name.

2.  In the vulnerable build the routine completely ignored the enum
    that it received; if the caller supplied a non-NULL output pointer
    the function unconditionally returned the constant string
    "ESSCapableOnLastStart" and reported success (0).

3.  The most important in-tree caller is
    winbio::GetBioRegKeyValue(_WINBIO_IDENTITY *,RegKeyName,ULONG *).
    Prior to the patch the first parameter (a1 – a _WINBIO_IDENTITY
    pointer) was accidentally forwarded to
    GetRegKeyPathFromRegKeyName() *in place of* the enum parameter.  In
    other words, an arbitrary pointer value was interpreted as
    RegKeyName while the real enum (a2) was ignored.

4.  Because GetRegKeyPathFromRegKeyName() always returned the same
    literal the fault was masked at run-time – the wrong parameter did
    not trigger an immediate error, but every request for *any* of the
    defined registry values was redirected to the single value
    ESSCapableOnLastStart.

5.  Higher-level logic, e.g. WinBioIsESSCapable(), used the helper to
    decide whether Enhanced Sign-in Security (ESS) is available.  An
    attacker able to set the publicly writable HKLM registry value
    ESSCapableOnLastStart could therefore make WinBioIsESSCapable()
    return an arbitrary result and bypass the ESS enforcement path.

6.  Because the registry data are neither encrypted nor integrity
    protected the flaw effectively results in clear-text transmission
    of a security decision between components and allows a local
    attacker to spoof that decision.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// winbio::GetRegKeyPathFromRegKeyName – vulnerable version
if (a2) {                       // only checks pointer, ignores a1
    *a2 = L"ESSCapableOnLastStart"; // always returned
    return 0;                   // success for every call
}
...
```
```c
// winbio::GetBioRegKeyValue – vulnerable call site
lpValue = &unk_18002BB24;
RegKeyPathFromRegKeyName =
    winbio::GetRegKeyPathFromRegKeyName(a1, &lpValue);
// a1 is _WINBIO_IDENTITY*, not an enum!
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
WinBioIsESSCapable()
  -> winbio::GetBioRegKeyValue(identity, RegKeyName::ESSCapable, &out)
      -> GetRegKeyPathFromRegKeyName(identity_ptr, &str)  // wrong arg
          -> returns constant "ESSCapableOnLastStart"
  -> caller reads registry HKLM...\ESSCapableOnLastStart
     instead of the intended value and trusts the result.

Attack Vector
--------------------------------------------------------------------
Local attacker with the ability to write to HKLM biometric policy
values (e.g. via mis-configured ACL or running with elevated rights)
sets ESSCapableOnLastStart to 1 (or 0) and forces Windows Hello to
believe the system *is* (or is not) ESS-capable, bypassing hardware
or VBS checks and weakening sign-in security.

Patch Description
--------------------------------------------------------------------
1.  GetRegKeyPathFromRegKeyName() was rewritten:
    • parameter is now an int (enum) and is validated.
    • explicit switch-like mapping to six legal strings.
    • returns ERROR_INVALID_PARAMETER (0x80070057) on out-of-range.
2.  All callers were updated – notably GetBioRegKeyValue() now passes
    the correct enum (a2) instead of the identity pointer.
3.  WinBioIsESSCapable() was simplified to rely solely on the fixed
    helper; dead TPM/VBS probing code was removed.
4.  Numerous ancillary routines were updated to use the new helper and
    corrected string constants (&unk_18002BEE4), plus safe handle /
    unique_any wrappers for registry keys.

Security Impact
--------------------------------------------------------------------
Before the fix any local user able to modify an unprotected registry
value could spoof the ESS capability flag and bypass Windows Hello’s
Enhanced Sign-in Security requirement.  Because the decision was
transported in clear text (registry) and the code silently accepted a
bogus pointer as enum, the bypass required no code-execution inside
winbio.dll.

Fix Effectiveness
--------------------------------------------------------------------
The patched binaries validate the enum, refuse invalid inputs, and use
correct registry value names.  WinBioIsESSCapable() now consumes the
expected value only, so spoofing another key no longer affects the ESS
logic.  The fix fully addresses the identified root cause with minimal
performance impact.

