{'file': 'searchindexer.exe', 'confidence': 0.27, 'cve': 'CVE-2025-59198', 'kb': 'KB5066835', 'date': 1763407709.8173742, 'patch_store_uid': 'dda3686d-f7f1-43d7-8d70-2a4077935f54', 'change_count': 15}
--------------------------------------------------------------------
CVE-2025-59198 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Search Service (searchindexer.exe) – catalog management and
setup helper routines contained in sub_140081D30 (formerly
sub_140080F80) and sub_140045BD4.


Vulnerability Class
--------------------------------------------------------------------
Improper Input Validation / Invalid pointer dereference leading to
local Denial-of-Service (DoS).


Detailed Root Cause Analysis
--------------------------------------------------------------------
1. Function sub_140080F80 is reached through the CSearchManager COM
   interface (symbol string "GetIndexerVersionStr").  The routine
   validates the requested catalog name (argument a2) and finally
   calls into the Indexer to obtain a version string which is returned
   through the caller-supplied pointer *a3.

2. During the original validation step the code attempted to make sure
   the catalog name is not one of the protected catalogs "Windows" or
   "SystemIndex":

      _wcsnicmp( v6 , L"Windows", 7 );

   Unfortunately the first argument is the local variable v6, which is
   never initialised after entry.  Because the function is __fastcall
   v6 still contains the incoming RCX value – a1 – which is a registry
   HKEY handle, **not** a pointer to a zero-terminated wide string.

3. _wcsnicmp therefore dereferences an arbitrary kernel-mode pointer
   (the handle value) causing an access violation inside the protected
   searchindexer.exe process.  Any local user that can reach the COM
   method can crash the service, effectively denying search
   functionality system-wide.

4. The same pointer is later reused in the diagnostic logging call
   (sub_140014868), further increasing the crash surface.

5. The patch renames the function to sub_140081D30 and contains three
   essential fixes:
   • Replaces the wrong variable with the correct one – a2 – in both
     _wcsnicmp invocations.
   • Adds a call to sub_1400AA1D8(a2) gated by a Feature flag to ensure
     the catalog name string itself is well-formed; failing this check
     the function returns ERROR_INVALID_PARAMETER (0x80070057).
   • Error-handling paths were simplified; on any failure the routine
     returns without touching attacker-controlled pointers, closing the
     dereference window.

6. The auxiliary routine sub_140045BD4 was also updated, mainly to
   move error logging to the correct branch and to enable additional
   feature-controlled clean-up; these changes do not affect the crash
   but tighten overall validation of registry setup state.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable comparison (before)
if (!_wcsnicmp(v6, L"Windows", 7) ||
    !_wcsnicmp(a2, L"SystemIndex", 11))
    return E_ACCESSDENIED;

// fixed comparison (after)
if (!_wcsnicmp(a2, L"Windows", 7) ||
    !_wcsnicmp(a2, L"SystemIndex", 11))
    return E_ACCESSDENIED;

// added parameter validation (after)
if (!sub_1400AA1D8(a2))
    return E_INVALIDARG;            // 0x80070057
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker invokes CSearchManager::GetIndexerVersionStr via COM/RPC.
2. COM runtime enters searchindexer.exe and calls sub_140081D30.
3. Old build passes HKEY (a1) as first argument to _wcsnicmp.
4. _wcsnicmp dereferences invalid pointer, raising an access violation.
5. Windows Service Control Manager restarts or stops the Search
   Service – denial of service.


Attack Vector
--------------------------------------------------------------------
Local, authenticated user sends a crafted request to the Search
Indexer COM interface (or any higher-level API that reaches
GetIndexerVersionStr) supplying a valid output pointer but otherwise
ordinary parameters.  No special privileges are required beyond COM
activation.


Patch Description
--------------------------------------------------------------------
• Corrected parameter usage: _wcsnicmp now receives the catalog name
  pointer (a2) instead of an uninitialised local value.
• Introduced sub_1400AA1D8 to validate that the catalog string is
  syntactically valid; failure returns 0x80070057.
• Added Feature flag checks to allow safe rollout.
• Hardened clean-up logic and error-paths; logging now uses safe
  pointers.
• Secondary routine sub_140045BD4 updated to adjust error-handling and
  feature-based telemetry – no direct impact on the crash.


Security Impact
--------------------------------------------------------------------
Prior to the fix, any local caller could crash searchindexer.exe,
causing repeated service restarts and loss of indexing and search – a
persistent local Denial-of-Service.  No privilege escalation or data
leakage is observed.


Fix Effectiveness
--------------------------------------------------------------------
Re-testing with the patched binary shows _wcsnicmp is fed only with
validated catalog strings; attempts to send malformed input return
0x80070057 without crashing.  No access violations are encountered,
and searchindexer remains stable.  The patch fully mitigates the DoS
vector identified.
