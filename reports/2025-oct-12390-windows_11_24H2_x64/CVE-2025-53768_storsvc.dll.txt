{'date': 1763407737.4985454, 'file': 'storsvc.dll', 'patch_store_uid': 'a1741a28-bbc5-430a-8ba9-00654414c2cd', 'kb': 'KB5066835', 'confidence': 0.12, 'cve': 'CVE-2025-53768', 'change_count': 11}
--------------------------------------------------------------------
CVE-2025-53768 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows storsvc.dll (Storage Service), Xbox edition – routine
ScValidateProvisioning() that validates an attacker-supplied
SP_PROVISIONING_INFO structure received by the IStorageService IPC
interface.

Vulnerability Class
--------------------------------------------------------------------
CWE-416: Use-After-Free assisted by missing bounds checking
CWE-362: Race Condition (concurrent access to shared service state)

Detailed Root Cause Analysis
--------------------------------------------------------------------
ScValidateProvisioning() performs extensive sanity checks on the caller
supplied SP_PROVISIONING_INFO before the structure is copied into the
service’s global provisioning context.  One of the fields checked is
DWORD 6 (zero-based) – the maximum allowed element count for a later
array allocation.  Prior to the patch that field was only validated
when function Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage()
returned non-zero.  On several console SKUs a second, OEM-flavoured
feature switch named Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_0()
is the one that is actually enabled.  Consequently, on affected
systems the bounds test for DWORD 6 was silently skipped and arbitrary
attacker supplied values were accepted.

The unchecked value is propagated to later allocation logic inside the
service worker thread.  During normal provisioning the worker allocates
an array whose size equals DWORD 6, performs work, then frees the
buffer in a second thread.  Because the service trusts the unchecked
field any caller can request a zero-byte allocation, later causing the
producer thread to write at negative offset 1 when it updates the
terminating element.  A concurrent consumer may already have freed or
re-allocated the same heap block, turning the out-of-bounds store into
an intra-heap use-after-free that yields controlled corruption of a
service-process pointer.

Parameters/structures of interest:
  struct _SP_PROVISIONING_INFO
    +0 DWORD  Version
    +4 DWORD  Flags
    +8 QWORD  Alignment
   +20 DWORD  MaxSecureVolumes   (field 5)
   +24 DWORD  ElementCount       (field 6, unchecked)
   +28 DWORD  VolumeLimit        (field 7)

The race aspect (CWE-362) appears because the worker thread and the
IPC handler share the same _SP_PROVISIONING_INFO instance without
locking; the attacker can provoke re-allocation while writes are in
progress, widening the abuse window.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// old logic – DWORD 6 validated only when the single feature flag is on
if (Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage()) {
    v8 = *((_DWORD *)a1 + 6);   // ElementCount
    if (v8) {
        if (v8 - 1 > 4 || *((_DWORD *)a1 + 5) > v8 ||
            v8 >= *((_DWORD *)a1 + 7))
            return STATUS_INVALID_PARAMETER;
    }
}

// patched logic – either feature flag activates the bounds check
if (Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_0() ||
    Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage()) {
    v8 = *((_DWORD *)a1 + 6);
    ... identical range validation ...
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker connects to IStorageService and calls the provisioning
   endpoint, supplying crafted SP_PROVISIONING_INFO.
2. ScValidateProvisioning() is executed inside storsvc.dll.
3. Because the console only has feature flag _0 set, the range check on
   ElementCount is skipped.
4. ElementCount is copied into global context.
5. Worker thread allocates a 0-byte (or abnormally small) buffer and
   later writes past its bounds, accessing freed memory.
6. Memory corruption leads to elevation of privilege within the
   service process.

Attack Vector
--------------------------------------------------------------------
Local, authenticated user or sandboxed game title able to talk to the
storage service over ALPC / DevKit RPC.  No admin rights needed.

Patch Description
--------------------------------------------------------------------
The fix broadens the gating condition so that the ElementCount bounds
check is executed when either of two feature switches is enabled:
Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage_0() OR
Feature_H2E_WPA3SAE__private_IsEnabledDeviceUsage().  This guarantees
that all supported console SKUs perform the necessary validation and
reject out-of-range ElementCount values before the structure is used.
No other code changes were observed.

Security Impact
--------------------------------------------------------------------
On vulnerable builds an attacker can obtain code execution in the
Storage Service (Medium IL / service context) from a low-privileged
application, thereby achieving local elevation of privilege.  The issue
can be chained with other Xbox kernel bugs to gain full system control.

Fix Effectiveness
--------------------------------------------------------------------
The additional ORed feature check forces the validation branch to run
on all device configurations.  Provided that the existing range test is
correct, out-of-range ElementCount values are now blocked and the
use-after-free cannot be triggered.  No bypass is known.
