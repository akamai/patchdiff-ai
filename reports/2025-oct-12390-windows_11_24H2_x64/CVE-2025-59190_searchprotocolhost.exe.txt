{'confidence': 0.3, 'change_count': 38, 'cve': 'CVE-2025-59190', 'date': 1763406209.3867717, 'kb': 'KB5066835', 'patch_store_uid': '4d862698-3c26-4890-a42d-1e3fbd91ca45', 'file': 'searchprotocolhost.exe'}
--------------------------------------------------------------------
CVE-2025-59190 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Microsoft Windows Search Service – image-embedding helper
(SearchProtocolHost.exe, CImageHandler::ConvertPBGRA8ToBGRA8Buffer).


Vulnerability Class
--------------------------------------------------------------------
Improper Input Validation / Out-of-bounds read (CWE-20 → DoS).


Detailed Root Cause Analysis
--------------------------------------------------------------------
The helper routine
CImageHandler::ConvertPBGRA8ToBGRA8Buffer(IMAGE_INFO const&, UCHAR*)
converts pre-multiplied BGRA pixel data.  When the supplied IMAGE_INFO
structure advertises an unsupported pixel-format ( `imageInfo.PixelFmt
!= 1` ), the legacy code enters an error path that constructs a WinRT
`hstring` for the exception message:

    winrt::param::hstring bad(a2);   // a2 == &IMAGE_INFO !!!

`a2` is a pointer to the caller-supplied IMAGE_INFO, *not* a wide-char
string.  `winrt::param::hstring` walks memory byte-by-byte until it
finds a terminating L"\0", so it starts reading past the structure into
arbitrary process memory.  If the buffer ends in an unmapped page the
SearchProtocolHost service crashes with an access-violation, denying
service to consumers of Windows Search.

Structures / fields involved:
  IMAGE_INFO
    +0  DWORD Width
    +4  DWORD Height
    +8  DWORD PixelFormat   (expected 1 == PBGRA8)

Execution parameters:
  if PixelFormat != 1  →  unsupported → malformed call above.

The crash is purely a read; no write or privilege-gain is involved, but
it is sufficient to continually terminate the service.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before
if (imageInfo.PixelFmt != 1) {
    winrt::param::hstring h((const wchar_t*)imageInfo); // OOB read
    winrt::hresult_invalid_argument hr(h, loc);
    throw hr;
}

// After (23H2 patch)
if (imageInfo.PixelFmt != 1) {
    winrt::param::hstring h(L"non-supported pixel format passed");
    winrt::hresult_invalid_argument hr(h, loc);
    throw hr;
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Client code feeds an IMAGE_INFO with `PixelFormat != 1` to the
   Search image pipeline.
2. ConvertPBGRA8ToBGRA8Buffer() hits the “unsupported” branch.
3. Old build passes the structure pointer to hstring → linear scan
   beyond valid memory → AV → SearchProtocolHost.exe terminates.


Attack Vector
--------------------------------------------------------------------
Local, unauthenticated.  Any process that can submit crafted thumbnail
or preview data to the Windows Search indexer (e.g. via IFilter/IStore)
can feed the malformed IMAGE_INFO and crash the service repeatedly,
causing a denial-of-service condition.


Patch Description
--------------------------------------------------------------------
1. The error path now builds the hstring from a *static, literal* wide
   string, eliminating the incorrect cast.
2. The winrt::param::hstring constructor was hardened: it now counts
   characters, verifies a terminating NUL, and aborts when given an
   unterminated buffer.
3. Minor related clean-ups (modernised exception helper, etc.)


Security Impact
--------------------------------------------------------------------
• Prior to the patch, a malformed request leads to an access-violation
  in SearchProtocolHost, stopping Windows Search.
• No EoP or info-leak; the issue is a service Denial-of-Service.


Fix Effectiveness
--------------------------------------------------------------------
The literal string removes the possibility of dereferencing attacker
input.  Additional validation in the hstring constructor adds a second
layer of defence for any remaining call-sites.  No residual paths to
the original flaw were observed in the patched binary.

--------------------------------------------------------------------
