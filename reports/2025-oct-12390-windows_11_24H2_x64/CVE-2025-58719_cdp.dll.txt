{'date': 1763403069.7412949, 'file': 'cdp.dll', 'kb': 'KB5066835', 'change_count': 643, 'confidence': 0.21, 'patch_store_uid': '76be1102-53fe-47f5-94be-28ece81636ed', 'cve': 'CVE-2025-58719'}
--------------------------------------------------------------------
CVE-2025-58719 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Connected Devices Platform Service (Cdpsvc)
cdp.dll – function chain around IWorkItemDispatcher::AddWorkItem and
Tip2 shared_data::on_result.

Vulnerability Class
--------------------------------------------------------------------
Use After Free – CWE-416

Detailed Root Cause Analysis
--------------------------------------------------------------------
The vulnerable routine was the compiler-generated lambda helper
cdp::IWorkItemDispatcher::AddWorkItem__lambda_8c339cd5...().

1.  The helper constructs a temporary std::function object on the
    caller’s stack (array v5).
2.  The concrete callable object is allocated on the heap via
    std::_Global_new_std::_Func_impl_no_alloc...() and its pointer is
    stored inside v5.
3.  v5 is passed by reference to the dispatcher’s AddWorkItem virtual
    method (v3).
4.  As soon as the virtual call returns, the stack object v5 is
    destroyed, which in turn frees the heap-allocated _Func_impl.
5.  The dispatcher, however, may have kept a copy of the pointer to the
    freed _Func_impl for deferred execution.  Any later invocation of
    the queued work item dereferences invalid memory, producing a classic
    use-after-free inside the SYSTEM-privileged Cdpsvc process.

Affected data structures / parameters
  • std::function<bool(ULONG,const WCHAR*,const WCHAR*)>  (v5)
  • std::_Func_impl_no_alloc<lambda>                      (heap object)
  • v3 – virtual table slot +0x18 (AddWorkItem)

Because the freed memory contains attacker-controlled pointers, an
authenticated local user can achieve arbitrary code execution in the
service context, resulting in elevation of privilege.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// BEFORE
v3 = *(__int64 (**)(__int64, char *))(*(_QWORD *)a1 + 24);
v6 = std::_Global_new_std::_Func_impl_no_alloc__lambda(...)(a2);
LOBYTE(v3) = v3(a1, v5);              // dispatcher keeps copy of v5
std::function<...>::~function(v5);    // v5 freed immediately → UAF
```
```c
// AFTER (simplified)
if (!tip2::details::g_test_interface_exception_guard)
    return (*func)(*a1);
result = g_test_interface_exception_guard(*a1,0,0,0,a2);
if (!result)
{
    *(WORD *)(a2+42) = 0x401E;        // set failure code
    *(BYTE *)(a2+40) = 3;
    return TestClose_0(...);          // safe cleanup
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Client code calls Cdpsvc API that eventually reaches
   IWorkItemDispatcher::AddWorkItem.
2. The helper lambda builds a temporary std::function (v5) and passes it
   to the dispatcher.
3. Dispatcher queues the callback for later execution.
4. Helper returns; std::function destructor runs and frees _Func_impl.
5. At a later time the dispatcher executes the queued work item and
   dereferences the freed _Func_impl → UAF → potential RCE in SYSTEM.

Attack Vector
--------------------------------------------------------------------
A locally authenticated attacker sends crafted work-item requests to the
Connected Devices Platform Service, causing it to queue callbacks that
reference attacker-controlled std::function objects.  When the service
later executes the queued work, it operates on freed memory, enabling
control of instruction flow and elevation to SYSTEM.

Patch Description
--------------------------------------------------------------------
Microsoft replaced the fragile lambda helper with
Tip2::details::shared_data<1,0,0>::on_result().  Key changes:
  • Removed on-stack std::function construction and destruction.
  • Introduced a persistent shared_data structure that survives until
    callback completion, eliminating premature free.
  • Wrapped the virtual call with g_test_interface_exception_guard to
    detect failures and route to TestClose_0 for orderly teardown.
  • Explicitly writes status code 0x401E and state 3 into the output
    TipReportingInfo buffer when the guard detects an error.

Security Impact
--------------------------------------------------------------------
Before the patch, a normal user could trigger use-after-free in the
SYSTEM service process and run arbitrary code, yielding full privilege
escalation.  The issue scores high for local EoP because exploitation is
reliable and the service runs as NT AUTHORITY\SYSTEM.

Fix Effectiveness
--------------------------------------------------------------------
The patch removes the lifetime mismatch by keeping the callable object
alive for the entire work-item lifecycle and by adding an exception
guard.  No immediate path to reclaim freed memory remains, and the
additional guard prevents silent failures.  Therefore the fix appears
complete for the identified UAF.
