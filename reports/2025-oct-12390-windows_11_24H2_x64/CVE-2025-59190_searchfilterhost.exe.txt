{'kb': 'KB5066835', 'date': 1763406151.5496657, 'confidence': 0.12, 'change_count': 53, 'file': 'searchfilterhost.exe', 'cve': 'CVE-2025-59190', 'patch_store_uid': 'bbd8c9d6-7db5-4474-9b79-39b862387365'}
--------------------------------------------------------------------
CVE-2025-59190 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Search Service – user-mode filter pipeline contained in
searchfilterhost.exe.  The affected code lives in the
SemanticTextFilterAdapter and TransactionFilterAdapter helper
classes that wrap concrete IFilter-style plug-ins.


Vulnerability Class
--------------------------------------------------------------------
Improper Input Validation (CWE-20) leading to NULL-pointer
Dereference / Denial-of-Service.


Detailed Root Cause Analysis
--------------------------------------------------------------------
The adapters expose thin wrappers (BreakType and Locale) that
forward the request to one of two internal filter interfaces that
are stored in the object at
    +48  -> filter for document scope
    +56  -> filter for property scope
The choice is controlled by an optional enum stored at +80 (for
Transaction* adapters) or +220 (for Semantic* adapters):
        enum tagGenericFilterItemType { None = 0, Property = 1,
                                        Break  = 4, ... }

PRE-PATCH  (TransactionFilterAdapter::BreakType / ::Locale)
-----------------------------------------------------------
The code only treated values 0 and 1 as valid:
    if (type == 0) use pointer +48
    else if (type == 1) use pointer +56
    else return E_INVALIDARG

When the value was 4 (Break) the logic fell into the final
else-branch, returned failure 0x8000000E, but **left the adapter in
an inconsistent state**.  Subsequent callers expected the request
to be serviced and attempted again, eventually dereferencing the
still-null delegate pointers, crashing searchfilterhost.exe and
resetting the Windows Search Service.

PRE-PATCH  (SemanticTextFilterAdapter::BreakType)
------------------------------------------------
The Semantic variant already accepted 4, but a missing defensive
check meant that the filter interface could be dereferenced before
its presence was verified.

PATCH
-----
The fix unifies the validation in all three affected methods:
    1. The enum is loaded once (rsi) and compared.
    2. (type == 0 || type == 4)  => delegate +48
    3. (type == 1)               => delegate +56
    4. otherwise                 => return E_INVALIDARG
    5. Before invoking the vtable, the pointer is checked for NULL.

Additional non-security code (feature-flagged telemetry and cache
population) was inserted in SemanticTextFilterAdapter::BreakType,
but the security hardening consists solely of the stricter enum
handling and repeat NULL checks.

Thus the root cause was an incomplete input validation state
machine that did not regard tagGenericFilterItemType::Break as a
legal value, eventually allowing a NULL-pointer dereference and
service crash.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// TransactionFilterAdapter::BreakType   (before)
if (!*(_DWORD *)optional) {
    v = *(QWORD *)(a1+48);
    return v->BreakType(a2);
}
if (*(_DWORD *)optional == 1) {
    v = *(QWORD *)(a1+56);
    return v->BreakType(a2);
}
*a2 = 0;                 // type 2,3,4 fall here => wrong state
return 0x8000000E;
```

```c
// TransactionFilterAdapter::BreakType   (after)
opt = a1+80;
if (!val(opt) || val(opt) == 4) {
    v = *(QWORD *)(a1+48);
    if (!v) return 0x8000033;
    return v->BreakType(a2);
}
if (val(opt) == 1) {
    v = *(QWORD *)(a1+56);
    if (!v) return 0x8000033;
    return v->BreakType(a2);
}
*a2 = 0;
return 0x8000007E;
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. User provides specially crafted data to the Windows Search index
   (e.g., a document with embedded property of type 4).
2. The indexer hands the stream to searchfilterhost.exe.
3. TransactionFilterAdapter::BreakType / ::Locale is invoked.
4. Pre-patch code treats type==4 as illegal, returns error but leaves
   internal state unchanged.
5. Higher-level logic retries or continues and eventually calls the
   same function again, which now dereferences a NULL delegate
   pointer at +48, raising an access-violation.
6. The unhandled exception terminates searchfilterhost.exe,
   temporarily disabling the Windows Search Service.


Attack Vector
--------------------------------------------------------------------
Local, non-privileged attacker can supply content that is parsed by
Windows Search (e.g., by indexing a crafted document or archive).
No special permissions are required beyond the ability to add files
to a location that is indexed by the service.


Patch Description
--------------------------------------------------------------------
• Adds consistent validation that accepts enum values 0 and 4.
• Refactors the decision logic to a single block using a local copy
  of the optional value, eliminating duplicate reads.
• Introduces explicit NULL checks for both delegate interface
  pointers before each virtual call.
• Semantic adapter received identical hardening plus diagnostic and
  cache code guarded by a WIL feature flag.


Security Impact
--------------------------------------------------------------------
Prior to the fix, malformed input could crash searchfilterhost.exe,
causing a service restart loop and rendering Windows Search
unavailable for the user session.  No privilege escalation or data
corruption was observed; the impact is denial-of-service.


Fix Effectiveness
--------------------------------------------------------------------
The hardened logic ensures that:
  1. All legal enum values (0,1,4) are handled explicitly.
  2. Illegal values immediately translate to an error code without
     touching delegate pointers.
  3. Any delegate pointer is validated for NULL before use.
Hence a NULL-pointer dereference can no longer be triggered through
malformed GenericFilterItemType values, effectively mitigating the
reported DoS condition.

