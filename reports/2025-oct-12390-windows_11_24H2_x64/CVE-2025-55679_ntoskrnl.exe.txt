{'file': 'ntoskrnl.exe', 'change_count': 222, 'date': 1763407778.952669, 'cve': 'CVE-2025-55679', 'kb': 'KB5066835', 'patch_store_uid': 'c1b97b38-6328-4043-8cf8-12e6eafee863', 'confidence': 0.35}
--------------------------------------------------------------------
CVE-2025-55679 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows NT kernel – XSTATE / CONTEXT handling helper routine
(RtlGetEnabledExtendedFeatures) used by KiContinue* and other
context-manipulation paths.

Vulnerability Class
--------------------------------------------------------------------
Improper Input Validation / Use of Uninitialized Variable → kernel
information disclosure (CWE-20 / CWE-200).

Detailed Root Cause Analysis
--------------------------------------------------------------------
The helper routine RtlGetEnabledExtendedFeatures(ULONG64 FeatureMask)
returns the set of CPU extended-state (XSTATE) features that are both
permitted by the architecture and enabled for the current thread.  In
the pre-patch implementation the register holding the final result was
assembled as follows:

 1. Obtain an architecture mask (v3).
 2. Depending on the type of CONTEXT requested, pick one of three
    hard-coded bit-masks (0x40000000000009FF, 0x4000000000060DFF or 4).
 3. AND the selected mask with the value contained in the r9 register
    (local variable v4) and return it to the caller.

The problem:   v4 was never initialised.  Its value therefore remained
whatever 64-bit data happened to be in the r9 register on entry to the
function – typically previous stack contents.  That stale kernel stack
content was then returned to the caller and later copied into the
user-supplied CONTEXT/XSTATE buffer by KiContinuePreviousModeUser and
similar paths, allowing an unprivileged user-mode process to read up to
64 bits of kernel stack memory per call.

Affected structures / parameters
• v4 (register r9) – uninitialised 64-bit temporary.
• RETURN value of RtlGetEnabledExtendedFeatures – propagated into
  _XSAVE_FORMAT / _CONTEXT blocks that are delivered to user-mode.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before patch – file ntoskrnl.exe
ULONG64 __stdcall RtlGetEnabledExtendedFeatures(ULONG64 FeatureMask)
{
  ...
  __int64 v3; // rax
  __int64 v4; // r9   <-- UNINITIALISED
  ...
  if ( (v3 & 0x10000) != 0 )
  {
    v5 = 0x40000000000009FFi64;
    return v5 & v4;          // leaks v4
  }
  if ( (v3 & 0x100000) != 0 )
  {
    v5 = 0x4000000000060DFFi64;
    return v5 & v4;          // leaks v4
  }
  if ( (v3 & 0x400000) != 0 )
    return v4 & 4;           // leaks v4
  return 0i64;
}
```

```c
// after patch
ULONG64 __stdcall RtlGetEnabledExtendedFeatures(ULONG64 FeatureMask)
{
  ULONG64 Allowed = FeatureMask & (MEMORY[...D8] | MEMORY[...708]);
  unsigned int ArchMask = RtlpArchContextFlagFromMachine(34404);
  RtlpRemoveArchDisallowedXStateFeatures(ArchMask, &Allowed);
  return Allowed;            // no use of uninitialised data
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
User process → NtContinue / NtGetContextThread →
KiContinuePreviousModeUser → RtlGetEnabledExtendedFeatures → returns
value containing uninitialised r9 → copied into user CONTEXT/XSTATE
buffer → user receives leaked kernel stack data.

Attack Vector
--------------------------------------------------------------------
A non-privileged local attacker repeatedly requests or sets an extended
CONTEXT (CONTEXT_XSTATE) for its own thread.  Each call yields up to 8
bytes of previously uninitialised kernel stack memory, which can be
aggregated to disclose sensitive information.

Patch Description
--------------------------------------------------------------------
1. Re-implemented RtlGetEnabledExtendedFeatures:
   • Eliminates the uninitialised local variable.
   • Computes the return value only from validated inputs.
   • Introduces new helper RtlpRemoveArchDisallowedXStateFeatures to
     strip disallowed bits explicitly.
2. All callers (RtlGetExtendedContextLength*, RtlInitializeExtended*
   etc.) were updated to the new validation helpers
   (RtlpValidateContextFlags2), centralising flag verification.

Security Impact
--------------------------------------------------------------------
Before the fix an attacker could read arbitrary kernel stack bytes
(indirectly through leaked register contents).  The disclosure breaks
Kernel Address Space Layout Randomisation (KASLR) and may expose other
confidential data residing on the stack.

Fix Effectiveness
--------------------------------------------------------------------
The patched routine no longer returns data derived from uninitialised
memory; the value is built exclusively from caller-supplied FeatureMask
AND architecturally-allowed bits.  No other path references the old
uninitialised variable, so the specific information disclosure avenue
is closed.

