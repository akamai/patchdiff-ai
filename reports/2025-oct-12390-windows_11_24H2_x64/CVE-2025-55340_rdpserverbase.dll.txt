{'patch_store_uid': '779bb73a-7c17-460a-bbea-59658147cbc4', 'kb': 'KB5066835', 'confidence': 0.15, 'cve': 'CVE-2025-55340', 'change_count': 2, 'date': 1763407710.2719488, 'file': 'rdpserverbase.dll'}
--------------------------------------------------------------------
CVE-2025-55340 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
rdpserverbase.dll – WebSocket transport layer of the Windows Remote
Desktop Protocol (RDP) service.  Affected routines are
WebSocketServer::SubscribeForDisconnect and
WebSocketServer::ProcessWebSocketRequest.


Vulnerability Class
--------------------------------------------------------------------
Logical error / improper authentication (CWE-287).  Failure to
propagate an error allowed an HTTP/WebSocket connection to be treated
as authenticated even when the underlying disconnect subscription had
failed.


Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  Purpose of SubscribeForDisconnect
    The helper allocates an OVERLAPPED structure, then calls
    HttpWaitForDisconnect( ConnectionHandle, ConnectionId ) so the
    server can be asynchronously notified when the HTTP connection
    drops.  Correct operation of the RDP WebSocket channel relies on
    this subscription.

2.  Bug in the original build
    • Return type was void.
    • When HttpWaitForDisconnect returned an immediate error other than
      ERROR_IO_PENDING (997) the function merely logged the error and
      returned without informing the caller.
    • Allocation failures were likewise silent – the caller was never
      told that the subscription could not be established.

3.  Caller behaviour
    ProcessWebSocketRequest unconditionally treated the connection as
    valid, inserted the newly created
    HTTP_TRANSPORT_CONNECTION_INFO object into its global list, and
    marked the OVERLAP_ID state as “connected”.  No verification of the
    subscription outcome was performed.

4.  Exploitable condition
    A local, already-authenticated attacker could intentionally cause
    HttpWaitForDisconnect to fail (e.g. by racing the HTTP handle or
    providing an invalid ConnectionId).  Because the failure was not
    propagated, the server still considered the WebSocket channel
    accepted.  Subsequent RDP traffic therefore flowed over a
    connection that was **not bound to a valid HTTP transport** and was
    no longer monitored for disconnect events, effectively bypassing a
    required security check in the WebSocket handshake path.

5.  Security outcome
    The attacker could open duplicate or stale channels and bypass the
    disconnect-tracking feature that enforces correct channel
    ownership.  This constitutes a security-feature bypass in the RDP
    authentication pipeline.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before – SubscribeForDisconnect (void, no status propagation)
StartThreadpoolIo(tpIo);
status = HttpWaitForDisconnect(hHttp, id, &ov);
if (status && status != 997) {
    CancelThreadpoolIo(tpIo);
    // log only …
}
// no return value – caller assumes success
```

```c
// After – now returns NTSTATUS style value
status = HttpWaitForDisconnect(hHttp, id, &ov);
if (!status || status == 997)
    return 0;                    // success
CancelThreadpoolIo(tpIo);
…
return (status > 0 ? (status & 0xFFFF) | 0x80070000 : status);
```

```c
// Caller before – ignored result
WebSocketServer::SubscribeForDisconnect(this, cnName, &Guid, ConnId);
```

```c
// Caller after – handles failure and cleans up
sts = WebSocketServer::SubscribeForDisconnect(this, cnName, &Guid,
                                              ConnId);
if (sts < 0) {
    --ListCount;
    Unlink(listEntry);
    CleanupConnInfo(this, info);
    return sts;
}
```
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker initiates a WebSocket upgrade request to the RDP service.
2. ProcessWebSocketRequest allocates a connection info object.
3. SubscribeForDisconnect is called with the supplied ConnectionId.
4. Attacker forces HttpWaitForDisconnect to fail immediately.
5. In the vulnerable build, the failure is swallowed; the connection is
   still inserted into the active list and marked authenticated.
6. RDP session proceeds without a valid transport binding, bypassing
   disconnect enforcement.


Attack Vector
--------------------------------------------------------------------
Local attacker already in an RDP session (or owning the local HTTP
handle) races or spoofs the ConnectionId during the WebSocket
handshake, causing HttpWaitForDisconnect to fail and leaving the server
in an unauthenticated but accepted state.


Patch Description
--------------------------------------------------------------------
• SubscribeForDisconnect now returns an INT64 status value instead of
  void and consistently reports all failure paths.
• Added early returns on success (0 / ERROR_IO_PENDING) and explicit
  error mapping for other codes.
• ProcessWebSocketRequest signature changed; it now captures the return
  value, and if the subscription fails it:
    – Removes the partially-constructed connection from internal
      lists.
    – Calls CleanupConnInfo and releases all resources.
    – Propagates the error back to the caller.
• Additional WPP tracing and MSRC95012 feature-gate added for
  diagnostics but not security-critical.


Security Impact
--------------------------------------------------------------------
Prior to the fix a malicious user could establish WebSocket channels
that the server believed were properly authenticated while the required
HttpWaitForDisconnect subscription never existed.  This bypassed a key
security feature (connection tracking) in the RDP gateway and could be
leveraged to maintain or create sessions that should have been
rejected, leading to CVE-2025-55340 (Security Feature Bypass / Improper
Authentication).


Fix Effectiveness
--------------------------------------------------------------------
The revised design eliminates the silent-failure condition by
propagating errors and aborting connection establishment when
subscription fails.  Because ProcessWebSocketRequest now cleans up and
refuses the request in such cases, the flawed state cannot be reached.
No remaining unchecked paths to connection acceptance were found in the
patched code, indicating the fix is effective.

