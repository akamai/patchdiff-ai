{'confidence': 0.22, 'patch_store_uid': '152ddfdc-d9de-401d-a57d-35df81fff0c6', 'file': 'shellhost.exe', 'kb': 'KB5066835', 'date': 1763403050.7183244, 'change_count': 4, 'cve': 'CVE-2025-59244'}
--------------------------------------------------------------------
CVE-2025-59244 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Core Shell (shellhost.exe) – FlowEndpointBase window‐message
handling code and supporting WIL feature-state helpers.

Vulnerability Class
--------------------------------------------------------------------
Improper input validation / external control of file name or path
(CWE-73).  The flaw is exploitable through spoofed WM_COPYDATA
messages and results in a network-triggerable spoofing condition that
can disclose NTLM hashes.

Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  The routine FlowEndpointBase::OnCopyData() is the single entry
    point that receives WM_COPYDATA traffic for the Core Shell flow
    channel.  Before the patch the function accepted the message when

       state != 3 && ( senderHwnd == this->m_peerHwnd || state == 4 )

    where  ‘state’ is a private connection state machine value
    (0-Init, 1-Handshake, 4-Connected, 3-Closed).  When state == 4 the
    message was taken **from any HWND**, i.e. the sender was not
    authenticated.

2.  The handler immediately dereferenced the caller-controlled
    COPYDATASTRUCT members (dwData, cbData, lpData) and passed the raw
    buffer into a WinRT IBuffer object.  The buffer is subsequently
    forwarded to shell internal code that interprets it as a ValueSet
    and ultimately as a file-system path.  Because the path comes from
    an unauthenticated window, the attacker fully controls it and can
    trigger outbound file/SMB probes that leak NTLM credentials.

3.  Supporting WIL feature helper functions (GetCurrentFeatureEnabled
    State / GetCachedFeatureEnabledState) contained several bit-twiddle
    errors that supplied wrong option bits to the caller and prevented
    additional run-time checks from being executed.  Although not the
    direct exploit vector, these mistakes kept the vulnerable path
    enabled in production builds.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
//  FlowEndpointBase::OnCopyData – vulnerable part (simplified)
if (state != 3 && (a2 == m_peerHwnd || state == 4))
{
    // No further validation of dwData/cbData/lpData
    IBuffer *buf = new CBuffer(cbData, lpData); // attacker-controlled
    .... // buf forwarded -> path usage
}

//  Patched logic (simplified)
if (Feature_SWT_3_is_on)
{
    if (state == 4 || (state == 1 && dwData == 3))
        goto Accept;
    allowed = (a2 == m_peerHwnd);
}
else
{
    if (a2 == m_peerHwnd)
        goto Accept;
    allowed = (state == 4);
}
if (!allowed)
    return;          // message dropped
Accept:
...
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker locates the shell window handle (FindWindow / EnumWindows).
2. Sends crafted WM_COPYDATA with:
   - dwData : arbitrary (non-validated)
   - cbData : length of fake ValueSet that contains attacker path
   - lpData : pointer to buffer in attacker process
3. FlowEndpointBase::OnCopyData inside shellhost.exe accepts the
   message because state==4 (or during handshake).
4. Buffer is wrapped into WinRT CBuffer/ValueSet and later used in
   code that opens or probes the supplied path, causing NTLM hash
   disclosure or other spoofing impact.

Attack Vector
--------------------------------------------------------------------
Local or remote attacker that can send window messages to the target
session (e.g., from a low-privilege process or via RDP/Terminal
services) delivers a spoofed WM_COPYDATA to the shell host window.

Patch Description
--------------------------------------------------------------------
• Introduces a feature-flag (Feature_SWT_3) gate around message
  processing.
• Adds explicit validation of dwData when the state machine is in
  handshake (state==1) – only value 3 is now accepted.
• Keeps the legacy acceptance rule only when the sender HWND matches
  the negotiated peer.
• Early-returns if the new checks fail, preventing the creation of the
  WinRT buffer on untrusted data.
• Corrects multiple bit-mask calculations in WIL feature helper
  routines so that the new checks cannot be bypassed by incorrectly
  cached state.

Security Impact
--------------------------------------------------------------------
Prior to the fix any process could spoof a flow message that contained
an arbitrary path, leading the Core Shell to initiate SMB / WebDAV
access and unintentionally disclose the current user’s NTLM hash.
Because the message can be sprayed over the network (e.g., via
Terminal Services), the flaw enables network-based spoofing attacks.

Fix Effectiveness
--------------------------------------------------------------------
The added sender/parameter validation and the corrected feature-state
logic remove the only code paths that handled untrusted WM_COPYDATA
payloads.  No further uses of the vulnerable acceptance pattern were
observed in the binary, so the patch appears complete and effective.
