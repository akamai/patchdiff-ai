{'file': 'ncsi.dll', 'cve': 'CVE-2025-59201', 'confidence': 0.48, 'kb': 'KB5066835', 'change_count': 16, 'patch_store_uid': '65794dd6-d80f-4e59-a7b4-7d7103778d19', 'date': 1763406104.2530203}
--------------------------------------------------------------------
CVE-2025-59201 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Network Connection Status Indicator (NCSI) – ncsi.dll, function
StoreNcsiIEProxyString.


Vulnerability Class
--------------------------------------------------------------------
Improper Access Control / Path-Traversal (CWE-284, CWE-22).


Detailed Root Cause Analysis
--------------------------------------------------------------------
StoreNcsiIEProxyString is responsible for persisting an Internet
Explorer proxy configuration string in the registry under an HKLM
location (symbol qword_18009BE30 / qword_18009CE30).  The caller passes

  Str   – Wide-char proxy string (may be NULL)
  a2    – Boolean that prefixes the string with "1" or "0"

Prior to the patch the routine performed **no validation** on the caller
supplied proxy string.  It simply formatted:
    "%s%s"   ->  [flag][user_text]
expanded the vector buffer, then executed:
    RegSetValueExW( hKey, NULL, 0, REG_SZ, user_buffer, cbData );

Because the key is under HKLM, the code executes inside the SYSTEM
process that hosts NCSI.  Any user that is able to reach this method
(receives a pointer through NCSI RPC/ALPC) can therefore write an
arbitrary path (e.g. "..\..\..\Windows\System32\evil.dll") that will
later be consumed by higher-privileged WinHTTP/WinInet components when
a PAC file or proxy executable is loaded.  This lets the attacker
redirect privileged traffic or load arbitrary code, achieving local
privilege escalation.

The central defect is the **absence of filtering for relative path
sequences ("..\\")** before the registry write.  The patch introduces a
ContainsRelativePathDoubleDot() gate that blocks such input.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
v3 = lpData;                     // attacker string
StringCchPrintfExW(Buffer[0], ... , "%s%s", flag, v3);
RegSetValueExW(hKey, 0, 0, REG_SZ, v3, cbData); // no checks

// after
v4 = Str;                        // attacker string
if (FeatureEnabled()) {
    if (ContainsRelativePathDoubleDot(Str))   // NEW CHECK
        goto fail;
    RegSetValueExW(hKey, 0, 0, REG_SZ, (BYTE*)v4, cbData);
}
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Low-privilege client calls into NCSI to set a proxy string.
2. StoreNcsiIEProxyString receives the uncontrolled text.
3. Prior to the fix the function writes the text, verbatim, into an
   HKLM registry value.
4. System services that rely on that value later resolve the path and
   execute / load the referenced resource with SYSTEM privileges.


Attack Vector
--------------------------------------------------------------------
A local authenticated attacker supplies a proxy configuration string
containing "..\\" sequences (e.g. "..\\..\\system32\\cmd.exe") through the
NCSI programming interface.  The string is accepted and stored under
HKLM.  Subsequent privileged use of that value results in execution or
redirection controlled by the attacker, granting SYSTEM-level code
execution.


Patch Description
--------------------------------------------------------------------
1. Function parameter renamed to clearly indicate wide-char string.
2. Added feature-flagged call:
       ContainsRelativePathDoubleDot(Str)
   which aborts the operation if the proxy string contains a relative
   path traversal token.
3. Logging GUIDs/constants updated; defensive path now exits through
   new label (LABEL_47).
4. No other semantic changes – write/delete behaviour is unchanged when
   the input passes validation.


Security Impact
--------------------------------------------------------------------
Before the fix any local user able to reach StoreNcsiIEProxyString could
store a malicious "..\\" path under HKLM, leading to proxy PAC
execution or DLL/script loading as SYSTEM, i.e. elevation of privilege.
The issue is classified as Improper Access Control (CVE-2025-59201).


Fix Effectiveness
--------------------------------------------------------------------
The added ContainsRelativePathDoubleDot() check blocks the specific
".." traversal vector, and it is called before the registry write under
both feature paths.  Provided the helper correctly detects all case and
encoding variations of "..", the patch fully prevents the original
exploit.  No residual write path bypass is visible in the diff.


