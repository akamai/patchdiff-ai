{'confidence': 0.22, 'date': 1763403012.2374687, 'kb': 'KB5066835', 'cve': 'CVE-2025-55692', 'file': 'wer.dll', 'patch_store_uid': 'a41eb3d2-76ed-4075-b075-6a9f72571101', 'change_count': 28}
--------------------------------------------------------------------
CVE-2025-55692 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Error Reporting (WER) – wer.dll, routine AeWERQueryFileInfo()


Vulnerability Class
--------------------------------------------------------------------
Improper Input Validation (CWE-20)


Detailed Root Cause Analysis
--------------------------------------------------------------------
AeWERQueryFileInfo() is invoked by the WER service (running as
NT AUTHORITY\SYSTEM) to obtain ProgramId and FileId strings from an
Amcache hive the service loads with RegLoadAppKeyW(). These two values
are expected to be fixed-length GUID strings (44 WCHARs including the
terminator).

In the vulnerable build the code path protected by
Feature_FileInfo_Improved_Error_Checking() is *optional*.  If the
feature flag is disabled (the default on released builds) the function
accepts *any* non-empty ProgramId or FileId value:

  else if ( *pvData || *v15 )
      v6 = 0;              // report success

No verification of length or formatting is performed.  Immediately
afterwards upper-layer logic trusts the returned buffer as a valid GUID
and uses it to build registry paths and file names while keeping the
fixed 256-byte stack allocation that was sized for a 44 WCHAR string.

An attacker controlling the Amcache hive can therefore place an overly
long (or unterminated) Unicode string in either ProgramId or FileId.
When the service later scans the buffer for the terminating NUL it runs
past the 256-byte stack slot and reads arbitrary stack memory.  That
stack memory is subsequently reused to build paths, enabling a chosen
stack-data overwrite of wide-string path components.  By crafting the
string so that the resulting path resolves to a file or key under the
attacker’s control, arbitrary-file-write and elevation of privilege can
be achieved.

Key data structures / parameters affected:
  a1 + 16     – 256-byte stack buffer for ProgramId
  a1 + 272    – 256-byte stack buffer for FileId
  pcbData[0]  – size supplied to RegGetValueW (256)
  pvData      – pointer to destination buffer


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// vulnerable branch (before patch)
pcbData[0] = 256;
ValueW = RegGetValueW(hkey, SubKey, L"ProgramId", 2u,
                      0, (PVOID)(a1 + 16), pcbData);
...
else if ( *pvData || *v15 )       // only one value needs to be non-empty
{
    v6 = 0;                       // success without length check
}
```
```c
// fixed branch (after patch)
pcbData = 256;
ValueW = RegGetValueW(hkey, SubKey, L"ProgramId", 2u,
                      0, (PVOID)(a1 + 16), &pcbData);
...
// unconditional strict length verification
v20 = -1; v21 = -1;
while ( *((WORD*)pvData + ++v21) );     // FileId length
...
if ( v21 != 44 ) goto fail;
while ( *(_WORD*)(v16 + 2*++v20) );     // ProgramId length
if ( v20 == 44 ) v6 = 0; else v6 = ERROR_FILE_NOT_FOUND;
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker prepares malicious Amcache.hve containing overlong
   ProgramId / FileId values.
2. WER service calls AeWERQueryFileInfo() while processing a crafted
   file path.
3. RegGetValueW() copies the attacker-controlled string into the fixed
   256-byte stack buffer.
4. Because the feature flag is disabled, size checks are skipped and
   the function reports success.
5. Subsequent string operations scan past the end of the buffer,
   corrupting stack data that is later used to compose system file /
   registry paths.
6. Crafted corruption causes the service to create or open objects in a
   location writable by the attacker, yielding SYSTEM-level file or
   registry writes and privilege escalation.


Attack Vector
--------------------------------------------------------------------
Local, authenticated attacker supplies a malicious Amcache.hve under
%ProgramData%\Microsoft\AppCompat\Programs (or any redirected
persisted-location identified by AeGetPersistedLocation).  No
administrative privileges are required; standard user write permission
is sufficient.


Patch Description
--------------------------------------------------------------------
1. Feature gating removed – improved checks now always executed.
2. Length of both ProgramId and FileId is verified to be exactly 44
   WCHARs; otherwise ERROR_FILE_NOT_FOUND is returned.
3. pcbData changed from two-element array to a single DWORD, preventing
   unintended size confusion.
4. Error logging consolidated; any validation failure now unwinds with
   a consistent error path.
5. Several variables renamed to emphasise correct types (pvData becomes
   void*, etc.).


Security Impact
--------------------------------------------------------------------
Prior to the patch a standard user could coerce the SYSTEM-level WER
service into writing arbitrary files / registry keys or otherwise
corrupting its own execution flow, resulting in elevation of privilege.


Fix Effectiveness
--------------------------------------------------------------------
The unconditional length check eliminates the ability to inject
overlong or unterminated strings into the fixed-size stack buffers.
Combined with the corrected pcbData handling and unified error paths,
no observable path remains to overflow or misuse the buffers.  The
patch therefore fully mitigates the described vulnerability.

