{'file': 'dsclient.dll', 'change_count': 20, 'kb': 'KB5066835', 'patch_store_uid': '1e4aec79-e249-4eb0-99b1-1224cd70ecfc', 'date': 1763402987.9397292, 'cve': 'CVE-2025-59200', 'confidence': 0.15}
--------------------------------------------------------------------
CVE-2025-59200 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Data Sharing Service client library (dsclient.dll) – routines that
establish an RPC connection to the Data-Sharing Service from the
calling user-mode process.

Vulnerability Class
--------------------------------------------------------------------
Concurrent execution using shared resource with improper
synchronisation (CWE-362) resulting in local service-spoofing /
confused-deputy condition.

Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  The client side helper DevPlat::Shared::BindToRPCServerInSession()
    constructs a fixed interface string
       "Dssvc\\Server\\Interface"
    and immediately calls RpcBindingCreateW / RpcBindingBind without
    requesting any form of authentication or verifying the identity of
    the server side.

2.  The binding object is created inside RpcBinding::Bind() /
    RpcBinding::Rebind().  In the original code path the call-graph is

       RpcBinding::Bind
         -> DevPlat::Shared::BindToRPCServerInSession
              -> RpcBindingCreateW
              -> RpcBindingBind

    All of these APIs are invoked with:
      • AuthnLevel   = RPC_C_AUTHN_LEVEL_PKT_PRIVACY (6)
      • AuthnSvc     = RPC_C_AUTHN_WINNT (10)
      • AuthIdentity = NULL
    (see the SECURITY_QOS block built around the stack variables
    v15-v17 in the before-patch listing).  Because AuthIdentity is NULL
    and RPC_C_QOS_CAPABILITIES_MUTUAL_AUTH is not set, the client does
    not request mutual authentication – any process running in the same
    session can register the endpoint first and impersonate the real
    service.

3.  A local attacker can therefore perform a time-of-check/time-of-use
    race: create an RPC endpoint named "Dssvc\\Server\\Interface"
    before the legitimate service starts, wait for a privileged
    process to connect, and serve spoofed responses.  The client trusts
    the attacker’s replies, leading to spoofing of Data-Sharing
    content.

4.  The vulnerability is completely inside dsclient.dll; no kernel code
    is involved.  Structures directly affected:
      • RPC_BINDING_HANDLE_SECURITY_V1_W
      • RPC_SECURITY_QOS (embedded in the above)
      • SID built from SECURITY_NT_AUTHORITY (IdentifierAuthority
        {0,0,0,0,5,0}) but previously unused.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// before
Security.SecurityQos = (RPC_SECURITY_QOS *)&v15;
Security.AuthIdentity   = 0;          // no identity
...
RpcBindingCreateW(&Template, &Security, 0, &Binding);
RpcBindingBind(0, Binding, &unk_1800084D0); // no mutual auth
```
```c
// after
if (FeatureEnabled)
{
    AllocateAndInitializeSid(..., &pSid);
    DevPlat::Shared::BindToRPCServerInSessionMutualAuth(
        ...,           // adds RPC_C_QOS_CAPABILITIES_MUTUAL_AUTH
        pSid, ...);    // server SID expected
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Victim process calls some Data-Sharing API.
2. dsclient!RpcBinding::Bind() invoked.
3. Prior to patch – direct path to DevPlat::Shared::BindToRPCServerInSession()
   creates unauthenticated binding.
4. Attacker-controlled fake service answers, spoofing legitimate
   service.

Attack Vector
--------------------------------------------------------------------
Local, low-privilege attacker wins a race by registering the RPC
endpoint "Dssvc\\Server\\Interface" before the genuine Data-Sharing
Service starts (or after service crash / rebind).  The client binds to
attacker’s handle and exchanges privileged data blindly.

Patch Description
--------------------------------------------------------------------
1. Introduces feature-gated mutual-authentication path:
   • RpcBinding::Bind() and RpcBinding::Rebind() now check
     Feature_2578215227.  If set, they call
       DevPlat::Shared::BindToRPCServerInSessionMutualAuth() or the new
       RpcBinding::BindToRPCServerWithMutualAuth().
   • These helpers build a SECURITY_DESCRIPTOR that contains the well
     known SID S-1-5-18/19/20 (exact value built with
     AllocateAndInitializeSid – value 0x12) and set
     RPC_C_QOS_CAPABILITIES_MUTUAL_AUTH so that the RPC runtime proves
     the server identity matches the supplied SID.
2. Legacy unauthenticated route kept only for feature disabled.
3. Related hardening: String* helpers rewritten with official
   strsafe.lib calls but not security relevant for this issue.

Security Impact
--------------------------------------------------------------------
Before the fix any local user could impersonate the Data-Sharing
Service, causing:
  • Spoofing of service responses (CVE-2025-59200)
  • Possible privilege escalation depending on caller trust.

After the patch the client requires mutual authentication against the
LocalService SID; a rogue endpoint that lacks this identity is rejected
by RpcBindingBind, terminating the race.

Fix Effectiveness
--------------------------------------------------------------------
The new code path explicitly requests mutual authentication and
validates the server SID.  Unless the attacker can obtain the
LocalService SID and register the endpoint under that identity (not
possible from a normal user context), the spoofing avenue is closed.
Residual risk: if the feature flag is disabled by policy the old path
is still used.  With the flag on (default after patch) the fix is
considered effective.
