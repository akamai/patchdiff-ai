{'confidence': 0.27, 'kb': 'KB5066835', 'change_count': 11, 'file': 'vmcompute.exe', 'patch_store_uid': '07663ad0-52a2-4018-be0d-63fb1362ba50', 'cve': 'CVE-2025-53717', 'date': 1763403084.6653953}
--------------------------------------------------------------------
CVE-2025-53717 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
vmcompute.exe  (host-side Hyper-V management service)
Functions that participate in virtual NUMA bookkeeping and in the
GlobalMemoryBalancer: 
 • DmVirtualNumaNode::UpdateAssignedVpCount 
 • GlobalMemoryBalancer::ResourcepGetMaxLpRatio
 • GlobalMemoryBalancer::ResourcepGetBestFit
 • GlobalMemoryBalancer::ResourceAssignVirtualToPhysical

Vulnerability Class
--------------------------------------------------------------------
Logic flaw / reliance on untrusted input in a security decision  
(CWE-807)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The host process keeps per-physical-node statistics in the structure
 GlobalMemoryBalancer::Resource
   +32h  AssignedLpCount
   +36h  AssignedVpCount

When a guest NUMA node is mapped, UpdateAssignedVpCount() is supposed
to increment one of those counters, depending on whether NUMA spanning
(guest node covering several physical nodes) is enabled.  The
vulnerable implementation always updated *both* fields and, more
importantly, wrote the update into whatever element operator[] happened
to return (the decompiled call passed no explicit index).

Because the guest completely controls the spanning mask that reaches
ResourceAssignVirtualToPhysical(), an attacker can repeatedly assign
the same virtual processors to several nodes.  Owing to the accounting
bug, AssignedVpCount stays artificially low, and the later admission
checks in ResourcepGetMaxLpRatio() / ResourcepGetBestFit() treat the
physical NUMA node as lightly loaded.  The GlobalMemoryBalancer then
selects the node even though its LP-per-VP limit has already been
exceeded, allowing creation of additional VBS enclaves that run with
host-level virtual-processor privileges.

New code introduces a feature gate called
   Feature_NumaSpanningBugFix
and changes every affected routine so that, when the gate is enabled:
  • UpdateAssignedVpCount() only modifies AssignedLpCount (+32h) for
    the spanning case and uses a correct span index (second argument
    now carries the index).
  • Consumers choose the correct counter (+32h or +36h) depending on
    the gate, eliminating the under-count.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// Before: wrong index, unconditional VP accounting
if (*(BYTE *)(a1+351) < *a2) {
    p = span<Resource>::operator[](a2);   // always first element
    *(DWORD *)(p+32) += *(DWORD *)(a1+344);
    if (*(DWORD *)(a1+344))
        *(DWORD *)(p+36) += *(DWORD *)(*(QWORD *)(a1+536)+32) *
                            *(DWORD *)(a1+344);
}

// After: index passed, behaviour gated
v5 = span<Resource>::operator[](a2, v4);
if (FeatureEnabled()) {
    if (v6)
        *(DWORD *)(v5+32) += *(DWORD *)(ptr+32) * v6;
} else {
    *(DWORD *)(v5+32) += v6;
    if (v7)
        *(DWORD *)(v5+36) += *(DWORD *)(ptr+32) * v7;
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Guest/administrator enables NUMA spanning and supplies a crafted
   virtual-to-physical node mask.
2. Host vmcompute.exe enters
   ResourceAssignVirtualToPhysical() -> UpdateAssignedVpCount().
3. Because of the bug, AssignedVpCount of the targeted physical node
   is *not* incremented.
4. Subsequent placement helpers (ResourcepGetMaxLpRatio and
   ResourcepGetBestFit) rely on the under-reported counters and accept
   additional mappings.
5. VBS enclave starts on an over-committed node, giving enclave code
   access to host-level VP privileges (local EoP).

Attack Vector
--------------------------------------------------------------------
Local attacker with the ability to create or reconfigure a VM on the
host (including inside a guest that runs in nested-virtualisation
scenarios) sets NUMA spanning and repeatedly re-assigns the same VPs.
No additional privileges are required beyond VM management rights.

Patch Description
--------------------------------------------------------------------
1. Added feature flag Feature_NumaSpanningBugFix.
2. UpdateAssignedVpCount() now receives the span index and updates the
   correct counter depending on the flag.
3. Every consumer routine selects between AssignedLpCount (+32h) and
   AssignedVpCount (+36h) under the same flag.
4. ResourceAssignVirtualToPhysical() rewritten to pass the correct
   index and use the gated accounting.

Security Impact
--------------------------------------------------------------------
Prior to the patch, over-commit checks could be bypassed, letting an
attacker create VBS enclaves with more virtual processors than
permitted.  Because the enclave executes in VTL1, this breaks the
intended privilege boundary and allows local elevation to the
virtual-processor context of the host.

Fix Effectiveness
--------------------------------------------------------------------
The corrected logic removes the mis-count and uses the span index that
matches the physical resource being updated.  Assuming the Windows
feature flag is enabled system-wide, the vulnerability is fully
neutralised.  If the flag is disabled by policy, the original flaw
would persist; therefore deployment guidance must ensure the feature is
turned on everywhere.
