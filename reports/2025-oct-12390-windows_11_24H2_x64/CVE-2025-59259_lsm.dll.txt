{'patch_store_uid': 'da4e902e-c230-48a6-bd3a-79fec5239c44', 'confidence': 0.14, 'file': 'lsm.dll', 'date': 1763407698.7495573, 'change_count': 14, 'kb': 'KB5066835', 'cve': 'CVE-2025-59259'}
--------------------------------------------------------------------
CVE-2025-59259 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Local Session Manager (lsm.dll)
  - CCsrPipe::OnReplyMessage
  - CCsrPipe::SendLpcMessage

Vulnerability Class
--------------------------------------------------------------------
Improper Validation of Specified Type of Input / NULL-pointer
Dereference (CWE-1287)

Detailed Root Cause Analysis
--------------------------------------------------------------------
The LSM service exchanges WinStation commands with the per-session
CSRSS process through the CCsrPipe helper.  Two code paths were
missing basic pointer and structural validation:

1. CCsrPipe::OnReplyMessage(_WINSTATIONREPLYMESSAGEMSG *)
   Incoming reply objects contain two caller-supplied pointers:
     pResponse  (FIELD  +8)   -> DWORD buffer
     pStatus    (FIELD +20)   -> DWORD buffer
   The pre-patch routine unconditionally executed
        *pStatus   = Message.StatusCode;
        *pResponse = Message.ResponseCode;
        SetEvent(Message.hEvent);
   If either pointer is NULL the store touches address 0x0 and the
   critical LSM service terminates with STATUS_ACCESS_VIOLATION,
   bringing down the logon subsystem and denying service to all
   users.

2. CCsrPipe::SendLpcMessage(_WINSTATION_APINUMBER,void *,…)
   a. The function accepted a caller-controlled pointer ("pMsg") but
      never verified that it was non-NULL before memcpy(…), resulting
      in a crash when pMsg == NULL.
   b. For API 9 (WINSTATION_REPLYCMD) the structure is expected to be
      coherent: when DoNotWait==1 both pResponse and pStatus must be
      NULL.  No such guarantee existed, so later dereferences or event
      waits could access invalid memory or enter an infinite wait
      state, effectively hanging the service.

Because both routines run inside the privileged LSM process, any
authenticated user that can send malformed WinStation messages can
reliably crash the subsystem, causing a system-wide denial of service.

Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// OnReplyMessage – vulnerable excerpt (before)
*((DWORD **)msg + 1)[0] = *(DWORD *)msg;      // *pStatus
*((DWORD **)msg + 4)[0] = ((DWORD *)msg)[6];  // *pResponse
SetEvent(*((HANDLE *)msg + 2));

// OnReplyMessage – fixed
if (pResponse && pStatus) {
    *pStatus   = msg->StatusCode;
    *pResponse = msg->ResponseCode;
    SetEvent(msg->hEvent);
} else {
    _DbgPrintMessage(...);
    return E_INVALIDARG;
}

// SendLpcMessage – new upfront validation
if (!pMsg) {
    _DbgPrintMessage("SendLpcMessage: pMsg is NULL");
    return E_INVALIDARG;                       // 0x80070057
}
if (ApiNumber == 9) {
    bool doNotWait = msg->DoNotWait;
    if (doNotWait != (msg->pStatus==NULL) ||
        doNotWait != (msg->pResponse==NULL)) {
        _DbgPrintMessage("Message structure inconsistency …");
        return E_INVALIDARG;
    }
}
```

Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker prepares a malformed WinStation reply/request with
   pStatus==NULL or pResponse==NULL (or passes NULL pMsg).
2. Message is delivered to LSM through the Csr pipe.
3. LSM executes OnReplyMessage / SendLpcMessage.
4. Pre-patch code blindly dereferences NULL -> access violation.
5. lsm.exe (critical service) crashes, Windows logs the user off and
   restarts.

Attack Vector
--------------------------------------------------------------------
Any authenticated context capable of sending WinStation API messages
(e.g., via Remote Desktop session handling or local WinStation APIs)
can deliver the malformed structure.  Network reachability is
"unknown"; at minimum local authenticated code is required.

Patch Description
--------------------------------------------------------------------
• Added explicit NULL checks for the top-level message pointer (pMsg).
• Added consistency checks between DoNotWait flag and embedded pointer
  fields for API 9.
• Added early return with E_INVALIDARG (-0x7FF8FF2F) when validation
  fails and recorded the fault via RtlLogUnexpectedCodepath.
• Wrapped pointer dereference in OnReplyMessage with the same
  validation, avoiding the write when either pointer is NULL.
• Extra diagnostic logging and feature-flag gating were introduced; no
  functional change beyond validation.

Security Impact
--------------------------------------------------------------------
Before the fix a non-privileged attacker could crash the Local Session
Manager, terminating all interactive logons and leading to a system
wide denial of service.  No privilege escalation or data disclosure is
involved, but availability is fully compromised.

Fix Effectiveness
--------------------------------------------------------------------
The added checks prevent NULL or inconsistent pointers from being
used, returning an error instead of performing the invalid write or
wait.  The vulnerable paths are now unreachable under the same attack
conditions, so the patch fully mitigates the described DoS flaw.
