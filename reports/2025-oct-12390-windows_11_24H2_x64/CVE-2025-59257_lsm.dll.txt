{'date': 1763406130.903407, 'kb': 'KB5066835', 'cve': 'CVE-2025-59257', 'patch_store_uid': 'da4e902e-c230-48a6-bd3a-79fec5239c44', 'file': 'lsm.dll', 'change_count': 14, 'confidence': 0.34}
--------------------------------------------------------------------
CVE-2025-59257 Report
--------------------------------------------------------------------

Component
--------------------------------------------------------------------
Windows Local Session Manager (lsm.dll) – specifically the ALPC
handling path that processes WINSTATIONREPLYMESSAGEMSG traffic
between LSM and the Client/Server-Runtime Sub-System (CSRSS).


Vulnerability Class
--------------------------------------------------------------------
Improper Validation of Specified Type of Input (CWE-1287) resulting
in NULL/invalid-pointer dereference and service crash (Denial of
Service).


Detailed Root Cause Analysis
--------------------------------------------------------------------
1.  Message type involved
    WINSTATION_APINUMBER 0x09  →  WINSTATIONREPLYMESSAGEMSG
    struct layout (simplified)
        DWORD   ApiNumber;            // +0x00 (value 9)
        BYTE    DoNotWait;            // +0x?? (offset 0x4040)
        DWORD  *pResponse;            // +0x4048 (offset 0xA8/0xB0)
        DWORD  *pStatus;              // +0x4060 (offset 0xC0/0xC8)

2.  Pre-patch execution path
    • CCsrMgr::LpcWorker receives an ALPC message from CSRSS.
    • When ApiNumber == 9 and DoNotWait == 0 the worker executed the
      in-place code shown below:
          **((_DWORD**)v2 + 8)  = *((_DWORD*)v2 + 14);
          **((_DWORD**)v2 + 11) = *((_DWORD*)v2 + 20);
      Here ‘v2’ is the raw PORT_MESSAGE buffer supplied by the remote
      client.  The code blindly dereferenced the two embedded
      pointers pResponse and pStatus.
    • If either pointer was NULL, or pointed outside the LSM address
      space, the write raised an access-violation inside the system
      process lsass.exe hosting lsm.dll, terminating the service and
      all dependent subsystems.

3.  Missing validation
    • No check that pResponse / pStatus are non-NULL.
    • No check that the DoNotWait flag coherently matches the pointer
      presence (async vs sync call semantics).

4.  Additional unsafe pattern
    • CCsrPipe::SendLpcMessage built outbound messages without
      validating the same invariants, allowing internally generated
      inconsistent messages to reach the vulnerable path as well.

5.  Result
    Any process able to send messages on the LSM <-> CSRSS ALPC port
    (normally any local authenticated user) could trigger an
    immediate crash of LSM, leading to logoff of all sessions and
    service denial for the entire machine.


Vulnerability Code Snippets
--------------------------------------------------------------------
```c
// lsm!CCsrMgr::LpcWorker  (before)
if (ApiNumber == 9) {
    /* no NULL checks */
    *msg->pResponse = msg->Response;   // (**((_DWORD**)v2 + 8))
    *msg->pStatus   = msg->Status;     // (**((_DWORD**)v2 + 11))
    SetEvent(msg->hSync);              // assumes valid handle
}
```
```c
// lsm!CCsrPipe::OnReplyMessage  (after)
if (pResponse && pStatus) {
    *pResponse = msg->Response;
    *pStatus   = msg->Status;
    SetEvent(msg->hSync);
    return S_OK;
}
_DbgPrintMessage("OnReplyMessage: pResponse or pStatus is NULL");
return E_INVALIDARG;                   // 0x80070057
```


Trigger Flow (Top-Down)
--------------------------------------------------------------------
1. Attacker opens LSM ALPC port (same one used by CSRSS).
2. Crafts WINSTATIONREPLYMESSAGEMSG with ApiNumber==9, DoNotWait==0
   but sets pResponse / pStatus to NULL.
3. Sends message → CCsrMgr::LpcWorker.
4. Pre-patch code dereferences NULL pointer, raising AV in lsm.dll.
5. Windows Session Manager service terminates → system-wide DoS.


Attack Vector
--------------------------------------------------------------------
Local authenticated user (or a compromised service) able to send
crafted ALPC messages to the LSM “SmSsWinStationManager” port can
supply a malformed WINSTATIONREPLYMESSAGEMSG with NULL (or bogus)
pointers, crashing LSM and denying service to all sessions.


Patch Description
--------------------------------------------------------------------
1. Introduced new helper CCsrPipe::OnReplyMessage.
   • Verifies Feature flag gating.
   • Validates that both pResponse and pStatus are non-NULL when
     DoNotWait is cleared.
   • Returns E_INVALIDARG and logs when validation fails.
2. CCsrMgr::LpcWorker replaced the unsafe inline dereference with a
   call to OnReplyMessage and improved error logging.
3. CCsrPipe::SendLpcMessage now performs symmetry checks before it
   constructs outbound messages:
   • Ensures pMsg is non-NULL.
   • Checks consistency between DoNotWait flag and pointer fields.
   • Uses RtlLogUnexpectedCodepath when invariant fails.
4. Defensive early exits added in all modified functions.


Security Impact
--------------------------------------------------------------------
Pre-patch, attackers could crash lsm.dll from user mode, instantly
terminating the LSM service and all active user sessions, resulting
in a persistent Denial-of-Service condition and possible system
reboot requirement.


Fix Effectiveness
--------------------------------------------------------------------
The added NULL / consistency checks eliminate the immediate NULL-
pointer dereference path and convert it into a handled error.  The
patch does not attempt to validate that the supplied addresses are
writable in LSM’s context, but ALPC semantics normally enforce that
for intra-process buffers.  Therefore the fix is effective for the
reported DoS scenario; no residual crash vector is observable with
only the evidence provided.
